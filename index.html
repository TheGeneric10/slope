<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>SLOPE — SEASON 1</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link rel="icon" href="./favicon.ico">
<style>
  *, *::before, *::after {
    margin:0; padding:0; box-sizing:border-box;
    user-select:none; -webkit-user-select:none;
    -webkit-tap-highlight-color:transparent; -webkit-touch-callout:none;
    -webkit-user-drag:none; cursor:default;
  }
  html, body { width:100%; height:100%; overflow:hidden; background:#000; touch-action:none; }
  canvas { position:fixed; display:block; image-rendering:crisp-edges; image-rendering:pixelated; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<input id="profileUploadInput" type="file" accept="image/*" style="display:none">
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<!-- ============================================================ -->
<!--  SCRIPT 1 · CONFIG & CONSTANTS                              -->
<!-- ============================================================ -->
<script id="s-config">
'use strict';

const LW = 420, LH = 746; // 9:16 ratio (~420×746)

const CFG = {
  TRACK_W0:340, TRACK_MIN:68,
  SHRINK:0.006, SEG_H:14, CURVE:1.3,
  SPD0:130, SPD_MAX:680, SPD_ACC:7,
  PR:10, PSPD:260, TRAIL:22,
  LIVES:3, MAX_LIVES:5, INVMS:2000,
  SPS:10,
  GEM_INT: [0.7,1.4],
  PWR_INT: [10,18],
  OBS_INT: [2.8,5.0], OBS_THRESH:180,
  CY:'#00f5ff', PK:'#ff006e', YL:'#ffe600',
  GR:'#39ff14', OR:'#ff7700', PU:'#cc00ff',
  BL:'#4488ff', BG:'#020508',
};

const SETTINGS = {
  particles:true, scanlines:true, screenShake:true,
  showFPS:true, sfx:true,
  gfxQuality:2,   // 0=LOW 1=MED 2=HIGH
  fpsLimit:1,     // 0=30 1=60 2=∞
  touchSensitivity:1.0,
  keyboardSensitivity:1.0,
  controllerSensitivity:1.0,
};


const SETTINGS_KEY='slope_settings';
function loadSettingsPrefs(){
  try {
    const v=JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}');
    if (typeof v!=='object' || !v) return;
    if (typeof v.particles==='boolean') SETTINGS.particles=v.particles;
    if (typeof v.scanlines==='boolean') SETTINGS.scanlines=v.scanlines;
    if (typeof v.screenShake==='boolean') SETTINGS.screenShake=v.screenShake;
    if (typeof v.showFPS==='boolean') SETTINGS.showFPS=v.showFPS;
    if (typeof v.sfx==='boolean') SETTINGS.sfx=v.sfx;
    if (Number.isFinite(v.gfxQuality)) SETTINGS.gfxQuality=clamp(v.gfxQuality,0,2);
    if (Number.isFinite(v.fpsLimit)) SETTINGS.fpsLimit=clamp(v.fpsLimit,0,2);
    if (Number.isFinite(v.touchSensitivity)) SETTINGS.touchSensitivity=clamp(v.touchSensitivity,0.5,2);
    if (Number.isFinite(v.keyboardSensitivity)) SETTINGS.keyboardSensitivity=clamp(v.keyboardSensitivity,0.5,2);
    if (Number.isFinite(v.controllerSensitivity)) SETTINGS.controllerSensitivity=clamp(v.controllerSensitivity,0.5,2);
  } catch {}
}
function saveSettingsPrefs(){
  localStorage.setItem(SETTINGS_KEY,JSON.stringify(SETTINGS));
}
loadSettingsPrefs();
const GFX_LABELS = ['LOW','MED','HIGH'];
const FPS_LABELS = ['30','60','∞'];
const FPS_VALUES = [30,60,0]; // 0=unlimited

const OPTION_DEFAULTS={showQuestsInGame:true, showTutorials:true, showTouchJoycons:true, showFPS:true};
function loadOptionPrefs(){
  try {
    const v=JSON.parse(localStorage.getItem('slope_options')||'{}');
    return {
      showQuestsInGame:v.showQuestsInGame!==false,
      showTutorials:v.showTutorials!==false,
      showTouchJoycons:v.showTouchJoycons!==false,
      showFPS:v.showFPS!==false,
    };
  } catch { return {...OPTION_DEFAULTS}; }
}
function saveOptionPrefs(){ localStorage.setItem('slope_options',JSON.stringify(OPTION_PREFS)); }
let OPTION_PREFS=loadOptionPrefs();

// BUG FIX 1: Removed duplicate VERSION constant ('0.9.1' shadowed '0.9.2')
const VERSION = 'pre-1.0.0 (patch_03012026)';

// Adventure stage configs
const ADV_STAGES = [
  {name:'STAGE 1', label:'VERY EASY', spd:100, spdMax:220, shrink:0.001, obsOff:true },
  {name:'STAGE 2', label:'EASY',      spd:170, spdMax:320, shrink:0.003, obsInt:[5.5,8.0]},
  {name:'STAGE 3', label:'MEDIUM',    spd:230, spdMax:420, shrink:0.005, obsInt:[3.8,6.0]},
  {name:'STAGE 4', label:'HARD',      spd:300, spdMax:520, shrink:0.006, obsInt:[2.8,4.5]},
  {name:'STAGE 5', label:'VERY HARD', spd:380, spdMax:600, shrink:0.007, obsInt:[2.0,3.5]},
  {name:'STAGE 6', label:'INTENSE',   spd:460, spdMax:680, shrink:0.009, obsInt:[1.3,2.5]},
];

const IMP_STAGES=[
  {name:'STAGE 1', label:'HARD', spd:340, spdMax:560, shrink:0.008, theme:'rgba(255,60,60,0.10)'},
  {name:'STAGE 2', label:'VERY HARD', spd:420, spdMax:640, shrink:0.010, theme:'rgba(255,40,40,0.14)'},
  {name:'STAGE 3', label:'INTENSE', spd:500, spdMax:700, shrink:0.012, theme:'rgba(255,30,30,0.18)'},
  {name:'STAGE 4', label:'EXTREME', spd:580, spdMax:760, shrink:0.014, theme:'rgba(255,10,10,0.24)'},
];

const LTM_MODES=[
  {id:'gold_rush', name:'GOLD RUSH', desc:'Golden adventure score pop', cardCol:'#ffd700', stageDuration:30, stages:[
    {name:'STAGE 1',label:'VERY EASY',spd:110,spdMax:230,shrink:0.0015,obsInt:[5.8,8.0]},
    {name:'STAGE 2',label:'EASY',spd:180,spdMax:320,shrink:0.0035,obsInt:[4.6,6.6]},
    {name:'STAGE 3',label:'MEDIUM',spd:250,spdMax:430,shrink:0.0048,obsInt:[3.8,5.5]},
    {name:'STAGE 4',label:'HARD',spd:320,spdMax:520,shrink:0.0065,obsInt:[3.0,4.2]},
    {name:'STAGE 5',label:'VERY HARD',spd:390,spdMax:620,shrink:0.0072,obsInt:[2.2,3.5]},
    {name:'STAGE 6',label:'INTENSE',spd:470,spdMax:700,shrink:0.0085,obsInt:[1.5,2.7]},
  ], forcedPowerups:['X2_SCORE','MINI_JETPACK','SHIELD','MAGNET','REGEN','HEALTH_BOOST','X4_GEMS','GEM_DROP'], stagePowerupStage:5, gemSet:[{col:'#ffd700',score:100,gems:3},{col:'#ff9900',score:250,gems:5},{col:'#ff3344',score:500,gems:10}],specialName:'GOLD FEVER',specialCol:'#ffd700'},
  {id:'space', specialName:'COSMIC BURST', specialCol:'#7bc9ff', name:'SPACE', desc:'Low gravity star ride', cardCol:'#7bc9ff', stageDuration:50, stages:[
    {name:'STAGE 1',label:'EASY',spd:95,spdMax:220,shrink:0.002,obsInt:[6.0,8.5]},
    {name:'STAGE 2',label:'MEDIUM',spd:145,spdMax:290,shrink:0.0035,obsInt:[4.5,7.2]},
    {name:'STAGE 3',label:'HARD',spd:210,spdMax:380,shrink:0.0055,obsInt:[3.8,6.0]},
  ], forcedPowerups:['X2_SCORE','MINI_JETPACK','SHIELD','MAGNET','REGEN','HEALTH_BOOST','GEM_DROP'], stagePowerupStage:2, lowGravity:true},
  {id:'volcano', specialName:'LAVA ARMOR', specialCol:'#ff5a2a', name:'VOLCANO', desc:'Eruptions and red pressure', cardCol:'#ff5a2a', stageDuration:40, stages:[
    {name:'STAGE 1',label:'MEDIUM',spd:220,spdMax:420,shrink:0.0055,obsInt:[3.5,5.5]},
    {name:'STAGE 2',label:'HARD',spd:320,spdMax:560,shrink:0.0082,obsInt:[2.4,4.0]},
    {name:'STAGE 3',label:'VERY HARD',spd:460,spdMax:720,shrink:0.0125,obsInt:[1.4,2.4]},
  ], forcedPowerups:['X2_SCORE','JETPACK','SHIELD','MAGNET','REGEN','HEALTH_BOOST','IMMUNITY','X2_GEMS','GEM_DROP'], stagePowerupStage:2, volcanoFX:true},
  {id:'frostbite', specialName:'ICE FIELD', specialCol:'#7af0ff', name:'FROSTBITE', desc:'Frozen lanes and glide control', cardCol:'#7af0ff', stageDuration:35, stages:[{name:'STAGE 1',label:'CHILL',spd:150,spdMax:320,shrink:0.003,obsInt:[4.8,6.8]},{name:'STAGE 2',label:'COLD',spd:220,spdMax:430,shrink:0.005,obsInt:[3.4,5.2]},{name:'STAGE 3',label:'BLIZZARD',spd:320,spdMax:560,shrink:0.007,obsInt:[2.4,4.0]}], forcedPowerups:['X2_SCORE','SHIELD','MAGNET','REGEN','GEM_DROP']},
  {id:'metro', specialName:'RAIL RUSH', specialCol:'#ff4dd2', name:'NEON METRO', desc:'City rails and fast pickups', cardCol:'#ff4dd2', stageDuration:34, stages:[{name:'STAGE 1',label:'RUSH',spd:180,spdMax:340,shrink:0.004,obsInt:[4.4,6.2]},{name:'STAGE 2',label:'HYPER',spd:260,spdMax:460,shrink:0.0064,obsInt:[3.1,4.8]},{name:'STAGE 3',label:'BLAZE',spd:360,spdMax:620,shrink:0.008,obsInt:[2.0,3.5]}], forcedPowerups:['X2_SCORE','MAGNET','REGEN','X2_GEMS','GEM_DROP']},
  {id:'storm', specialName:'THUNDER CORE', specialCol:'#d3c4ff', name:'THUNDER RUN', desc:'Electric storms and shake', cardCol:'#d3c4ff', stageDuration:38, stages:[{name:'STAGE 1',label:'STATIC',spd:170,spdMax:320,shrink:0.0035,obsInt:[4.8,6.8]},{name:'STAGE 2',label:'SPARK',spd:240,spdMax:450,shrink:0.006,obsInt:[3.0,4.8]},{name:'STAGE 3',label:'THUNDER',spd:330,spdMax:610,shrink:0.0078,obsInt:[2.1,3.3]}], forcedPowerups:['X2_SCORE','SHIELD','IMMUNITY','REGEN','GEM_DROP']},
  {id:'hacker', specialName:'GLITCH BREAK', specialCol:'#45ffcc', name:'GLITCH GRID', desc:'Digital chaos and pulse', cardCol:'#45ffcc', stageDuration:32, stages:[{name:'STAGE 1',label:'PATCHED',spd:160,spdMax:330,shrink:0.0036,obsInt:[4.7,6.5]},{name:'STAGE 2',label:'BREACH',spd:250,spdMax:470,shrink:0.0063,obsInt:[3.0,4.7]},{name:'STAGE 3',label:'MELTDOWN',spd:350,spdMax:620,shrink:0.0081,obsInt:[2.0,3.2]}], forcedPowerups:['X2_SCORE','MAGNET','X4_GEMS','REGEN','GEM_DROP']},
  {id:'void', specialName:'VOID SHELL', specialCol:'#a98bff', name:'VOID TUNNEL', desc:'Ultra dark precision route', cardCol:'#a98bff', stageDuration:42, stages:[{name:'STAGE 1',label:'DUSK',spd:170,spdMax:330,shrink:0.0041,obsInt:[4.8,6.4]},{name:'STAGE 2',label:'NIGHT',spd:260,spdMax:470,shrink:0.0066,obsInt:[2.8,4.6]},{name:'STAGE 3',label:'VOID',spd:360,spdMax:640,shrink:0.0088,obsInt:[1.8,3.0]}], forcedPowerups:['X2_SCORE','SHIELD','MAGNET','REGEN','IMMUNITY']},
  {id:'jungle', specialName:'WILD GROWTH', specialCol:'#7dff60', name:'JUNGLE DASH', desc:'Roots, rain and gem rain', cardCol:'#7dff60', stageDuration:37, stages:[{name:'STAGE 1',label:'WET',spd:155,spdMax:320,shrink:0.0034,obsInt:[4.9,6.7]},{name:'STAGE 2',label:'VINES',spd:235,spdMax:430,shrink:0.0057,obsInt:[3.2,5.0]},{name:'STAGE 3',label:'CANOPY',spd:330,spdMax:580,shrink:0.0075,obsInt:[2.2,3.6]}], forcedPowerups:['X2_SCORE','MAGNET','REGEN','HEALTH_BOOST','GEM_DROP']},
  {id:'chrono', specialName:'TIME FRACTURE', specialCol:'#fff37b', name:'TIME WARP', desc:'Temporal speed spikes', cardCol:'#fff37b', stageDuration:36, stages:[{name:'STAGE 1',label:'SLOW',spd:125,spdMax:260,shrink:0.0028,obsInt:[5.0,7.0]},{name:'STAGE 2',label:'RIFT',spd:245,spdMax:440,shrink:0.006,obsInt:[3.0,4.8]},{name:'STAGE 3',label:'WARP',spd:390,spdMax:660,shrink:0.0092,obsInt:[1.7,2.9]}], forcedPowerups:['X2_SCORE','JETPACK','MAGNET','X2_GEMS','X4_GEMS']},
];
</script>

<!-- ============================================================ -->
<!--  SCRIPT 2 · CANVAS & RESIZE                                 -->
<!-- ============================================================ -->
<script id="s-canvas">
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');
canvas.width  = LW;
canvas.height = LH;

let canvasScale = 1, canvasOX = 0, canvasOY = 0;

function resizeCanvas() {
  const vw = window.innerWidth, vh = window.innerHeight;
  const s  = Math.min(vw / LW, vh / LH);
  const cw = Math.round(LW * s), ch = Math.round(LH * s);
  const ox = Math.round((vw - cw) / 2), oy = Math.round((vh - ch) / 2);
  canvas.style.cssText = `width:${cw}px;height:${ch}px;left:${ox}px;top:${oy}px;`;
  canvasScale = s; canvasOX = ox; canvasOY = oy;
}

resizeCanvas();
window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 200));
setInterval(resizeCanvas, 250); // auto-fit every 250ms (less input overhead)
</script>

<!-- ============================================================ -->
<!--  SCRIPT 3 · INPUT HANDLING                                  -->
<!-- ============================================================ -->
<script id="s-input">
const K = { left:false, right:false };

// Touch swipe state — smooth left/right movement on hold+swipe
let touchActive = false;
let touchStartX = 0;
let touchCurrentX = 0;
let touchSwipe = 0;   // -1 to 1 continuous
let touchSwipeTarget = 0;
let touchMoved = false;
let _lastTouchEnd = 0;
let questTouchY = null;
let profileTouchY = null;
let leaderboardTouchY = null;
let adminLtmTouchY = null;
let shopTouchY = null;
let joyL=false, joyR=false;
let usingTouchJoy=false;
const isTouchDevice=('ontouchstart' in window)||(navigator.maxTouchPoints>0);
const GP={left:false,right:false,pauseEdge:false,lastPause:false};
var gs='LOADING';
var profileUploadState={active:false,mode:'idle',error:'',rawData:'',img:null,zoom:1,offX:0,offY:0,drag:false,lastX:0,lastY:0};
var fps=0, fpsFrames=0, fpsTimer=0;
let mouseCanvasPos={x:-9999,y:-9999};

function getCanvasXY(e) {
  const rect = canvas.getBoundingClientRect();
  const src  = e.changedTouches ? e.changedTouches[0]
             : e.touches        ? e.touches[0] : e;
  return {
    x: (src.clientX - rect.left) * (LW / rect.width),
    y: (src.clientY - rect.top)  * (LH / rect.height)
  };
}

const BTNS = {
  start:null, retry:null, home:null, settings:null, back:null,
  pause:null, resume:null, menuFromPause:null,
  shopSkip:null, shopBack:null,
  charBack:null, charPrev:null, charNext:null, charShop:null,
  modeEndless:null, modeAdventure:null, modeImpossible:null, modeLtm:null,
  about:null,
  quests:null, questsBack:null,
  leaderboard:null, leaderboardPause:null, leaderboardBack:null, leaderboardTabGlobal:null, leaderboardTabEndless:null, leaderboardTabAdventure:null, leaderboardTabImpossible:null, leaderboardTabLtm:null,
  upgrades:null, upgradesBack:null,
  continueBuy:null, continueGiveUp:null,
  questsFilter:null, questsFilterOpt0:null, questsFilterOpt1:null, questsFilterOpt2:null, questsFilterOpt3:null,
  resetBtn:null,
  dialogYes:null, dialogNo:null, actionPopupBtn:null,
  optimizeBtn:null, confirmYes:null, confirmNo:null,
  modeSoon:null, modeWideSoon:null,
  authAction:null, authBack:null, authSubmit:null, authRestart:null,
  pauseOptions:null, optionsBack:null, optionsToggleQuests:null, optionsToggleTutorials:null, hudOptions:null,
  signinEmail:null, signinPass:null, signupName:null, signupEmail:null, signupPass:null, signupConfirm:null, signupSwitch:null, signinSwitch:null, signinGoogle:null, signupGoogle:null,
  profileChangeUsername:null, profileChangePassword:null, profileAvatar:null, profileTrash:null, profileUploadOk:null, profileUploadCancel:null, profileUploadZoomIn:null, profileUploadZoomOut:null, profileUploadReset:null, profileUploadErrOk:null, profileInfoBox:null, profileUidToggle:null, profileUidCopy:null, profileStatusDefault:null, profileStatusIdle:null, profileStatusDnd:null, profileStatusOffline:null, usernameTryAgain:null, usernameExit:null, usernameContinue:null, playerCardClose:null, playerCardEdit:null, playerCardFav:null, menuProfileBox:null, guestPromptSignIn:null, guestPromptContinue:null, publicProfileBack:null, publicProfileRequests:null, publicProfileFriends:null, playerCardFind:null, playerCardAdd:null, playerCardFollow:null, playerCardUnfriend:null, socialTabFriends:null, socialTabFollowers:null, socialTabFollowing:null, socialActionA:null, socialActionB:null, profileDelete:null,
  adminBack:null, adminAuthInput:null, adminAuthSubmit:null, adminSetGems:null, adminGrantSelected:null, adminUnlockAll:null, adminLockAll:null, adminLockSelectedSkin:null, adminLockSelectedAura:null, adminLockSelectedTheme:null, adminVerifyUid:null, adminVerifyToggle:null, adminVerifyApply:null, adminViewLtm:null, adminLtmBack:null,
  controls:null, controlsBack:null, touchJoyL:null, touchJoyR:null, noAds:null, noAdsBuy:null, noAdsContinue:null, overLeaderboard:null,
};

function hitBtn(p, rect) {
  if (!rect) return false;
  return p.x>=rect.x && p.x<=rect.x+rect.w && p.y>=rect.y && p.y<=rect.y+rect.h;
}

function stopProfileCropInteraction(){
  if (!profileUploadState || !profileUploadState.active) return;
  profileUploadState.drag=false;
  if (typeof clampProfileUploadOffsets==='function') clampProfileUploadOffsets(profileUploadState,220);
}

let confirmDialog={active:false,title:'',msg:'',action:''};
let actionPopup={active:false,title:'',msg:'',ok:true,loading:false,onContinue:null};
function openConfirm(action,title,msg) {
  confirmDialog={active:true,action,title,msg};
}
function openActionPopup(title,msg,ok=true,loading=false,onContinue=null){
  actionPopup={active:true,title:String(title||'STATUS'),msg:String(msg||''),ok:!!ok,loading:!!loading,onContinue:(typeof onContinue==='function'?onContinue:null)};
}

let pendingFoundProfile=null;


const CARD_FAV_KEY='slope_profile_card_favs';
function loadCardFavs(){
  try { const arr=JSON.parse(localStorage.getItem(CARD_FAV_KEY)||'[]'); return new Set(Array.isArray(arr)?arr.map(v=>String(v)):[]); }
  catch(e){ return new Set(); }
}
function saveCardFavs(){
  localStorage.setItem(CARD_FAV_KEY,JSON.stringify(Array.from(cardFavUids)));
}
let cardFavUids=loadCardFavs();
let socialRelationCache={friends:new Set(),followers:new Set(),following:new Set(),received:new Set(),sent:new Set()};
let socialUserIndexCache={};
let lastSocialSnapshot={statusByUid:{},received:new Set()};
let socialPollTimer=0;
let profileLiveRefreshTimer=0;
let playerCardFriendMenu={open:false};
let socialCountsCache={};

let uidVisible=false;
let playerCardPopup={active:false,isSelf:false,favorite:false,fromMenu:false,viewed:null};
let guestProfilePrompt={active:false};
const PRIVACY_LEVELS=['FRIENDS OF FRIENDS','FRIENDS ONLY','PRIVATE'];
const PUBLIC_PROFILE_KEY='slope_public_profile';
function loadPublicProfilePrefs(){
  try {
    const v=JSON.parse(localStorage.getItem(PUBLIC_PROFILE_KEY)||'{}');
    return {
      bio:Number.isFinite(v.bio)?clamp(v.bio,0,2):1,
      friends:Number.isFinite(v.friends)?clamp(v.friends,0,2):2,
      followers:Number.isFinite(v.followers)?clamp(v.followers,0,2):2,
      following:Number.isFinite(v.following)?clamp(v.following,0,2):2,
      showMiniCounts:v.showMiniCounts!==false,
    };
  } catch(e) { return {bio:1,friends:2,followers:2,following:2,showMiniCounts:true}; }
}
let publicProfilePrefs=loadPublicProfilePrefs();
function savePublicProfilePrefs(){ localStorage.setItem(PUBLIC_PROFILE_KEY,JSON.stringify(publicProfilePrefs)); }
const STATUS_COLORS={online:'#39ff14',idle:'#ffe45a',dnd:'#ff3366',offline:'#8a95a5'};
const STATUS_LABELS={online:'Online',idle:'Idle',dnd:'Do Not Disturb',offline:'Offline'};
function getStatusValue(){
  if (!isSignedIn || !navigator.onLine) return 'offline';
  return computeEffectiveStatus(auth);
}
function getStatusPref(){
  const st=String((auth&&auth.statusPref)||'').toLowerCase();
  return STATUS_COLORS[st]?st:'online';
}
function computeEffectiveStatus(meta){
  const m=meta||{};
  const base=String(m.status||'offline').toLowerCase();
  const pref=String(m.statusPref||base||'online').toLowerCase();
  const lastSeen=Number(m.lastSeen||0);
  const now=Date.now();
  if (base==='offline') return 'offline';
  if (!lastSeen || (now-lastSeen)>(90*1000)) return 'offline';
  if (pref==='dnd') return 'dnd';
  if (pref==='idle') return 'idle';
  if (pref==='offline') return 'offline';
  if ((now-lastSeen)>=(10*60*1000)) return 'idle';
  return 'online';
}
let lastPresenceActivityAt=Date.now();
let lastPresenceSyncAt=0;
let lastPresenceCloudSyncAt=0;
function markPresenceActivity(source='input'){
  lastPresenceActivityAt=Date.now();
  if (!isSignedIn || !navigator.onLine) return;
  const pref=getStatusPref();
  if (pref!=='online') return;
  if (String(auth.status||'')!=='online') {
    auth={...auth,status:'online',lastSeen:lastPresenceActivityAt};
    saveAuth(auth);
  }
}
async function refreshSelfPresence(force=false){
  if (!isSignedIn) return;
  const now=Date.now();
  const online=!!navigator.onLine;
  const pref=getStatusPref();
  let target='offline';
  if (online) {
    if (pref==='dnd' || pref==='idle' || pref==='offline') target=pref;
    else target=(now-lastPresenceActivityAt)>=10*60*1000?'idle':'online';
  }
  const curStatus=String(auth.status||'offline');
  const changed=curStatus!==target;
  const heartbeatDue=(now-lastPresenceSyncAt)>45000;
  const shouldHeartbeat=(target!=='offline')&&heartbeatDue;
  if (!changed && !force && !shouldHeartbeat) return;
  const keepOfflineTs=(target==='offline' && !changed);
  const nextLastSeen=keepOfflineTs?(Number(auth.lastSeen||0)||now):now;
  auth={...auth,status:target,lastSeen:nextLastSeen};
  saveAuth(auth);
  lastPresenceSyncAt=now;
  if (fbUser && fbReady && (changed || force || ((now-lastPresenceCloudSyncAt)>20000 && target!=='offline'))) {
    lastPresenceCloudSyncAt=now;
    try { await writeCloudUserInfo({status:target,lastSeen:nextLastSeen,statusPref:pref}); } catch(e){}
    try { await syncSlopeMirror({status:String(target),lastSeen:String(nextLastSeen)}); } catch(e){}
  }
}
async function applyConnectivityStatus(syncCloud=false){
  if (!isSignedIn) {
    auth={...auth,status:'offline',statusPref:'offline',lastSeen:Date.now()};
    saveAuth(auth);
  }
  if (!navigator.onLine) {
    const keepTs=(String(auth.status||'')==='offline' && Number(auth.lastSeen||0)>0)?Number(auth.lastSeen):Date.now();
    auth={...auth,status:'offline',lastSeen:keepTs};
    saveAuth(auth);
    if (syncCloud && fbUser && fbReady) {
      try { await writeCloudUserInfo({status:'offline',lastSeen:keepTs,statusPref:getStatusPref()}); } catch(e){}
      try { await syncSlopeMirror({status:'offline',lastSeen:String(keepTs)}); } catch(e){}
    }
    return;
  }
  await refreshSelfPresence(syncCloud);
}
async function applyConnectivityStatus(syncCloud=false){
  if (!isSignedIn) {
    auth={...auth,status:'offline',statusPref:'offline',lastSeen:Date.now()};
    saveAuth(auth);
    return;
  }
  if (!navigator.onLine) {
    auth={...auth,status:'offline',lastSeen:Date.now()};
    saveAuth(auth);
    if (syncCloud && fbUser && fbReady) {
      try { await writeCloudUserInfo({status:'offline',lastSeen:Date.now(),statusPref:getStatusPref()}); } catch(e){}
      try { await syncSlopeMirror({status:'offline',lastSeen:String(Date.now())}); } catch(e){}
    }
    return;
  }
  await refreshSelfPresence(syncCloud);
}
window.addEventListener('offline',()=>{ applyConnectivityStatus(true); });
window.addEventListener('online',()=>{ applyConnectivityStatus(true); });

function fmtOfflineAgo(ts){
  const sec=Math.max(0,Math.floor((Date.now()-Number(ts||0))/1000));
  if (sec<60) return `${sec}s`;
  const m=Math.floor(sec/60); if (m<60) return `${m}m`;
  const h=Math.floor(m/60); if (h<24) return `${h}h`;
  const d=Math.floor(h/24); if (d<7) return `${d}d`;
  const w=Math.floor(d/7); if (w<52) return `${w}w`;
  const y=Math.floor(d/365); return `${Math.max(1,y)}y`;
}
function offlineMeta(ts){
  const sec=Math.max(0,Math.floor((Date.now()-Number(ts||0))/1000));
  const weekSec=7*24*60*60;
  const weeks=Math.floor(sec/weekSec);
  return {
    short:fmtOfflineAgo(ts),
    compact:weeks>12?'12w+':fmtOfflineAgo(ts),
    isLong:weeks>12,
  };
}

async function setPlayerStatus(next){
  if (!isSignedIn) { addNotif('Guest status is locked to OFFLINE.',CFG.PK); return; }
  const st=String(next||'online').toLowerCase();
  if (!STATUS_COLORS[st]) return;
  const now=Date.now();
  if (!navigator.onLine) {
    auth={...auth,status:'offline',statusPref:st,lastSeen:now};
    saveAuth(auth);
    addNotif('STATUS SAVED (OFFLINE)',CFG.YL);
    return;
  }
  if (st==='online') lastPresenceActivityAt=now;
  auth={...auth,status:st,statusPref:st,lastSeen:now};
  saveAuth(auth);
  if (fbUser) {
    try { await writeCloudUserInfo({status:st,lastSeen:now,statusPref:st}); } catch(e){}
    try { await syncSlopeMirror({status:String(st),lastSeen:String(now)}); } catch(e){}
  }
  addNotif(`STATUS: ${STATUS_LABELS[st].toUpperCase()}`,STATUS_COLORS[st]);
}

function drawStatusDot(x,y,status){
  const col=STATUS_COLORS[status]||STATUS_COLORS.offline;
  ctx.save();
  glow(col,8); circle(x,y,4,col,true);
  ctx.restore();
}

function getCardRelation(uid){
  const id=String(uid||'');
  if (!id || !isSignedIn || !fbUser) return {incoming:false,outgoing:false,friend:false,following:false,follower:false,favorite:false};
  return {
    incoming:socialRelationCache.received.has(id),
    outgoing:socialRelationCache.sent.has(id),
    friend:socialRelationCache.friends.has(id),
    following:socialRelationCache.following.has(id),
    follower:socialRelationCache.followers.has(id),
    favorite:cardFavUids.has(id),
  };
}
function resolveDisplayStatus(meta){
  return computeEffectiveStatus(meta||{});
}
function drawPlayerCardPopup(t){
  if (!playerCardPopup.active) return;
  const status=getStatusValue();
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.74)'; ctx.fillRect(0,0,LW,LH);
  const w=322,h=250,x=(LW-w)/2,y=(LH-h)/2;
  ctx.fillStyle='rgba(5,12,18,0.98)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(0,245,255,0.45)'; ctx.lineWidth=2; glow(CFG.CY,12); ctx.strokeRect(x,y,w,h);
  BTNS.playerCardClose={x:x+w-34,y:y+8,w:24,h:24};
  drawNeonBtn(BTNS.playerCardClose.x,BTNS.playerCardClose.y,24,24,CFG.PK,'×',11,1,0);
  const cardUser=playerCardPopup.viewed||{};
  const rel=getCardRelation(cardUser.uid);
  if (playerCardPopup.isSelf) {
    BTNS.playerCardEdit={x:x+10,y:y+10,w:56,h:24};
    BTNS.playerCardFav={x:x+72,y:y+10,w:28,h:24};
    BTNS.playerCardFind={x:x+106,y:y+10,w:56,h:24};
    BTNS.playerCardAdd=null; BTNS.playerCardFollow=null; BTNS.playerCardUnfriend=null; BTNS.playerCardMenuUnfriend=null;
    drawNeonBtn(BTNS.playerCardEdit.x,BTNS.playerCardEdit.y,56,24,CFG.CY,'EDIT',8,1,0);
    drawNeonBtn(BTNS.playerCardFav.x,BTNS.playerCardFav.y,28,24,playerCardPopup.favorite?'#ff9a1a':CFG.YL,playerCardPopup.favorite?'★':'☆',10,1,0);
    drawNeonBtn(BTNS.playerCardFind.x,BTNS.playerCardFind.y,56,24,CFG.GR,'FIND',8,1,0);
  } else {
    BTNS.playerCardEdit=null; BTNS.playerCardFind=null;
    BTNS.playerCardFav={x:x+146,y:y+10,w:28,h:24};
    BTNS.playerCardFollow={x:x+180,y:y+10,w:74,h:24};
    BTNS.playerCardUnfriend=null;
    let actionLabel='ADD FRIEND';
    let actionCol=CFG.GR;
    if (rel.incoming) { actionLabel='VIEW FRIEND REQUEST'; actionCol=CFG.YL; }
    else if (rel.outgoing) { actionLabel='CANCEL FRIEND REQUEST'; actionCol=CFG.PK; }
    else if (rel.friend) { actionLabel='FRIEND'; actionCol=CFG.CY; }
    BTNS.playerCardAdd={x:x+10,y:y+10,w:130,h:24};
    drawNeonBtn(BTNS.playerCardAdd.x,BTNS.playerCardAdd.y,130,24,actionCol,actionLabel,7,1,Math.sin(t*2));
    drawNeonBtn(BTNS.playerCardFav.x,BTNS.playerCardFav.y,28,24,rel.favorite?'#ff9a1a':CFG.YL,rel.favorite?'★':'☆',10,1,0);
    drawNeonBtn(BTNS.playerCardFollow.x,BTNS.playerCardFollow.y,74,24,rel.following?CFG.PK:CFG.CY,rel.following?'UNFOLLOW':'FOLLOW',8,1,0);
    if (rel.friend && playerCardFriendMenu.open) {
      const mx=x+10,my=y+38,mw=130,mh=50;
      ctx.fillStyle='rgba(0,0,0,0.92)'; ctx.fillRect(mx,my,mw,mh);
      ctx.strokeStyle='rgba(255,0,110,0.55)'; ctx.lineWidth=1.5; glow(CFG.PK,10); ctx.strokeRect(mx,my,mw,mh);
      BTNS.playerCardMenuUnfriend={x:mx+8,y:my+8,w:mw-16,h:16};
      drawNeonBtn(BTNS.playerCardMenuUnfriend.x,BTNS.playerCardMenuUnfriend.y,BTNS.playerCardMenuUnfriend.w,BTNS.playerCardMenuUnfriend.h,CFG.PK,'UNFRIEND',8,1,Math.sin(t*2));
      setFont(7,'700',"'Share Tech Mono',monospace"); noGlow(); txt('tap outside to close',mx+mw/2,my+42,'rgba(220,230,255,0.7)');
    } else {
      BTNS.playerCardMenuUnfriend=null;
    }
  }

  const name=String((playerCardPopup.isSelf?(auth&&auth.name):cardUser.name)||'Player');
  const pfpX=x+w-48, pfpY=y+58, r=22;
  const cardAvatar=playerCardPopup.isSelf?String(profileAvatar||''):String(cardUser.avatar||'');
  if (cardAvatar) {
    const img=new Image(); img.src=cardAvatar;
    ctx.save(); ctx.beginPath(); ctx.arc(pfpX,pfpY,r,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,pfpX-r,pfpY-r,r*2,r*2); ctx.restore();
  } else {
    circle(pfpX,pfpY,r,'#1f2c36',true); drawDefaultProfileIcon(pfpX,pfpY,r,'rgba(216,246,255,0.95)');
  }
  ctx.strokeStyle='rgba(0,245,255,0.6)'; ctx.lineWidth=2; circle(pfpX,pfpY,r+2,CFG.CY,false);

  if (playerCardPopup.isSelf?playerCardPopup.favorite:rel.favorite) {
    ctx.save();
    const baseX=pfpX, baseY=pfpY;
    for (let i=0;i<8;i++) {
      const a=t*2.2+i*(Math.PI/4);
      const sx=baseX+Math.cos(a)*34;
      const sy=baseY+Math.sin(a)*30;
      setFont(8,'900'); glow('#ff9a1a',10);
      txt('★',sx,sy,'#ff9a1a');
    }
    ctx.restore();
  }
  const cardStatus=playerCardPopup.isSelf?status:resolveDisplayStatus(cardUser);
  const cardSeen=playerCardPopup.isSelf?(auth&&auth.lastSeen):Number(cardUser.lastSeen||0);
  drawStatusDot(x+18,y+58,cardStatus);
  if (cardStatus==='offline') {
    const meta=offlineMeta(cardSeen);
    setFont(10,'900'); noGlow(); txt('Offline',x+30,y+58,'#d8f6ff','left');
    if (!meta.isLong) {
      setFont(7,'700',"'Share Tech Mono',monospace"); noGlow(); txt(`was seen ${meta.short} ago`,x+30,y+70,'rgba(185,220,245,0.85)','left');
    } else {
      const label='Offline';
      setFont(10,'900');
      const tw=ctx.measureText(label).width;
      const hx=mouseCanvasPos.x, hy=mouseCanvasPos.y;
      if (hx>=x+30 && hx<=x+30+tw && hy>=y+46 && hy<=y+62) {
        const tip='was seen 12w+ ago';
        const tipW=Math.max(96,ctx.measureText(tip).width+14);
        const tipX=clamp(hx-tipW/2,10,LW-tipW-10), tipY=y+74;
        ctx.save();
        ctx.fillStyle='rgba(0,0,0,0.92)'; ctx.fillRect(tipX,tipY,tipW,20);
        ctx.strokeStyle='rgba(0,245,255,0.35)'; ctx.lineWidth=1; ctx.strokeRect(tipX,tipY,tipW,20);
        setFont(7,'700',"'Share Tech Mono',monospace"); noGlow(); txt(tip,tipX+tipW/2,tipY+13,'rgba(220,245,255,0.95)');
        ctx.restore();
      }
    }
  } else {
    setFont(10,'900'); noGlow(); txt(`${STATUS_LABELS[cardStatus]||'Offline'}`,x+30,y+62,'#d8f6ff','left');
  }
  setFont(16,'900'); glow(CFG.CY,10); txt(name,x+14,y+96,CFG.CY,'left');
  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow();
  const cardBest=playerCardPopup.isSelf?bestScore:Number(cardUser.bestScore||0);
  txt(`Best: ${Math.floor(cardBest||0)}`,x+14,y+122,'rgba(220,240,255,0.9)','left');
  const skinName=playerCardPopup.isSelf?String((CHAR_CATALOG.find(c=>c.id===selectedChar)||CHAR_CATALOG[0]).name):String(cardUser.selectedSkin||cardUser.skin||'Unknown');
  const auraName=playerCardPopup.isSelf?String((AURA_CATALOG.find(a=>a.id===selectedAura)||AURA_CATALOG[0]).name):String(cardUser.selectedAura||cardUser.aura||'Unknown');
  const themeName=playerCardPopup.isSelf?String((THEME_CATALOG.find(t2=>t2.id===selectedTheme)||THEME_CATALOG[0]).name):String(cardUser.selectedTheme||cardUser.theme||'Unknown');
  txt(`Skin: ${skinName}`,x+14,y+140,'rgba(220,240,255,0.85)','left');
  txt(`Aura: ${auraName}`,x+14,y+158,'rgba(220,240,255,0.85)','left');
  txt(`Theme: ${themeName}`,x+14,y+176,'rgba(220,240,255,0.85)','left');
  txt(`Bio: ${((playerCardPopup.isSelf?profileBio:cardUser.bio)||'No bio').slice(0,60)}`,x+14,y+196,'rgba(190,220,235,0.8)','left');
  const statW=88, statH=20, statGap=8, statY=y+h-28;
  const statX=x+12;
  const lockFriends=publicProfilePrefs.friends>=1;
  const lockFollowers=publicProfilePrefs.followers>=1;
  const lockFollowing=publicProfilePrefs.following>=1;
  const fc=playerCardPopup.isSelf?socialCounters.friends:Number(cardUser.friendCount||0);
  const foc=playerCardPopup.isSelf?socialCounters.followers:Number(cardUser.followerCount||0);
  const fgc=playerCardPopup.isSelf?socialCounters.following:Number(cardUser.followingCount||0);
  drawNeonBtn(statX,statY,statW,statH,lockFriends?'#45535f':CFG.CY,`${Math.max(0,fc)} FRIENDS`,7,1,0);
  drawNeonBtn(statX+statW+statGap,statY,statW,statH,lockFollowers?'#45535f':CFG.GR,`${Math.max(0,foc)} FOLLOWERS`,7,1,0);
  drawNeonBtn(statX+(statW+statGap)*2,statY,statW,statH,lockFollowing?'#45535f':CFG.YL,`${Math.max(0,fgc)} FOLLOWING`,7,1,0);
  ctx.restore();
}
function runConfirmAction() {
  const a=confirmDialog.action;
  confirmDialog.active=false;
  if (a==='PAUSE_MAINMENU') { goMenu(); return; }
  if (a==='PAUSE_GIVEUP') { finalizeGameOver(); return; }
  if (a==='CONTINUE_GIVEUP') { finalizeGameOver(); return; }
  if (a==='IMPOSSIBLE_START') { startImpossibleIntro(); return; }
  if (a==='IMPOSSIBLE_RETRY') { startImpossibleIntro(); return; }
  if (a==='SIGNOUT') { if (typeof doSignOut==='function') doSignOut(); return; }
  if (a==='REMOVE_PFP') { if (typeof clearProfileAvatar==='function') clearProfileAvatar(); return; }
  if (a==='DELETE_ACCOUNT') { if (typeof beginDeleteAccountFlow==='function') beginDeleteAccountFlow(); return; }
  if (a==='UNFRIEND_VIEWED') { if (typeof removeFriendWithViewed==='function') removeFriendWithViewed(); return; }
  if (a==='RESET_EVERYTHING') {
    localStorage.clear();
    location.reload();
  }
}
function drawConfirmDialog() {
  if (!confirmDialog.active) return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.72)'; ctx.fillRect(0,0,LW,LH);
  const w=300,h=170,x=(LW-w)/2,y=(LH-h)/2;
  ctx.fillStyle='#000'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle=CFG.CY; ctx.lineWidth=2; glow(CFG.CY,14); ctx.strokeRect(x,y,w,h);
  setFont(16,'900'); glow(CFG.CY,12); txt(confirmDialog.title,LW/2,y+30,CFG.CY);
  setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.72;
  txt(confirmDialog.msg,LW/2,y+56,'rgba(0,245,255,0.8)');
  ctx.globalAlpha=1;
  BTNS.dialogYes={x:x+22,y:y+h-48,w:120,h:30};
  BTNS.dialogNo={x:x+w-142,y:y+h-48,w:120,h:30};
  drawNeonBtn(BTNS.dialogYes.x,BTNS.dialogYes.y,BTNS.dialogYes.w,BTNS.dialogYes.h,CFG.CY,'YES',11,1,Math.sin(menuT*3));
  drawNeonBtn(BTNS.dialogNo.x,BTNS.dialogNo.y,BTNS.dialogNo.w,BTNS.dialogNo.h,CFG.PK,'NO',11,1,Math.sin(menuT*2));
  ctx.restore();
}
function drawActionPopup(t){
  if (!actionPopup.active) return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.72)'; ctx.fillRect(0,0,LW,LH);
  const w=304,h=176,x=(LW-w)/2,y=(LH-h)/2;
  const col=actionPopup.ok?CFG.GR:CFG.PK;
  ctx.fillStyle='#000'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle=col; ctx.lineWidth=2; glow(col,14); ctx.strokeRect(x,y,w,h);
  setFont(15,'900'); glow(col,10); txt(actionPopup.title.slice(0,34),LW/2,y+30,col);
  setFont(9,'400',"'Share Tech Mono',monospace"); noGlow();
  const line1=actionPopup.msg.slice(0,68);
  const line2=actionPopup.msg.length>68?actionPopup.msg.slice(68,136):'';
  txt(line1,LW/2,y+62,'rgba(225,240,255,0.88)');
  if (line2) txt(line2,LW/2,y+80,'rgba(225,240,255,0.78)');
  if (actionPopup.loading) {
    drawLoadingDots(LW/2-14,y+104,t,col);
    drawLoadingSquares(LW/2,y+116,t,col);
  }
  BTNS.actionPopupBtn=actionPopup.loading?null:{x:(LW-160)/2,y:y+h-44,w:160,h:30};
  if (!actionPopup.loading) drawNeonBtn(BTNS.actionPopupBtn.x,BTNS.actionPopupBtn.y,160,30,col,actionPopup.ok?'CONTINUE':'CLOSE',11,1,Math.sin(t*2));
  ctx.restore();
}

function handleTap(e) {
  const p = getCanvasXY(e);

  if (playerCardPopup.active) {
    if (hitBtn(p,BTNS.playerCardClose)) { SFX.click(); playerCardPopup.active=false; playerCardFriendMenu.open=false; return; }
    if (playerCardPopup.isSelf && hitBtn(p,BTNS.playerCardEdit)) { SFX.click(); playerCardPopup.active=false; doTransition('PROFILE'); return; }
    if (playerCardPopup.isSelf && hitBtn(p,BTNS.playerCardFav)) { SFX.click(); playerCardPopup.favorite=!playerCardPopup.favorite; return; }
    if (playerCardPopup.isSelf && hitBtn(p,BTNS.playerCardFind)) { SFX.click(); playerCardPopup.active=false; openInputDialog({title:'FIND USER',label:'Username',value:'',maxLen:32,saveLabel:'FIND',cancelLabel:'CANCEL',onSubmit:async v=>{ await openMiniProfileByUsername(v||''); }}); return; }
    if (!playerCardPopup.isSelf && hitBtn(p,BTNS.playerCardFav)) { SFX.click(); toggleFavoriteViewed(); return; }
    if (!playerCardPopup.isSelf && hitBtn(p,BTNS.playerCardFollow)) { SFX.click(); toggleFollowViewed(); return; }
    if (!playerCardPopup.isSelf && BTNS.playerCardMenuUnfriend && hitBtn(p,BTNS.playerCardMenuUnfriend)) { SFX.click(); playerCardFriendMenu.open=false; openConfirm('UNFRIEND_VIEWED','REMOVE FRIEND?','This will remove this player from your friends list.'); return; }
    if (!playerCardPopup.isSelf && hitBtn(p,BTNS.playerCardAdd)) { SFX.click(); handlePlayerCardPrimaryAction(); return; }
    if (!playerCardPopup.isSelf && playerCardFriendMenu.open) { playerCardFriendMenu.open=false; return; }
    return;
  }

  if (guestProfilePrompt.active) {
    if (hitBtn(p,BTNS.guestPromptSignIn)) { SFX.click(); guestProfilePrompt.active=false; doTransition('SIGNIN'); return; }
    if (hitBtn(p,BTNS.guestPromptContinue)) { SFX.click(); guestProfilePrompt.active=false; doTransition('MENU'); return; }
    return;
  }

  if (usernameChangeFlow.active) {
    if (usernameChangeFlow.phase==='error') {
      if (hitBtn(p,BTNS.usernameTryAgain)) { SFX.click(); usernameChangeFlow.active=false; openInputDialog({title:'CHANGE USERNAME',label:'New Username',value:usernameChangeFlow.candidate||auth.name||'',maxLen:32,onSubmit:async v=>{ await requestUsernameChange(v||''); }}); return; }
      if (hitBtn(p,BTNS.usernameExit)) { SFX.click(); usernameChangeFlow.active=false; return; }
      return;
    }
    if (usernameChangeFlow.phase==='success') {
      if (hitBtn(p,BTNS.usernameContinue)) { SFX.click(); usernameChangeFlow.active=false; return; }
      return;
    }
    return;
  }

  if (actionPopup.active) {
    if (!actionPopup.loading && hitBtn(p,BTNS.actionPopupBtn)) {
      SFX.click();
      const cb=actionPopup.onContinue;
      actionPopup.active=false;
      actionPopup.onContinue=null;
      if (typeof cb==='function') cb();
      return;
    }
    return;
  }

  if (confirmDialog.active) {
    if (hitBtn(p,BTNS.dialogYes)) { SFX.click(); runConfirmAction(); return; }
    if (hitBtn(p,BTNS.dialogNo))  { SFX.click(); confirmDialog.active=false; return; }
    return;
  }
  if (inputDialog.active) {
    if (hitBtn(p,BTNS.inputSave)) { SFX.click(); closeInputDialog(true); return; }
    if (hitBtn(p,BTNS.inputCancel)) { SFX.click(); closeInputDialog(false); return; }
    return;
  }

  if (showOptimizeConfirm) {
    if (hitBtn(p, BTNS.confirmYes)) { SFX.click(); applyOptimize(); showOptimizeConfirm=false; return; }
    if (hitBtn(p, BTNS.confirmNo))  { SFX.click(); showOptimizeConfirm=false; return; }
    return;
  }

  if (gs === 'PLAY') {
    if (hitBtn(p, BTNS.pause)) { SFX.click(); togglePause(); return; }
    if (hitBtn(p, BTNS.hudOptions)) { SFX.click(); optionsReturnState='PLAY'; doTransition('OPTIONS'); return; }
    return;
  }
  if (gs === 'LOADING') return;
  if (gs === 'MENU') {
    if (noAdsPopup) {
      if (hitBtn(p,BTNS.noAdsBuy)) { SFX.click(); addNotif('Purchase flow coming soon.',CFG.YL); noAdsPopup=false; return; }
      if (hitBtn(p,BTNS.noAdsContinue)) { SFX.click(); noAdsPopup=false; return; }
      return;
    }
    if (hitBtn(p,BTNS.noAds)) { SFX.click(); noAdsPopup=true; return; }
    if (hitBtn(p, BTNS.start))    { SFX.click(); doTransition('MODESELECT'); return; }
    if (hitBtn(p, BTNS.about))    { SFX.click(); doTransition('ABOUT');      return; }
    if (hitBtn(p, BTNS.controls)) { SFX.click(); doTransition('CONTROLS');   return; }
    if (hitBtn(p, BTNS.settings)) { SFX.click(); doTransition('SETTINGS');   return; }
    if (hitBtn(p, BTNS.quests))   { SFX.click(); doTransition('QUESTS');     return; }
    if (hitBtn(p, BTNS.leaderboard)) { SFX.click(); leaderboardReturnState='MENU'; doTransition('LEADERBOARD'); triggerLeaderboardFetch(); return; }
    if (hitBtn(p, BTNS.upgrades)) { SFX.click(); doTransition('UPGRADES'); return; }
    if (hitBtn(p, BTNS.charShop)) { SFX.click(); doTransition('CHARSHOP'); charShopPage=0; return; }
    if (hitBtn(p, BTNS.authAction)) { SFX.click(); if (isSignedIn) { playerCardPopup.active=true; playerCardPopup.isSelf=true; playerCardPopup.fromMenu=true; playerCardPopup.viewed=null; } else guestProfilePrompt.active=true; authFlowState='idle'; authFlowTimer=0; authFlowError=''; return; }
    if (hitBtn(p, BTNS.menuProfileBox)) { SFX.click(); if (isSignedIn) { playerCardPopup.active=true; playerCardPopup.isSelf=true; playerCardPopup.fromMenu=true; playerCardPopup.viewed=null; } else guestProfilePrompt.active=true; return; }
    return;
  }
  if (gs === 'MODESELECT') {
    if (hitBtn(p, BTNS.modeEndless))   { SFX.click(); gameMode='ENDLESS';   doTransition('SHOP'); return; }
    if (hitBtn(p, BTNS.modeAdventure)) { SFX.click(); gameMode='ADVENTURE'; doTransition('SHOP'); return; }
    if (hitBtn(p, BTNS.modeImpossible)) { SFX.click(); openConfirm('IMPOSSIBLE_START','IMPOSSIBLE MODE WARNING','One life only. No starter powerups. Are you sure?'); return; }
    if (hitBtn(p, BTNS.modeLtm)) {
      if (!navigator.onLine) { addNotif('LTM REQUIRES INTERNET',CFG.PK); return; }
      SFX.click();
      gameMode='LTM';
      if (isAdminUser) doTransition('ADMIN_LTM');
      else doTransition('SHOP');
      return;
    }
    if (hitBtn(p, BTNS.back)) { SFX.click(); doTransition('MENU'); return; }
    return;
  }
  if (gs === 'CHARSHOP') {
    handleCharShopTap(p); return;
  }
  if (gs === 'SHOP') {
    handleShopTap(p); return;
  }
  if (gs === 'SETTINGS') {
    if (hitBtn(p, BTNS.resetBtn)) { SFX.click(); openConfirm('RESET_EVERYTHING','RESET EVERYTHING?','This will erase all progress and purchases.'); return; }
    if (hitBtn(p, BTNS.back)) { SFX.click(); doTransition('MENU'); return; }
    const pSet={x:p.x,y:p.y-settingsScroll};
    if (hitBtn(pSet, BTNS.optimizeBtn)) { SFX.click(); showOptimizeConfirm=true; return; }
    handleSettingsTap(p); return;
  }
  if (gs === 'QUESTS') {
    if (hitBtn(p, BTNS.questsBack)) { SFX.click(); doTransition('MENU'); return; }
    if (hitBtn(p, BTNS.questsFilter)) { SFX.click(); questFilterOpen=!questFilterOpen; return; }
    const fOpts=[BTNS.questsFilterOpt0,BTNS.questsFilterOpt1,BTNS.questsFilterOpt2,BTNS.questsFilterOpt3];
    for (let i=0;i<fOpts.length;i++) {
      if (hitBtn(p, fOpts[i])) { SFX.click(); questFilter=i; questFilterOpen=false; questScroll=0; return; }
    }
    return;
  }
  if (gs === 'LEADERBOARD') {
    if (hitBtn(p,BTNS.leaderboardTabGlobal)) { SFX.click(); leaderboardCategory='GLOBAL'; triggerLeaderboardFetch(true); return; }
    if (hitBtn(p,BTNS.leaderboardTabEndless)) { SFX.click(); leaderboardCategory='ENDLESS'; triggerLeaderboardFetch(true); return; }
    if (hitBtn(p,BTNS.leaderboardTabAdventure)) { SFX.click(); leaderboardCategory='ADVENTURE'; triggerLeaderboardFetch(true); return; }
    if (hitBtn(p,BTNS.leaderboardTabImpossible)) { SFX.click(); leaderboardCategory='IMPOSSIBLE'; triggerLeaderboardFetch(true); return; }
    if (hitBtn(p,BTNS.leaderboardTabLtm)) { SFX.click(); leaderboardCategory='LTM'; triggerLeaderboardFetch(true); return; }
    if (hitBtn(p, BTNS.leaderboardBack)) {
      SFX.click();
      if (leaderboardReturnState==='PAUSE') doTransition('PAUSE');
      else if (leaderboardReturnState==='OVER') doTransition('OVER');
      else doTransition('MENU');
      return;
    }
    return;
  }
  if (gs === 'ABOUT') {
    if (hitBtn(p, BTNS.back)) { SFX.click(); doTransition('MENU'); return; }
    return;
  }
  if (gs === 'CONTROLS') {
    if (hitBtn(p, BTNS.controlsBack)) { SFX.click(); doTransition('MENU'); return; }
    return;
  }
  if (gs === 'UPGRADES') {
    handleUpgradesTap(p);
    return;
  }
  if (gs === 'OPTIONS') {
    handleOptionsTap(p);
    return;
  }
  if (gs === 'SIGNIN') {
    handleSignInTap(p);
    return;
  }
  if (gs === 'SIGNUP') {
    handleSignUpTap(p);
    return;
  }
  if (gs === 'PROFILE') {
    handleProfileTap(p);
    return;
  }
  if (gs === 'PUBLIC_PROFILE') {
    if (hitBtn(p,BTNS.publicProfileBack)) { SFX.click(); doTransition('PROFILE'); return; }
    if (hitBtn(p,BTNS.publicProfileRequests)) { SFX.click(); socialView.mode='received'; socialView.scroll=0; doTransition('FRIEND_REQUESTS'); fetchSocialData(); return; }
    if (hitBtn(p,BTNS.publicProfileFriends)) { SFX.click(); socialView.mode='friends'; socialView.scroll=0; doTransition('FRIENDS_LIST'); fetchSocialData(); return; }
    const rows=['publicBioBtn','publicFriendsBtn','publicFollowersBtn','publicFollowingBtn'];
    for (const k of rows) if (hitBtn(p,BTNS[k])) { SFX.click();
      if (k==='publicBioBtn') publicProfilePrefs.bio=(publicProfilePrefs.bio+1)%3;
      if (k==='publicFriendsBtn') publicProfilePrefs.friends=(publicProfilePrefs.friends+1)%3;
      if (k==='publicFollowersBtn') publicProfilePrefs.followers=(publicProfilePrefs.followers+1)%3;
      if (k==='publicFollowingBtn') publicProfilePrefs.following=(publicProfilePrefs.following+1)%3;
      savePublicProfilePrefs();
      return; }
    return;
  }
  if (gs === 'FRIEND_REQUESTS') {
    if (hitBtn(p,BTNS.publicProfileBack)) { SFX.click(); doTransition('PUBLIC_PROFILE'); return; }
    if (hitBtn(p,BTNS.socialTabFriends)) { SFX.click(); socialView.mode='received'; socialView.scroll=0; return; }
    if (hitBtn(p,BTNS.socialTabFollowers)) { SFX.click(); socialView.mode='sent'; socialView.scroll=0; return; }
    const aList=Array.isArray(BTNS.socialActionAList)?BTNS.socialActionAList:[];
    const bList=Array.isArray(BTNS.socialActionBList)?BTNS.socialActionBList:[];
    for (let i=0;i<aList.length;i++) if (aList[i]&&hitBtn(p,aList[i])) { SFX.click(); handleSocialPrimaryAction(i); return; }
    for (let i=0;i<bList.length;i++) if (bList[i]&&hitBtn(p,bList[i])) { SFX.click(); handleSocialSecondaryAction(i); return; }
    return;
  }
  if (gs === 'FRIENDS_LIST') {
    if (hitBtn(p,BTNS.publicProfileBack)) { SFX.click(); doTransition('PUBLIC_PROFILE'); return; }
    if (hitBtn(p,BTNS.socialTabFriends)) { SFX.click(); socialView.mode='friends'; socialView.scroll=0; return; }
    if (hitBtn(p,BTNS.socialTabFollowers)) { SFX.click(); socialView.mode='followers'; socialView.scroll=0; return; }
    if (hitBtn(p,BTNS.socialTabFollowing)) { SFX.click(); socialView.mode='following'; socialView.scroll=0; return; }
    const rowBtns=Array.isArray(BTNS.socialRowOpenList)?BTNS.socialRowOpenList:[];
    for (let i=0;i<rowBtns.length;i++) if (rowBtns[i]&&hitBtn(p,rowBtns[i])) {
      const list=socialView.mode==='followers'?socialData.followers:(socialView.mode==='following'?socialData.following:socialData.friends);
      const item=list[rowBtns[i].idx]||null;
      if (item) { SFX.click(); playerCardPopup.active=true; playerCardPopup.isSelf=!!(isSignedIn&&auth&&auth.uid===item.uid); playerCardPopup.fromMenu=false; playerCardPopup.viewed=item; playerCardFriendMenu.open=false; hydrateViewedSocialCounts(); }
      return;
    }
    return;
  }
  if (gs === 'ADMIN_AUTH') {
    handleAdminAuthTap(p);
    return;
  }
  if (gs === 'ADMIN_MENU') {
    handleAdminMenuTap(p);
    return;
  }
  if (gs === 'ADMIN_LTM') {
    if (hitBtn(p,BTNS.adminLtmBack)) { SFX.click(); doTransition('MODESELECT'); return; }
    const pAdmin={x:p.x,y:p.y-adminLtmScroll};
    const liveBtn=adminLtmTestButtons[-1];
    if (liveBtn && hitBtn(pAdmin,liveBtn)) {
      SFX.click();
      ltmForcedIndex=-1;
      gameMode='LTM';
      doTransition('SHOP');
      return;
    }
    for (let i=0;i<adminLtmTestButtons.length;i++) {
      const b=adminLtmTestButtons[i];
      if (hitBtn(pAdmin,b)) {
        SFX.click();
        ltmForcedIndex=i;
        ltmSelectedIndex=i;
        ltmRotationIndex=i;
        setGlobalLtmConfig(i);
        gameMode='LTM';
        doTransition('SHOP');
        return;
      }
    }
    return;
  }
  if (gs === 'CONTINUE') {
    if (hitBtn(p, BTNS.continueBuy)) { SFX.click(); tryContinueRun(); return; }
    if (hitBtn(p, BTNS.continueGiveUp)) { SFX.click(); openConfirm('CONTINUE_GIVEUP','GIVE UP RUN?','You will lose this run progress.'); return; }
    return;
  }
  if (gs === 'OVER') {
    if (hitBtn(p,BTNS.overLeaderboard)) { SFX.click(); leaderboardReturnState='OVER'; leaderboardCategory=(gameMode==='ADVENTURE'?'ADVENTURE':(gameMode==='IMPOSSIBLE'?'IMPOSSIBLE':(gameMode==='LTM'?'LTM':'ENDLESS'))); doTransition('LEADERBOARD'); triggerLeaderboardFetch(true); return; }
    if (hitBtn(p, BTNS.retry)) {
      SFX.click();
      if (gameMode==='IMPOSSIBLE') { openConfirm('IMPOSSIBLE_RETRY','RETRY IMPOSSIBLE?','Restart with intro screen and one life only.'); return; }
      doTransition('SHOP');
      return;
    }
    if (hitBtn(p, BTNS.home))  { SFX.click(); doTransition('MENU'); goMenu(); return; }
    return;
  }
  if (gs === 'PAUSE') {
    if (hitBtn(p, BTNS.resume))        { SFX.click(); togglePause(); return; }
    if (hitBtn(p, BTNS.menuFromPause)) { SFX.click(); openConfirm('PAUSE_GIVEUP','GIVE UP RUN?','You will end this run and go to WIPEOUT.'); return; }
    if (hitBtn(p, BTNS.leaderboardPause)) { SFX.click(); leaderboardReturnState='PAUSE'; doTransition('LEADERBOARD'); triggerLeaderboardFetch(); return; }
    if (hitBtn(p, BTNS.pauseOptions)) { SFX.click(); optionsReturnState='PAUSE'; doTransition('OPTIONS'); return; }
    togglePause(); return;
  }
}

// ── Touch: swipe left/right for movement ─────────────────────────
canvas.addEventListener('touchstart', e => {
  markPresenceActivity('touchstart');
  e.preventDefault();
  const p=getCanvasXY(e);
  if (gs==='PROFILE' && BTNS.profileAvatar) {
    const dx=p.x-BTNS.profileAvatar.cx, dy=p.y-BTNS.profileAvatar.cy;
    if ((dx*dx+dy*dy) <= (BTNS.profileAvatar.r*BTNS.profileAvatar.r)) { profileAvatarPressing=true; profileAvatarPressStart=Date.now(); profileAvatarHoldFX=false; }
    if (profileUploadState.active && profileUploadState.mode==='preview') {
      const frame=220, fx=(LW-frame)/2, fy=((LH-410)/2)+44;
      if (p.x>=fx && p.x<=fx+frame && p.y>=fy && p.y<=fy+frame) { profileUploadState.drag=true; profileUploadState.lastX=p.x; profileUploadState.lastY=p.y; }
    }
  }
  if (gs==='PLAY' && OPTION_PREFS.showTouchJoycons && isTouchDevice) {
    if (hitBtn(p,BTNS.touchJoyL)) { joyL=true; joyR=false; usingTouchJoy=true; return; }
    if (hitBtn(p,BTNS.touchJoyR)) { joyR=true; joyL=false; usingTouchJoy=true; return; }
  }
  const t = e.touches[0];
  touchActive = true; touchMoved = false;
  touchStartX = t.clientX; touchCurrentX = t.clientX;
  questTouchY = t.clientY;
  profileTouchY = t.clientY;
  leaderboardTouchY = t.clientY;
  adminLtmTouchY = t.clientY;
  shopTouchY = t.clientY;
  touchSwipe = 0; touchSwipeTarget = 0;
}, { passive:false });

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (usingTouchJoy) return;
  if (!touchActive) return;

  if (gs==='QUESTS') {
    const t=e.touches[0];
    if (questTouchY!==null) {
      const dy=t.clientY-questTouchY;
      if (Math.abs(dy)>2) touchMoved=true;
      questScroll=clamp(questScroll+dy, minQuestScroll(), 0);
    }
    questTouchY=t.clientY;
    return;
  }
  if (gs==='LEADERBOARD') {
    const t=e.touches[0];
    if (leaderboardTouchY!==null) {
      const dy=t.clientY-leaderboardTouchY;
      if (Math.abs(dy)>2) touchMoved=true;
      leaderboardScroll=clamp(leaderboardScroll+dy, minLeaderboardScroll(), 0);
    }
    leaderboardTouchY=t.clientY;
    return;
  }
  if (gs==='PROFILE') {
    const t=e.touches[0];
    if (profileUploadState.active && profileUploadState.mode==='preview' && profileUploadState.drag) {
      const np=getCanvasXY(e);
      touchMoved=true;
      profileUploadState.offX += np.x-profileUploadState.lastX;
      profileUploadState.offY += np.y-profileUploadState.lastY;
      profileUploadState.lastX=np.x; profileUploadState.lastY=np.y;
      clampProfileUploadOffsets(profileUploadState,220);
      return;
    }
    if (profileTouchY!==null) {
      const dy=t.clientY-profileTouchY;
      if (Math.abs(dy)>2) touchMoved=true;
      if (Math.abs(dy)>8) profileAvatarPressing=false;
      profileScroll=clamp(profileScroll+dy, minProfileScroll(), 0);
    }
    profileTouchY=t.clientY;
    return;
  }
  if (gs==='SHOP') {
    const t=e.touches[0];
    if (shopTouchY!==null) {
      const dy=t.clientY-shopTouchY;
      if (Math.abs(dy)>2) touchMoved=true;
      shopScroll=clamp(shopScroll+dy, minShopScroll(), 0);
    }
    shopTouchY=t.clientY;
    return;
  }
  if (gs==='ADMIN_MENU') {
    const t=e.touches[0];
    if (profileTouchY!==null) {
      const dy=t.clientY-profileTouchY;
      if (Math.abs(dy)>2) touchMoved=true;
      adminScroll=clamp(adminScroll+dy, minAdminScroll(), 0);
    }
    profileTouchY=t.clientY;
    return;
  }
  if (gs==='ADMIN_LTM') {
    const t=e.touches[0];
    if (adminLtmTouchY!==null) {
      const dy=t.clientY-adminLtmTouchY;
      if (Math.abs(dy)>2) touchMoved=true;
      adminLtmScroll=clamp(adminLtmScroll+dy, minAdminLtmScroll(), 0);
    }
    adminLtmTouchY=t.clientY;
    return;
  }

  touchCurrentX = e.touches[0].clientX;
  const delta = touchCurrentX - touchStartX;
  if (Math.abs(delta) > 8) touchMoved = true;
  // Smooth swipe target + easing
  touchSwipeTarget = clamp(delta / 78, -1, 1);
  touchSwipe = lerp(touchSwipe,touchSwipeTarget,0.25);
}, { passive:false });

canvas.addEventListener('touchend', e => {
  e.preventDefault();
  _lastTouchEnd = Date.now();
  if (!touchMoved) {
    handleTap(e);
  }
  touchActive = false; touchSwipe = 0; touchSwipeTarget = 0; touchMoved = false; questTouchY = null; profileTouchY=null; leaderboardTouchY=null; adminLtmTouchY=null; shopTouchY=null; settingsTouchY=null; optionsTouchY=null; socialTouchY=null; joyL=false; joyR=false; usingTouchJoy=false; profileAvatarPressing=false; profileAvatarHoldFX=false; stopProfileCropInteraction();
}, { passive:false });

canvas.addEventListener('touchcancel', () => {
  touchActive = false; touchSwipe = 0; touchSwipeTarget = 0; touchMoved = false; questTouchY = null; profileTouchY=null; leaderboardTouchY=null; adminLtmTouchY=null; shopTouchY=null; settingsTouchY=null; optionsTouchY=null; socialTouchY=null; joyL=false; joyR=false; usingTouchJoy=false; profileAvatarPressing=false; profileAvatarHoldFX=false; stopProfileCropInteraction();
});

// Mouse (desktop)
canvas.addEventListener('mousedown', e => {
  markPresenceActivity('mousedown');
  if (gs==='PROFILE') {
    const p=getCanvasXY(e);
    if (BTNS.profileAvatar) {
      const dx=p.x-BTNS.profileAvatar.cx, dy=p.y-BTNS.profileAvatar.cy;
      if ((dx*dx+dy*dy) <= (BTNS.profileAvatar.r*BTNS.profileAvatar.r)) { profileAvatarPressing=true; profileAvatarPressStart=Date.now(); profileAvatarHoldFX=false; }
    }
    if (profileUploadState.active && profileUploadState.mode==='preview') {
      const frame=220, fx=(LW-frame)/2, fy=((LH-410)/2)+44;
      if (p.x>=fx && p.x<=fx+frame && p.y>=fy && p.y<=fy+frame) { profileUploadState.drag=true; profileUploadState.lastX=p.x; profileUploadState.lastY=p.y; }
    }
  }
  if (gs==='PLAY' || gs==='PAUSE') {
    touchActive = true; touchMoved = false;
    touchStartX = e.clientX; touchCurrentX = e.clientX; touchSwipe = 0;
  }
});
canvas.addEventListener('mousemove', e => {
  markPresenceActivity('mousemove');
  const mp=getCanvasXY(e);
  mouseCanvasPos.x=mp.x; mouseCanvasPos.y=mp.y;
  if (gs==='PROFILE' && profileUploadState.active && profileUploadState.mode==='preview' && profileUploadState.drag) {
    const p=mp;
    profileUploadState.offX += p.x-profileUploadState.lastX;
    profileUploadState.offY += p.y-profileUploadState.lastY;
    profileUploadState.lastX=p.x; profileUploadState.lastY=p.y;
    clampProfileUploadOffsets(profileUploadState,220);
    return;
  }
  if (!touchActive || gs !== 'PLAY') return;
  touchCurrentX = e.clientX;
  const delta = touchCurrentX - touchStartX;
  if (Math.abs(delta) > 8) touchMoved = true;
  touchSwipeTarget = clamp(delta / 92, -1, 1);
  touchSwipe = lerp(touchSwipe,touchSwipeTarget,0.22);
});
canvas.addEventListener('mouseup', () => { touchActive=false; touchSwipe=0; touchSwipeTarget=0; joyL=false; joyR=false; usingTouchJoy=false; profileAvatarPressing=false; profileAvatarHoldFX=false; stopProfileCropInteraction(); });
canvas.addEventListener('mouseleave', () => { touchActive=false; touchSwipe=0; touchSwipeTarget=0; joyL=false; joyR=false; usingTouchJoy=false; profileAvatarPressing=false; profileAvatarHoldFX=false; stopProfileCropInteraction(); });

document.addEventListener('click', e => {
  if (Date.now() - _lastTouchEnd < 450) return;
  handleTap(e);
});


document.addEventListener('wheel', e => {
  if (gs==='QUESTS') {
    e.preventDefault();
    questScroll=clamp(questScroll - e.deltaY*0.6, minQuestScroll(), 0);
    return;
  }
  if (gs==='PROFILE') {
    e.preventDefault();
    if (profileUploadState.active && profileUploadState.mode==='preview') {
      const st=profileUploadState;
      st.zoom=clamp(st.zoom - e.deltaY*0.0015,1,3);
      clampProfileUploadOffsets(st,220);
      return;
    }
    profileScroll=clamp(profileScroll - e.deltaY*0.6, minProfileScroll(), 0);
    return;
  }
  if (gs==='LEADERBOARD') {
    e.preventDefault();
    leaderboardScroll=clamp(leaderboardScroll - e.deltaY*0.8, minLeaderboardScroll(), 0);
    return;
  }
  if (gs==='SETTINGS') {
    e.preventDefault();
    settingsScroll=clamp(settingsScroll - e.deltaY*0.8, minSettingsScroll(), 0);
    return;
  }
  if (gs==='ADMIN_MENU') {
    e.preventDefault();
    adminScroll=clamp(adminScroll - e.deltaY*0.8, minAdminScroll(), 0);
    return;
  }
  if (gs==='OPTIONS') {
    e.preventDefault();
    optionsScroll=clamp(optionsScroll - e.deltaY*0.8, minOptionsScroll(), 0);
    return;
  }
  if (gs==='SHOP') {
    e.preventDefault();
    shopScroll=clamp(shopScroll - e.deltaY*0.8, minShopScroll(), 0);
    return;
  }
  if (gs==='ADMIN_LTM') {
    e.preventDefault();
    adminLtmScroll=clamp(adminLtmScroll - e.deltaY*0.8, minAdminLtmScroll(), 0);
    return;
  }
}, { passive:false });

// Keyboard
window.addEventListener('keydown', e => {
  markPresenceActivity('keydown');
  if (inputDialog.active) {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='a') { inputDialog.selectAll=true; e.preventDefault(); return; }
    if (e.key==='Escape') { closeInputDialog(false); e.preventDefault(); return; }
    if (e.key==='Enter' && !inputDialog.multiline) { closeInputDialog(true); e.preventDefault(); return; }
    if (e.key==='Enter' && inputDialog.multiline) {
      if (inputDialog.selectAll) { inputDialog.value=''; inputDialog.selectAll=false; }
      if (inputDialog.value.length<inputDialog.maxLen) inputDialog.value+='\n';
      e.preventDefault();
      return;
    }
    if (e.key==='Backspace') {
      if (inputDialog.selectAll) { inputDialog.value=''; inputDialog.selectAll=false; }
      else inputDialog.value=inputDialog.value.slice(0,-1);
      e.preventDefault();
      return;
    }
    if (e.key.length===1) {
      if (inputDialog.selectAll) { inputDialog.value=''; inputDialog.selectAll=false; }
      if (inputDialog.value.length<inputDialog.maxLen) inputDialog.value+=e.key;
      e.preventDefault();
      return;
    }
    return;
  }
  if (gs==='PROFILE' && profileUploadState.active) {
    if (profileUploadState.mode==='error') {
      if (e.key==='Enter' && BTNS.profileUploadErrOk) { SFX.click(); resetProfileUploadState(); e.preventDefault(); return; }
      if (e.key==='Escape') { SFX.click(); resetProfileUploadState(); e.preventDefault(); return; }
    } else {
      const st=profileUploadState;
      const step=e.shiftKey?18:8;
      if (e.key==='ArrowLeft') { st.offX-=step; clampProfileUploadOffsets(st,220); e.preventDefault(); return; }
      if (e.key==='ArrowRight') { st.offX+=step; clampProfileUploadOffsets(st,220); e.preventDefault(); return; }
      if (e.key==='ArrowUp') { st.offY-=step; clampProfileUploadOffsets(st,220); e.preventDefault(); return; }
      if (e.key==='ArrowDown') { st.offY+=step; clampProfileUploadOffsets(st,220); e.preventDefault(); return; }
      if (e.key==='+' || e.key==='=' ) { st.zoom=clamp(st.zoom+0.1,1,3); clampProfileUploadOffsets(st,220); e.preventDefault(); return; }
      if (e.key==='-' || e.key==='_' ) { st.zoom=clamp(st.zoom-0.1,1,3); clampProfileUploadOffsets(st,220); e.preventDefault(); return; }
      if (e.key.toLowerCase()==='r') { st.zoom=1; st.offX=0; st.offY=0; clampProfileUploadOffsets(st,220); e.preventDefault(); return; }
      if (e.key==='Enter') { SFX.click(); applyProfileCropAndSave(); e.preventDefault(); return; }
      if (e.key==='Escape') { SFX.click(); resetProfileUploadState(); e.preventDefault(); return; }
    }
  }

  const l = e.key==='ArrowLeft'  || e.key.toLowerCase()==='a';
  const r = e.key==='ArrowRight' || e.key.toLowerCase()==='d';
  if (l) K.left  = true;
  if (r) K.right = true;
  if ((e.key===' '||e.key==='Enter') && gs==='MENU')   { doTransition('MODESELECT'); }
  if ((e.key===' '||e.key==='Enter') && gs==='OVER')   { doTransition('SHOP'); shuffleShop(); }
  if (e.key==='Escape' && gs==='SHOP')      { doTransition('MODESELECT'); }
  if (e.key==='Escape' && gs==='CHARSHOP')  { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='MODESELECT'){ doTransition('MENU'); }
  if (e.key==='Escape' && gs==='QUESTS')    { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='ABOUT')     { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='CONTROLS')  { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='LEADERBOARD'){ doTransition(leaderboardReturnState==='PAUSE'?'PAUSE':'MENU'); }
  if (e.key==='Escape' && gs==='CONTINUE')  { openConfirm('CONTINUE_GIVEUP','GIVE UP RUN?','You will lose this run progress.'); }
  if (e.key==='Escape' && gs==='UPGRADES')  { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='SIGNIN')    { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='SIGNUP')    { doTransition('SIGNIN'); }
  if (e.key==='Escape' && gs==='PROFILE')   { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='PUBLIC_PROFILE') { doTransition('PROFILE'); }
  if (e.key==='Escape' && gs==='FRIEND_REQUESTS') { doTransition('PUBLIC_PROFILE'); }
  if (e.key==='Escape' && gs==='FRIENDS_LIST') { doTransition('PUBLIC_PROFILE'); }
  if (e.key==='Escape' && gs==='ADMIN_AUTH') { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='ADMIN_MENU') { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='ADMIN_LTM') { doTransition('MODESELECT'); }
  if (e.key.toLowerCase()==='m' && isAdminUser && (gs==='MENU' || gs==='PROFILE' || gs==='SETTINGS' || gs==='OPTIONS')) {
    adminAuthState='idle'; adminAuthMsg=''; adminAuthInput='';
    doTransition('ADMIN_AUTH');
    e.preventDefault();
    return;
  }
  if (e.key==='Escape' && gs==='OPTIONS')   { doTransition(optionsReturnState); }
  if (e.key==='Escape' && gs==='SETTINGS')  { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='IMPOSSIBLE_INTRO') { doTransition('MENU'); }
  if (e.key==='Escape' && gs==='PLAY')   togglePause();
  if (e.key==='Escape' && gs==='PAUSE')  togglePause();
  if (l||r||e.key===' '||e.key==='Enter') e.preventDefault();
});
window.addEventListener('keyup', e => {
  if (e.key==='ArrowLeft'  || e.key.toLowerCase()==='a') K.left  = false;
  if (e.key==='ArrowRight' || e.key.toLowerCase()==='d') K.right = false;
});

// Combined movement: keyboard OR touch swipe
const goL = () => K.left  || touchSwipe < -0.1 || joyL || GP.left;
const goR = () => K.right || touchSwipe >  0.1 || joyR || GP.right;
// Speed multiplier from touch swipe (0.1–1.0)
const touchSpeedMult = () => Math.max(Math.abs(touchSwipe), (K.left||K.right) ? 1 : 0);

function pollGamepad() {
  const pads=navigator.getGamepads?navigator.getGamepads():[];
  const gp=(pads&&pads[0])?pads[0]:null;
  GP.left=false; GP.right=false; GP.pauseEdge=false;
  if (!gp) { GP.lastPause=false; return; }
  const ax=(gp.axes&&gp.axes.length)?gp.axes[0]:0;
  const dL=gp.buttons&&gp.buttons[14]&&gp.buttons[14].pressed;
  const dR=gp.buttons&&gp.buttons[15]&&gp.buttons[15].pressed;
  GP.left=ax<-0.35||!!dL;
  GP.right=ax>0.35||!!dR;
  const pauseNow=(gp.buttons&&gp.buttons[9]&&gp.buttons[9].pressed)||(gp.buttons&&gp.buttons[7]&&gp.buttons[7].pressed);
  GP.pauseEdge=pauseNow&&!GP.lastPause;
  GP.lastPause=!!pauseNow;
}

window.addEventListener('gamepadconnected',()=>addNotif('CONTROLLER CONNECTED',CFG.GR));
window.addEventListener('gamepaddisconnected',()=>addNotif('CONTROLLER DISCONNECTED',CFG.PK));

document.addEventListener('visibilitychange', () => {
  if (document.hidden && gs==='PLAY') togglePause();
});
window.addEventListener('blur', () => {
  if (gs==='PLAY') togglePause();
  K.left=false; K.right=false; touchSwipe=0; joyL=false; joyR=false; usingTouchJoy=false;
});
</script>

<!-- ============================================================ -->
<!--  SCRIPT 4 · UTILITIES & DRAWING HELPERS                     -->
<!-- ============================================================ -->
<script id="s-utils">
const rnd   = (a,b) => a + Math.random()*(b-a);
const rndI  = (a,b) => Math.floor(rnd(a,b+1));
const clamp = (v,a,b) => Math.max(a,Math.min(b,v));
const lerp  = (a,b,t) => a+(b-a)*t;

function setFont(size, weight='700', fam="'Orbitron','Share Tech Mono',monospace") {
  ctx.font = `${weight} ${size}px ${fam}`;
}
function txt(str,x,y,col='#fff',align='center') {
  ctx.fillStyle=col; ctx.textAlign=align; ctx.fillText(str,x,y);
}
function glow(col,blur=15) { ctx.shadowColor=col; ctx.shadowBlur=blur; }
function noGlow() { ctx.shadowBlur=0; }
function circle(x,y,r,col,fill=true) {
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
  if (fill) { ctx.fillStyle=col; ctx.fill(); }
  else      { ctx.strokeStyle=col; ctx.stroke(); }
}
function rrect(x,y,w,h,r) {
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}
function hexToRgba(hex,a) {
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}
function clipRect(x,y,w,h) {
  ctx.beginPath();
  ctx.rect(x,y,w,h);
  ctx.clip();
}
function drawNeonBtn(x,y,w,h,col,label,fontSize=14,alpha=1,pulse=1) {
  ctx.save(); ctx.globalAlpha=alpha*(0.7+0.3*pulse);
  glow(col,18); ctx.strokeStyle=col; ctx.lineWidth=2;
  ctx.strokeRect(x,y,w,h);
  ctx.fillStyle=hexToRgba(col,0.10); ctx.fillRect(x,y,w,h);
  ctx.globalAlpha=alpha; setFont(fontSize,'900');
  glow(col,14); txt(label,x+w/2,y+h/2+fontSize*0.37,col);
  ctx.restore();
}

// Perimeter point helper for rainbow border
function perimPt(x,y,w,h,p) {
  const P=2*(w+h); p=((p%P)+P)%P;
  if (p<w) return {x:x+p,y:y};
  p-=w; if (p<h) return {x:x+w,y:y+p};
  p-=h; if (p<w) return {x:x+w-p,y:y+h};
  p-=w; return {x:x,y:y+h-p};
}
function drawRainbowBorder(x,y,w,h,t,lineW=2.5) {
  const steps=80, perim=2*(w+h);
  ctx.save(); ctx.lineWidth=lineW;
  for (let i=0;i<steps;i++) {
    const hue=((i/steps)*360+t*90)%360;
    const p1=perimPt(x,y,w,h,(i/steps)*perim);
    const p2=perimPt(x,y,w,h,((i+1)/steps)*perim);
    ctx.strokeStyle=`hsl(${hue},100%,55%)`;
    glow(`hsl(${hue},100%,55%)`,8);
    ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
  }
  ctx.restore();
}

function drawRoleBadgeSquare(cx,cy,size,col,t=0,withCheck=false){
  const ang=t*2.4;
  ctx.save();
  ctx.translate(cx,cy); ctx.rotate(ang);
  ctx.strokeStyle=col; ctx.lineWidth=2; glow(col,10);
  ctx.strokeRect(-size/2,-size/2,size,size);
  ctx.fillStyle=hexToRgba(col,0.12); ctx.fillRect(-size/2,-size/2,size,size);
  ctx.restore();
  if (withCheck) {
    ctx.save();
    setFont(Math.max(8,size-4),'900',"'Share Tech Mono',monospace");
    noGlow(); txt('✓',cx,cy+size*0.22,'#fff');
    ctx.restore();
  }
}

// ── Screen shake ──────────────────────────────────────────────────
let shakeX=0,shakeY=0,shakePow=0,shakeDur=0;
function addShake(pow,dur) {
  if (!SETTINGS.screenShake) return;
  shakePow=Math.max(shakePow,pow); shakeDur=Math.max(shakeDur,dur);
}
function updateShake(dt) {
  if (shakeDur>0) {
    shakeDur-=dt;
    shakeX=(Math.random()-.5)*shakePow*2; shakeY=(Math.random()-.5)*shakePow*2;
  } else { shakeX=shakeY=0; shakePow=0; }
}
function applyShake() { if (shakePow>0) ctx.translate(shakeX,shakeY); }

// ── Transition helpers ────────────────────────────────────────────
let transAlpha=1, transDir=1;
let transSlideY=0, transSliding=false, transSlideTarget=0, transSlideCallback=null;
let pendingGS=null;

function doTransition(nextState) {
  // quick fade-to-black then switch
  pendingGS=nextState;
  if (gameMode==='IMPOSSIBLE' && nextState!=='IMPOSSIBLE_INTRO' && nextState!=='PLAY') {
    impossibleStage=0;
  }
  transDir=0; transAlpha=0;
}

function drawTransition() {
  if (transAlpha<=0) return;
  ctx.save(); ctx.globalAlpha=transAlpha;
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  ctx.restore();
}

function drawTopOverlays(t){
  drawSocialToasts();
  drawGlobalFps();
  drawPlayerCardPopup(t);
  drawUsernameChangeOverlay(t);
  drawActionPopup(t);
  drawAuthOverlay(t);
  drawOptimizeConfirmPopup(t);
  drawConfirmDialog();
  drawInputDialog(t);
  drawGuestProfilePrompt(t);
}

function drawGlobalFps(){
  if (!(SETTINGS.showFPS && OPTION_PREFS.showFPS)) return;
  ctx.save();
  const fpsCol=fps>=55?'rgba(57,255,20,0.78)':fps>=30?'rgba(255,230,0,0.78)':'rgba(255,0,110,0.82)';
  setFont(8,'700',"'Share Tech Mono',monospace");
  noGlow();
  if (gs==='MENU') {
    txt(`FPS ${fps}`,LW-90,46,fpsCol,'left');
  } else {
    txt(`FPS ${fps}`,LW-12,14,fpsCol,'right');
  }
  ctx.restore();
}
</script>

<!-- ============================================================ -->
<!--  SCRIPT 4b · SFX ENGINE                                     -->
<!-- ============================================================ -->
<script id="s-sfx">
const SFX = (() => {
  let AC=null;
  function init() {
    if (!AC) AC=new (window.AudioContext||window.webkitAudioContext)();
    if (AC.state==='suspended') AC.resume();
  }
  function tone(freq,type,dur,vol,freqEnd,delay=0) {
    if (!SETTINGS.sfx) return; init();
    const osc=AC.createOscillator(), g=AC.createGain();
    osc.connect(g); g.connect(AC.destination);
    osc.type=type;
    const t0=AC.currentTime+delay;
    osc.frequency.setValueAtTime(freq,t0);
    if (freqEnd) osc.frequency.exponentialRampToValueAtTime(freqEnd,t0+dur);
    g.gain.setValueAtTime(vol,t0);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    osc.start(t0); osc.stop(t0+dur+0.01);
  }
  function noise(dur,vol,bandHz=400,delay=0) {
    if (!SETTINGS.sfx) return; init();
    const frames=Math.ceil(AC.sampleRate*dur);
    const buf=AC.createBuffer(1,frames,AC.sampleRate);
    const data=buf.getChannelData(0);
    for (let i=0;i<frames;i++) data[i]=Math.random()*2-1;
    const src=AC.createBufferSource(); src.buffer=buf;
    const filt=AC.createBiquadFilter();
    filt.type='bandpass'; filt.frequency.value=bandHz; filt.Q.value=1;
    const g=AC.createGain();
    src.connect(filt); filt.connect(g); g.connect(AC.destination);
    const t0=AC.currentTime+delay;
    g.gain.setValueAtTime(vol,t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    src.start(t0); src.stop(t0+dur+0.01);
  }
  return {
    gem(tier=0) {
      const freqs=[[880,1760],[1100,2200],[660,1980]];
      const [f1,f2]=freqs[tier]||freqs[0];
      tone(f1,'sine',0.05,0.14,f2); tone(f2,'sine',0.10,0.10,f2*1.5,0.04);
    },
    pwr() { tone(440,'sine',0.07,0.18); tone(660,'sine',0.10,0.16,880,0.06); tone(880,'sine',0.16,0.20,1320,0.12); },
    shieldBlock() { tone(1200,'square',0.04,0.22,600); tone(900,'sine',0.20,0.18,1800); noise(0.08,0.10,1000); },
    hit() { tone(260,'sawtooth',0.06,0.28,80); noise(0.15,0.22,300); },
    loseLife() { tone(300,'sawtooth',0.08,0.30,80); tone(180,'sawtooth',0.18,0.22,50,0.06); noise(0.25,0.18,200); },
    gameOver() { tone(330,'sawtooth',0.10,0.30,120); tone(220,'sawtooth',0.18,0.25,80,0.08); tone(110,'sawtooth',0.40,0.20,55,0.20); noise(0.50,0.15,150); },
    jetpack() { tone(90,'sawtooth',0.25,0.22,160); tone(55,'square',0.30,0.16,80); noise(0.30,0.14,120); noise(0.20,0.12,600,0.05); },
    pause() { tone(660,'sine',0.07,0.12,440); },
    resume() { tone(440,'sine',0.07,0.12,660); },
    start() { tone(440,'sine',0.06,0.14); tone(550,'sine',0.09,0.16,null,0.05); tone(660,'sine',0.12,0.18,null,0.10); tone(880,'sine',0.20,0.20,null,0.16); },
    magnet() { tone(200,'sine',0.08,0.18,800); tone(400,'sine',0.18,0.14,900,0.06); },
    slow() { tone(880,'sine',0.16,0.20,180); tone(440,'sine',0.25,0.14,100,0.08); },
    boost() { tone(660,'triangle',0.05,0.20,1320); tone(990,'sine',0.12,0.18,1980,0.04); noise(0.08,0.10,800); },
    stage() { tone(440,'sine',0.05,0.18); tone(660,'sine',0.08,0.20,880,0.04); tone(990,'sine',0.14,0.22,1320,0.09); tone(1320,'sine',0.25,0.25,1760,0.16); noise(0.12,0.12,600); },
    regen() { tone(500,'sine',0.06,0.16,800); tone(700,'sine',0.12,0.18,1000,0.05); tone(900,'sine',0.20,0.22,1200,0.10); },
    click() { tone(760,'square',0.03,0.10,520); },
    surprise() { tone(740,'sine',0.04,0.14,1040); tone(1040,'sine',0.05,0.16,1560,0.04); tone(1560,'triangle',0.12,0.12,1960,0.09); },
  };
})();
</script>

<!-- ============================================================ -->
<!--  SCRIPT 5 · PARTICLES & EFFECTS                             -->
<!-- ============================================================ -->
<script id="s-particles">
class Particle {
  constructor(x,y,vx,vy,col,life,size,gravity=180) {
    this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.col=col;
    this.life=this.maxLife=life; this.size=size; this.gravity=gravity;
  }
  update(dt) {
    this.x+=this.vx*dt; this.y+=this.vy*dt;
    this.vy+=this.gravity*dt; this.vx*=0.98;
    this.life-=dt; return this.life>0;
  }
  draw() {
    const a=clamp(this.life/this.maxLife,0,1);
    ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=this.col;
    glow(this.col,8); circle(this.x,this.y,this.size*a,this.col);
    ctx.restore();
  }
}

const particles=[], exhaustParts=[], fogParts=[];

// Background floating squares (menu/loading)
const bgSquares=[];
function initBgSquares() {
  bgSquares.length=0;
  for (let i=0;i<18;i++) {
    bgSquares.push({
      x:rnd(0,LW), y:rnd(0,LH),
      size:rnd(20,80), rot:rnd(0,Math.PI*2),
      vx:rnd(-8,8), vy:rnd(-12,-4),
      vrot:rnd(-0.5,0.5),
      alpha:rnd(0.03,0.09),
      col:[CFG.CY,CFG.PU,CFG.BL,CFG.PK][rndI(0,3)],
    });
  }
}
function updateBgSquares(dt) {
  bgSquares.forEach(s=>{
    const menuBoost=(gs==='MENU')?1.8:1;
    s.x+=s.vx*dt*menuBoost; s.y+=s.vy*dt; s.rot+=s.vrot*dt;
    if (s.y<-100) { s.y=LH+50; s.x=rnd(0,LW); }
    if (s.x<-100) s.x=LW+50;
    if (s.x>LW+100) s.x=-50;
  });
}
function drawBgSquares() {
  bgSquares.forEach(s=>{
    ctx.save(); ctx.globalAlpha=s.alpha;
    ctx.strokeStyle=s.col; ctx.lineWidth=1.5;
    glow(s.col,10);
    ctx.translate(s.x,s.y); ctx.rotate(s.rot);
    ctx.strokeRect(-s.size/2,-s.size/2,s.size,s.size);
    ctx.restore();
  });
}


function getSelectedThemeData(){
  const t=(typeof selectedTheme!=='undefined'?selectedTheme:'classic');
  const theme=(typeof THEME_CATALOG!=='undefined'?THEME_CATALOG.find(x=>x.id===t):null);
  return theme||{id:'classic',col:CFG.CY};
}
function drawAuraVisual(){
  if (typeof selectedAura==='undefined' || selectedAura==='none') return;
  const aura=(typeof AURA_CATALOG!=='undefined'?AURA_CATALOG.find(a=>a.id===selectedAura):null);
  const col=(aura&&aura.col)||CFG.CY;
  ctx.save();
  const r=CFG.PR+16+3*Math.sin(menuT*6);
  glow(col,16); ctx.strokeStyle=col; ctx.lineWidth=2; circle(player.x,player.y,r,col,false);
  ctx.globalAlpha=0.25; ctx.fillStyle=hexToRgba(col,0.18); circle(player.x,player.y,r-3,col);
  ctx.restore();
}
const rings=[];
function addRing(x,y,col,maxR=80,speed=220,thickness=3) {
  rings.push({x,y,col,r:0,maxR,speed,alpha:1,thickness});
}
function updateRings(dt) {
  for (let i=rings.length-1;i>=0;i--) {
    const r=rings[i]; r.r+=r.speed*dt; r.alpha=clamp(1-r.r/r.maxR,0,1);
    if (r.r>=r.maxR) rings.splice(i,1);
  }
}
function drawRings() {
  rings.forEach(r=>{
    ctx.save(); ctx.globalAlpha=r.alpha;
    glow(r.col,14); ctx.strokeStyle=r.col;
    ctx.lineWidth=r.thickness; circle(r.x,r.y,r.r,r.col,false);
    ctx.restore();
  });
}

function burst(x,y,col,n=22,spread=300) {
  const q=SETTINGS.gfxQuality===0?0.25:SETTINGS.gfxQuality===1?0.5:1;
  if (!SETTINGS.particles) return;
  const count=Math.ceil(n*q);
  for (let i=0;i<count;i++) {
    const ang=Math.PI*2*Math.random(),spd=60+Math.random()*spread;
    particles.push(new Particle(x,y,Math.cos(ang)*spd,Math.sin(ang)*spd-40,col,0.4+Math.random()*0.7,1.5+Math.random()*3));
  }
}
function spark(x,y,col) {
  if (!SETTINGS.particles||Math.random()>.35) return;
  if (SETTINGS.gfxQuality===0&&Math.random()>.4) return;
  particles.push(new Particle(x,y,(Math.random()-.5)*50,-30-Math.random()*90,col,0.1+Math.random()*0.18,1+Math.random()*1.6));
}
function ringBurst(x,y,col) {
  addRing(x,y,col,90,200,2.5); addRing(x,y,col,140,160,1.5);
  if (!SETTINGS.particles||SETTINGS.gfxQuality===0) return;
  for (let i=0;i<20;i++) {
    const ang=(i/20)*Math.PI*2,spd=90+Math.random()*140;
    particles.push(new Particle(x,y,Math.cos(ang)*spd,Math.sin(ang)*spd,col,0.4+Math.random()*0.35,1.5+Math.random()*2,0));
  }
}

function spawnExhaust(x,y) {
  if (!SETTINGS.particles) return;
  const n=SETTINGS.gfxQuality===0?1:3;
  for (let i=0;i<n;i++) {
    const ang=Math.PI/2+(Math.random()-.5)*0.7,spd=120+Math.random()*200;
    const col=Math.random()<0.5?'#ff6600':Math.random()<0.5?'#ffcc00':'#ffffff';
    exhaustParts.push(new Particle(x+(Math.random()-.5)*6,y+8,Math.cos(ang)*spd*0.3,Math.cos(ang)*spd,col,0.18+Math.random()*0.25,2+Math.random()*4,-40));
  }
}
function spawnFog(x,y) {
  if (!SETTINGS.particles||SETTINGS.gfxQuality===0) return;
  for (let i=0;i<2;i++) {
    const side=Math.random()<0.5?-1:1;
    fogParts.push({x:x+side*(30+Math.random()*80),y:y+(Math.random()-.5)*60,vx:side*(10+Math.random()*20),vy:(Math.random()-.5)*15,r:20+Math.random()*40,life:1.0,maxLife:1.0+Math.random()*0.8,col:Math.random()<0.5?'#00f5ff':'#8844ff'});
  }
}

function updateParticles(dt) {
  for (let i=particles.length-1;i>=0;i--) if (!particles[i].update(dt)) particles.splice(i,1);
  for (let i=exhaustParts.length-1;i>=0;i--) if (!exhaustParts[i].update(dt)) exhaustParts.splice(i,1);
  for (let i=fogParts.length-1;i>=0;i--) {
    const f=fogParts[i]; f.x+=f.vx*dt; f.y+=f.vy*dt; f.life-=dt;
    if (f.life<=0) fogParts.splice(i,1);
  }
}
function drawParticles() { particles.forEach(p=>p.draw()); }
function drawExhaust() {
  exhaustParts.forEach(p=>p.draw());
  fogParts.forEach(f=>{
    const a=clamp(f.life/f.maxLife,0,1)*0.18;
    ctx.save(); ctx.globalAlpha=a;
    const grad=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.r);
    grad.addColorStop(0,f.col); grad.addColorStop(1,'transparent');
    ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill();
    ctx.restore();
  });
}

const floatTexts=[];
function addFloat(x,y,str,col) { floatTexts.push({x,y,str,col,t:1.0,vy:-80}); }
function updateFloats(dt) {
  for (let i=floatTexts.length-1;i>=0;i--) {
    const f=floatTexts[i]; f.y+=f.vy*dt; f.t-=dt*1.6;
    if (f.t<=0) floatTexts.splice(i,1);
  }
}
function drawFloats() {
  floatTexts.forEach(f=>{
    ctx.save(); ctx.globalAlpha=clamp(f.t,0,1);
    setFont(13,'900'); glow(f.col,14); txt(f.str,f.x,f.y,f.col); ctx.restore();
  });
}

const notifs=[];
const socialToasts=[];
const socialToastSquares=[];
function addNotif(str,col) {
  notifs.push({str,col,t:1.8});
  if (notifs.length>3) notifs.shift();
}
function addSocialToast(str,col=CFG.CY){
  const msg=String(str||'').slice(0,72);
  socialToasts.push({str:msg,col,t:2.8,dur:2.8});
  while (socialToasts.length>3) socialToasts.shift();
  const cx=LW/2;
  for (let i=0;i<16;i++) {
    const ang=Math.random()*Math.PI*2;
    const sp=28+Math.random()*42;
    socialToastSquares.push({x:cx+rnd(-24,24),y:22+rnd(-8,8),vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp-12,t:0.7,size:rnd(2,4),col});
  }
}
function updateNotifs(dt) {
  for (let i=notifs.length-1;i>=0;i--) { notifs[i].t-=dt; if(notifs[i].t<=0) notifs.splice(i,1); }
  for (let i=socialToasts.length-1;i>=0;i--) { socialToasts[i].t-=dt; if (socialToasts[i].t<=0) socialToasts.splice(i,1); }
  for (let i=socialToastSquares.length-1;i>=0;i--) {
    const p=socialToastSquares[i];
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=35*dt; p.t-=dt;
    if (p.t<=0) socialToastSquares.splice(i,1);
  }
}
function drawNotifs() {
  notifs.forEach((n,i)=>{
    const a=clamp(n.t>0.4?1:n.t/0.4,0,1);
    const slideA=clamp((1.8-n.t)*4,0,1);
    const y=LH*0.18+i*26-(1-slideA)*12;
    ctx.save(); ctx.globalAlpha=a; setFont(13,'700');
    glow(n.col,16); txt(`◆ ${n.str} ◆`,LW/2,y,n.col); ctx.restore();
  });
}
function drawSocialToasts(){
  socialToastSquares.forEach(p=>{
    ctx.save();
    ctx.globalAlpha=clamp(p.t/0.7,0,1);
    ctx.fillStyle=p.col;
    glow(p.col,8);
    ctx.fillRect(p.x,p.y,p.size,p.size);
    ctx.restore();
  });
  socialToasts.forEach((n,i)=>{
    setFont(9,'700',"'Share Tech Mono',monospace");
    const inA=clamp((n.dur-n.t)/0.25,0,1);
    const outA=clamp(n.t/0.4,0,1);
    const a=Math.min(inA,outA);
    const y=16+i*28;
    const w=Math.min(336,Math.max(180,ctx.measureText(n.str).width+52));
    const x=(LW-w)/2;
    ctx.save();
    ctx.globalAlpha=a;
    ctx.fillStyle='rgba(0,0,0,0.86)';
    ctx.fillRect(x,y,w,22);
    ctx.strokeStyle=hexToRgba(n.col,0.85); ctx.lineWidth=1.5; glow(n.col,12); ctx.strokeRect(x,y,w,22);
    setFont(9,'700',"'Share Tech Mono',monospace");
    noGlow();
    txt(n.str,LW/2,y+15,'#dff8ff');
    ctx.restore();
  });
}

function clearAllFX() {
  particles.length=0; exhaustParts.length=0;
  fogParts.length=0; rings.length=0;
  floatTexts.length=0; notifs.length=0; socialToasts.length=0; socialToastSquares.length=0;
}
</script>

<!-- ============================================================ -->
<!--  SCRIPT 6 · TERRAIN                                         -->
<!-- ============================================================ -->
<script id="s-terrain">
class Terrain {
  constructor() { this.reset(); }
  reset() {
    this.segs=[]; this.scrollY=0; this.cx=LW/2;
    this.trackW=CFG.TRACK_W0; this.speed=CFG.SPD0; this.t=0;
    const needed=Math.ceil(LH/CFG.SEG_H)+50;
    for (let i=0;i<needed;i++) this._pushTop();
    const shift=LH+CFG.SEG_H;
    for (const s of this.segs) s.y+=shift;
  }
  _pushTop() {
    this.cx+=(Math.random()-.5)*2*CFG.CURVE;
    const half=this.trackW/2,mg=18;
    this.cx=clamp(this.cx,mg+half,LW-mg-half);
    const y=this.segs.length===0?-CFG.SEG_H:this.segs[0].y-CFG.SEG_H;
    this.segs.unshift({lx:this.cx-half,rx:this.cx+half,y});
  }
  update(dt) {
    this.t+=dt;
    // Adventure mode: speed capped by stage config
    const stage=currentStageConfig();
    const maxSpd = isStageMode() ? stage.spdMax : CFG.SPD_MAX;
    const shrink = isStageMode() ? stage.shrink : CFG.SHRINK;
    this.speed=Math.min(maxSpd, this.speed+CFG.SPD_ACC*dt);
    this.trackW=Math.max(CFG.TRACK_MIN, this.trackW-shrink*this.speed*dt);
    const dy=this.speed*dt;
    this.scrollY+=dy;
    for (const s of this.segs) s.y+=dy;
    while(this.segs.length&&this.segs[this.segs.length-1].y>LH+CFG.SEG_H+5) this.segs.pop();
    const needed=Math.ceil(LH/CFG.SEG_H)+50;
    while(this.segs.length<needed) this._pushTop();
  }
  getWalls(y) {
    for (let i=0;i<this.segs.length-1;i++) {
      const a=this.segs[i],b=this.segs[i+1];
      if (y>=a.y&&y<b.y) {
        const t=(y-a.y)/(b.y-a.y);
        return {left:lerp(a.lx,b.lx,t),right:lerp(a.rx,b.rx,t)};
      }
    }
    if (!this.segs.length) return {left:0,right:LW};
    if (y<this.segs[0].y) return {left:this.segs[0].lx,right:this.segs[0].rx};
    const last=this.segs[this.segs.length-1];
    return {left:last.lx,right:last.rx};
  }
  speedFrac() { return (this.speed-CFG.SPD0)/(CFG.SPD_MAX-CFG.SPD0); }
}
const terrain=new Terrain();
</script>

<!-- ============================================================ -->
<!--  SCRIPT 7 · PLAYER                                          -->
<!-- ============================================================ -->
<script id="s-player">
const PLAYER_BASE_Y=LH*0.38;
const SIDE_BORDER_PAD_BASE=6;
const IMMUNITY_COLLISION_COOLDOWN=3.0;

class Player {
  constructor() { this.reset(); }
  reset() {
    this.x=LW/2; this.y=PLAYER_BASE_Y;
    this.trail=[]; this.inv=false; this.invT=0;
    this.blink=true; this.blinkT=0; this.shield=false;
    this.jetpackActive=false; this.jetpackT=0; this.jetpackMax=5.0;
  }
  startInv() { this.inv=true; this.invT=CFG.INVMS; this.blinkT=0; this.blink=true; }

  activateJetpack(dur=5.0) {
    this.jetpackActive=true; this.jetpackT=dur; this.jetpackMax=dur;
    this.inv=true; this.invT=99999;
  }

  update(dt,terr) {
    // Jetpack Y movement
    if (this.jetpackActive) {
      this.jetpackT-=dt;
      if (this.jetpackT<=0) {
        this.jetpackActive=false; this.jetpackT=0;
        this.inv=false; this.invT=0;
        addNotif('JETPACK ENDED','#ff7700');
        collectNearbyDrops(this.x,this.y,120);
        activateImmunity(3.0);
        worldSpeedMult=1;
      } else {
        const progress=(this.jetpackMax-this.jetpackT)/this.jetpackMax;
        if (progress<0.67) {
          this.y=lerp(PLAYER_BASE_Y,LH*0.12,Math.min(1,(progress/0.67)*1.6));
        } else {
          this.y=lerp(LH*0.12,PLAYER_BASE_Y,Math.pow((progress-0.67)/0.33,2));
        }
        spawnExhaust(this.x,this.y);
        if (Math.random()<0.35) spawnFog(this.x,this.y);
      }
    } else {
      this.y=PLAYER_BASE_Y;
    }

    // Horizontal movement (keyboard or swipe)
    const smoothSwipe=clamp(touchSwipe,-1,1);
    const touchBoost=(1 + (smoothSwipe!==0 ? Math.abs(smoothSwipe)*0.55 : 0));
    const lMul=Math.max(
      K.left?SETTINGS.keyboardSensitivity:0,
      (smoothSwipe<-0.05||joyL)?SETTINGS.touchSensitivity*touchBoost*Math.max(0.2,Math.abs(smoothSwipe)):0,
      GP.left?SETTINGS.controllerSensitivity:0
    );
    const rMul=Math.max(
      K.right?SETTINGS.keyboardSensitivity:0,
      (smoothSwipe>0.05||joyR)?SETTINGS.touchSensitivity*touchBoost*Math.max(0.2,Math.abs(smoothSwipe)):0,
      GP.right?SETTINGS.controllerSensitivity:0
    );
    if (lMul>0) this.x-=CFG.PSPD*lMul*dt;
    if (rMul>0) this.x+=CFG.PSPD*rMul*dt;
    this.x=clamp(this.x,CFG.PR,LW-CFG.PR);

    const walls=terr.getWalls(this.y);
    const sidePad=clamp((walls.right-walls.left)*0.03,2,SIDE_BORDER_PAD_BASE);
    const minX=walls.left+CFG.PR+sidePad;
    const maxX=walls.right-CFG.PR-sidePad;
    if (this.x<minX||this.x>maxX) {
      this.x=clamp(this.x,minX,maxX);
      if (!immunityActive&&!this.jetpackActive) return 'SIDE_TOUCH';
      return 'SIDE_CONTACT_SAFE';
    }

    this.trail.unshift({x:this.x,y:this.y});
    if (this.trail.length>CFG.TRAIL) this.trail.pop();

    // Blink during inv
    if (this.inv&&!this.jetpackActive) {
      this.invT-=dt*1000; this.blinkT+=dt*1000;
      if (this.blinkT>80) { this.blink=!this.blink; this.blinkT=0; }
      if (this.invT<=0) { this.inv=false; this.blink=true; }
    }

    // Hard wall collision (still blocked during immunity)
    const w=terr.getWalls(this.y);
    if (this.x-CFG.PR<w.left||this.x+CFG.PR>w.right) return 'WALL';
    return null;
  }
}
const player=new Player();
</script>

<!-- ============================================================ -->
<!--  SCRIPT 8 · ENTITIES                                        -->
<!-- ============================================================ -->
<script id="s-entities">
const GEM_TYPES=[
  {col:CFG.CY, pts:12, r:5, gemVal:1, label:'BLUE'},
  {col:CFG.YL, pts:25, r:7, gemVal:2, label:'YELLOW'},
  {col:CFG.PK, pts:50, r:9, gemVal:5, label:'PINK'},
];

class Gem {
  constructor(terr) {
    const w=terr.getWalls(CFG.SEG_H*2),pad=14;
    const lx=w.left+pad,rx=w.right-pad;
    this.x=lx<rx?rnd(lx,rx):(w.left+w.right)/2; this.y=-12;
    const ti=Math.random()<0.6?0:Math.random()<0.6?1:2;
    this.type=GEM_TYPES[ti];
    if (gameMode==='LTM') {
      const lm=getActiveLtm();
      if (lm&&lm.id==='gold_rush'&&Array.isArray(lm.gemSet)&&lm.gemSet.length>=3) {
        const r=Math.random();
        const pick=r<0.62?lm.gemSet[0]:(r<0.88?lm.gemSet[1]:lm.gemSet[2]);
        this.type={col:pick.col,pts:pick.score,gemVal:pick.gems};
      }
    }
    this.rot=0; this.active=true; this.collected=false;
  }
  update(dt,speed) {
    if (this.collected){this.active=false;return;}
    this.y+=speed*dt; this.rot+=dt*2.5; this.active=this.y<LH+20;
  }
  draw() {
    if (!this.active) return;
    const {x,y,rot}=this;
    const type=this.type||GEM_TYPES[0];
    if (!type) return;
    ctx.save(); ctx.translate(x,y); ctx.rotate(rot);
    glow(type.col,18); ctx.fillStyle=type.col;
    const r=type.r||5;
    ctx.beginPath(); ctx.moveTo(0,-r*1.4); ctx.lineTo(r,0); ctx.lineTo(0,r*1.4); ctx.lineTo(-r,0);
    ctx.closePath(); ctx.fill();
    ctx.globalAlpha=0.6; ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.moveTo(0,-r*0.7); ctx.lineTo(r*0.5,0); ctx.lineTo(0,r*0.4); ctx.lineTo(-r*0.5,0);
    ctx.closePath(); ctx.fill(); ctx.restore();
  }
  checkHit(px,py) {
    if (this.collected) return false;
    const type=this.type||GEM_TYPES[0];
    if (!type) return false;
    return Math.hypot(px-this.x,py-this.y)<(type.r||5)+CFG.PR+4;
  }
}

const PWR_TYPES={
  SHIELD:       {col:CFG.BL, label:'SHIELD',       icon:'🛡', dur:150 },
  SLOW:         {col:CFG.GR, label:'SLOW-MO',       icon:'⏱', dur:4.5 },
  BOOST:        {col:CFG.YL, label:'SCORE ×2',      icon:'⚡', dur:10.0},
  MAGNET:       {col:CFG.PU, label:'MAGNET',         icon:'✦', dur:10.0},
  JETPACK:      {col:CFG.OR, label:'JETPACK',        icon:'🚀', dur:5.0 },
  HEALTH_BOOST: {col:'#ff44aa',label:'HEALTH BOOST', icon:'❤', dur:30  },
  REGEN:        {col:'#ff6699',label:'REGENERATION', icon:'✚', dur:0   },
  MINI_JETPACK:{col:'#88ffcc',label:'MINI JETPACK', icon:'🛸', dur:10.0},
  NEW_STAGE:   {col:'#66bbff',label:'NEW STAGE',    icon:'🌀', dur:6.0},
  X2_GEMS:     {col:'#ffd700',label:'X2 GEMS',      icon:'💎', dur:10.0},
  GEM_DROP:    {col:'#99ddff',label:'GEM DROP',     icon:'💠', dur:8.0},
  BAD_LUCK:    {col:'#ff3333',label:'BAD LUCK',     icon:'☠', dur:5.0},
  X4_GEMS:     {col:'#ffe066',label:'X4 GEMS',      icon:'💠', dur:8.0},
  SICK:        {col:'#ffffff',label:'SICK POWER',   icon:'🧪', dur:12.0},
  LTM_SPECIAL: {col:'#ffffff',label:'LTM SPECIAL',  icon:'✹', dur:10.0},
};
const PWR_WEIGHTED=[
  ...Array(4).fill('SHIELD'),
  ...Array(4).fill('SLOW'),
  ...Array(4).fill('BOOST'),
  ...Array(4).fill('MAGNET'),
  ...Array(5).fill('JETPACK'),
  ...Array(3).fill('HEALTH_BOOST'),
  ...Array(3).fill('REGEN'),
  ...Array(3).fill('X2_GEMS'),
  ...Array(2).fill('GEM_DROP'),
  ...Array(3).fill('BAD_LUCK'),
];
function randPwrKey() {
  const allowRegen=lives<maxLives;
  if (gameMode==='ADVENTURE') {
    let pool=[...PWR_WEIGHTED];
    if (!allowRegen) pool=pool.filter(k=>k!=='REGEN');
    if (!canAdvanceStage()) pool=pool.filter(k=>k!=='NEW_STAGE');
    if (adventureStage>=5 && Math.random()<0.28) return 'MINI_JETPACK';
    pool=pool.filter(k=>k!=='BAD_LUCK');
    return pool[rndI(0,pool.length-1)];
  }

  if (gameMode==='LTM') {
    const mode=getActiveLtm();
    const forced=(mode&&mode.forcedPowerups)||[];
    if (Math.random()<0.10) return 'SICK';
    if (Math.random()<0.12) return 'LTM_SPECIAL';
    if (forced.length) {
      const map={X2_SCORE:'BOOST',JETPACK:'JETPACK',MINI_JETPACK:'MINI_JETPACK',SHIELD:'SHIELD',MAGNET:'MAGNET',REGEN:'REGEN',HEALTH_BOOST:'HEALTH_BOOST',IMMUNITY:'SHIELD',X2_GEMS:'X2_GEMS',X4_GEMS:'X4_GEMS',GEM_DROP:'GEM_DROP'};
      const key=forced[rndI(0,forced.length-1)];
      return map[key]||'BOOST';
    }
    return ['BOOST','MAGNET','SHIELD','X2_GEMS'][rndI(0,3)];
  }
  if (gameMode==='IMPOSSIBLE') {
    let pool=PWR_WEIGHTED.filter(k=>!['REGEN','HEALTH_BOOST','NEW_STAGE'].includes(k));
    if (impossibleStage>=2) pool=pool.filter(k=>k!=='X2_GEMS');
    if (impossibleStage>=2) pool=pool.filter(k=>k!=='BAD_LUCK');
    if (impossibleStage<=1 && Math.random()<0.22) return 'BAD_LUCK';
    return pool[rndI(0,pool.length-1)];
  }
  const pool=(allowRegen?PWR_WEIGHTED:PWR_WEIGHTED.filter(k=>k!=='REGEN')).filter(k=>k!=='BAD_LUCK'&&k!=='NEW_STAGE');
  return pool[rndI(0,pool.length-1)];
}

class PowerUp {
  constructor(terr) {
    const w=terr.getWalls(CFG.SEG_H*2),pad=18;
    const lx=w.left+pad,rx=w.right-pad;
    this.x=lx<rx?rnd(lx,rx):(w.left+w.right)/2; this.y=-15;
    this.key=randPwrKey(); this.info=PWR_TYPES[this.key];
    this.rot=0; this.t=0; this.active=true; this.collected=false;
  }
  update(dt,speed) {
    if (this.collected){this.active=false;return;}
    this.y+=speed*dt; this.rot+=dt*1.8; this.t+=dt;
    this.active=this.y<LH+20;
  }
  draw() {
    if (!this.active) return;
    const {x,y,t,info,key}=this;
    ctx.save(); ctx.translate(x,y);
    const isSpecial=key==='JETPACK'||key==='NEW_STAGE'||key==='MINI_JETPACK'||key==='SICK'||key==='LTM_SPECIAL'||key==='X4_GEMS';
    if (isSpecial) {
      let col=info.col;
      const rainbow=(key==='SICK'||key==='LTM_SPECIAL');
      if (rainbow) col=`hsl(${Math.floor((t*240)%360)},100%,60%)`;
      if (key==='LTM_SPECIAL'&&gameMode==='LTM') col=(getActiveLtm().specialCol||col);
      const r=(key==='SICK'||key==='LTM_SPECIAL')?22:(key==='X4_GEMS'?20:18);
      glow(col,30);
      ctx.strokeStyle=col; ctx.lineWidth=2.6;
      ctx.globalAlpha=0.5+0.4*Math.sin(t*5);
      ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
      ctx.globalAlpha=0.22+0.12*Math.sin(t*7);
      ctx.fillStyle=col; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
      if (rainbow) {
        ctx.globalAlpha=0.5;
        for (let i=0;i<6;i++) {
          const a=t*2+i*Math.PI/3;
          const rc=`hsl(${(i*60+Math.floor(t*260))%360},100%,65%)`;
          glow(rc,8); circle(Math.cos(a)*(r+3),Math.sin(a)*(r+3),2.6,rc);
        }
      }
      ctx.globalAlpha=1;
      ctx.font='bold 14px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillStyle='#fff'; glow('#fff',8); ctx.fillText(info.icon,0,1);
    } else {
      glow(info.col,20); ctx.strokeStyle=info.col; ctx.lineWidth=1.5;
      ctx.globalAlpha=0.5+0.3*Math.sin(t*4);
      circle(0,0,14,info.col,false); ctx.globalAlpha=1;
      for (let i=0;i<4;i++) {
        const a=this.rot+i*Math.PI/2;
        glow(info.col,10); circle(Math.cos(a)*14,Math.sin(a)*14,2,info.col);
      }
      glow(info.col,18); ctx.fillStyle=hexToRgba(info.col,0.25); circle(0,0,9,info.col);
      ctx.font='bold 11px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.globalAlpha=1; ctx.fillStyle=info.col; glow(info.col,12);
      ctx.fillText(info.icon,0,0.5);
    }
    ctx.restore();
  }
  checkHit(px,py) {
    if (this.collected) return false;
    return Math.hypot(px-this.x,py-this.y)<((this.key==='SICK'||this.key==='LTM_SPECIAL'||this.key==='X4_GEMS')?26:20);
  }
}

class Obstacle {
  constructor(terr) {
    this.y=-15;
    const w=terr.getWalls(CFG.SEG_H*2);
    this.lBound=w.left+4; this.rBound=w.right-4;
    const trackW=this.rBound-this.lBound;
    this.gapW=clamp(trackW*0.55,52,75);
    this.gapX=(this.lBound+this.rBound)/2+(Math.random()-.5)*(trackW-this.gapW-20);
    this.vel=(Math.random()>.5?1:-1)*(45+Math.random()*65);
    this.active=true; this.t=0; this.hit=false;
  }
  update(dt,speed,terr) {
    this.y+=speed*dt; this.t+=dt; this.gapX+=this.vel*dt;
    const w=terr.getWalls(this.y);
    const lb=w.left+4,rb=w.right-4;
    const mnG=lb+this.gapW/2+2,mxG=rb-this.gapW/2-2;
    if (this.gapX<mnG){this.gapX=mnG;this.vel=Math.abs(this.vel);}
    if (this.gapX>mxG){this.gapX=mxG;this.vel=-Math.abs(this.vel);}
    this.lBound=lb; this.rBound=rb;
    this.active=this.y<LH+20;
  }
  draw() {
    if (!this.active) return;
    const {y,gapX,gapW,lBound,rBound,t}=this;
    const pulse=0.7+0.3*Math.sin(t*8);
    ctx.save();
    const lW=gapX-gapW/2-lBound,rStart=gapX+gapW/2,rW=rBound-rStart,h=7;
    glow(CFG.OR,18*pulse); ctx.fillStyle=CFG.OR; ctx.globalAlpha=0.9;
    if (lW>0) ctx.fillRect(lBound,y-h/2,lW,h);
    if (rW>0) ctx.fillRect(rStart,y-h/2,rW,h);
    ctx.globalAlpha=1; ctx.fillStyle='#fff';
    if (lW>0){ctx.fillRect(lBound,y-h/2,lW,1.5);ctx.fillRect(lBound,y+h/2-1.5,lW,1.5);}
    if (rW>0){ctx.fillRect(rStart,y-h/2,rW,1.5);ctx.fillRect(rStart,y+h/2-1.5,rW,1.5);}
    glow(CFG.GR,14); ctx.fillStyle=CFG.GR; ctx.globalAlpha=0.7+0.3*Math.sin(t*6);
    ctx.textAlign='center'; ctx.font='bold 9px monospace'; ctx.textBaseline='middle';
    ctx.fillText('▼',gapX,y); ctx.restore();
  }
  checkHit(px,py) {
    if (this.hit) return false;
    if (Math.abs(py-this.y)>10) return false;
    return !(px>=this.gapX-this.gapW/2-2&&px<=this.gapX+this.gapW/2+2);
  }
}

class FallingRock {
  constructor(terr) {
    const w=terr.getWalls(CFG.SEG_H*2),pad=16;
    const lx=w.left+pad,rx=w.right-pad;
    this.x=lx<rx?rnd(lx,rx):(w.left+w.right)/2;
    this.y=-rnd(70,220);
    this.r=rnd(18,32);
    this.spin=rnd(-2.4,2.4);
    this.rot=rnd(0,Math.PI*2);
    this.active=true;
    this.hit=false;
    this.type='FALLING_ROCK';
  }
  update(dt,speed,terr) {
    this.y+=speed*dt*0.95;
    this.rot+=this.spin*dt;
    const w=terr.getWalls(this.y);
    const lb=w.left+this.r*0.45, rb=w.right-this.r*0.45;
    if (this.x<lb) this.x=lb;
    if (this.x>rb) this.x=rb;
    this.active=this.y<LH+this.r+36;
  }
  draw() {
    if (!this.active) return;
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.rot);
    glow('#7a838f',14);
    ctx.fillStyle='rgba(130,142,156,0.95)';
    ctx.beginPath();
    ctx.arc(0,0,this.r,0,Math.PI*2);
    ctx.fill();
    ctx.lineWidth=2;
    ctx.strokeStyle='rgba(220,230,240,0.55)';
    ctx.stroke();
    noGlow();
    ctx.strokeStyle='rgba(60,70,80,0.7)';
    ctx.lineWidth=1.2;
    ctx.beginPath(); ctx.moveTo(-this.r*0.45,-this.r*0.1); ctx.lineTo(this.r*0.35,this.r*0.15); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-this.r*0.2,this.r*0.35); ctx.lineTo(this.r*0.25,-this.r*0.35); ctx.stroke();
    ctx.restore();
  }
  checkHit(px,py) {
    if (this.hit) return false;
    const dx=px-this.x, dy=py-this.y;
    return (dx*dx+dy*dy)<((this.r+8)*(this.r+8));
  }
}
</script>

<!-- ============================================================ -->
<!--  SCRIPT 9 · RENDERING                                       -->
<!-- ============================================================ -->
<script id="s-render">
function drawPerspGrid(scrollY,sf) {
  const r=Math.round(0+sf*255),g2=Math.round(245-sf*245),b=Math.round(255-sf*187);
  const gc=`rgb(${r},${g2},${b})`;
  const vx=LW/2,vy=-40;
  ctx.save(); ctx.globalAlpha=0.055+sf*0.04;
  ctx.strokeStyle=gc; ctx.lineWidth=0.8;
  for (let i=0;i<=10;i++) {
    const bx=(i/10)*LW;
    ctx.beginPath(); ctx.moveTo(lerp(vx,bx,0.05),vy); ctx.lineTo(bx,LH); ctx.stroke();
  }
  const step=48,offset=(scrollY*0.55)%step;
  for (let y=-step+offset;y<LH+step;y+=step) {
    const t2=clamp(y/LH,0,1),lx2=lerp(vx,0,t2),rx2=lerp(vx,LW,t2);
    ctx.beginPath(); ctx.moveTo(lx2,y); ctx.lineTo(rx2,y); ctx.stroke();
  }
  ctx.restore();
}

function drawTerrain() {
  const segs=terrain.segs; if (segs.length<2) return;
  const sf=terrain.speedFrac();
  const r=Math.round(0+sf*255),g2=Math.round(245-sf*245),b=Math.round(255-sf*187);
  const wc=`rgb(${r},${g2},${b})`;
  ctx.save();
  ctx.beginPath(); ctx.moveTo(0,segs[0].y);
  segs.forEach(s=>ctx.lineTo(s.lx,s.y)); ctx.lineTo(0,segs[segs.length-1].y);
  ctx.closePath(); ctx.fillStyle='rgba(0,0,0,0.97)'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(segs[0].lx,segs[0].y);
  segs.forEach(s=>ctx.lineTo(s.lx,s.y));
  ctx.strokeStyle=wc; ctx.lineWidth=3; glow(wc,16); ctx.stroke();
  ctx.restore();
  ctx.save();
  ctx.beginPath(); ctx.moveTo(LW,segs[0].y);
  segs.forEach(s=>ctx.lineTo(s.rx,s.y)); ctx.lineTo(LW,segs[segs.length-1].y);
  ctx.closePath(); ctx.fillStyle='rgba(0,0,0,0.97)'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(segs[0].rx,segs[0].y);
  segs.forEach(s=>ctx.lineTo(s.rx,s.y));
  ctx.strokeStyle=wc; ctx.lineWidth=3; glow(wc,16); ctx.stroke();
  ctx.restore();
  ctx.save();
  ctx.setLineDash([10,16]); ctx.lineDashOffset=-(terrain.scrollY%26)*0.5;
  ctx.beginPath();
  segs.forEach((s,i)=>{const cx=(s.lx+s.rx)/2;i===0?ctx.moveTo(cx,s.y):ctx.lineTo(cx,s.y);});
  ctx.strokeStyle='rgba(0,245,255,0.06)'; ctx.lineWidth=1; noGlow(); ctx.stroke();
  ctx.setLineDash([]); ctx.restore();
}

function drawMagnetEffect(gemList,pwrList) {
  if (activePwr!=='MAGNET') return;
  ctx.save();
  const drawPull=(ox,oy,range)=>{
    const dx=player.x-ox,dy=player.y-oy,dist=Math.hypot(dx,dy);
    if (dist>range) return;
    const a=clamp(1-dist/range,0,1)*0.5;
    ctx.globalAlpha=a; ctx.strokeStyle=CFG.PU; ctx.lineWidth=1; glow(CFG.PU,8);
    ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(ox+dx*0.4,oy+dy*0.4); ctx.stroke();
    const ang=Math.atan2(dy,dx),mx=ox+dx*0.4,my=oy+dy*0.4;
    ctx.beginPath(); ctx.moveTo(mx,my);
    ctx.lineTo(mx-8*Math.cos(ang-0.4),my-8*Math.sin(ang-0.4));
    ctx.lineTo(mx-8*Math.cos(ang+0.4),my-8*Math.sin(ang+0.4));
    ctx.closePath(); ctx.fillStyle=CFG.PU; ctx.fill();
  };
  gemList.forEach(gem=>{if(!gem.active||gem.collected)return;drawPull(gem.x,gem.y,280);});
  pwrList.forEach(pwr=>{if(!pwr.active||pwr.collected)return;drawPull(pwr.x,pwr.y,250);});
  ctx.restore();
}

function drawPlayer() {
  const {x,y,trail,inv,blink,shield,jetpackActive}=player;
  if (inv&&!blink&&!jetpackActive) return;
  for (let i=1;i<trail.length;i++) {
    const t2=1-i/trail.length;
    const charD=CHAR_CATALOG.find(c=>c.id===selectedChar)||CHAR_CATALOG[0];
    const tc=miniJetpackActive?'#88ccff':newStageActive?'#66bbff':jetpackActive?CFG.OR:activePwr==='SLOW'?CFG.GR:activePwr==='BOOST'?CFG.YL:activePwr==='MAGNET'?CFG.PU:activePwr==='HEALTH_BOOST'?'#ff44aa':charD.trailCol;
    ctx.save(); ctx.globalAlpha=t2*0.5;
    glow(tc,8); circle(trail[i].x,trail[i].y,CFG.PR*t2*0.65,tc);
    ctx.restore(); spark(trail[i].x,trail[i].y,tc);
  }
  if (jetpackActive) {
    ctx.save();
    for (let i=0;i<3;i++) {
      const fw=6-i*1.5,fh=12+Math.random()*8+i*4,fx=x+(Math.random()-.5)*8;
      glow('#ff6600',20);
      const flameGrad=ctx.createLinearGradient(fx,y+8,fx,y+8+fh);
      flameGrad.addColorStop(0,'rgba(255,220,50,0.9)');
      flameGrad.addColorStop(0.5,'rgba(255,100,0,0.7)');
      flameGrad.addColorStop(1,'rgba(255,50,0,0)');
      ctx.fillStyle=flameGrad;
      ctx.beginPath(); ctx.ellipse(fx,y+10,fw,fh,0,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }
  if (shield) {
    ctx.save(); ctx.globalAlpha=0.6+0.3*Math.sin(menuT*6);
    glow(CFG.BL,20); ctx.strokeStyle=CFG.BL; ctx.lineWidth=2.5;
    circle(x,y,CFG.PR+7,CFG.BL,false); ctx.restore();
  }
  // Health boost aura
  if (healthBoostActive) {
    ctx.save(); ctx.globalAlpha=0.3+0.2*Math.sin(menuT*5);
    glow('#ff44aa',18); ctx.strokeStyle='#ff44aa'; ctx.lineWidth=2;
    circle(x,y,CFG.PR+18,'#ff44aa',false); ctx.restore();
  }
  if (immunityActive&&!jetpackActive) {
    const speedBoost=immunityTimer<=1?18:immunityTimer<=2?14:immunityTimer<=3?10:7;
    ctx.save(); ctx.globalAlpha=0.35+0.35*Math.sin(menuT*speedBoost);
    glow(CFG.GR,22); ctx.strokeStyle=CFG.GR; ctx.lineWidth=2.2;
    circle(x,y,CFG.PR+20,CFG.GR,false);
    ctx.restore();
  }
  if (activePwr&&!jetpackActive) {
    const ac=PWR_TYPES[activePwr]?.col||CFG.CY;
    ctx.save(); ctx.globalAlpha=0.35+0.2*Math.sin(menuT*8);
    glow(ac,22); ctx.strokeStyle=ac; ctx.lineWidth=2;
    circle(x,y,CFG.PR+13,ac,false); ctx.restore();
  }
  if (jetpackActive) {
    ctx.save();
    ctx.globalAlpha=0.5+0.3*Math.sin(menuT*12);
    glow(CFG.OR,30); ctx.strokeStyle=CFG.OR; ctx.lineWidth=2.5;
    circle(x,y,CFG.PR+16,CFG.OR,false);
    ctx.globalAlpha=0.2+0.15*Math.sin(menuT*8);
    glow('#ff4400',20); ctx.strokeStyle='#ff4400'; ctx.lineWidth=1;
    circle(x,y,CFG.PR+25,'#ff4400',false);
    ctx.restore();
  }
  ctx.save();
  const charData=CHAR_CATALOG.find(c=>c.id===selectedChar)||CHAR_CATALOG[0];
  const ballCol=jetpackActive?CFG.OR:charData.col;
  glow(ballCol,26); ctx.strokeStyle=ballCol; ctx.lineWidth=2;
  circle(x,y,CFG.PR,ballCol,false);
  const grad=ctx.createRadialGradient(x-3,y-3,0,x,y,CFG.PR);
  grad.addColorStop(0,'rgba(255,255,255,0.95)');
  grad.addColorStop(0.4,ballCol);
  grad.addColorStop(1,'rgba(0,20,30,0.5)');
  ctx.beginPath(); ctx.arc(x,y,CFG.PR-1,0,Math.PI*2);
  ctx.fillStyle=grad; ctx.fill();
  ctx.globalAlpha=0.55; ctx.fillStyle='#fff';
  circle(x-CFG.PR*0.28,y-CFG.PR*0.28,CFG.PR*0.28,'#fff');
  ctx.restore();
}

function drawJetpackFog() {
  if (!player.jetpackActive&&!miniJetpackActive&&!newStageActive) return;
  const jp=player.jetpackActive?((player.jetpackMax-player.jetpackT)/Math.max(0.01,player.jetpackMax)):0.6;
  const base=(miniJetpackActive||newStageActive)?0.22:0.18;
  const a=Math.min(1,jp*2)*base;
  ctx.save();
  const g1=ctx.createLinearGradient(0,0,120,0);
  g1.addColorStop(0,`rgba(${(miniJetpackActive||newStageActive)?'120,190,255':'255,100,0'},${a})`); g1.addColorStop(1,'transparent');
  ctx.fillStyle=g1; ctx.fillRect(0,0,120,LH);
  const g2=ctx.createLinearGradient(LW,0,LW-120,0);
  g2.addColorStop(0,`rgba(${(miniJetpackActive||newStageActive)?'120,190,255':'255,100,0'},${a})`); g2.addColorStop(1,'transparent');
  ctx.fillStyle=g2; ctx.fillRect(LW-120,0,120,LH);
  ctx.restore();
}

function drawHUD() {
  const sf=terrain.speedFrac(),pdX=14,pdY=14;
  const scalePop=1+scorePopT*0.35;

  ctx.save(); ctx.translate(LW/2,pdY+12); ctx.scale(scalePop,scalePop);
  setFont(11,'400',"'Share Tech Mono',monospace"); txt('SCORE',0,0,'rgba(0,245,255,0.5)');
  const shownMult=scoreMultiplier();
  const multiStr=shownMult>1?`  ×${shownMult}`:'';
  setFont(22,'900'); glow(CFG.CY,14); txt(`${Math.floor(score)}${multiStr}`,0,22,CFG.CY);
  ctx.restore();

  // Gem bank
  {
    const gbW=112, gbH=18, gbX=(LW-gbW)/2, gbY=pdY+42;
    ctx.save();
    ctx.fillStyle='rgba(0,245,255,0.06)'; ctx.fillRect(gbX,gbY,gbW,gbH);
    ctx.strokeStyle='rgba(0,245,255,0.35)'; ctx.lineWidth=1; glow(CFG.CY,6); ctx.strokeRect(gbX,gbY,gbW,gbH);
    ctx.fillStyle=CFG.CY;
    ctx.beginPath();
    ctx.moveTo(gbX+12,gbY+3); ctx.lineTo(gbX+16,gbY+9); ctx.lineTo(gbX+12,gbY+15); ctx.lineTo(gbX+8,gbY+9);
    ctx.closePath();
    ctx.fill();
    setFont(9,'900'); glow(CFG.CY,8); txt(`${totalGems}`,gbX+24,gbY+13,CFG.CY,'left');
    setFont(7,'700',"'Share Tech Mono',monospace"); noGlow();
    txt(`+${gemsCollected}`,gbX+gbW-8,gbY+13,CFG.YL,'right');
    ctx.restore();
  }

  ctx.save(); setFont(9,'400',"'Share Tech Mono',monospace");
  txt('HIGHSCORE',pdX+22,pdY+8,'rgba(0,245,255,0.42)','center');
  setFont(14,'700'); glow(CFG.CY,10); txt(`${Math.floor(bestScore)}`,pdX+22,pdY+22,CFG.CY,'center');
  ctx.restore();

  // Adventure stage indicator
  if (isStageMode()) {
    ctx.save(); setFont(9,'700');
    const st=currentStageConfig();
    glow(gameMode==='IMPOSSIBLE'?'#ff4455':CFG.GR,12);
    txt(`${st.name} · ${st.label}`,LW/2,pdY+68,gameMode==='IMPOSSIBLE'?'#ff4455':CFG.GR); ctx.restore();
  }

  // Lives (right side)
  ctx.save();
  const lx=LW-pdX-14;
  const livesLabelY=pdY+8;
  const livesDotsY=pdY+20;
  setFont(9,'400',"'Share Tech Mono',monospace");
  txt('LIVES',lx,livesLabelY,'rgba(0,245,255,0.4)','right');
  // Show dots up to maxLives (dimmed beyond current lives count)
  for (let i=0;i<maxLives;i++) {
    const dx=lx-(maxLives-1-i)*14, alive=i<lives;
    const col=i<CFG.LIVES?CFG.PK:'#ff44aa'; // extra lives = pink-ish
    glow(alive?col:'transparent',alive?8:0);
    circle(dx,livesDotsY,5,alive?col:'rgba(255,0,110,0.15)');
  }
  ctx.restore();

  // Pause button
  {
    const pbX=pdX-2,pbY=pdY+38,pbW=40,pbH=20;
    BTNS.pause={x:pbX,y:pbY,w:pbW,h:pbH};
    const isPaused=gs==='PAUSE';
    const pbCol=isPaused?CFG.CY:'rgba(0,245,255,0.55)';
    ctx.save(); ctx.strokeStyle=pbCol; ctx.lineWidth=1.5;
    glow(pbCol,isPaused?14:6); ctx.strokeRect(pbX,pbY,pbW,pbH);
    ctx.fillStyle=hexToRgba(CFG.CY,isPaused?0.18:0.06); ctx.fillRect(pbX,pbY,pbW,pbH);
    setFont(9,'900'); glow(pbCol,8); txt(isPaused?'▶':'❚❚',pbX+pbW/2,pbY+pbH/2+3.5,pbCol);
    ctx.restore();
    const obX=pbX+44,obY=pbY,obW=42,obH=20;
    BTNS.hudOptions={x:obX,y:obY,w:obW,h:obH};
    ctx.save(); ctx.strokeStyle='rgba(204,0,255,0.6)'; ctx.lineWidth=1.3; glow(CFG.PU,6);
    ctx.strokeRect(obX,obY,obW,obH);
    setFont(8,'900'); txt('OPT',obX+obW/2,obY+14,CFG.PU);
    ctx.restore();
  }


  if (isTouchDevice && OPTION_PREFS.showTouchJoycons) {
    const r=32, y=LH-92;
    const lx=64, rx=LW-64;
    const pulse=0.72+0.28*Math.sin(menuT*5);
    BTNS.touchJoyL={x:lx-r,y:y-r,w:r*2,h:r*2};
    BTNS.touchJoyR={x:rx-r,y:y-r,w:r*2,h:r*2};
    [
      {x:lx,label:'◀',on:joyL,col:'#66bbff'},
      {x:rx,label:'▶',on:joyR,col:'#66bbff'}
    ].forEach(b=>{
      ctx.save();
      ctx.globalAlpha=b.on?1:0.86*pulse;
      glow(b.col,b.on?18:10);
      ctx.fillStyle=b.on?'rgba(102,187,255,0.28)':'rgba(0,0,0,0.28)';
      circle(b.x,y,r,b.col,true);
      ctx.strokeStyle=b.col; ctx.lineWidth=2; circle(b.x,y,r,b.col,false);
      setFont(20,'900'); txt(b.label,b.x,y+7,b.col);
      ctx.restore();
    });
  } else {
    BTNS.touchJoyL=BTNS.touchJoyR=null;
  }

  // Speed bar + next-stage meter
  ctx.save();
  const bw=120,bh=3,bx=(LW-bw)/2,by=LH-pdY-bh;
  if (hasStageProgression() && canAdvanceStage()) {
    const nby=by-12;
    const stageFrac=clamp(stagePowerupElapsed/Math.max(0.001,stagePowerupNext),0,1);
    setFont(7,'400',"'Share Tech Mono',monospace"); txt('NEXT STAGE',LW/2,nby-4,'rgba(140,255,220,0.55)');
    ctx.fillStyle='rgba(136,255,204,0.12)'; ctx.fillRect(bx,nby,bw,bh);
    const ng=ctx.createLinearGradient(bx,0,bx+bw,0);
    ng.addColorStop(0,'#88ffcc'); ng.addColorStop(1,'#66bbff');
    ctx.fillStyle=ng; glow('#88ffcc',7); ctx.fillRect(bx,nby,bw*stageFrac,bh);
  }
  setFont(8,'400',"'Share Tech Mono',monospace"); txt('SPEED',LW/2,by-6,'rgba(0,245,255,0.35)');
  ctx.fillStyle='rgba(0,245,255,0.1)'; ctx.fillRect(bx,by,bw,bh);
  const spGrad=ctx.createLinearGradient(bx,0,bx+bw,0);
  spGrad.addColorStop(0,CFG.CY); spGrad.addColorStop(1,CFG.PK);
  ctx.fillStyle=spGrad; glow(CFG.CY,8); ctx.fillRect(bx,by,bw*sf,bh);
  ctx.restore();

  // Active powerup list (right side, compact)
  const activeTimers=[];
  if (activePwr&&PWR_TYPES[activePwr]?.dur>0) {
    activeTimers.push({icon:PWR_TYPES[activePwr].icon,label:PWR_TYPES[activePwr].label,col:PWR_TYPES[activePwr].col,time:pwrTimer});
  }
  if (healthBoostActive&&healthBoostTimer>0) {
    activeTimers.push({icon:'❤',label:'HEALTH BOOST',col:'#ff44aa',time:healthBoostTimer});
  }
  if (player.jetpackActive) {
    activeTimers.push({icon:'🚀',label:'JETPACK',col:CFG.OR,time:player.jetpackT});
  }
  if (miniJetpackActive) {
    activeTimers.push({icon:'🛸',label:'MINI JETPACK',col:'#88ffcc',time:miniJetpackTimer});
  }
  if (gemDoubleActive) activeTimers.push({icon:'💎',label:`X${Math.max(2,gemBoostMult)} GEMS`,col:'#ffd700',time:(gameMode==='IMPOSSIBLE'&&impossibleStage>=2)?999:gemDoubleTimer});
  if (gemDropActive) activeTimers.push({icon:'💠',label:'GEM DROP',col:'#99ddff',time:gemDropTimer});
  if (newStageActive) {
    activeTimers.push({icon:'🌀',label:'NEW STAGE',col:'#66bbff',time:newStageTimer});
  }
  if (immunityActive) {
    activeTimers.push({icon:'🟢',label:'IMMUNITY',col:CFG.GR,time:immunityTimer});
  }
  if (activeTimers.length) {
    ctx.save();
    const sx=LW-12, sy=LH-pdY-130;
    activeTimers.forEach((item,i)=>{
      const y=sy+i*16;
      setFont(7,'700',"'Share Tech Mono',monospace");
      glow(item.col,8);
      txt(`${item.icon} ${item.label} ${Math.max(0,item.time).toFixed(1)}s`,sx,y,item.col,'right');
    });
    ctx.restore();
  }

  // Combo
  if (multi>1||gemStreak>0) {
    ctx.save();
    const mx=pdX+6,my=LH-pdY-34;
    const sm=scoreMultiplier();
    const comboShown=Math.max(0,multi-1);
    setFont(9,'700'); glow(CFG.YL,10); txt(`COMBO ×${comboShown} · SCORE ×${sm}`,mx,my,CFG.YL,'left');
    if (multi<4) {
      const bwm=96,bhm=4,pct=(gemStreak%5)/5;
      const by=my+7;
      ctx.fillStyle='rgba(255,230,0,0.12)'; ctx.fillRect(mx,by,bwm,bhm);
      ctx.fillStyle=CFG.YL; glow(CFG.YL,7); ctx.fillRect(mx,by,bwm*pct,bhm);
    }
    ctx.restore();
  }

  if (player.shield) {
    ctx.save(); setFont(10,'700'); glow(CFG.BL,14);
    txt('🛡 SHIELD',pdX+2,LH-pdY-38,CFG.BL,'left'); ctx.restore();
  }

  // Touch hint
  if ('ontouchstart' in window) {
    ctx.save(); ctx.globalAlpha=0.09; noGlow(); setFont(18,'900'); ctx.fillStyle=CFG.CY;
    txt('◄◄',24,LH/2+10); txt('►►',LW-24,LH/2+10); ctx.restore();
  }

  ctx.save(); noGlow(); setFont(8,'400',"'Share Tech Mono',monospace");
  txt(`v${VERSION}`,LW-pdX,LH-pdY,'rgba(0,245,255,0.2)','right'); ctx.restore();
}

function drawScanlines() {
  if (!SETTINGS.scanlines||SETTINGS.gfxQuality===0) return;
  ctx.save(); ctx.globalAlpha=0.02;
  for (let y=0;y<LH;y+=3) { ctx.fillStyle='#000'; ctx.fillRect(0,y,LW,1); }
  ctx.restore();
}

// ── Flash ─────────────────────────────────────────────────────────
let flashAlpha=0, flashCol=CFG.PK;
// Game over multi-flash sequence
let gameOverFlash=0, gameOverFlashPhase=0;
function triggerGameOverFlash() {
  gameOverFlash=1.5; gameOverFlashPhase=0;
}
function drawFlash() {
  // Multi-flash game over sequence
  if (gameOverFlash>0) {
    const t=gameOverFlash;
    let a=0, col=CFG.PK;
    if (t>1.2)      { a=((1.5-t)/0.3)*0.9; col='#fff'; }
    else if (t>0.9) { a=((t-0.9)/0.3)*0.7; col=CFG.PK; }
    else if (t>0.6) { a=((0.9-t)/0.3)*0.5; col=CFG.PK; }
    else if (t>0.3) { a=((t-0.3)/0.3)*0.4; col='#ff0044'; }
    else            { a=(t/0.3)*0.2; col='#440000'; }
    ctx.save(); ctx.globalAlpha=a;
    ctx.fillStyle=col; ctx.fillRect(0,0,LW,LH); ctx.restore();
  }
  if (flashAlpha<=0) return;
  ctx.save(); ctx.globalAlpha=flashAlpha;
  ctx.fillStyle=flashCol; ctx.fillRect(0,0,LW,LH); ctx.restore();
}

// ── LOADING SCREEN ────────────────────────────────────────────────
let loadProgress=0, loadDone=false, loadSlideY=0;
let loadParticles=[];

function initLoadParticles() {
  loadParticles=[];
  for (let i=0;i<30;i++) {
    loadParticles.push({
      x:rnd(0,LW), y:rnd(0,LH),
      vx:rnd(-40,40), vy:rnd(-80,-20),
      col:[CFG.CY,CFG.PU,CFG.PK,CFG.YL][rndI(0,3)],
      size:rnd(2,5), life:rnd(1,3), maxLife:rnd(1,3), alpha:0,
    });
  }
}

function drawLoadingScreen(t) {
  // Background
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawBgSquares();

  ctx.save(); ctx.translate(0, loadSlideY);

  // Glitch title
  const titleY=LH*0.32;
  if (Math.sin(t*2.2)>0.8) {
    const ox=(Math.random()-.5)*12;
    ctx.globalAlpha=0.7; setFont(72,'900');
    ctx.fillStyle=CFG.PK; ctx.textAlign='center'; ctx.fillText('SLOPE',LW/2+ox,titleY+3);
    ctx.fillStyle=CFG.CY; ctx.fillText('SLOPE',LW/2-ox,titleY-2);
    ctx.globalAlpha=1;
  }
  setFont(72,'900'); glow(CFG.CY,30);
  ctx.fillStyle=CFG.CY; ctx.textAlign='center'; ctx.fillText('SLOPE',LW/2,titleY);

  setFont(11,'400',"'Share Tech Mono',monospace"); glow(CFG.CY,6);
  txt('NEON RUSH',LW/2,titleY+32,'rgba(0,245,255,0.6)');
  txt(`VERSION ${VERSION}`,LW/2,titleY+48,'rgba(0,245,255,0.35)');

  // Progress bar
  const bw=240,bh=6,bx=(LW-bw)/2,by=LH*0.58;
  ctx.save();
  ctx.fillStyle='rgba(0,245,255,0.1)'; ctx.fillRect(bx,by,bw,bh);
  const pGrad=ctx.createLinearGradient(bx,0,bx+bw,0);
  pGrad.addColorStop(0,CFG.CY); pGrad.addColorStop(0.5,CFG.PU); pGrad.addColorStop(1,CFG.PK);
  ctx.fillStyle=pGrad; glow(CFG.CY,12);
  ctx.fillRect(bx,by,bw*loadProgress,bh);
  // Shimmer on bar
  const shimX=bx+bw*loadProgress-20;
  if (loadProgress>0.02) {
    const sg=ctx.createLinearGradient(shimX,0,shimX+20,0);
    sg.addColorStop(0,'transparent'); sg.addColorStop(0.5,'rgba(255,255,255,0.7)'); sg.addColorStop(1,'transparent');
    ctx.fillStyle=sg; ctx.fillRect(shimX,by-1,20,bh+2);
  }
  ctx.restore();

  // Loading text
  const dots='.'.repeat(Math.floor(t*2)%4);
  setFont(10,'400',"'Share Tech Mono',monospace"); glow(CFG.CY,6);
  txt(`LOADING${dots}  ${Math.floor(loadProgress*100)}%`,LW/2,by+24,'rgba(0,245,255,0.5)');

  // Flying particles on complete
  if (loadProgress>=1) {
    loadParticles.forEach(p=>{
      p.alpha=Math.min(1,p.alpha+0.05);
      ctx.save(); ctx.globalAlpha=p.alpha*(p.life/p.maxLife);
      glow(p.col,10); circle(p.x,p.y,p.size,p.col);
      ctx.restore();
    });
  }

  ctx.restore();
}

// ── MAIN MENU ─────────────────────────────────────────────────────
let menuSlideY=0; // for slide-in animation
let seasonScrollX=0, seasonDir=1;

function drawStartScreen(t) {
  drawPerspGrid(terrain.scrollY,0); drawTerrain();
  drawBgSquares();
  ctx.save();
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,LW,LH);
  ctx.restore();

  ctx.save(); ctx.translate(0,menuSlideY);

  // Glitch title
  const titleY=LH*0.22;
  if (Math.sin(t*1.3)>0.85) {
    const ox=(Math.random()-.5)*10,oy2=(Math.random()-.5)*4;
    ctx.globalAlpha=0.7; setFont(60,'900');
    ctx.fillStyle=CFG.PK; ctx.textAlign='center'; ctx.fillText('SLOPE',LW/2+ox,titleY+oy2);
    ctx.fillStyle=CFG.CY; ctx.fillText('SLOPE',LW/2-ox,titleY-oy2);
    ctx.globalAlpha=1;
  }
  setFont(60,'900'); glow(CFG.CY,30);
  ctx.fillStyle=CFG.CY; ctx.textAlign='center'; ctx.fillText('SLOPE',LW/2,titleY);
  setFont(13,'900'); glow(CFG.CY,10);
  txt('SEASON 1',LW/2+seasonScrollX,titleY+34,'rgba(0,245,255,0.8)');
  setFont(11,'400',"'Share Tech Mono',monospace"); glow(CFG.CY,8);
  txt('NEON RUSH',LW/2,titleY+50,'rgba(0,245,255,0.7)');
  txt(`VERSION ${VERSION}`,LW/2,titleY+64,'rgba(0,245,255,0.35)');

  // Divider
  ctx.save();
  const lw2=120,lx2=(LW-lw2)/2,ly=titleY+78;
  const dg=ctx.createLinearGradient(lx2,0,lx2+lw2,0);
  dg.addColorStop(0,'transparent'); dg.addColorStop(0.5,CFG.CY); dg.addColorStop(1,'transparent');
  ctx.strokeStyle=dg; ctx.lineWidth=1; glow(CFG.CY,8);
  ctx.beginPath(); ctx.moveTo(lx2,ly); ctx.lineTo(lx2+lw2,ly); ctx.stroke(); ctx.restore();

  // Visual accents
  ctx.save();
  const pulse=0.35+0.25*Math.sin(t*2.8);
  ctx.globalAlpha=pulse;
  glow(CFG.CY,12); ctx.strokeStyle='rgba(0,245,255,0.45)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(34,titleY+10); ctx.lineTo(108,titleY+10); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(LW-34,titleY+10); ctx.lineTo(LW-108,titleY+10); ctx.stroke();
  circle(30,titleY+10,2.5,CFG.CY); circle(LW-30,titleY+10,2.5,CFG.CY);
  ctx.restore();

  // Vertical button list
  const btnW=188, btnH=36, btnX=(LW-btnW)/2;
  let btnY=LH*0.39;
  const gap=6;

  // START GAME
  BTNS.start={x:btnX,y:btnY,w:btnW,h:btnH};
  drawNeonBtn(btnX,btnY,btnW,btnH,CFG.CY,'▶  START GAME',15,1,Math.sin(t*3));
  btnY+=btnH+gap;

  // ABOUT
  BTNS.about={x:btnX,y:btnY,w:btnW,h:btnH};
  drawNeonBtn(btnX,btnY,btnW,btnH,CFG.PK,'ℹ  ABOUT',12,0.9,Math.sin(t*2.1));
  btnY+=btnH+gap;

  // CONTROLS
  BTNS.controls={x:btnX,y:btnY,w:btnW,h:btnH};
  drawNeonBtn(btnX,btnY,btnW,btnH,CFG.GR,'🎮 CONTROLS',12,0.9,Math.sin(t*2.3));
  btnY+=btnH+gap;

  // SETTINGS
  BTNS.settings={x:btnX,y:btnY,w:btnW,h:btnH};
  drawNeonBtn(btnX,btnY,btnW,btnH,CFG.PU,'⚙  SETTINGS',12,0.85,Math.sin(t*2));
  btnY+=btnH+gap;

  // QUESTS
  BTNS.quests={x:btnX,y:btnY,w:btnW,h:btnH};
  drawNeonBtn(btnX,btnY,btnW,btnH,CFG.YL,'📋 QUESTS',13,0.85,Math.sin(t*2.4));
  btnY+=btnH+gap;

  // LEADERBOARD
  BTNS.leaderboard={x:btnX,y:btnY,w:btnW,h:btnH};
  drawNeonBtn(btnX,btnY,btnW,btnH,CFG.GR,'🏆 LEADERBOARD',13,0.85,Math.sin(t*2.3));
  btnY+=btnH+gap;

  // UPGRADES
  BTNS.upgrades={x:btnX,y:btnY,w:btnW,h:btnH};
  drawNeonBtn(btnX,btnY,btnW,btnH,CFG.YL,'⬆ UPGRADES',13,0.85,Math.sin(t*2.1));
  btnY+=btnH+gap;

  // SHOP (rainbow animated border)
  BTNS.charShop={x:btnX,y:btnY,w:btnW,h:btnH};
  ctx.save(); ctx.fillStyle='rgba(255,230,0,0.06)'; ctx.fillRect(btnX,btnY,btnW,btnH);
  setFont(13,'900'); glow(CFG.YL,12); txt('🛒 SHOP',LW/2,btnY+btnH/2+5,CFG.YL);
  ctx.restore();
  drawRainbowBorder(btnX,btnY,btnW,btnH,t,2.5);
  btnY+=btnH+gap;

  const authW=188,authH=28,authX=(LW-authW)/2;
  BTNS.authAction={x:authX,y:btnY,w:authW,h:authH};
  drawNeonBtn(authX,btnY,authW,authH,isSignedIn?'#8a8a8a':'#6c6c6c',isSignedIn?'👤 MINI PROFILE':'SIGN IN!',10,0.9,Math.sin(t*2.2));
  const nameBannerW=152;
  BTNS.menuProfileBox={x:LW-nameBannerW-14,y:10,w:nameBannerW,h:22};
  ctx.save();
  const bannerFill=isSignedIn?'rgba(60,130,255,0.65)':'rgba(120,120,120,0.65)';
  const bannerStroke=isSignedIn?'rgba(180,220,255,0.85)':'rgba(210,210,210,0.85)';
  ctx.fillStyle=bannerFill; ctx.fillRect(LW-nameBannerW-14,10,nameBannerW,22);
  ctx.strokeStyle=bannerStroke; ctx.lineWidth=1; ctx.strokeRect(LW-nameBannerW-14,10,nameBannerW,22);
  const bannerName=(isSignedIn?(auth.name||'RUNNER'):'GUEST').slice(0,12);
  const pfpR=8, pfpX=LW-24, pfpY=21;
  if (isSignedIn && profileAvatar) { const img=new Image(); img.src=profileAvatar; ctx.save(); ctx.beginPath(); ctx.arc(pfpX,pfpY,pfpR,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,pfpX-pfpR,pfpY-pfpR,pfpR*2,pfpR*2); ctx.restore(); }
  else { circle(pfpX,pfpY,pfpR,'#1f2c36',true); drawDefaultProfileIcon(pfpX,pfpY,pfpR,'#d8f6ff'); }
  ctx.strokeStyle='rgba(0,245,255,0.7)'; ctx.lineWidth=1.2; circle(pfpX,pfpY,pfpR+1,CFG.CY,false);
  const status=getStatusValue();
  drawStatusDot(LW-nameBannerW+4,21,status);
  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt(bannerName,LW-38,24,'#fff','right');
  const tw=ctx.measureText(bannerName).width;
  let bx=LW-38-tw-8;
  if (isSignedIn && auth && auth.admin===true) { drawRoleBadgeSquare(bx,21,8,CFG.YL,t,false); bx-=12; }
  if (isSignedIn && auth && auth.verified===true) { drawRoleBadgeSquare(bx,21,8,'#33aaff',t,true); }
  ctx.restore();
  BTNS.noAds={x:8,y:8,w:28,h:28};
  ctx.save(); ctx.fillStyle='rgba(255,30,30,0.75)'; ctx.fillRect(8,8,28,28); ctx.strokeStyle='#ff9090'; ctx.strokeRect(8,8,28,28);
  setFont(10,'900',"'Share Tech Mono',monospace"); noGlow(); txt('⛔',22,27,'#fff'); ctx.restore();
  if (!navigator.onLine) {
    setFont(14,'900'); glow(CFG.PK,12); txt('PLAYER OFFLINE',LW/2,LH/2-8,CFG.PK);
    setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); txt('Connect to internet to load leaderboard.',LW/2,LH/2+16,CFG.CY);
    leaderboardContentH=listH;
  } else if (!isSignedIn) {
    ctx.save(); ctx.fillStyle='#ffe600'; ctx.fillRect(authX+authW-74,btnY-2,72,12);
    setFont(6,'900',"'Share Tech Mono',monospace"); noGlow(); ctx.fillStyle='#000';
    txt('SAVE PROGRESS!',authX+authW-38,btnY+7,'#000'); ctx.restore();
  }
  btnY+=authH+gap;

  ctx.save(); noGlow(); setFont(10,'700'); glow(CFG.CY,8); ctx.globalAlpha=0.7;
  txt(`◆ ${totalGems}`,LW-14,LH-8,CFG.CY,'right'); ctx.restore();
  if (noAdsPopup) {
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,0.74)'; ctx.fillRect(0,0,LW,LH);
    const w=280,h=170,x=(LW-w)/2,y=(LH-h)/2;
    ctx.fillStyle='#111'; ctx.fillRect(x,y,w,h);
    ctx.strokeStyle=CFG.PK; ctx.lineWidth=2; glow(CFG.PK,10); ctx.strokeRect(x,y,w,h);
    setFont(16,'900'); txt('TIRED OF ADS?',LW/2,y+30,'#fff');
    BTNS.noAdsBuy={x:x+20,y:y+62,w:w-40,h:36};
    BTNS.noAdsContinue={x:x+20,y:y+110,w:w-40,h:30};
    drawNeonBtn(BTNS.noAdsBuy.x,BTNS.noAdsBuy.y,BTNS.noAdsBuy.w,BTNS.noAdsBuy.h,CFG.YL,'PURCHASE $2.99',12,1,Math.sin(t*3));
    drawNeonBtn(BTNS.noAdsContinue.x,BTNS.noAdsContinue.y,BTNS.noAdsContinue.w,BTNS.noAdsContinue.h,'#777','CONTINUE WITH ADS',10,1,0);
    ctx.restore();
  }
  drawFooter();
  ctx.restore(); // menuSlideY translate
}




function drawGuestProfilePrompt(t){
  if (!guestProfilePrompt.active) return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.72)'; ctx.fillRect(0,0,LW,LH);
  const w=288,h=170,x=(LW-w)/2,y=(LH-h)/2;
  ctx.fillStyle='#050a10'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(0,245,255,0.45)'; ctx.lineWidth=2; glow(CFG.CY,12); ctx.strokeRect(x,y,w,h);
  setFont(14,'900'); glow(CFG.CY,10); txt('SIGN IN TO VIEW PROFILE',LW/2,y+30,CFG.CY);
  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt('Guests can continue with limited local view.',LW/2,y+52,'rgba(190,235,255,0.85)');
  BTNS.guestPromptSignIn={x:x+22,y:y+82,w:w-44,h:30};
  BTNS.guestPromptContinue={x:x+22,y:y+120,w:w-44,h:30};
  drawNeonBtn(BTNS.guestPromptSignIn.x,BTNS.guestPromptSignIn.y,BTNS.guestPromptSignIn.w,BTNS.guestPromptSignIn.h,CFG.CY,'SIGN IN',11,1,Math.sin(t*2));
  drawNeonBtn(BTNS.guestPromptContinue.x,BTNS.guestPromptContinue.y,BTNS.guestPromptContinue.w,BTNS.guestPromptContinue.h,'#9a9a9a','CONTINUE AS GUEST',10,1,0);
  ctx.restore();
}

function drawPublicProfileScreen(t){
  if (isSignedIn && !socialView.loading && (socialCounters.friends+socialCounters.followers+socialCounters.following+socialCounters.received+socialCounters.sent===0)) fetchSocialData();
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.08,0.03); drawBgSquares();
  const x=24,y=86,w=LW-48,h=560;
  ctx.fillStyle='rgba(5,12,18,0.95)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(57,255,20,0.4)'; ctx.lineWidth=1.5; glow(CFG.GR,10); ctx.strokeRect(x,y,w,h);
  setFont(24,'900'); glow(CFG.GR,14); txt('PUBLIC PROFILE',LW/2,64,CFG.GR);
  const rows=[
    ['Show Bio Public','bio'],
    ['Show Friends List Public','friends'],
    ['Show Followers List Public','followers'],
    ['Show Following List Public','following'],
  ];
  rows.forEach((r,i)=>{
    const ry=y+34+i*66;
    BTNS[['publicBioBtn','publicFriendsBtn','publicFollowersBtn','publicFollowingBtn'][i]]={x:x+16,y:ry,w:w-32,h:52};
    drawNeonBtn(x+16,ry,w-32,52,CFG.CY,`${r[0]}  :  ${PRIVACY_LEVELS[publicProfilePrefs[r[1]]||0]}`,9,1,Math.sin(t*1.8+i));
  });
  BTNS.publicProfileRequests={x:x+16,y:y+322,w:w-32,h:34};
  drawNeonBtn(BTNS.publicProfileRequests.x,BTNS.publicProfileRequests.y,BTNS.publicProfileRequests.w,BTNS.publicProfileRequests.h,CFG.YL,`VIEW FRIEND REQUESTS (RECEIVED ${socialCounters.received} | SENT ${socialCounters.sent})`,9,1,Math.sin(t*2.3));
  BTNS.publicProfileFriends={x:x+16,y:y+368,w:w-32,h:34};
  drawNeonBtn(BTNS.publicProfileFriends.x,BTNS.publicProfileFriends.y,BTNS.publicProfileFriends.w,BTNS.publicProfileFriends.h,CFG.CY,`VIEW FRIENDS ${socialCounters.friends} | ${socialCounters.followers} FOLLOWERS | ${socialCounters.following} FOLLOWING`,9,1,0);
  BTNS.publicProfileBack={x:(LW-220)/2,y:LH-52,w:220,h:34};
  drawNeonBtn(BTNS.publicProfileBack.x,BTNS.publicProfileBack.y,BTNS.publicProfileBack.w,BTNS.publicProfileBack.h,CFG.PK,'RETURN TO PRIVATE PROFILE',10,1,Math.sin(t*2));
}

function drawSocialRows(t,title,sub,list,mode){
  BTNS.socialActionAList=[];
  BTNS.socialActionBList=[];
  BTNS.socialRowOpenList=[];
  const x=28,y=102,w=LW-56,h=520;
  ctx.fillStyle='rgba(8,10,14,0.95)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(255,230,0,0.35)'; ctx.strokeRect(x,y,w,h);
  setFont(22,'900'); glow(CFG.YL,12); txt(title,LW/2,60,CFG.YL);
  setFont(9,'700',"'Share Tech Mono',monospace"); noGlow(); txt(sub,LW/2,80,'rgba(255,240,150,0.9)');
  BTNS.socialTabFriends={x:x+8,y:y-2,w:104,h:24};
  BTNS.socialTabFollowers={x:x+118,y:y-2,w:104,h:24};
  if (mode==='list') BTNS.socialTabFollowing={x:x+228,y:y-2,w:104,h:24}; else BTNS.socialTabFollowing=null;
  drawNeonBtn(BTNS.socialTabFriends.x,BTNS.socialTabFriends.y,BTNS.socialTabFriends.w,BTNS.socialTabFriends.h,CFG.CY,mode==='requests'?'RECEIVED':'FRIENDS',8,1,0);
  drawNeonBtn(BTNS.socialTabFollowers.x,BTNS.socialTabFollowers.y,BTNS.socialTabFollowers.w,BTNS.socialTabFollowers.h,CFG.PU,mode==='requests'?'SENT':'FOLLOWERS',8,1,0);
  if (mode==='list') drawNeonBtn(BTNS.socialTabFollowing.x,BTNS.socialTabFollowing.y,BTNS.socialTabFollowing.w,BTNS.socialTabFollowing.h,CFG.GR,'FOLLOWING',8,1,0);

  const listX=x+8,listY=y+30,listW=w-16,listH=h-38;
  socialView.viewH=listH;
  socialView.contentH=Math.max(listH,Math.max(1,list.length)*58+8);
  socialView.scroll=clamp(socialView.scroll,minSocialScroll(),0);
  ctx.save(); ctx.beginPath(); ctx.rect(listX,listY,listW,listH); ctx.clip(); ctx.translate(0,socialView.scroll);
  socialView.renderCount=Math.min(list.length,socialView.renderCount+4);
  for (let i=0;i<socialView.renderCount;i++) {
    const it=list[i]||{};
    const ry=listY+8+i*58;
    ctx.fillStyle=(i%2===0)?'rgba(255,255,255,0.03)':'rgba(0,0,0,0.0)'; ctx.fillRect(listX,ry-12,listW,54);
    const ax=listX+16, ay=ry+6, ar=11;
    const av=String(it.avatar||'');
    if (av) { const img=new Image(); img.src=av; ctx.save(); ctx.beginPath(); ctx.arc(ax,ay,ar,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,ax-ar,ay-ar,ar*2,ar*2); ctx.restore(); }
    else { circle(ax,ay,ar,'#1f2c36',true); drawDefaultProfileIcon(ax,ay,ar,'rgba(216,246,255,0.95)'); }
    ctx.strokeStyle='rgba(0,245,255,0.55)'; ctx.lineWidth=1; circle(ax,ay,ar+1,CFG.CY,false);
    drawStatusDot(ax+12,ay+10,resolveDisplayStatus(it));
    setFont(10,'900'); glow(CFG.CY,6); txt((it.name||'Runner').slice(0,20),listX+34,ry+4,CFG.CY,'left');
    setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); const rowStatus=resolveDisplayStatus(it);
    if (rowStatus==='offline') {
      const om=offlineMeta(it.lastSeen||Date.now());
      const offText=om.isLong?'Offline':`Offline · was seen ${om.short} ago`;
      txt(offText,listX+34,ry+20,'rgba(210,230,255,0.78)','left');
    } else {
      txt(`${STATUS_LABELS[rowStatus]||rowStatus}`,listX+34,ry+20,'rgba(210,230,255,0.78)','left');
    }
    if (mode==='requests') {
      BTNS.socialActionAList[i]={x:listX+listW-88,y:ry-8,w:36,h:22,idx:i};
      BTNS.socialActionBList[i]={x:listX+listW-46,y:ry-8,w:36,h:22,idx:i};
      const aLbl=(socialView.mode==='received')?'✓':'👤';
      drawNeonBtn(BTNS.socialActionAList[i].x,BTNS.socialActionAList[i].y,36,22,socialView.mode==='received'?CFG.GR:'#888',aLbl,9,1,0);
      drawNeonBtn(BTNS.socialActionBList[i].x,BTNS.socialActionBList[i].y,36,22,CFG.PK,'✕',9,1,0);
    } else if (mode==='list') {
      BTNS.socialRowOpenList[i]={x:listX+listW-74,y:ry-8,w:66,h:22,idx:i};
      drawNeonBtn(BTNS.socialRowOpenList[i].x,BTNS.socialRowOpenList[i].y,66,22,CFG.CY,'VIEW',8,1,0);
    }
  }
  ctx.restore();
  if (socialView.loading) { drawLoadingDots(LW/2,y+h-20,t,CFG.CY); drawLoadingSquares(LW/2,y+h-40,t,CFG.CY); }
  if (!list.length && !socialView.loading) { setFont(10,'700',"'Share Tech Mono',monospace"); noGlow(); txt('No entries yet.',LW/2,y+44,'rgba(220,230,255,0.9)'); }

  if (minSocialScroll()<0) {
    const sbX=listX+listW-4,sbY=listY,sbH=listH;
    const th=Math.max(24,(listH/(listH+Math.abs(minSocialScroll())))*sbH);
    const ty=sbY + ((-socialView.scroll)/Math.abs(minSocialScroll()))*(sbH-th);
    ctx.fillStyle='rgba(0,245,255,0.18)'; ctx.fillRect(sbX,sbY,4,sbH);
    ctx.fillStyle='rgba(0,245,255,0.78)'; ctx.fillRect(sbX,ty,4,th);
  }

  BTNS.publicProfileBack={x:(LW-180)/2,y:LH-52,w:180,h:34};
  drawNeonBtn(BTNS.publicProfileBack.x,BTNS.publicProfileBack.y,BTNS.publicProfileBack.w,BTNS.publicProfileBack.h,CFG.PK,'← BACK',11,1,Math.sin(t*2));
}

function drawFriendRequestsScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.07,0.03); drawBgSquares();
  const list=socialView.mode==='sent'?socialData.sent:socialData.received;
  drawSocialRows(t,'FRIEND REQUESTS',`RECEIVED ${socialCounters.received}  |  SENT ${socialCounters.sent}`,list,'requests');
}

function drawFriendsListScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.07,0.03); drawBgSquares();
  const list=socialView.mode==='followers'?socialData.followers:(socialView.mode==='following'?socialData.following:socialData.friends);
  drawSocialRows(t,'SOCIAL LISTS',`FRIENDS ${socialCounters.friends} | FOLLOWERS ${socialCounters.followers} | FOLLOWING ${socialCounters.following}`,list,'list');
}

function drawFooter() {
  ctx.save();
  noGlow(); setFont(8,'400',"'Share Tech Mono',monospace"); ctx.globalAlpha=0.38;
  txt('2026 THEGENERIC. ALL RIGHTS RESERVED.',LW/2,LH-8,'rgba(0,245,255,0.45)');
  ctx.restore();
}

function drawAboutScreen(t) {
  drawPerspGrid(terrain.scrollY,0.03); drawTerrain();
  drawBgSquares();
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);

  setFont(34,'900'); glow(CFG.GR,22); txt('ABOUT',LW/2,58,CFG.GR);
  setFont(10,'400',"'Share Tech Mono',monospace"); noGlow();
  txt(`SLOPE v${VERSION} — pre-release patch stream`,LW/2,79,'rgba(57,255,20,0.65)');

  const boxX=24, boxY=108, boxW=LW-48, boxH=488;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.58)'; ctx.fillRect(boxX,boxY,boxW,boxH);
  ctx.strokeStyle='rgba(57,255,20,0.35)'; ctx.lineWidth=1.5; ctx.strokeRect(boxX,boxY,boxW,boxH);
  ctx.restore();

  const lines=[
    'pre-1.0.0 PATCH PREVIEW',
    '• Migrated Firebase mirror path to SLOPE/users',
    '• Added Google sign-in button on sign-in flow',
    '• Added profile change-password action + profile scrolling',
    '• Auth/sign-out now routes back to main menu',
    '• Expanded profile cloud-save details (gems, unlocks, cosmetics)',
    '',
    'v0.12.4 HOTFIX UPDATE',
    '• Removed duplicate RETURN BACK TO GAME auth button',
    '• Sign-in email defaults are now blank for cleaner UX',
    '• Input dialog now supports Ctrl/Cmd+A highlight/replace',
    '• General bug-fix and auth flow stability improvements'
  ];

  let y=boxY+28;
  lines.forEach((line,i)=>{
    if (!line) { y+=10; return; }
    const head=/^v0\./.test(line);
    setFont(head?11:9,head?'900':'700',"'Share Tech Mono',monospace");
    if (head) glow(CFG.CY,10); else noGlow();
    txt(line,boxX+14,y,head?CFG.CY:'rgba(230,255,255,0.82)','left');
    y+=head?24:20;
  });

  BTNS.back={x:(LW-150)/2,y:LH-54,w:150,h:32};
  drawNeonBtn(BTNS.back.x,BTNS.back.y,BTNS.back.w,BTNS.back.h,CFG.PK,'← BACK',11,0.9,Math.sin(t*2.2));
  drawFooter();
  ctx.restore();
}

function drawOptimizeConfirmPopup(t){
  if (!showOptimizeConfirm) return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.78)';
  ctx.fillRect(0,0,LW,LH);
  ctx.globalAlpha=0.95; ctx.fillStyle='#000';
  rrect(LW/2-132,LH/2-84,264,168,8); ctx.fill();
  ctx.strokeStyle=CFG.GR; ctx.lineWidth=2; glow(CFG.GR,14);
  rrect(LW/2-132,LH/2-84,264,168,8); ctx.stroke();
  ctx.globalAlpha=1;
  setFont(13,'900'); glow(CFG.GR,12); txt('OPTIMIZE GAME?',LW/2,LH/2-54,CFG.GR);
  setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.75;
  txt('Sets LOW quality + 30 FPS',LW/2,LH/2-34,'rgba(57,255,20,0.9)');
  txt('Disables particles, scanlines, shake',LW/2,LH/2-22,'rgba(57,255,20,0.9)');
  txt('and keeps control sensitivity values.',LW/2,LH/2-10,'rgba(57,255,20,0.9)');
  ctx.globalAlpha=1;
  BTNS.confirmYes={x:LW/2-112,y:LH/2+10,w:104,h:38};
  BTNS.confirmNo={x:LW/2+8,y:LH/2+10,w:104,h:38};
  drawNeonBtn(BTNS.confirmYes.x,BTNS.confirmYes.y,BTNS.confirmYes.w,BTNS.confirmYes.h,CFG.GR,'YES',13,1,Math.sin(t*4));
  drawNeonBtn(BTNS.confirmNo.x,BTNS.confirmNo.y,BTNS.confirmNo.w,BTNS.confirmNo.h,CFG.PK,'NO',13,1,Math.sin(t*3.5));
  ctx.restore();
}

function drawControlsScreen(t) {
  drawPerspGrid(terrain.scrollY,0.03); drawTerrain(); drawBgSquares();
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(34,'900'); glow(CFG.GR,22); txt('CONTROLS',LW/2,58,CFG.GR);
  const boxX=20,boxY=100,boxW=LW-40,boxH=520;
  ctx.fillStyle='rgba(0,0,0,0.58)'; ctx.fillRect(boxX,boxY,boxW,boxH);
  ctx.strokeStyle='rgba(57,255,20,0.35)'; ctx.lineWidth=1.5; ctx.strokeRect(boxX,boxY,boxW,boxH);
  const groups=[
    ['TOUCH','Swipe Left/Right or Joycons'],
    ['KEYBOARD','A/D or ←/→ to move · ESC pause'],
    ['CONTROLLER (XBOX)','Left Stick / D-Pad move · Start pause'],
    ['CONTROLLER (PLAYSTATION)','Left Stick / D-Pad move · Options pause'],
    ['CONTROLLER (NINTENDO)','Left Stick / D-Pad move · + pause'],
    ['GENERAL','All controllers use standard Gamepad API']
  ];
  groups.forEach((g,i)=>{
    const y=boxY+28+i*78;
    setFont(10,'900'); glow(CFG.CY,8); txt(g[0],boxX+14,y,CFG.CY,'left');
    setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); txt(g[1],boxX+14,y+22,'rgba(220,255,255,0.78)','left');
    ctx.strokeStyle='rgba(0,245,255,0.2)'; ctx.lineWidth=1; ctx.strokeRect(boxX+10,y+30,boxW-20,32);
  });
  BTNS.controlsBack={x:(LW-150)/2,y:LH-54,w:150,h:32};
  drawNeonBtn(BTNS.controlsBack.x,BTNS.controlsBack.y,150,32,CFG.PK,'← BACK',11,0.9,Math.sin(t*2));
  drawFooter();
  ctx.restore();
}

// ── MODE SELECT ───────────────────────────────────────────────────
function drawModeSelect(t) {
  drawPerspGrid(terrain.scrollY,0.05); drawTerrain();
  drawBgSquares();
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);

  setFont(30,'900'); glow(CFG.CY,20); txt('SELECT MODE',LW/2,62,CFG.CY);
  setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.55;
  txt('Pick a lane • each mode has unique pacing + rewards',LW/2,82,'rgba(0,245,255,0.55)'); ctx.globalAlpha=1;

  const cardY=102, cardH=382, cardW=88, gap=8;
  const startX=(LW-(cardW*4+gap*3))/2;

  const cards=[
    {key:'modeEndless',x:startX,col:CFG.CY,title:'ENDLESS',sub:'CLASSIC',icon:'∞',feats:['Classic run','No cap','Score chase'],btn:'PLAY'},
    {key:'modeAdventure',x:startX+cardW+gap,col:CFG.GR,title:'ADVENTURE',sub:'STAGES',icon:'🌀',feats:['Stage flow','Ramp','Rewards'],btn:'PLAY'},
    {key:'modeImpossible',x:startX+(cardW+gap)*2,col:'#ff4455',title:'IMPOSSIBLE',sub:'ONE LIFE',icon:'☠',feats:['4 brutal','No regen','Red storm'],btn:'PLAY'},
    {key:'modeLtm',x:startX+(cardW+gap)*3,col:'#ffd700',title:'LTM',sub:'GLOBAL LIVE',icon:'★',feats:['Global RTDB mode','Internet required','10 themed rotations'],btn:'SELECT'}
  ];

  cards.forEach((c,i)=>{
    const x=c.x,y=cardY;
    BTNS[c.key]={x,y,w:cardW,h:cardH};
    ctx.save();
    ctx.fillStyle=i===2?'rgba(255,50,50,0.12)':(i===1?'rgba(57,255,20,0.08)':'rgba(0,245,255,0.08)');
    ctx.fillRect(x,y,cardW,cardH);
    glow(c.col,14); ctx.strokeStyle=c.col; ctx.lineWidth=2; ctx.strokeRect(x,y,cardW,cardH);
    setFont(i===2?12:14,'900'); glow(c.col,10); txt(c.title,x+cardW/2,y+28,c.col);
    setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt(c.sub,x+cardW/2,y+44,c.col);
    if (i===2) {
      ctx.save(); ctx.fillStyle='#ffe600'; ctx.fillRect(x+cardW-34,y+4,30,12);
      setFont(7,'900',"'Share Tech Mono',monospace"); noGlow(); txt('NEW!',x+cardW-19,y+13,'#000'); ctx.restore();
    }
    setFont(26,'900'); glow(c.col,14); txt(c.icon,x+cardW/2,y+100,c.col);
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow();
    c.feats.forEach((f,j)=>txt(`• ${f}`,x+10,y+136+j*16,c.col,'left'));
    const modeBest=i===0?Number(modeScores.endless||0):i===1?Number(modeScores.adventure||0):i===2?Number(modeScores.impossible||0):Number(modeScores.ltm||0);
    setFont(7,'700',"'Share Tech Mono',monospace"); noGlow();
    txt(`MY HIGHSCORE ${Math.floor(modeBest||0)}`,x+cardW/2,y+cardH-50,'rgba(220,245,255,0.85)');
    const btnLbl=(c.key==='modeLtm'&&!isAdminUser)?'PLAY':c.btn;
    drawNeonBtn(x+10,y+cardH-38,cardW-20,28,c.col,btnLbl,10,1,Math.sin(t*3+i));
    ctx.restore();
  });

  if (navigator.onLine && (Date.now()-ltmConfigFetchAt>16000)) loadGlobalLtmConfig(false);
  const daily=getActiveLtm();
  const dailyIdx=clamp(ltmSelectedIndex>=0?ltmSelectedIndex:getDailyLtmIndex(),0,Math.max(0,LTM_MODES.length-1));
  const themeA=daily.cardCol||'#ffd700';
  const nextCol=(LTM_MODES[(dailyIdx+1)%LTM_MODES.length]&&LTM_MODES[(dailyIdx+1)%LTM_MODES.length].cardCol)||'#ffe45a';
  const soonW=cardW*4+gap*3, soonH=62, soonX=startX, soonY=cardY+cardH+12;
  ctx.save();
  const bg=ctx.createLinearGradient(soonX,0,soonX+soonW,0);
  bg.addColorStop(0,hexToRgba(themeA,0.18));
  bg.addColorStop(1,hexToRgba(nextCol,0.18));
  ctx.fillStyle=bg; ctx.fillRect(soonX,soonY,soonW,soonH);
  glow(themeA,12); ctx.strokeStyle=hexToRgba(themeA,0.92); ctx.lineWidth=2; ctx.strokeRect(soonX,soonY,soonW,soonH);
  const shineX=soonX + ((Math.sin(t*1.6)+1)/2)*(soonW+120)-120;
  const shine=ctx.createLinearGradient(shineX,0,shineX+120,0);
  shine.addColorStop(0,'transparent');
  shine.addColorStop(0.5,'rgba(255,255,255,0.2)');
  shine.addColorStop(1,'transparent');
  ctx.fillStyle=shine; ctx.fillRect(soonX,soonY,soonW,soonH);
  setFont(9,'900',"'Share Tech Mono',monospace"); noGlow();
  txt(`LTM ${dailyIdx+1}/10 • ${daily.name}`,soonX+10,soonY+18,'#0d0d0d','left');
  setFont(8,'700',"'Share Tech Mono',monospace");
  txt(`${daily.desc||'Live special mode'} • ${(daily.specialName||'Mode bonus').slice(0,26)}`,soonX+10,soonY+34,'#ffffff','left');
  const netTxt=navigator.onLine?`GLOBAL ROTATION • NEXT UPDATE IN ${getDailyCountdown()}`:'OFFLINE • LTM PLAY DISABLED';
  txt(netTxt,soonX+10,soonY+50,'#0d0d0d','left');
  ctx.restore();

  const bW=130,bH=34,bX=(LW-bW)/2,bY=LH-46;
  BTNS.back={x:bX,y:bY,w:bW,h:bH};
  drawNeonBtn(bX,bY,bW,bH,CFG.PK,'← BACK',11,0.85,Math.sin(t*2));
  ctx.restore();
}


function drawImpossibleIntro(t) {
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  const pix=16;
  for (let y=0;y<LH;y+=pix) {
    for (let x=0;x<LW;x+=pix) {
      if (Math.random()<0.08) { ctx.fillStyle='rgba(180,20,20,0.22)'; ctx.fillRect(x,y,pix,pix); }
    }
  }
  for (let i=0;i<26;i++) {
    const cx=(i*37+t*22)%LW, cy=(i*53+t*10)%LH;
    ctx.fillStyle='rgba(160,160,160,0.08)'; circle(cx,cy,18+rnd(0,22),'rgba(160,160,160,0.08)');
  }
  let title='WELCOME TO IMPOSSIBLE MODE';
  let sub='One life only. Survive if you can.';
  if (impossibleIntroT>2.8) {
    const c=Math.max(0,3-Math.floor(impossibleIntroT-2.8));
    title=c>0?String(c):'GO!';
    sub='STAGE 1: Defeat the Evil!';
  }
  setFont(22,'900'); glow('#ff3344',22); txt(title,LW/2,LH*0.34,'#ff3344');
  setFont(10,'700',"'Share Tech Mono',monospace"); noGlow(); txt(sub,LW/2,LH*0.34+24,'rgba(255,180,180,0.85)');
  const py=impossibleIntroT>5.6?lerp(LH*0.58,PLAYER_BASE_Y,Math.min(1,(impossibleIntroT-5.6)/1.2)):LH*0.58;
  glow('#ff7744',18); circle(LW/2,py,CFG.PR+2,'#ff7744');
  setFont(9,'700',"'Share Tech Mono',monospace"); txt('IMPOSSIBLE STARTS IN',LW/2,LH*0.62,'rgba(255,120,120,0.85)');
}

// ── QUESTS SCREEN ─────────────────────────────────────────────────
let questScroll=0;
let questFilter=0, questFilterOpen=false;
const QUEST_FILTERS=['DEFAULT','SCORE','SURVIVE','COLLECT'];
function getFilteredObjectives() {
  const all=(ACTIVE_OBJECTIVES||[]);
  if (questFilter===1) return all.filter(o=>/score|points|combo|stage/i.test(`${o.label} ${o.desc}`));
  if (questFilter===2) return all.filter(o=>/survive|stay alive|seconds|\bs\b|time/i.test(`${o.label} ${o.desc}`));
  if (questFilter===3) return all.filter(o=>/collect|gems|powerups|use /i.test(`${o.label} ${o.desc}`));
  return all;
}

function minQuestScroll() {
  const rows=(getFilteredObjectives().length||0);
  const contentH=Math.max(0, rows*72);
  const viewH=(LH-150)-8;
  return Math.min(0, viewH-contentH);
}
function drawQuestsScreen(t) {
  refreshHourlyObjectives();
  questScroll=clamp(questScroll,minQuestScroll(),0);
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(0,0.06); drawBgSquares();
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);

  setFont(32,'900'); glow(CFG.YL,20); txt('QUESTS',LW/2,52,CFG.YL);
  ctx.save(); ctx.strokeStyle='rgba(255,230,0,0.3)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(40,66); ctx.lineTo(LW-40,66); ctx.stroke(); ctx.restore();

  // Stats summary
  const filteredObjectives=getFilteredObjectives();
  setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.55;
  const done=OBJECTIVES.filter(o=>doneObjs.includes(o.id)).length;
  txt(`${done}/${OBJECTIVES.length} total completed  ·  ${filteredObjectives.length} shown`,LW/2,82,'rgba(255,230,0,0.6)');
  ctx.globalAlpha=1;

  // Filter dropdown
  const fx=18,fy=70,fw=126,fh=18;
  BTNS.questsFilter={x:fx,y:fy,w:fw,h:fh};
  drawNeonBtn(fx,fy,fw,fh,CFG.CY,`FILTER: ${QUEST_FILTERS[questFilter]} ▾`,8,0.7,0);
  if (questFilterOpen) {
    for (let i=0;i<QUEST_FILTERS.length;i++) {
      const oy=fy+fh+2+i*(fh+2);
      BTNS[`questsFilterOpt${i}`]={x:fx,y:oy,w:fw,h:fh};
      drawNeonBtn(fx,oy,fw,fh,i===questFilter?CFG.GR:CFG.PU,QUEST_FILTERS[i],8,0.65,0);
    }
  } else {
    BTNS.questsFilterOpt0=BTNS.questsFilterOpt1=BTNS.questsFilterOpt2=BTNS.questsFilterOpt3=null;
  }

  // Objectives list (scrollable clip)
  ctx.save();
  ctx.beginPath(); ctx.rect(0,90,LW,LH-150); ctx.clip();
  filteredObjectives.forEach((obj,i)=>{
    const done=doneObjs.includes(obj.id);
    const y=98+i*72+questScroll;
    if (y<80||y>LH-80) return;
    const bx=16,bw=LW-32,bh=62;
    ctx.save();
    ctx.fillStyle=done?'rgba(57,255,20,0.08)':'rgba(0,245,255,0.05)';
    ctx.fillRect(bx,y,bw,bh);
    ctx.strokeStyle=done?CFG.GR:'rgba(0,245,255,0.25)';
    ctx.lineWidth=1.2; ctx.strokeRect(bx,y,bw,bh);

    // Status icon
    setFont(14,'900'); glow(done?CFG.GR:CFG.CY,done?12:6);
    txt(done?'✔':'○',bx+18,y+26,done?CFG.GR:'rgba(0,245,255,0.4)');

    // Labels
    setFont(10,'900'); glow(done?CFG.GR:CFG.CY,done?8:6);
    txt(obj.label,bx+34,y+18,done?CFG.GR:CFG.CY,'left');
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.55;
    txt(obj.desc,bx+34,y+32,done?'rgba(57,255,20,0.7)':'rgba(0,245,255,0.6)','left');

    // Reward
    setFont(9,'700'); glow(CFG.YL,done?6:4); ctx.globalAlpha=done?0.9:0.6;
    txt(`+${obj.reward} ◆`,bx+bw-12,y+26,CFG.YL,'right');

    if (done) {
      ctx.save(); setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.4;
      txt('COMPLETED',bx+bw-12,y+42,CFG.GR,'right'); ctx.restore();
    }
    ctx.restore();
  });
  ctx.restore();

  // Glitched scrollbar
  const viewTop=90, viewH=LH-150, trackX=LW-10;
  const minS=minQuestScroll();
  const contentH=Math.max(viewH, getFilteredObjectives().length*72);
  const thumbH=Math.max(24, viewH*(viewH/contentH));
  const scrollRange=Math.max(1, viewH-thumbH);
  const thumbY=viewTop + (minS===0?0:((-questScroll)/Math.abs(minS))*scrollRange);
  ctx.save();
  ctx.globalAlpha=0.6;
  ctx.fillStyle='rgba(255,0,110,0.2)';
  ctx.fillRect(trackX,viewTop,4,viewH);
  ctx.fillStyle='rgba(0,245,255,0.7)';
  ctx.fillRect(trackX,thumbY,4,thumbH);
  if (Math.sin(t*18)>0.3) {
    ctx.fillStyle='rgba(255,230,0,0.8)';
    ctx.fillRect(trackX-1,thumbY+rnd(0,thumbH-2),6,2);
  }
  ctx.restore();

  // Back button
  const bW=140,bH=38,bX=(LW-bW)/2,bY=LH-50;
  BTNS.questsBack={x:bX,y:bY,w:bW,h:bH};
  drawNeonBtn(bX,bY,bW,bH,CFG.PK,'← BACK',12,1,Math.sin(t*2.5));
  ctx.restore();
}


function drawLeaderboardScreen(t) {
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY,0.06); drawBgSquares();
  ctx.save();
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(32,'900'); glow(CFG.GR,20); txt('LEADERBOARD',LW/2,54,CFG.GR);
  setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.6;
  txt('Top 100 · refreshes every hour',LW/2,72,CFG.CY); ctx.globalAlpha=1;
  const tabs=['GLOBAL','ENDLESS','ADVENTURE','IMPOSSIBLE','LTM'];
  const tabY=78, tabW=72, tabH=16, tabGap=4, tabX=(LW-(tabW*tabs.length+tabGap*(tabs.length-1)))/2;
  tabs.forEach((tb,i)=>{
    const x=tabX+i*(tabW+tabGap);
    BTNS['leaderboardTab'+tb.charAt(0)+tb.slice(1).toLowerCase()]={x,y:tabY,w:tabW,h:tabH};
    const on=leaderboardCategory===tb;
    ctx.fillStyle=on?'rgba(57,255,20,0.28)':'rgba(0,0,0,0.35)'; ctx.fillRect(x,tabY,tabW,tabH);
    ctx.strokeStyle=on?CFG.GR:'rgba(130,130,130,0.4)'; ctx.strokeRect(x,tabY,tabW,tabH);
    setFont(7,'900',"'Share Tech Mono',monospace"); txt(tb,x+tabW/2,tabY+11,on?CFG.GR:'#9ea6ad');
  });

  const bx=24,by=98,bw=LW-48,bh=520;
  const listX=bx+10, listY=by+42, listW=bw-20, listH=bh-54;
  leaderboardViewH=listH;
  ctx.fillStyle='rgba(0,0,0,0.58)'; ctx.fillRect(bx,by,bw,bh);
  ctx.strokeStyle='rgba(57,255,20,0.35)'; ctx.lineWidth=1.5; ctx.strokeRect(bx,by,bw,bh);

  setFont(10,'900'); glow(CFG.YL,10);
  txt('RANK',listX+12,by+26,CFG.YL,'left');
  txt('PLAYER',listX+74,by+26,CFG.YL,'left');
  txt('SCORE',bx+bw-20,by+26,CFG.YL,'right');
  ctx.strokeStyle='rgba(57,255,20,0.25)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(listX,by+30); ctx.lineTo(listX+listW,by+30); ctx.stroke();

  if (!navigator.onLine) {
    setFont(14,'900'); glow(CFG.PK,12); txt('PLAYER OFFLINE',LW/2,LH/2-8,CFG.PK);
    setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); txt('Connect to internet to load leaderboard.',LW/2,LH/2+16,CFG.CY);
    leaderboardContentH=listH;
  } else if (!isSignedIn) {
    setFont(14,'900'); glow(CFG.PK,12); txt('SIGN IN REQUIRED',LW/2,LH/2-8,CFG.PK);
    setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); txt('Please sign in to view leaderboard.',LW/2,LH/2+16,CFG.CY);
    leaderboardContentH=listH;
  } else if (leaderboardState==='loading') {
    const sq=18, gap=10, total=3*sq+2*gap, sx=LW/2-total/2;
    for (let i=0;i<3;i++) {
      const a=0.25+0.75*Math.max(0,Math.sin(t*8+i*0.8));
      ctx.globalAlpha=a; ctx.fillStyle=CFG.CY; ctx.fillRect(sx+i*(sq+gap),LH/2-20,sq,sq);
    }
    ctx.globalAlpha=0.9; setFont(11,'700'); glow(CFG.CY,10); txt('FETCHING...',LW/2,LH/2+20,CFG.CY);
    leaderboardContentH=listH;
  } else if (leaderboardState==='error') {
    setFont(14,'900'); glow(CFG.PK,12); txt('UNAVAILABLE',LW/2,LH/2-8,CFG.PK);
    setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); txt('Could not fetch leaderboard.',LW/2,LH/2+16,CFG.CY);
    leaderboardContentH=listH;
  } else {
    const rowH=18;
    leaderboardContentH=10 + (100*rowH);
    leaderboardScroll=clamp(leaderboardScroll,minLeaderboardScroll(),0);
    ctx.save();
    ctx.beginPath(); ctx.rect(listX,listY,listW,listH); ctx.clip();
    ctx.translate(0,leaderboardScroll);
    for (let i=0;i<100;i++) {
      const r=leaderboardData[i]||{name:'—',score:0,empty:true};
      const y=listY+8+i*rowH;
      const rowBg=(i%2===0)?'rgba(60,255,90,0.05)':'rgba(0,0,0,0)';
      ctx.fillStyle=rowBg; ctx.fillRect(listX,y-10,listW,rowH);
      let col='rgba(190,210,230,0.95)';
      if (i===0) col='#ffd700';
      else if (i===1) col='#e5ecf7';
      else if (i===2) col='#cd7f32';
      else if (i<=9) col='#ffffff';
      setFont(11,'700',"'Share Tech Mono',monospace"); noGlow();
      txt(`#${i+1}`,listX+8,y,col,'left');
      txt(String(r.name||'—').slice(0,20),listX+72,y,col,'left');
      txt(`${Math.floor(r.score||0)}`,listX+listW-10,y,col,'right');
    }
    ctx.restore();

    if (minLeaderboardScroll()<0) {
      const sbX=listX+listW-4, sbY=listY, sbH=listH;
      const thumbH=Math.max(24,(listH/(listH+Math.abs(minLeaderboardScroll())))*sbH);
      const track=sbH-thumbH;
      const thumbY=sbY + ((-leaderboardScroll)/Math.abs(minLeaderboardScroll()))*track;
      ctx.fillStyle='rgba(57,255,20,0.16)'; ctx.fillRect(sbX,sbY,4,sbH);
      ctx.fillStyle='rgba(57,255,20,0.78)'; ctx.fillRect(sbX,thumbY,4,thumbH);
    }
  }

  BTNS.leaderboardBack={x:(LW-140)/2,y:LH-48,w:140,h:34};
  const backLbl=leaderboardReturnState==='PAUSE'?'← PAUSE':(leaderboardReturnState==='OVER'?'← WIPEOUT':'← BACK');
  drawNeonBtn((LW-140)/2,LH-48,140,34,CFG.PK,backLbl,11,1,Math.sin(t*2.5));
  ctx.restore();
}


function drawAdminLtmScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY,0.06); drawBgSquares();
  setFont(28,'900'); glow(CFG.YL,18); txt('SELECT LTM MODE',LW/2,54,CFG.YL);
  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt('LIVE MODE + 10 TEST MODES (admin)',LW/2,72,'rgba(255,245,140,0.9)');
  const x=20,y=90,w=LW-40,h=560;
  ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(255,230,0,0.5)'; ctx.strokeRect(x,y,w,h);
  const rowH=124;
  adminLtmTestButtons=[];
  adminLtmViewH=h-10;
  adminLtmContentH=(LTM_MODES.length+1)*rowH+8;
  adminLtmScroll=clamp(adminLtmScroll,minAdminLtmScroll(),0);
  ctx.save(); ctx.beginPath(); ctx.rect(x+6,y+6,w-12,h-12); ctx.clip();
  ctx.translate(0,adminLtmScroll);
  const liveIdx=clamp(ltmSelectedIndex>=0?ltmSelectedIndex:getDailyLtmIndex(),0,Math.max(0,LTM_MODES.length-1));
  const live=LTM_MODES[liveIdx]||LTM_MODES[0];
  {
    const yy=y+12;
    ctx.fillStyle='rgba(255,230,0,0.08)'; ctx.fillRect(x+12,yy,w-24,102);
    ctx.strokeStyle='#ffe45a'; glow('#ffe45a',10); ctx.strokeRect(x+12,yy,w-24,102);
    setFont(14,'900'); txt(`LIVE MODE · ${live.name}`,x+24,yy+22,'#ffe45a','left');
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); txt((live.desc||'').slice(0,44),x+24,yy+38,'rgba(245,248,255,0.96)','left');
    txt(`Uses global daily config (${liveIdx+1}/10)`,x+24,yy+54,'rgba(240,245,255,0.88)','left');
    const tb={x:x+w-138,y:yy+62,w:110,h:26};
    adminLtmTestButtons[-1]=tb;
    drawNeonBtn(tb.x,tb.y,tb.w,tb.h,'#ffe45a','PLAY LIVE',9,1,Math.sin(t*2));
    txt('LIVE MODE',x+w-34,yy+22,CFG.GR,'right');
  }
  LTM_MODES.forEach((m,i)=>{
    const yy=y+12+(i+1)*rowH;
    ctx.fillStyle='rgba(255,255,255,0.04)'; ctx.fillRect(x+12,yy,w-24,102);
    ctx.strokeStyle=m.cardCol||CFG.YL; glow(m.cardCol||CFG.YL,8); ctx.strokeRect(x+12,yy,w-24,102);
    setFont(14,'900'); txt(`TEST ${i+1}. ${m.name}`,x+24,yy+22,m.cardCol||CFG.YL,'left');
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); txt((m.desc||'').slice(0,44),x+24,yy+38,'rgba(245,248,255,0.96)','left');
    const st=(m.stages||[]).map(s=>`${s.name.split(' ')[1]||''}:${s.label}`).join(' | ').slice(0,60);
    txt(st,x+24,yy+54,'rgba(240,245,255,0.88)','left');
    txt(`Starter PWR: ${(m.forcedPowerups||[]).slice(0,5).join(', ')}`,x+24,yy+70,'rgba(232,242,255,0.9)','left');
    const tb={x:x+w-138,y:yy+62,w:110,h:26};
    adminLtmTestButtons[i]=tb;
    drawNeonBtn(tb.x,tb.y,tb.w,tb.h,m.cardCol||CFG.CY,'PLAY TEST',9,1,Math.sin(t*2+i));
    txt('TEST MODE',x+w-34,yy+22,CFG.YL,'right');
  });
  ctx.restore();
  if (minAdminLtmScroll()<0) {
    const sbX=x+w-8, sbY=y+8, sbH=h-16;
    const thumbH=Math.max(26,(adminLtmViewH/(adminLtmViewH+Math.abs(minAdminLtmScroll())))*sbH);
    const track=sbH-thumbH;
    const thumbY=sbY + ((-adminLtmScroll)/Math.abs(minAdminLtmScroll()))*track;
    ctx.fillStyle='rgba(255,230,0,0.18)'; ctx.fillRect(sbX,sbY,4,sbH);
    ctx.fillStyle='rgba(255,230,0,0.9)'; ctx.fillRect(sbX,thumbY,4,thumbH);
  }
  BTNS.adminLtmBack={x:(LW-150)/2,y:LH-42,w:150,h:30};
  drawNeonBtn(BTNS.adminLtmBack.x,BTNS.adminLtmBack.y,150,30,CFG.PK,'← BACK',11,1,Math.sin(t*2));
}

function drawContinueOffer(t) {
  const boxX=34, boxY=LH*0.55, boxW=LW-68, boxH=150;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.65)'; ctx.fillRect(boxX,boxY,boxW,boxH);
  ctx.strokeStyle='rgba(0,245,255,0.35)'; ctx.lineWidth=1.5; ctx.strokeRect(boxX,boxY,boxW,boxH);
  setFont(13,'900'); glow(CFG.CY,12); txt('CONTINUE PLAYING',LW/2,boxY+20,CFG.CY);
  const pct=continueOfferTimer/10;
  ctx.fillStyle='rgba(0,245,255,0.15)'; ctx.fillRect(boxX+16,boxY+32,boxW-32,5);
  ctx.fillStyle=CFG.CY; glow(CFG.CY,8); ctx.fillRect(boxX+16,boxY+32,(boxW-32)*pct,5);
  const cost=CONTINUE_COSTS[continueAttempts]||CONTINUE_COSTS[CONTINUE_COSTS.length-1];
  const canAfford=totalGems>=cost;
  BTNS.continueBuy={x:boxX+20,y:boxY+52,w:boxW-40,h:36};
  drawNeonBtn(boxX+20,boxY+52,boxW-40,36,canAfford?CFG.CY:'#3a88ff',canAfford?`PURCHASE (${cost}◆)`:`LOCKED (${cost}◆)`,11,1,canAfford?Math.sin(t*5):0.3);
  BTNS.continueGiveUp={x:boxX+20,y:boxY+96,w:boxW-40,h:30};
  drawNeonBtn(boxX+20,boxY+96,boxW-40,30,CFG.PK,'GIVE UP',11,0.9,Math.sin(t*2));
  ctx.restore();
}

// ── GAME OVER SCREEN ──────────────────────────────────────────────
let overShakePow=0;
let continueAttempts=0;
let continueOfferTimer=0;
const CONTINUE_COSTS=[1000,2500,5000];
function drawGameOver(t) {
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  const sx=SETTINGS.screenShake?Math.sin(t*40)*overShakePow*2*(1-clamp(t/1.2,0,1)):0;
  ctx.save(); ctx.translate(sx,0);
  if (Math.sin(t*2.1)>0.7) {
    const ox=(Math.random()-.5)*14;
    ctx.globalAlpha=0.65; setFont(52,'900');
    ctx.fillStyle=CFG.PK; ctx.textAlign='center'; ctx.fillText('WIPEOUT',LW/2+ox,LH*0.22+3);
    ctx.fillStyle=CFG.CY; ctx.fillText('WIPEOUT',LW/2-ox,LH*0.22-2); ctx.globalAlpha=1;
  }
  glow(CFG.PK,28); ctx.fillStyle=CFG.PK; ctx.textAlign='center';
  setFont(52,'900'); ctx.fillText('WIPEOUT',LW/2,LH*0.22);
  setFont(10,'700',"'Share Tech Mono',monospace"); noGlow();
  txt('SCORE',LW/2,LH*0.33,'rgba(255,230,0,0.55)');
  setFont(52,'900'); glow(CFG.YL,24); txt(`${Math.floor(score)}`,LW/2,LH*0.39,CFG.YL);
  setFont(10,'700',"'Share Tech Mono',monospace"); noGlow();
  txt('HIGHSCORE',LW/2,LH*0.445,'rgba(0,245,255,0.55)');
  setFont(20,'900'); glow(CFG.CY,14);
  txt(`${Math.floor(bestScore)}`,LW/2,LH*0.48,score>=bestScore?CFG.YL:CFG.CY);
  if (score>=bestScore&&score>0) {
    ctx.globalAlpha=0.7+0.3*Math.sin(t*4); setFont(11,'700'); glow(CFG.YL,14);
    txt('★ NEW BEST! ★',LW/2,LH*0.48+20,CFG.YL); ctx.globalAlpha=1;
  }
  if (isStageMode()) {
    const st=currentStageConfig();
    setFont(10,'700'); glow(gameMode==='IMPOSSIBLE'?'#ff4455':CFG.GR,10);
    txt(`Reached: ${st.name} · ${st.label}`,LW/2,LH*0.52,gameMode==='IMPOSSIBLE'?'#ff4455':CFG.GR);
  }
  noGlow(); setFont(9,'400',"'Share Tech Mono',monospace"); ctx.globalAlpha=0.55;
  txt(`◆ ${gemsCollected} GEMS   ×${maxCombo} MAX COMBO`,LW/2,LH*0.54,CFG.CY);
  txt(`⏱ ${Math.floor(gameTime)}s SURVIVED   BANK: ${totalGems}◆`,LW/2,LH*0.54+17,CFG.CY);
  ctx.globalAlpha=1;
  BTNS.continueBuy=null; BTNS.continueGiveUp=null;
  const bW=170,bH=44,bX=(LW-bW)/2,retryY=LH*0.61;
  if (continueOfferTimer>0&&continueAttempts<3) {
    const boxX=34, boxY=LH*0.57, boxW=LW-68, boxH=130;
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(boxX,boxY,boxW,boxH);
    ctx.strokeStyle='rgba(0,245,255,0.35)'; ctx.lineWidth=1.5; ctx.strokeRect(boxX,boxY,boxW,boxH);
    setFont(12,'900'); glow(CFG.CY,12); txt('CONTINUE PLAYING',LW/2,boxY+18,CFG.CY);
    const pct=continueOfferTimer/10;
    ctx.fillStyle='rgba(0,245,255,0.15)'; ctx.fillRect(boxX+16,boxY+28,boxW-32,4);
    ctx.fillStyle=CFG.CY; glow(CFG.CY,8); ctx.fillRect(boxX+16,boxY+28,(boxW-32)*pct,4);
    const cost=CONTINUE_COSTS[continueAttempts];
    BTNS.continueBuy={x:boxX+20,y:boxY+46,w:boxW-40,h:32};
    drawNeonBtn(boxX+20,boxY+46,boxW-40,32,CFG.CY,`PURCHASE (${cost}◆)`,11,1,Math.sin(t*5));
    BTNS.continueGiveUp={x:boxX+20,y:boxY+86,w:boxW-40,h:28};
    drawNeonBtn(boxX+20,boxY+86,boxW-40,28,CFG.PK,'GIVE UP',10,0.9,Math.sin(t*2));
    ctx.restore();
  } else {
    BTNS.continueBuy=null; BTNS.continueGiveUp=null;
  }
  BTNS.retry={x:bX,y:retryY,w:bW,h:bH};
  drawNeonBtn(bX,retryY,bW,bH,CFG.CY,'↺  PLAY AGAIN',14,1,Math.sin(t*3.2));
  const lbY=retryY+54;
  BTNS.overLeaderboard={x:bX,y:lbY,w:bW,h:34};
  drawNeonBtn(bX,lbY,bW,34,CFG.GR,'🏆 MODE LEADERBOARD',10,0.9,Math.sin(t*2.8));
  const homeY=lbY+40;
  BTNS.home={x:bX,y:homeY,w:bW,h:bH};
  drawNeonBtn(bX,homeY,bW,bH,CFG.PK,'⌂  MAIN MENU',12,0.9,Math.sin(t*2.5));
  noGlow(); ctx.globalAlpha=0.3; setFont(9,'400',"'Share Tech Mono',monospace");
  txt(`v${VERSION}`,LW-14,LH-10,'rgba(0,245,255,0.2)','right');
  ctx.restore(); ctx.restore();
}

// ── PAUSE ─────────────────────────────────────────────────────────
function drawPause() {
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  const bannerY=LH*0.18;
  setFont(44,'900'); glow(CFG.CY,24); txt('PAUSED',LW/2,bannerY,CFG.CY);
  ctx.save(); const dw=160,dx2=(LW-dw)/2;
  const dg=ctx.createLinearGradient(dx2,0,dx2+dw,0);
  dg.addColorStop(0,'transparent'); dg.addColorStop(0.5,CFG.CY); dg.addColorStop(1,'transparent');
  ctx.strokeStyle=dg; ctx.lineWidth=1; glow(CFG.CY,6);
  ctx.beginPath(); ctx.moveTo(dx2,bannerY+14); ctx.lineTo(dx2+dw,bannerY+14); ctx.stroke(); ctx.restore();
  ctx.save(); const scoreY=bannerY+28;
  setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.5;
  txt('SCORE',LW/2,scoreY,CFG.CY);
  setFont(28,'900'); glow(CFG.YL,14); ctx.globalAlpha=1;
  txt(`${Math.floor(score)}`,LW/2,scoreY+24,CFG.YL);
  setFont(9,'700'); glow(CFG.CY,8); ctx.globalAlpha=0.75;
  txt(`◆ ${totalGems}  +${gemsCollected} this run`,LW/2,scoreY+42,CFG.CY);
  ctx.restore();

  const topThree=ACTIVE_OBJECTIVES.slice(0,3);
  ctx.save();
  setFont(9,'900'); glow(CFG.YL,10); txt('TOP QUESTS',LW/2,scoreY+62,CFG.YL);
  topThree.forEach((q,i)=>{
    const y=scoreY+80+i*20;
    setFont(8,'700'); glow(CFG.CY,7);
    txt(`${i+1}. ${q.label}`,LW/2,y,doneObjs.includes(q.id)?CFG.GR:CFG.CY);
  });
  ctx.restore();

  const bW=184,bH=42,bX=(LW-bW)/2;
  const resumeY=bannerY+150;
  BTNS.resume={x:bX,y:resumeY,w:bW,h:bH};
  drawNeonBtn(bX,resumeY,bW,bH,CFG.CY,'▶  RESUME',15,1,Math.sin(menuT*3.5));
  const lbY=resumeY+50;
  BTNS.leaderboardPause={x:bX,y:lbY,w:bW,h:bH};
  drawNeonBtn(bX,lbY,bW,bH,CFG.GR,'🏆 LEADERBOARD',12,0.9,Math.sin(menuT*2.4));
  const optY=lbY+50;
  BTNS.pauseOptions={x:bX,y:optY,w:bW,h:bH};
  drawNeonBtn(bX,optY,bW,bH,CFG.PU,'⚙ OPTIONS',13,0.9,Math.sin(menuT*2.6));
  const mmY=optY+50;
  BTNS.menuFromPause={x:bX,y:mmY,w:bW,h:bH};
  drawNeonBtn(bX,mmY,bW,bH,CFG.PK,'⚑  GIVE UP',13,0.9,Math.sin(menuT*2.2));
  ctx.save(); noGlow(); ctx.globalAlpha=0.25;
  setFont(8,'400',"'Share Tech Mono',monospace");
  txt('ESC / TAP PAUSE TO RESUME',LW/2,mmY+bH+14,'rgba(0,245,255,0.4)'); ctx.restore();
  ctx.restore();
}



let optionsReturnState='PAUSE';
let optionsScroll=0, optionsTouchY=null;
let settingsScroll=0, settingsTouchY=null;
let socialTouchY=null;
let profileScroll=0;
let profileViewH=402, profileContentH=620;
function minProfileScroll(){ return Math.min(0, profileViewH-profileContentH); }
function minOptionsScroll(){ const viewH=LH-200, contentH=7*76; return Math.min(0, viewH-contentH); }
function minSettingsScroll(){ const viewH=LH-210, contentH=860; return Math.min(0, viewH-contentH); }
function handleOptionsTap(p){
  if (hitBtn(p,BTNS.optionsBack)) { SFX.click(); doTransition(optionsReturnState); return; }
  const p2={x:p.x,y:p.y-optionsScroll};
  const rows=[['showQuestsInGame','optionsToggleQuests'],['showTutorials','optionsToggleTutorials'],['showFPS','_optFps'],['showTouchJoycons','_optJoy']];
  for (const [k,b] of rows) { if (hitBtn(p2,BTNS[b])) { SFX.click(); OPTION_PREFS[k]=!OPTION_PREFS[k]; saveOptionPrefs(); return; } }
  if (BTNS._optTouchL&&hitBtn(p2,BTNS._optTouchL)) { SETTINGS.touchSensitivity=clamp(SETTINGS.touchSensitivity-SENS_STEP,SENS_MIN,SENS_MAX); saveSettingsPrefs(); return; }
  if (BTNS._optTouchR&&hitBtn(p2,BTNS._optTouchR)) { SETTINGS.touchSensitivity=clamp(SETTINGS.touchSensitivity+SENS_STEP,SENS_MIN,SENS_MAX); saveSettingsPrefs(); return; }
  if (BTNS._optKbL&&hitBtn(p2,BTNS._optKbL)) { SETTINGS.keyboardSensitivity=clamp(SETTINGS.keyboardSensitivity-SENS_STEP,SENS_MIN,SENS_MAX); saveSettingsPrefs(); return; }
  if (BTNS._optKbR&&hitBtn(p2,BTNS._optKbR)) { SETTINGS.keyboardSensitivity=clamp(SETTINGS.keyboardSensitivity+SENS_STEP,SENS_MIN,SENS_MAX); saveSettingsPrefs(); return; }
  if (BTNS._optPadL&&hitBtn(p2,BTNS._optPadL)) { SETTINGS.controllerSensitivity=clamp(SETTINGS.controllerSensitivity-SENS_STEP,SENS_MIN,SENS_MAX); saveSettingsPrefs(); return; }
  if (BTNS._optPadR&&hitBtn(p2,BTNS._optPadR)) { SETTINGS.controllerSensitivity=clamp(SETTINGS.controllerSensitivity+SENS_STEP,SENS_MIN,SENS_MAX); saveSettingsPrefs(); return; }
}

function drawOptionsScreen(t){
  ctx.save();
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(36,'900'); glow(CFG.CY,20); txt('OPTIONS',LW/2,66,CFG.CY);
  setFont(9,'400',"'Share Tech Mono',monospace"); noGlow();
  txt('In-game preferences',LW/2,84,'rgba(0,245,255,0.5)');

  const viewY=126, viewH=LH-200;
  optionsScroll=clamp(optionsScroll,minOptionsScroll(),0);
  ctx.save();
  ctx.beginPath(); ctx.rect(0,viewY,LW,viewH); ctx.clip();
  ctx.translate(0,optionsScroll);
  const rows=[
    {k:'showQuestsInGame',label:'SHOW QUESTS IN-GAME',desc:'Quest panel on left side while playing',y:136,col:CFG.YL,id:'q'},
    {k:'showTutorials',label:'SHOW TUTORIALS',desc:'Early-run hint prompts and tips',y:212,col:CFG.PU,id:'t'},
    {k:'showFPS',label:'SHOW FPS',desc:'FPS counter in HUD and menus',y:288,col:CFG.CY,id:'f'},
    {k:'showTouchJoycons',label:'SHOW TOUCH JOYCONS',desc:'Animated side arrows for touch devices',y:364,col:CFG.GR,id:'j'},
  ];
  rows.forEach(r=>{
    const on=OPTION_PREFS[r.k];
    const x=26,w=LW-52,h=64;
    ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(x,r.y,w,h);
    ctx.strokeStyle=on?r.col:'rgba(120,120,120,0.35)'; ctx.lineWidth=1.4; ctx.strokeRect(x,r.y,w,h);
    setFont(10,'900'); glow(on?r.col:'#888',8); txt(r.label,x+14,r.y+20,on?r.col:'#9a9a9a','left');
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); txt(r.desc,x+14,r.y+36,'rgba(210,240,255,0.6)','left');
    const tx=LW-118,ty=r.y+18,tw=78,th=30;
    drawNeonBtn(tx,ty,tw,th,on?r.col:'#777',on?'ON':'OFF',10,1,on?Math.sin(t*2.3):0);
    if (r.id==='q') BTNS.optionsToggleQuests={x:tx,y:ty,w:tw,h:th};
    if (r.id==='t') BTNS.optionsToggleTutorials={x:tx,y:ty,w:tw,h:th};
    if (r.id==='f') BTNS._optFps={x:tx,y:ty,w:tw,h:th};
    if (r.id==='j') BTNS._optJoy={x:tx,y:ty,w:tw,h:th};
  });

  const sens=[
    {lbl:'TOUCH SENS',v:SETTINGS.touchSensitivity,col:CFG.PU,l:'_optTouchL',r:'_optTouchR',y:440},
    {lbl:'KEYBOARD SENS',v:SETTINGS.keyboardSensitivity,col:CFG.GR,l:'_optKbL',r:'_optKbR',y:516},
    {lbl:'CONTROLLER SENS',v:SETTINGS.controllerSensitivity,col:CFG.CY,l:'_optPadL',r:'_optPadR',y:592},
  ];
  sens.forEach(o=>{
    const x=26,w=LW-52,h=64;
    ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(x,o.y,w,h);
    ctx.strokeStyle=o.col; ctx.lineWidth=1.3; ctx.strokeRect(x,o.y,w,h);
    setFont(10,'900'); glow(o.col,8); txt(o.lbl,x+14,o.y+22,o.col,'left');
    const midX=LW-102, btnY=o.y+18;
    BTNS[o.l]={x:midX-58,y:btnY,w:34,h:28};
    BTNS[o.r]={x:midX+24,y:btnY,w:34,h:28};
    drawNeonBtn(BTNS[o.l].x,BTNS[o.l].y,34,28,o.col,'◀',10,1,0);
    drawNeonBtn(BTNS[o.r].x,BTNS[o.r].y,34,28,o.col,'▶',10,1,0);
    setFont(10,'900'); glow(o.col,8); txt(`${o.v.toFixed(1)}x`,midX,o.y+38,o.col);
  });

  ctx.restore();

  const minO=minOptionsScroll();
  if (minO<0) {
    const thumbH=Math.max(30,viewH*viewH/(viewH+Math.abs(minO)));
    const thumbY=viewY + ((-optionsScroll)/Math.abs(minO))*(viewH-thumbH);
    ctx.fillStyle='rgba(0,245,255,0.15)'; ctx.fillRect(LW-10,viewY,4,viewH);
    ctx.fillStyle='rgba(0,245,255,0.55)'; ctx.fillRect(LW-10,thumbY,4,thumbH);
  }

  BTNS.optionsBack={x:(LW-140)/2,y:LH-52,w:140,h:34};
  drawNeonBtn(BTNS.optionsBack.x,BTNS.optionsBack.y,140,34,CFG.PK,'← BACK',12,1,Math.sin(t*2.2));
  ctx.restore();
}

// ── SHOP SCREEN ───────────────────────────────────────────────────
const SHOP_CATALOG=[
  {key:'BOOST',        label:'×2 MULTIPLIER',  icon:'⚡', cost:200,  desc:'Double all gem pts'},
  {key:'MAGNET',       label:'MAGNET',          icon:'✦', cost:200,  desc:'Pulls gems & powerups'},
  {key:'JETPACK',      label:'STARTER JETPACK', icon:'🚀', cost:250,  desc:'10s flight! Invincible'},
  {key:'SHIELD',       label:'SHIELD',          icon:'🛡', cost:150,  desc:'Absorb one hit'},
  {key:'HEALTH_BOOST', label:'HEALTH BOOST',    icon:'❤', cost:300,  desc:'5 lives for 60s!'},
];
let shopOffers=[],shopSelected=-1,shopScroll=0,shopViewH=0,shopContentH=0;
const SHOP_RECTS=[];
function minShopScroll(){ return Math.min(0, shopViewH-shopContentH); }
function shuffleShop() {
  const pool=[...SHOP_CATALOG].sort(()=>Math.random()-0.5);
  shopOffers=pool.slice(0,3); shopSelected=-1; SHOP_RECTS.length=0; shopScroll=0;
}

function handleShopTap(p) {
  const p2={x:p.x,y:p.y-shopScroll};
  if (hitBtn(p2,BTNS.shopBack)) { SFX.click(); doTransition('MODESELECT'); return; }
  if (hitBtn(p2,BTNS.shopSkip)) { SFX.click(); startGame(null); return; }
  SHOP_RECTS.forEach((r,i)=>{ if (hitBtn(p2,r)) shopSelected=(shopSelected===i)?-1:i; });
  if (hitBtn(p2,BTNS.start)&&shopSelected>=0) { SFX.click();
    const offer=shopOffers[shopSelected];
    if (totalGems>=offer.cost) {
      totalGems-=offer.cost; saveBank(totalGems); startGame(offer.key);
    } else { addNotif(`Need ${offer.cost}◆ gems!`,CFG.PK); SFX.hit(); }
  } else if (hitBtn(p2,BTNS.start)&&shopSelected<0) { SFX.click(); startGame(null); }
}

function drawShopScreen(t) {
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.3,0.05);
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(26,'900'); glow(CFG.CY,18); txt('STARTER POWER-UP',LW/2,46,CFG.CY);
  setFont(11,'700'); glow(CFG.CY,10); txt(`◆ ${totalGems} GEMS`,LW/2,64,CFG.CY);
  // Game mode badge
  const modeLabel=gameMode==='LTM'?`LTM • ${getActiveLtm().name}`:`Mode: ${gameMode}`;
  setFont(9,'700'); glow(gameMode==='ADVENTURE'?CFG.GR:(gameMode==='LTM'?CFG.YL:CFG.CY),8);
  txt(modeLabel,LW/2,80,gameMode==='ADVENTURE'?CFG.GR:(gameMode==='LTM'?CFG.YL:CFG.CY));

  SHOP_RECTS.length=0;
  const cardW=116,cardH=158,gap=7;
  const totalW=cardW*3+gap*2,startX=(LW-totalW)/2;
  const viewTop=88,viewBottom=LH-10;
  shopViewH=viewBottom-viewTop;
  shopContentH=330;
  shopScroll=clamp(shopScroll,minShopScroll(),0);
  setFont(8,'400',"'Share Tech Mono',monospace"); noGlow();
  const modeHint=gameMode==='ENDLESS'?'Classic score chase with balanced spawn rates':(gameMode==='ADVENTURE'?'Stage ramp mode with progression pacing':(gameMode==='IMPOSSIBLE'?'One life only. No starter safety net.':`Special rules: ${(getActiveLtm().desc||'LTM active').slice(0,42)}`));
  txt(modeHint,LW/2,92,'rgba(220,235,255,0.8)');
  ctx.save();
  if (typeof clipRect==='function') clipRect(0,viewTop,LW,shopViewH);
  else { ctx.beginPath(); ctx.rect(0,viewTop,LW,shopViewH); ctx.clip(); }
  ctx.translate(0,shopScroll);

  shopOffers.forEach((offer,i)=>{
    const cx=startX+i*(cardW+gap),cy=92;
    const sel=shopSelected===i;
    const canAfford=totalGems>=offer.cost;
    const col=PWR_TYPES[offer.key]?.col||CFG.CY;
    const pulse=0.7+0.3*Math.sin(t*3+i*1.1);
    const dimA=canAfford?1:0.45;
    ctx.save();
    ctx.globalAlpha=(sel?0.22:0.07+0.04*Math.sin(t*2+i))*dimA;
    ctx.fillStyle=col; ctx.fillRect(cx,cy,cardW,cardH); ctx.restore();
    ctx.save();
    ctx.strokeStyle=col; ctx.lineWidth=sel?2.5:1.5;
    glow(col,sel?20:8); ctx.globalAlpha=(sel?1:pulse*0.7)*dimA;
    ctx.strokeRect(cx,cy,cardW,cardH); ctx.restore();
    if (sel) { ctx.save(); glow(col,14); ctx.fillStyle=col; setFont(12,'900'); txt('✔',cx+cardW-14,cy+16,col); ctx.restore(); }
    ctx.save(); ctx.font='bold 26px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    glow(col,18); ctx.fillStyle='#fff'; ctx.fillText(offer.icon,cx+cardW/2,cy+34); ctx.restore();
    ctx.save(); setFont(8,'700'); glow(col,10); txt(offer.label,cx+cardW/2,cy+62,col); ctx.restore();
    ctx.save(); setFont(7,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.55;
    txt(offer.desc,cx+cardW/2,cy+76,'#fff'); ctx.restore();
    // Duration
    const info=PWR_TYPES[offer.key];
    const durStr=offer.key==='SHIELD'?'150 SEC':offer.key==='JETPACK'?'10 SEC':offer.key==='HEALTH_BOOST'?'60 SEC':`${info?.dur||'?'}s`;
    ctx.save(); setFont(8,'700'); glow(col,6); ctx.globalAlpha=0.7;
    txt(`⏱ ${durStr}`,cx+cardW/2,cy+92,col); ctx.restore();
    ctx.save(); ctx.globalAlpha=0.85;
    ctx.fillStyle=canAfford?hexToRgba(CFG.YL,0.15):'rgba(255,0,60,0.15)';
    ctx.fillRect(cx+12,cy+cardH-28,cardW-24,18);
    setFont(9,'700'); glow(canAfford?CFG.YL:'#ff4466',8);
    txt(`◆ ${offer.cost}`,cx+cardW/2,cy+cardH-16,canAfford?CFG.YL:'#ff4466');
    if (!canAfford){setFont(7,'400',"'Share Tech Mono',monospace");noGlow();ctx.globalAlpha=0.5;txt('NOT ENOUGH',cx+cardW/2,cy+cardH-4,'rgba(255,100,100,0.8)');}
    ctx.restore();
    SHOP_RECTS.push({x:cx,y:cy,w:cardW,h:cardH});
  });

  const hasSelection=shopSelected>=0;
  const hasAffordable=shopOffers.some(o=>totalGems>=o.cost);
  const selOffer=hasSelection?shopOffers[shopSelected]:null;
  const canAffordSel=selOffer&&totalGems>=selOffer.cost;
  const btnY=LH*0.66,btnW=180,btnH=46,btnX=(LW-btnW)/2;
  BTNS.start={x:btnX,y:btnY,w:btnW,h:btnH};
  const lockMode=!hasSelection||!hasAffordable;
  const btnCol=lockMode?'#3a88ff':hasSelection?(canAffordSel?CFG.CY:CFG.PK):'rgba(0,245,255,0.4)';
  const btnLabel=lockMode?'🔒  LOCKED - SELECT ABOVE':canAffordSel?`▶  START -${selOffer.cost}◆`:`✗  NEED ${selOffer.cost}◆`;
  const pulse=lockMode?0.65+0.35*Math.sin(t*2.2):hasSelection?Math.sin(t*6):0.4;
  drawNeonBtn(btnX,btnY,btnW,btnH,btnCol,btnLabel,11,1,pulse);
  if (!lockMode&&hasSelection&&canAffordSel) {
    ctx.save();
    ctx.strokeStyle='#66bbff';
    ctx.lineWidth=2.2;
    glow('#66bbff',18);
    ctx.globalAlpha=0.5+0.5*Math.sin(t*12);
    ctx.strokeRect(btnX-2,btnY-2,btnW+4,btnH+4);
    ctx.restore();
  }
  const skipY=btnY+56,skipW=160,skipX=(LW-skipW)/2;
  BTNS.shopSkip={x:skipX,y:skipY,w:skipW,h:34};
  drawNeonBtn(skipX,skipY,skipW,34,CFG.PU,'SKIP — FREE START',10,0.7,Math.sin(t*2));
  const backY=skipY+46,backW=140,backX=(LW-backW)/2;
  BTNS.shopBack={x:backX,y:backY,w:backW,h:30};
  drawNeonBtn(backX,backY,backW,30,CFG.PK,'← BACK',9,0.85,0);
  shopContentH=backY+30-viewTop+10;
  ctx.restore();

  if (minShopScroll()<0) {
    const sbX=LW-10,sbY=viewTop,sbH=shopViewH;
    const thumbH=Math.max(24,(shopViewH/(shopViewH+Math.abs(minShopScroll())))*sbH);
    const track=Math.max(1,sbH-thumbH);
    const thumbY=sbY + ((-shopScroll)/Math.abs(minShopScroll()))*track;
    ctx.fillStyle='rgba(0,245,255,0.16)'; ctx.fillRect(sbX,sbY,4,sbH);
    ctx.fillStyle='rgba(0,245,255,0.62)'; ctx.fillRect(sbX,thumbY,4,thumbH);
  }
  ctx.restore();
}

// ── SETTINGS SCREEN ───────────────────────────────────────────────
let showOptimizeConfirm=false;
async function detectDisplayHz(sampleCount=40){
  return await new Promise(resolve=>{
    const ts=[];
    function step(t){
      ts.push(t);
      if (ts.length>=sampleCount){
        const ds=[]; for (let i=1;i<ts.length;i++) ds.push(ts[i]-ts[i-1]);
        const avg=ds.reduce((a,b)=>a+b,0)/Math.max(1,ds.length);
        const hz=avg>0?1000/avg:60;
        resolve(clamp(hz,30,240));
        return;
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  });
}

async function applyOptimize() {
  const hc=Number(navigator.hardwareConcurrency||4);
  const mem=Number(navigator.deviceMemory||4);
  let hz=60;
  try { hz=await detectDisplayHz(28); } catch(e) { hz=60; }

  const lowTier=(hc<=4)||(mem&&mem<=4);
  const midTier=(hc<=8)||(mem&&mem<=8);

  if (lowTier) {
    SETTINGS.gfxQuality=0;
    SETTINGS.particles=false; SETTINGS.scanlines=false; SETTINGS.screenShake=false;
  } else if (midTier) {
    SETTINGS.gfxQuality=1;
    SETTINGS.particles=true; SETTINGS.scanlines=false; SETTINGS.screenShake=true;
  } else {
    SETTINGS.gfxQuality=2;
    SETTINGS.particles=true; SETTINGS.scanlines=true; SETTINGS.screenShake=true;
  }

  SETTINGS.fpsLimit=(hz>=60)?1:0;
  OPTION_PREFS.showFPS=true;
  saveOptionPrefs(); saveSettingsPrefs();
  addNotif(`AUTO OPTIMIZED (${Math.round(hz)}Hz · ${hc}C/${mem||'?' }GB)`,CFG.GR);
}

const SETTING_DEFS=[
  {key:'sfx',        label:'SOUND FX',     desc:'Laser pings & effects'},
  {key:'particles',  label:'PARTICLES',    desc:'Burst & trail effects'},
  {key:'scanlines',  label:'SCANLINES',    desc:'CRT scanline overlay'},
  {key:'screenShake',label:'SCREEN SHAKE', desc:'Camera shake on hit'},
  {key:'showFPS',    label:'SHOW FPS',     desc:'FPS counter display'},
];
const SETTING_RECTS=[];
const SENS_MIN=0.5, SENS_MAX=2.0, SENS_STEP=0.1;

function handleSettingsTap(p) {
  const p2={x:p.x,y:p.y-settingsScroll};
  SETTING_RECTS.forEach(({key,rect})=>{ if(!hitBtn(p2,rect)) return; if (key==='showFPS') OPTION_PREFS.showFPS=!OPTION_PREFS.showFPS; else SETTINGS[key]=!SETTINGS[key]; saveOptionPrefs(); });
  // GFX slider
  if (BTNS._gfxLeft&&hitBtn(p2,BTNS._gfxLeft))  SETTINGS.gfxQuality=Math.max(0,SETTINGS.gfxQuality-1);
  if (BTNS._gfxRight&&hitBtn(p2,BTNS._gfxRight)) SETTINGS.gfxQuality=Math.min(2,SETTINGS.gfxQuality+1);
  // FPS slider
  if (BTNS._fpsLeft&&hitBtn(p2,BTNS._fpsLeft))   SETTINGS.fpsLimit=Math.max(0,SETTINGS.fpsLimit-1);
  if (BTNS._fpsRight&&hitBtn(p2,BTNS._fpsRight))  SETTINGS.fpsLimit=Math.min(2,SETTINGS.fpsLimit+1);
  if (BTNS._touchSensLeft&&hitBtn(p2,BTNS._touchSensLeft)) SETTINGS.touchSensitivity=clamp(SETTINGS.touchSensitivity-SENS_STEP,SENS_MIN,SENS_MAX);
  if (BTNS._touchSensRight&&hitBtn(p2,BTNS._touchSensRight)) SETTINGS.touchSensitivity=clamp(SETTINGS.touchSensitivity+SENS_STEP,SENS_MIN,SENS_MAX);
  if (BTNS._kbSensLeft&&hitBtn(p2,BTNS._kbSensLeft)) SETTINGS.keyboardSensitivity=clamp(SETTINGS.keyboardSensitivity-SENS_STEP,SENS_MIN,SENS_MAX);
  if (BTNS._kbSensRight&&hitBtn(p2,BTNS._kbSensRight)) SETTINGS.keyboardSensitivity=clamp(SETTINGS.keyboardSensitivity+SENS_STEP,SENS_MIN,SENS_MAX);
  if (BTNS._padSensLeft&&hitBtn(p2,BTNS._padSensLeft)) SETTINGS.controllerSensitivity=clamp(SETTINGS.controllerSensitivity-SENS_STEP,SENS_MIN,SENS_MAX);
  if (BTNS._padSensRight&&hitBtn(p2,BTNS._padSensRight)) SETTINGS.controllerSensitivity=clamp(SETTINGS.controllerSensitivity+SENS_STEP,SENS_MIN,SENS_MAX);
  saveSettingsPrefs();
}

function drawSettingsScreen(t) {
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(0,0.1); drawBgSquares();
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(36,'900'); glow(CFG.CY,20); txt('SETTINGS',LW/2,56,CFG.CY);
  ctx.save(); const ly=72;
  const dg=ctx.createLinearGradient((LW-120)/2,0,(LW+120)/2,0);
  dg.addColorStop(0,'transparent'); dg.addColorStop(0.5,CFG.CY); dg.addColorStop(1,'transparent');
  ctx.strokeStyle=dg; ctx.lineWidth=1; glow(CFG.CY,6);
  ctx.beginPath(); ctx.moveTo((LW-120)/2,ly); ctx.lineTo((LW+120)/2,ly); ctx.stroke(); ctx.restore();

  const sViewY=84, sViewH=LH-220;
  settingsScroll=clamp(settingsScroll,minSettingsScroll(),0);
  ctx.save();
  ctx.beginPath(); ctx.rect(0,sViewY,LW,sViewH); ctx.clip();
  ctx.translate(0,settingsScroll);

  SETTING_RECTS.length=0;
  SETTING_DEFS.forEach((def,i)=>{
    const row=84+i*66;
    const on=def.key==='showFPS'?OPTION_PREFS.showFPS:SETTINGS[def.key];
    const col=on?CFG.CY:CFG.PK;
    ctx.save(); ctx.globalAlpha=0.06+0.04*Math.sin(t*2+i);
    ctx.fillStyle=col; ctx.fillRect(16,row,LW-32,56); ctx.restore();
    noGlow(); setFont(11,'700'); glow(col,10); txt(def.label,LW*0.38,row+20,col,'center');
    noGlow(); setFont(8,'400',"'Share Tech Mono',monospace"); ctx.globalAlpha=0.45;
    txt(def.desc,LW*0.38,row+33,col,'center'); ctx.globalAlpha=1;
    const tw=56,th=26,tx=LW*0.72-tw/2,ty=row+15;
    ctx.save(); ctx.globalAlpha=on?1:0.55; glow(col,14);
    ctx.strokeStyle=col; ctx.lineWidth=2; ctx.strokeRect(tx,ty,tw,th);
    ctx.fillStyle=hexToRgba(col,on?0.2:0.05); ctx.fillRect(tx,ty,tw,th);
    setFont(10,'900'); glow(col,12); txt(on?'ON':'OFF',tx+tw/2,ty+th/2+4,on?'#fff':col);
    ctx.restore();
    SETTING_RECTS.push({key:def.key,rect:{x:tx,y:ty,w:tw,h:th}});
  });

  // Graphics quality slider
  const slY1=84+SETTING_DEFS.length*66+8;
  ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle=CFG.YL; ctx.fillRect(16,slY1,LW-32,50); ctx.restore();
  setFont(10,'700'); glow(CFG.YL,10); txt('GRAPHICS QUALITY',LW/2,slY1+16,CFG.YL);
  const gArW=30,gArH=24,gSlY=slY1+22;
  BTNS._gfxLeft={x:LW/2-70,y:gSlY,w:gArW,h:gArH};
  BTNS._gfxRight={x:LW/2+42,y:gSlY,w:gArW,h:gArH};
  drawNeonBtn(LW/2-70,gSlY,gArW,gArH,CFG.YL,'◀',10,0.8,0);
  setFont(11,'900'); glow(CFG.YL,12); txt(GFX_LABELS[SETTINGS.gfxQuality],LW/2,gSlY+16,CFG.YL);
  drawNeonBtn(LW/2+42,gSlY,gArW,gArH,CFG.YL,'▶',10,0.8,0);

  // FPS limit slider
  const slY2=slY1+58;
  ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle=CFG.CY; ctx.fillRect(16,slY2,LW-32,50); ctx.restore();
  setFont(10,'700'); glow(CFG.CY,10); txt('FPS LIMIT',LW/2,slY2+16,CFG.CY);
  const fArY=slY2+22;
  BTNS._fpsLeft={x:LW/2-70,y:fArY,w:gArW,h:gArH};
  BTNS._fpsRight={x:LW/2+42,y:fArY,w:gArW,h:gArH};
  drawNeonBtn(LW/2-70,fArY,gArW,gArH,CFG.CY,'◀',10,0.8,0);
  setFont(11,'900'); glow(CFG.CY,12); txt(FPS_LABELS[SETTINGS.fpsLimit],LW/2,fArY+16,CFG.CY);
  drawNeonBtn(LW/2+42,fArY,gArW,gArH,CFG.CY,'▶',10,0.8,0);

  // Input sensitivity sliders
  const sensY1=slY2+58;
  ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle=CFG.PU; ctx.fillRect(16,sensY1,LW-32,50); ctx.restore();
  setFont(10,'700'); glow(CFG.PU,10); txt('TOUCH SENSITIVITY',LW/2,sensY1+16,CFG.PU);
  BTNS._touchSensLeft={x:LW/2-70,y:sensY1+22,w:gArW,h:gArH};
  BTNS._touchSensRight={x:LW/2+42,y:sensY1+22,w:gArW,h:gArH};
  drawNeonBtn(BTNS._touchSensLeft.x,BTNS._touchSensLeft.y,gArW,gArH,CFG.PU,'◀',10,0.8,0);
  setFont(11,'900'); glow(CFG.PU,12); txt(`${SETTINGS.touchSensitivity.toFixed(1)}x`,LW/2,sensY1+39,CFG.PU);
  drawNeonBtn(BTNS._touchSensRight.x,BTNS._touchSensRight.y,gArW,gArH,CFG.PU,'▶',10,0.8,0);

  const sensY2=sensY1+58;
  ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle=CFG.GR; ctx.fillRect(16,sensY2,LW-32,50); ctx.restore();
  setFont(10,'700'); glow(CFG.GR,10); txt('KEYBOARD SENSITIVITY',LW/2,sensY2+16,CFG.GR);
  BTNS._kbSensLeft={x:LW/2-70,y:sensY2+22,w:gArW,h:gArH};
  BTNS._kbSensRight={x:LW/2+42,y:sensY2+22,w:gArW,h:gArH};
  drawNeonBtn(BTNS._kbSensLeft.x,BTNS._kbSensLeft.y,gArW,gArH,CFG.GR,'◀',10,0.8,0);
  setFont(11,'900'); glow(CFG.GR,12); txt(`${SETTINGS.keyboardSensitivity.toFixed(1)}x`,LW/2,sensY2+39,CFG.GR);
  drawNeonBtn(BTNS._kbSensRight.x,BTNS._kbSensRight.y,gArW,gArH,CFG.GR,'▶',10,0.8,0);

  const sensY3=sensY2+58;
  ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle=CFG.CY; ctx.fillRect(16,sensY3,LW-32,50); ctx.restore();
  setFont(10,'700'); glow(CFG.CY,10); txt('CONTROLLER SENSITIVITY',LW/2,sensY3+16,CFG.CY);
  BTNS._padSensLeft={x:LW/2-70,y:sensY3+22,w:gArW,h:gArH};
  BTNS._padSensRight={x:LW/2+42,y:sensY3+22,w:gArW,h:gArH};
  drawNeonBtn(BTNS._padSensLeft.x,BTNS._padSensLeft.y,gArW,gArH,CFG.CY,'◀',10,0.8,0);
  setFont(11,'900'); glow(CFG.CY,12); txt(`${SETTINGS.controllerSensitivity.toFixed(1)}x`,LW/2,sensY3+39,CFG.CY);
  drawNeonBtn(BTNS._padSensRight.x,BTNS._padSensRight.y,gArW,gArH,CFG.CY,'▶',10,0.8,0);

  // Optimize button
  const optY=sensY3+58, optW=180, optH=36, optX=(LW-optW)/2;
  BTNS.optimizeBtn={x:optX,y:optY,w:optW,h:optH};
  drawNeonBtn(optX,optY,optW,optH,CFG.GR,'⚡ OPTIMIZE GAME',12,1,Math.sin(t*2.5));

  ctx.restore();

  const minS=minSettingsScroll();
  if (minS<0) {
    const thumbH=Math.max(34,sViewH*sViewH/(sViewH+Math.abs(minS)));
    const thumbY=sViewY + ((-settingsScroll)/Math.abs(minS))*(sViewH-thumbH);
    ctx.fillStyle='rgba(0,245,255,0.15)'; ctx.fillRect(LW-10,sViewY,4,sViewH);
    ctx.fillStyle='rgba(0,245,255,0.55)'; ctx.fillRect(LW-10,thumbY,4,thumbH);
  }

  // Reset everything
  const rW=220,rH=34,rX=(LW-rW)/2,rY=LH-118;
  BTNS.resetBtn={x:rX,y:rY,w:rW,h:rH};
  drawNeonBtn(rX,rY,rW,rH,CFG.PK,'RESET EVERYTHING',11,0.9,Math.sin(t*2));

  // Back button
  const bW=140,bH=36,bX=(LW-bW)/2,bY=LH-68;
  BTNS.back={x:bX,y:bY,w:bW,h:bH};
  drawNeonBtn(bX,bY,bW,bH,CFG.PU,'← BACK',13,1,Math.sin(t*2.5));
  drawFooter();
  ctx.restore();
}
</script>

<!-- ============================================================ -->
<!--  SCRIPT 10b · OBJECTIVES & CHARACTER DATA                   -->
<!-- ============================================================ -->
<script id="s-objectives">
const QUEST_POOL_SIZE=780;
const QUESTS_PER_HOUR_MIN=16;
const QUESTS_PER_HOUR_MAX=20;

let jetpackCount=0, regenUsed=0;
let pwrCounts={JETPACK:0,MAGNET:0,BOOST:0,SHIELD:0,SLOW:0,HEALTH_BOOST:0,MINI_JETPACK:0,NEW_STAGE:0,REGEN:0,X2_GEMS:0,GEM_DROP:0,BAD_LUCK:0};

function makeQuest(id,label,desc,reward,check){ return {id,label,desc,reward,check}; }

function buildObjectivePool() {
  const q=[];
  const add=(label,desc,reward,check)=>q.push(makeQuest(`q${q.length+1}`,label,desc,reward,check));
  const addId=(id,label,desc,reward,check)=>q.push(makeQuest(id,label,desc,reward,check));

  // Legacy quest IDs kept for skin unlock compatibility
  addId('combo4','Hit ×4 Combo','Collect 15 gems in a row',500,()=>maxCombo>=4);
  addId('survive60','Survive 60s','Stay alive 60 seconds',200,()=>gameTime>=60);
  addId('gems200','Collect 200 Gems','In a single run',500,()=>gemsCollected>=200);
  addId('score5000','Score 5000','Reach 5000 points',500,()=>score>=5000);

  for (let t=10;t<=400;t+=5) add(`Collect ${t} Gems`,`In a single run`,80+Math.floor(t*1.8),()=>gemsCollected>=t);
  for (let t=500;t<=25000;t+=250) add(`Score ${t}`,`Reach ${t} points`,90+Math.floor(t/40),()=>score>=t);
  for (let t=20;t<=500;t+=10) add(`Survive ${t}s`,`Stay alive ${t} seconds`,100+Math.floor(t*3.2),()=>gameTime>=t);
  for (let t=2;t<=30;t++) add(`Hit ×${t} Combo`,`Build combo to ×${t}`,120+t*40,()=>maxCombo>=t);

  for (let t=1;t<=30;t++) add(`Use Jetpack x${t}`,`Collect ${t} jetpack powerups`,120+t*55,()=>pwrCounts.JETPACK>=t);
  for (let t=1;t<=30;t++) add(`Use Magnet x${t}`,`Collect ${t} magnet powerups`,120+t*50,()=>pwrCounts.MAGNET>=t);
  for (let t=1;t<=30;t++) add(`Use Score ×2 x${t}`,`Collect ${t} boost powerups`,120+t*50,()=>pwrCounts.BOOST>=t);
  for (let t=1;t<=25;t++) add(`Use Shield x${t}`,`Collect ${t} shield powerups`,120+t*55,()=>pwrCounts.SHIELD>=t);
  for (let t=1;t<=20;t++) add(`Use Regen x${t}`,`Restore life ${t} times`,140+t*70,()=>regenUsed>=t);
  for (let t=2;t<=6;t++) add(`Reach Stage ${t}`,`Adventure mode`,280+t*120,()=>gameMode==='ADVENTURE'&&adventureStage>=t-1);

  for (let t=2;t<=80;t+=2) add(`Collect ${t} Powerups`,`Any powerup type`,100+t*18,()=>Object.values(pwrCounts).reduce((a,b)=>a+b,0)>=t);

  // Endless-specific objectives
  for (let t=120;t<=1200;t+=30) add(`Endless: Survive ${t}s`,`ENDLESS mode only`,220+Math.floor(t*2.5),()=>gameMode==='ENDLESS'&&gameTime>=t);
  for (let t=2500;t<=65000;t+=500) add(`Endless: Score ${t}`,`ENDLESS mode only`,240+Math.floor(t/30),()=>gameMode==='ENDLESS'&&score>=t);
  for (let t=120;t<=900;t+=20) add(`Endless: Collect ${t} Gems`,`ENDLESS mode only`,200+Math.floor(t*2.1),()=>gameMode==='ENDLESS'&&gemsCollected>=t);

  // Adventure-specific objectives
  for (let t=2;t<=10;t++) add(`Adventure: Reach Stage ${t}`,`ADV mode only`,420+t*180,()=>gameMode==='ADVENTURE'&&adventureStage>=t-1);
  for (let t=3500;t<=38000;t+=500) add(`Adventure: Score ${t}`,`ADV mode only`,320+Math.floor(t/35),()=>gameMode==='ADVENTURE'&&score>=t);
  for (let t=1;t<=25;t++) add(`Adventure: Trigger New Stage x${t}`,`Collect NEW STAGE ${t} times`,420+t*80,()=>gameMode==='ADVENTURE'&&pwrCounts.NEW_STAGE>=t);

  // Impossible-heavy objectives
  for (let t=2;t<=12;t++) add(`Impossible: Reach Stage ${t}`,`IMPOSSIBLE mode only`,680+t*240,()=>gameMode==='IMPOSSIBLE'&&impossibleStage>=t-1);
  for (let t=6000;t<=90000;t+=750) add(`Impossible: Score ${t}`,`IMPOSSIBLE mode only`,540+Math.floor(t/28),()=>gameMode==='IMPOSSIBLE'&&score>=t);
  for (let t=90;t<=900;t+=15) add(`Impossible: Survive ${t}s`,`IMPOSSIBLE mode only`,500+Math.floor(t*4.2),()=>gameMode==='IMPOSSIBLE'&&gameTime>=t);
  for (let t=40;t<=520;t+=10) add(`Impossible: Collect ${t} Gems`,`IMPOSSIBLE mode only`,460+Math.floor(t*3.2),()=>gameMode==='IMPOSSIBLE'&&gemsCollected>=t);
  for (let t=1;t<=40;t++) add(`Impossible: Bad Luck x${t}`,`Collect BAD LUCK ${t} times`,520+t*110,()=>gameMode==='IMPOSSIBLE'&&pwrCounts.BAD_LUCK>=t);
  for (let t=1;t<=40;t++) add(`Impossible: Mini Jetpack x${t}`,`Collect MINI JETPACK ${t} times`,520+t*105,()=>gameMode==='IMPOSSIBLE'&&pwrCounts.MINI_JETPACK>=t);

  // trim/fill to exactly quest pool size
  while (q.length<QUEST_POOL_SIZE) {
    const t=q.length+1;
    add(`Precision Run ${t}`,`Score ${t*120} with no wall hit`,200+Math.floor(t*3.5),()=>score>=t*120&&lives===maxLives);
  }
  return q.slice(0,QUEST_POOL_SIZE);
}

const OBJECTIVES=buildObjectivePool();
let ACTIVE_OBJECTIVES=[];
let activeQuestHourKey='';

function getHourKey() {
  const d=new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}-${d.getHours()}`;
}
function hashStr(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function mulberry32(seed){ return function(){ seed|=0; seed=seed+0x6D2B79F5|0; let t=Math.imul(seed^seed>>>15,1|seed); t=t+Math.imul(t^t>>>7,61|t)^t; return ((t^t>>>14)>>>0)/4294967296; }; }

function refreshHourlyObjectives(force=false) {
  const k=getHourKey();
  if (!force && k===activeQuestHourKey && ACTIVE_OBJECTIVES.length) return;
  activeQuestHourKey=k;
  const rand=mulberry32(hashStr(`slope-${k}-${VERSION}`));
  const available=OBJECTIVES.filter(o=>!doneObjs.includes(o.id));
  const src=(available.length?available:OBJECTIVES).slice();
  for (let i=src.length-1;i>0;i--) {
    const j=Math.floor(rand()*(i+1));
    const t=src[i]; src[i]=src[j]; src[j]=t;
  }
  const pickCount=Math.min(src.length,rndI(QUESTS_PER_HOUR_MIN,QUESTS_PER_HOUR_MAX));
  ACTIVE_OBJECTIVES=src.slice(0,pickCount);
  questScroll=0;
}

function tickObjectives() {
  refreshHourlyObjectives();
  ACTIVE_OBJECTIVES.forEach(obj=>{
    if (doneObjs.includes(obj.id)) return;
    if (obj.check()) {
      doneObjs.push(obj.id); saveDoneObjs(doneObjs);
      totalGems=addToBank(obj.reward);
      objAnims.push({id:obj.id,t:3.5,label:obj.label,reward:obj.reward,col:CFG.YL});
      addNotif(`QUEST: ${obj.label} +${obj.reward}◆`,CFG.YL);
      CHAR_CATALOG.forEach(c=>{
        if (c.unlock==='obj'&&c.objId===obj.id&&!unlockedChars.includes(c.id)) {
          unlockChar(c.id); unlockedChars=loadUnlocked();
          addNotif(`UNLOCKED: ${c.name}!`,c.col);
        }
      });
    }
  });
}
function updateObjAnims(dt) {
  for (let i=objAnims.length-1;i>=0;i--) { objAnims[i].t-=dt; if(objAnims[i].t<=0) objAnims.splice(i,1); }
}
function drawObjAnims() {
  objAnims.forEach((a,i)=>{
    const slideX=lerp(-180,14,(3.5-a.t)*5);
    const fade=Math.min(1,a.t>0.3?1:a.t/0.3);
    const y=LH*0.35+i*36;
    ctx.save(); ctx.globalAlpha=fade*0.95;
    glow(a.col,12); ctx.fillStyle='rgba(2,5,8,0.90)'; ctx.fillRect(slideX,y,170,28);
    ctx.strokeStyle=a.col; ctx.lineWidth=1.5; ctx.strokeRect(slideX,y,170,28);
    setFont(11,'900'); glow(a.col,10); txt('✔',slideX+14,y+19,a.col,'left');
    setFont(8,'700'); glow(a.col,6); txt(a.label,slideX+26,y+12,a.col,'left');
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha*=0.7;
    txt(`+${a.reward} ◆`,slideX+26,y+24,CFG.YL,'left'); ctx.restore();
  });
}

function drawObjectivesPanel() {
  if (!OPTION_PREFS.showQuestsInGame) return;
  refreshHourlyObjectives();
  const active=ACTIVE_OBJECTIVES.filter(o=>!doneObjs.includes(o.id)).slice(0,3);
  if (!active.length) return;
  ctx.save();
  active.forEach((obj,i)=>{
    const x=8,y=LH*0.42+i*44;
    ctx.globalAlpha=0.6;
    ctx.fillStyle='rgba(2,5,8,0.75)'; ctx.fillRect(x,y,148,38);
    ctx.strokeStyle='rgba(0,245,255,0.25)'; ctx.lineWidth=1; ctx.strokeRect(x,y,148,38);
    setFont(8,'700'); noGlow(); ctx.globalAlpha=0.8;
    txt(obj.label,x+74,y+13,CFG.CY,'center');
    setFont(7,'400',"'Share Tech Mono',monospace"); ctx.globalAlpha=0.5;
    txt(obj.desc,x+74,y+25,'rgba(0,245,255,0.6)','center');
    setFont(8,'700'); ctx.globalAlpha=0.75;
    txt(`+${obj.reward}◆`,x+74,y+36,CFG.YL,'center');
  });
  ctx.restore();
}


function drawTutorialHint() {
  if (!OPTION_PREFS.showTutorials || gameTime>9) return;
  ctx.save();
  const a=0.45+0.4*Math.sin(menuT*3);
  ctx.globalAlpha=a;
  setFont(9,'700',"'Share Tech Mono',monospace"); noGlow();
  txt('TIP: Tap ⏸ to pause. Tap OPT to open options.',LW/2,LH-90,'rgba(0,245,255,0.75)');
  ctx.restore();
}

const objAnims=[];

const CHAR_CATALOG=[
  {id:'default', name:'DEFAULT', col:CFG.CY,      trailCol:CFG.CY,    unlock:'free', icon:'●'},
  {id:'crimson', name:'CRIMSON', col:'#ff2244',    trailCol:'#ff4466', unlock:'buy', cost:2000, icon:'●'},
  {id:'jade',    name:'JADE',    col:'#00ff88',    trailCol:'#00cc66', unlock:'buy', cost:2000, icon:'●'},
  {id:'gold',    name:'GOLD',    col:'#ffcc00',    trailCol:'#ffaa00', unlock:'buy', cost:2500, icon:'●'},
  {id:'violet',  name:'VIOLET',  col:'#cc44ff',    trailCol:'#aa22dd', unlock:'buy', cost:2500, icon:'●'},
  {id:'solar',   name:'SOLAR',   col:'#ff7700',    trailCol:'#ff5500', unlock:'buy', cost:3000, icon:'●'},
  {id:'arctic',  name:'ARCTIC',  col:'#88ddff',    trailCol:'#44bbee', unlock:'buy', cost:3000, icon:'●'},
  {id:'void',    name:'VOID',    col:'#440088',    trailCol:'#8800cc', unlock:'buy', cost:3000, icon:'●'},
  {id:'nova',    name:'NOVA',    col:'#ffffff',    trailCol:'#ccccff', unlock:'buy', cost:3500, icon:'●'},
  {id:'inferno', name:'INFERNO', col:'#ff3300',    trailCol:'#ffaa00', unlock:'buy', cost:3500, icon:'●'},
  {id:'streak',  name:'STREAK',  col:CFG.YL,       trailCol:CFG.YL,   unlock:'obj', objId:'combo4',  objLabel:'Hit ×4 Combo', icon:'●'},
  {id:'veteran', name:'VETERAN', col:'#39ff14',    trailCol:'#22cc00', unlock:'obj', objId:'survive60',objLabel:'Survive 60s', icon:'●'},
  {id:'hoarder', name:'HOARDER', col:CFG.PK,       trailCol:CFG.PK,   unlock:'obj', objId:'gems200', objLabel:'200 Gems Run', icon:'●'},
  {id:'legend',  name:'LEGEND',  col:'#ffe600',    trailCol:'#ff7700', unlock:'obj', objId:'score5000',objLabel:'Score 5000', icon:'●'},
  {id:'cyber',   name:'CYBER',   col:'#3cf1ff', trailCol:'#1ac8df', unlock:'buy', cost:3600, icon:'●'},
  {id:'mint',    name:'MINT',    col:'#53ffcf', trailCol:'#2acea3', unlock:'buy', cost:3700, icon:'●'},
];

const AURA_CATALOG=[
  {id:'none',name:'NO AURA',col:'#66aacc',unlock:'free',icon:'◌'},
  {id:'pulse',name:'PULSE',col:'#44ddff',unlock:'buy',cost:1500,icon:'◉'},
  {id:'nova',name:'NOVA',col:'#ffee66',unlock:'buy',cost:2200,icon:'✹'},
  {id:'toxic',name:'TOXIC',col:'#55ff55',unlock:'buy',cost:2400,icon:'☢'},
  {id:'ember',name:'EMBER',col:'#ff8844',unlock:'buy',cost:2600,icon:'✦'},
  {id:'mythic',name:'MYTHIC',col:'#cc88ff',unlock:'obj',objId:'survive60',objLabel:'Survive 60s',icon:'✶'},
  {id:'glacier',name:'GLACIER',col:'#9fe7ff',unlock:'buy',cost:2800,icon:'❄'},
  {id:'storm',name:'STORM',col:'#9dbeff',unlock:'buy',cost:3000,icon:'✷'},
];
const THEME_CATALOG=[
  {id:'classic',name:'CLASSIC',col:'#00f5ff',unlock:'free',icon:'▦'},
  {id:'night',name:'NIGHT',col:'#4488ff',unlock:'buy',cost:1800,icon:'☾'},
  {id:'dawn',name:'DAWN',col:'#ffaa55',unlock:'buy',cost:2200,icon:'☀'},
  {id:'forest',name:'FOREST',col:'#66dd66',unlock:'buy',cost:2400,icon:'♣'},
  {id:'void',name:'VOID',col:'#bb66ff',unlock:'buy',cost:2600,icon:'◈'},
  {id:'obsidian',name:'OBSIDIAN',col:'#999999',unlock:'obj',objId:'score5000',objLabel:'Score 5000',icon:'⬢'},
  {id:'neonpink',name:'NEON PINK',col:'#ff4db8',unlock:'buy',cost:2800,icon:'✦'},
  {id:'sunset',name:'SUNSET',col:'#ff8844',unlock:'buy',cost:2900,icon:'⬒'},
  {id:'ocean',name:'OCEAN',col:'#4dcfff',unlock:'buy',cost:3000,icon:'≈'},
  {id:'lava',name:'LAVA',col:'#ff5522',unlock:'buy',cost:3000,icon:'☄'},
  {id:'mint',name:'MINT',col:'#6dffc9',unlock:'buy',cost:3100,icon:'✿'},
  {id:'rose',name:'ROSE',col:'#ff7da6',unlock:'buy',cost:3100,icon:'❀'},
  {id:'amber',name:'AMBER',col:'#ffc247',unlock:'buy',cost:3200,icon:'✶'},
  {id:'steel',name:'STEEL',col:'#b8c4d0',unlock:'buy',cost:3200,icon:'⬡'},
  {id:'plasma',name:'PLASMA',col:'#9f7bff',unlock:'buy',cost:3300,icon:'✹'},
  {id:'prism',name:'PRISM',col:'#7ef7ff',unlock:'buy',cost:3300,icon:'◬'},
  {id:'honey',name:'HONEY',col:'#ffd65b',unlock:'buy',cost:3400,icon:'⬣'},
  {id:'candy',name:'CANDY',col:'#ff87e5',unlock:'buy',cost:3400,icon:'✧'},
  {id:'sprout',name:'SPROUT',col:'#8cff7d',unlock:'buy',cost:3500,icon:'❋'},
  {id:'deep',name:'DEEP',col:'#4d66ff',unlock:'buy',cost:3500,icon:'⬟'},
  {id:'frost',name:'FROST',col:'#ccf5ff',unlock:'buy',cost:3600,icon:'❄'},
  {id:'aurora',name:'AURORA',col:'#66ffd5',unlock:'buy',cost:3700,icon:'✺'},
  {id:'emberglow',name:'EMBERGLOW',col:'#ff9955',unlock:'buy',cost:3700,icon:'✷'},
];

const SHOP_PAGES=[
  {title:'SKINS SHOP', key:'skins', list:CHAR_CATALOG},
  {title:'AURAS SHOP', key:'auras', list:AURA_CATALOG},
  {title:'THEMES SHOP', key:'themes', list:THEME_CATALOG},
];

let charShopPage=0;
const SHOP_ITEMS_PER_PAGE=6;
const charBtnRects=[];
let charShopMsg='', charShopMsgT=0;

function loadAuraUnlocks(){ try{return JSON.parse(localStorage.getItem('slope_auras')||'["none"]');}catch{return['none'];} }
function saveAuraUnlocks(arr){ localStorage.setItem('slope_auras',JSON.stringify(arr)); if (typeof queueCloudSync==='function') queueCloudSync(); }
function loadThemeUnlocks(){ try{return JSON.parse(localStorage.getItem('slope_themes')||'["classic"]');}catch{return['classic'];} }
function saveThemeUnlocks(arr){ localStorage.setItem('slope_themes',JSON.stringify(arr)); if (typeof queueCloudSync==='function') queueCloudSync(); }
let unlockedAuras=loadAuraUnlocks();
let unlockedThemes=loadThemeUnlocks();
let selectedAura=localStorage.getItem('slope_selectedAura')||'none';
let selectedTheme=localStorage.getItem('slope_selectedTheme')||'classic';
function setSelectedAura(id){ selectedAura=id; localStorage.setItem('slope_selectedAura',id); if (typeof queueCloudSync==='function') queueCloudSync(); }
function setSelectedTheme(id){ selectedTheme=id; localStorage.setItem('slope_selectedTheme',id); if (typeof queueCloudSync==='function') queueCloudSync(); }

function unlockGeneric(id, store, saver){ if (!store.includes(id)){ store.push(id); saver(store); } }

function handleShopCategoryItem(item, pageKey){
  if (pageKey==='skins') {
    if (unlockedChars.includes(item.id)) { setSelectedChar(item.id); charShopMsg=`${item.name} selected!`; charShopMsgT=2; return; }
    if (item.unlock==='buy') {
      if (totalGems>=item.cost) { totalGems-=item.cost; saveBank(totalGems); unlockChar(item.id); unlockedChars=loadUnlocked(); setSelectedChar(item.id); charShopMsg=`${item.name} unlocked!`; charShopMsgT=2.5; SFX.pwr(); }
      else { charShopMsg=`Need ${item.cost}◆ gems!`; charShopMsgT=1.5; SFX.hit(); }
    } else { charShopMsg=`Complete: ${item.objLabel}`; charShopMsgT=2; }
    return;
  }
  if (pageKey==='auras') {
    if (unlockedAuras.includes(item.id)) { setSelectedAura(item.id); charShopMsg=`${item.name} aura selected!`; charShopMsgT=2; return; }
    if (item.unlock==='buy') {
      if (totalGems>=item.cost) { totalGems-=item.cost; saveBank(totalGems); unlockGeneric(item.id,unlockedAuras,saveAuraUnlocks); setSelectedAura(item.id); charShopMsg=`${item.name} aura unlocked!`; charShopMsgT=2.5; SFX.pwr(); }
      else { charShopMsg=`Need ${item.cost}◆ gems!`; charShopMsgT=1.5; SFX.hit(); }
    } else { charShopMsg=`Complete: ${item.objLabel}`; charShopMsgT=2; }
    return;
  }
  if (pageKey==='themes') {
    if (unlockedThemes.includes(item.id)) { setSelectedTheme(item.id); charShopMsg=`${item.name} theme selected!`; charShopMsgT=2; return; }
    if (item.unlock==='buy') {
      if (totalGems>=item.cost) { totalGems-=item.cost; saveBank(totalGems); unlockGeneric(item.id,unlockedThemes,saveThemeUnlocks); setSelectedTheme(item.id); charShopMsg=`${item.name} theme unlocked!`; charShopMsgT=2.5; SFX.pwr(); }
      else { charShopMsg=`Need ${item.cost}◆ gems!`; charShopMsgT=1.5; SFX.hit(); }
    } else { charShopMsg=`Complete: ${item.objLabel}`; charShopMsgT=2; }
  }
}

function handleCharShopTap(p) {
  if (hitBtn(p,BTNS.charBack)) { SFX.click(); doTransition('MENU'); return; }
  if (hitBtn(p,BTNS.charPrev)) { SFX.click(); charShopPage=Math.max(0,charShopPage-1); return; }
  if (hitBtn(p,BTNS.charNext)) { SFX.click(); charShopPage=Math.min(SHOP_PAGES.length-1,charShopPage+1); return; }
  const page=SHOP_PAGES[charShopPage]||SHOP_PAGES[0];
  charBtnRects.forEach((r,i)=>{
    const item=page.list[i];
    if (!item||!hitBtn(p,r)) return;
    handleShopCategoryItem(item,page.key);
  });
}

function drawCharShop(t) {
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(0,0.08); drawBgSquares();
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);

  const page=SHOP_PAGES[charShopPage]||SHOP_PAGES[0];
  setFont(28,'900'); glow(CFG.YL,18); txt(page.title,LW/2,52,CFG.YL);
  setFont(11,'700'); glow(CFG.CY,10); txt(`◆ ${totalGems} GEMS`,LW/2,70,CFG.CY);
  ctx.save(); ctx.strokeStyle='rgba(255,230,0,0.3)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(40,80); ctx.lineTo(LW-40,80); ctx.stroke(); ctx.restore();

  charBtnRects.length=0;
  const cols=3,cW=120,cH=108,gapX=7,gapY=7;
  const gridW=cols*(cW+gapX)-gapX,gridX=(LW-gridW)/2;
  for (let i=0;i<SHOP_ITEMS_PER_PAGE;i++) {
    const item=page.list[i];
    if (!item) break;
    const col=i%cols,row=Math.floor(i/cols);
    const bx=gridX+col*(cW+gapX),by=88+row*(cH+gapY);
    charBtnRects.push({x:bx,y:by,w:cW,h:cH});

    const owned = page.key==='skins'?unlockedChars.includes(item.id):page.key==='auras'?unlockedAuras.includes(item.id):unlockedThemes.includes(item.id);
    const selected = page.key==='skins'?selectedChar===item.id:page.key==='auras'?selectedAura===item.id:selectedTheme===item.id;
    const acol=item.col||CFG.CY;

    ctx.save();
    ctx.globalAlpha=selected?0.28:owned?0.14:0.06;
    ctx.fillStyle=acol; ctx.fillRect(bx,by,cW,cH);
    ctx.globalAlpha=selected?1:owned?0.7:0.35;
    ctx.strokeStyle=acol; ctx.lineWidth=selected?2.5:1.5;
    glow(acol,selected?20:8); ctx.strokeRect(bx,by,cW,cH); ctx.globalAlpha=1;

    const bpx=bx+cW/2,bpy=by+33;
    glow(acol,18); setFont(24,'900'); txt(item.icon||'●',bpx,bpy+6,acol);
    if (selected) { glow(acol,24); ctx.strokeStyle='#fff'; ctx.lineWidth=1.5; circle(bpx,bpy,16,acol,false); }

    setFont(9,'900'); glow(acol,8); txt(item.name,bx+cW/2,by+58,acol);
    ctx.save();
    if (selected) {
      ctx.fillStyle=hexToRgba(acol,0.3); ctx.fillRect(bx+10,by+cH-20,cW-20,15);
      setFont(8,'700'); glow(acol,8); txt('EQUIPPED',bx+cW/2,by+cH-8,acol);
    } else if (owned) {
      ctx.fillStyle='rgba(57,255,20,0.15)'; ctx.fillRect(bx+10,by+cH-20,cW-20,15);
      setFont(8,'700'); noGlow(); txt('OWNED',bx+cW/2,by+cH-8,CFG.GR);
    } else if (item.unlock==='buy') {
      ctx.fillStyle=totalGems>=item.cost?hexToRgba(CFG.YL,0.12):'rgba(255,0,0,0.08)';
      ctx.fillRect(bx+10,by+cH-20,cW-20,15);
      const cc=totalGems>=item.cost?CFG.YL:'rgba(255,100,100,0.8)';
      setFont(8,'700'); noGlow(); txt(`◆${item.cost}`,bx+cW/2,by+cH-8,cc);
    } else {
      ctx.fillStyle='rgba(0,245,255,0.08)'; ctx.fillRect(bx+10,by+cH-20,cW-20,15);
      setFont(7,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.6;
      txt('CHALLENGE',bx+cW/2,by+cH-8,'rgba(0,245,255,0.7)');
    }
    ctx.restore();
    ctx.restore();
  }

  const totalPages=SHOP_PAGES.length,pgY=LH-76;
  BTNS.charPrev={x:20,y:pgY,w:50,h:28}; BTNS.charNext={x:LW-70,y:pgY,w:50,h:28};
  if (charShopPage>0) drawNeonBtn(20,pgY,50,28,CFG.CY,'◀',12,0.7,0);
  if (charShopPage<totalPages-1) drawNeonBtn(LW-70,pgY,50,28,CFG.CY,'▶',12,0.7,0);
  setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.4;
  txt(`${charShopPage+1}/${totalPages}`,LW/2,pgY+18,CFG.CY);

  if (charShopMsgT>0) {
    ctx.save(); ctx.globalAlpha=Math.min(1,charShopMsgT);
    setFont(11,'700'); glow(CFG.YL,14); txt(charShopMsg,LW/2,pgY-12,CFG.YL); ctx.restore();
  }
  BTNS.charBack={x:(LW-140)/2,y:LH-44,w:140,h:30};
  drawNeonBtn((LW-140)/2,LH-44,140,30,CFG.PK,'← BACK',11,0.85,Math.sin(t*2));
  ctx.restore();
}
</script>

<!-- ============================================================ -->
<!--  SCRIPT 10c · GAME LOGIC                                    -->
<!-- ============================================================ -->
<script id="s-logic">
function loadBank()  { return parseInt(localStorage.getItem('slope_gems')||'0',10); }
function saveBank(v) { localStorage.setItem('slope_gems',String(v)); if (typeof queueCloudSync==='function') queueCloudSync(); }
function addToBank(n){ const v=loadBank()+n; saveBank(v); return v; }
let totalGems=loadBank();


const UPGRADE_DEFS=[
  {key:'immunity',label:'IMMUNITY',col:CFG.GR},
  {key:'score',label:'X2 SCORE',col:CFG.YL},
  {key:'shield',label:'SHIELD',col:CFG.BL},
  {key:'health',label:'HEALTH BOOST',col:'#ff44aa'},
];
const UPGRADE_COSTS=[5000,10000,16000,20000];
function loadUpgrades() {
  try {
    const v=JSON.parse(localStorage.getItem('slope_upgrades')||'{}');
    return {
      immunity:clamp(parseInt(v.immunity||1,10),1,5),
      score:clamp(parseInt(v.score||1,10),1,5),
      shield:clamp(parseInt(v.shield||1,10),1,5),
      health:clamp(parseInt(v.health||1,10),1,5),
    };
  } catch { return {immunity:1,score:1,shield:1,health:1}; }
}
function saveUpgrades(v){ localStorage.setItem('slope_upgrades',JSON.stringify(v)); if (typeof queueCloudSync==='function') queueCloudSync(); }
let upgrades=loadUpgrades();
const UPGRADE_ROWS=[];
function upgradeCost(level){ return UPGRADE_COSTS[Math.max(0,Math.min(3,level-1))]; }
function scoreBoostMult(){ return 2 + (upgrades.score-1)*0.2; }
function shieldDuration(base){ return Math.round(base*(1+(upgrades.shield-1)*0.15)); }
function healthBoostDuration(base){ return Math.round(base*(1+(upgrades.health-1)*0.15)); }
function immunityDuration(){ return IMMUNITY_COLLISION_COOLDOWN + (upgrades.immunity-1)*0.4; }
function runAvgTime(){
  const runs=Math.max(1,parseInt(localStorage.getItem('slope_runs')||'0',10));
  const total=parseFloat(localStorage.getItem('slope_totalTime')||'0');
  return total/runs;
}
function upgradeTimeFactor(key,level){
  const lvl=Math.max(1,Math.min(5,level));
  if (key==='immunity') return 1+(lvl-1)*0.08;
  if (key==='shield') return 1+(lvl-1)*0.06;
  if (key==='health') return 1+(lvl-1)*0.07;
  if (key==='score') return 1+(lvl-1)*0.03;
  return 1;
}
function withUpgradeAvgTime(key,level){
  const base=Math.max(1,runAvgTime());
  return base*upgradeTimeFactor(key,level);
}
function handleUpgradesTap(p){
  if (hitBtn(p,BTNS.upgradesBack)) { SFX.click(); doTransition('MENU'); return; }
  UPGRADE_ROWS.forEach(r=>{
    if (!hitBtn(p,r.btn)) return;
    const lvl=upgrades[r.key];
    if (lvl>=5) return;
    const cost=upgradeCost(lvl);
    if (totalGems<cost) { addNotif(`Need ${cost}◆`,CFG.PK); SFX.hit(); return; }
    totalGems-=cost; saveBank(totalGems);
    upgrades[r.key]=lvl+1; saveUpgrades(upgrades);
    SFX.surprise();
    addNotif(`${r.label} Lv.${upgrades[r.key]}!`,r.col);
  });
}
function drawUpgradesScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.2,0.07); drawBgSquares();
  ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(34,'900'); glow(CFG.YL,18); txt('UPGRADES',LW/2,52,CFG.YL);
  setFont(10,'700'); glow(CFG.CY,10); txt(`◆ ${totalGems} GEMS`,LW/2,70,CFG.CY);
  UPGRADE_ROWS.length=0;
  UPGRADE_DEFS.forEach((u,i)=>{
    const y=92+i*122;
    ctx.save(); ctx.globalAlpha=0.08; ctx.fillStyle=u.col; ctx.fillRect(18,y,LW-36,106); ctx.restore();
    setFont(12,'900'); glow(u.col,10); txt(u.label,34,y+22,u.col,'left');
    const lvl=upgrades[u.key];
    setFont(9,'400',"'Share Tech Mono',monospace"); noGlow(); txt(`Level ${lvl}/5`,LW-34,y+22,u.col,'right');
    for (let k=0;k<5;k++) {
      const bx=34+k*28, by=y+36;
      ctx.fillStyle=k<lvl?u.col:'rgba(255,255,255,0.12)';
      ctx.fillRect(bx,by,20,6);
    }
    const avgRaw=Math.max(1,runAvgTime());
    const avgCurrent=withUpgradeAvgTime(u.key,lvl);
    const avgNext=withUpgradeAvgTime(u.key,Math.min(5,lvl+1));
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); ctx.globalAlpha=0.7;
    txt(`Avg Time: ${avgRaw.toFixed(1)}s  | Current: ${avgCurrent.toFixed(1)}s  →  Next: ${avgNext.toFixed(1)}s`,34,y+52,'rgba(200,255,255,0.72)','left'); ctx.globalAlpha=1;
    const btn={x:34,y:y+66,w:LW-68,h:30};
    const maxed=lvl>=5;
    const cost=maxed?0:upgradeCost(lvl);
    const canAfford=maxed||totalGems>=cost;
    drawNeonBtn(btn.x,btn.y,btn.w,btn.h,maxed?CFG.GR:(canAfford?u.col:'#3a88ff'),maxed?'MAX LEVEL':(canAfford?`UPGRADE ◆${cost}`:`LOCKED ◆${cost}`),11,1,maxed?0.2:Math.sin(t*2+i));
    UPGRADE_ROWS.push({key:u.key,btn,label:u.label,col:u.col});
  });
  BTNS.upgradesBack={x:(LW-140)/2,y:LH-44,w:140,h:30};
  drawNeonBtn(BTNS.upgradesBack.x,BTNS.upgradesBack.y,140,30,CFG.PK,'← BACK',11,0.9,Math.sin(t*2));
  ctx.restore();
}


const AUTH_KEY='slope_auth';
const AUTH_GUEST={signedIn:false,name:'Guest Runner',email:'',uid:'',verified:false,bio:'',avatar:'',status:'offline',statusPref:'offline',lastSeen:0};
const FIREBASE_CONFIG={
  apiKey:"AIzaSyA375t6p_Zc9Ztfi-RUniqAmjttsjPyy1k",
  authDomain:"thegeneric-685b0.firebaseapp.com",
  databaseURL:"https://thegeneric-685b0-default-rtdb.firebaseio.com",
  projectId:"thegeneric-685b0",
  storageBucket:"thegeneric-685b0.firebasestorage.app",
  messagingSenderId:"272113167212",
  appId:"1:272113167212:web:ce1eaa647222c15a292149",
  measurementId:"G-N068FXTMC7"
};
const CLOUD_INFO_ROOT='SLOPE/user/encrypted/info';
const CLOUD_SLOPE_ROOT='SLOPE/users';
const CLOUD_LEADERBOARD_ROOT='SLOPE/leaderboards';
const CLOUD_INFO_ROOT_FALLBACKS=[CLOUD_INFO_ROOT];

let fbReady=false, fbAuth=null, fbDb=null, fbUser=null;
let cloudSyncTimer=0;
let profileBio='';
let profileAvatar='';
let profileAvatarPressStart=0;
let profileAvatarPressing=false;
let profileAvatarHoldFX=false;
profileUploadState={active:false,mode:'idle',error:'',rawData:'',img:null,zoom:1,offX:0,offY:0,drag:false,lastX:0,lastY:0};
let cloudProfileRoot=CLOUD_INFO_ROOT;
let cloudGemCount=loadBank();
let cloudUpdatedAt=0;
let cloudJoinedAt=0;
let profilePadPrev={a:false,b:false,x:false,y:false,lb:false,rb:false};


function drawDefaultProfileIcon(cx,cy,r,col='rgba(216,246,255,0.9)'){
  ctx.save();
  noGlow();
  ctx.strokeStyle=col; ctx.lineWidth=2;
  circle(cx,cy-r*0.24,r*0.28,col,false);
  ctx.beginPath();
  ctx.arc(cx,cy+r*0.34,r*0.44,Math.PI*1.06,Math.PI*1.94,false);
  ctx.stroke();
  ctx.restore();
}

function resetProfileUploadState(){
  profileUploadState={active:false,mode:'idle',error:'',rawData:'',img:null,zoom:1,offX:0,offY:0,drag:false,lastX:0,lastY:0};
}

function openProfileUploadError(msg){
  profileUploadState.active=true;
  profileUploadState.mode='error';
  profileUploadState.error=String(msg||'Profile icon upload failed.');
}

function beginProfileUploadPreview(dataUrl){
  const img=new Image();
  img.onload=()=>{
    profileUploadState.active=true;
    profileUploadState.mode='preview';
    profileUploadState.error='';
    profileUploadState.rawData=dataUrl;
    profileUploadState.img=img;
    profileUploadState.zoom=1;
    profileUploadState.offX=0;
    profileUploadState.offY=0;
    profileUploadState.drag=false;
    clampProfileUploadOffsets(profileUploadState,220);
  };
  img.onerror=()=>openProfileUploadError('Image decode failed. Try a different file.');
  img.src=dataUrl;
}

async function applyProfileCropAndSave(){
  const st=profileUploadState;
  if (!st.img) { openProfileUploadError('No image ready to upload.'); return; }
  clampProfileUploadOffsets(st,220);
  try {
    const out=document.createElement('canvas');
    out.width=256; out.height=256;
    const octx=out.getContext('2d');
    octx.clearRect(0,0,256,256);
    const iw=st.img.width, ih=st.img.height;
    const base=Math.max(256/Math.max(iw,1),256/Math.max(ih,1));
    const sc=base*st.zoom;
    const dw=iw*sc, dh=ih*sc;
    const offScale=256/220;
    const dx=(256-dw)/2+(st.offX*offScale);
    const dy=(256-dh)/2+(st.offY*offScale);
    octx.drawImage(st.img,dx,dy,dw,dh);
    const data=out.toDataURL('image/png',0.92);
    profileAvatar=String(data||'');
    auth={...auth,avatar:profileAvatar}; saveAuth(auth);
    await writeCloudUserInfo({avatar:profileAvatar,pfpLink:profileAvatar,pfpLinkId:getAvatarLinkId(profileAvatar)||'none'});
    addNotif('Profile icon updated.',CFG.GR);
    openActionPopup('ICON UPDATED','Profile icon uploaded successfully.',true);
    resetProfileUploadState();
  } catch (e) {
    openProfileUploadError('Upload failed while applying crop.');
    openActionPopup('ICON UPLOAD FAILED','Could not upload profile icon.',false);
  }
}

async function clearProfileAvatar(){
  profileAvatar='';
  auth={...auth,avatar:''}; saveAuth(auth);
  try { await writeCloudUserInfo({avatar:'',pfpLink:'',pfpLinkId:'none'}); } catch(e){}
  addNotif('Profile icon removed.',CFG.YL);
  openActionPopup('ICON REMOVED','Profile icon reset to default.',true);
}

function fmtCloudTs(ts){
  if (!Number.isFinite(ts) || ts<=0) return '—';
  const d=new Date(ts);
  if (Number.isNaN(d.getTime())) return '—';
  return `${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
}


function parseCloudTs(v){
  if (Number.isFinite(v) && v>0) return Number(v);
  const n=Number(v);
  if (Number.isFinite(n) && n>0) return n;
  const p=Date.parse(String(v||''));
  return Number.isFinite(p) && p>0 ? p : 0;
}


function clampProfileUploadOffsets(st, frame=220){
  if (!st || !st.img) return;
  const iw=Math.max(st.img.width,1), ih=Math.max(st.img.height,1);
  const base=Math.max(frame/iw, frame/ih);
  const sc=base*st.zoom;
  const dw=iw*sc, dh=ih*sc;
  if (dw<=frame) st.offX=0;
  else {
    const lim=(dw-frame)/2;
    st.offX=clamp(st.offX,-lim,lim);
  }
  if (dh<=frame) st.offY=0;
  else {
    const lim=(dh-frame)/2;
    st.offY=clamp(st.offY,-lim,lim);
  }
}

function updateProfileUploadController(dt){
  if (gs!=='PROFILE' || !profileUploadState.active || profileUploadState.mode!=='preview') {
    profilePadPrev={a:false,b:false,x:false,y:false,lb:false,rb:false};
    return;
  }
  const pads=navigator.getGamepads ? navigator.getGamepads() : [];
  const gp=(pads&&pads[0])||null;
  if (!gp) {
    profilePadPrev={a:false,b:false,x:false,y:false,lb:false,rb:false};
    return;
  }
  const st=profileUploadState;
  const btn=i=>!!(gp.buttons&&gp.buttons[i]&&gp.buttons[i].pressed);
  let mx=0,my=0;
  const ax=(gp.axes&&gp.axes.length>0)?gp.axes[0]:0;
  const ay=(gp.axes&&gp.axes.length>1)?gp.axes[1]:0;
  if (Math.abs(ax)>0.2) mx+=ax;
  if (Math.abs(ay)>0.2) my+=ay;
  if (btn(14)) mx-=1;
  if (btn(15)) mx+=1;
  if (btn(12)) my-=1;
  if (btn(13)) my+=1;
  if (mx||my) {
    const move=130*dt;
    st.offX+=mx*move;
    st.offY+=my*move;
    clampProfileUploadOffsets(st,220);
  }

  const a=btn(0), b=btn(1), x=btn(2), y=btn(3), lb=btn(4), rb=btn(5);
  if (rb && !profilePadPrev.rb) { st.zoom=clamp(st.zoom+0.1,1,3); clampProfileUploadOffsets(st,220); SFX.click(); }
  if (lb && !profilePadPrev.lb) { st.zoom=clamp(st.zoom-0.1,1,3); clampProfileUploadOffsets(st,220); SFX.click(); }
  if ((x && !profilePadPrev.x) || (y && !profilePadPrev.y)) { st.zoom=1; st.offX=0; st.offY=0; clampProfileUploadOffsets(st,220); SFX.click(); }
  if (a && !profilePadPrev.a) { SFX.click(); applyProfileCropAndSave(); }
  if (b && !profilePadPrev.b) { SFX.click(); resetProfileUploadState(); }
  profilePadPrev={a,b,x,y,lb,rb};
}

function getAvatarLinkId(avatar){
  const src=String(avatar||'');
  if (!src) return '';
  return `pfp_${hashStr(src).toString(16)}`;
}

function buildSlopeUserPayload(extra={}){
  const now=Date.now();
  const localGems=loadBank();
  const pfpLink=profileAvatar||'';
  const payload={
    uid:String((fbUser&&fbUser.uid)||auth.uid||''),
    email:String((fbUser&&fbUser.email)||auth.email||''),
    displayName:String((fbUser&&fbUser.displayName)||auth.name||'Runner'),
    verified:String(!!(auth&&auth.verified===true)),
    bio:String(profileBio||''),
    pfpLink,
    pfpLinkId:getAvatarLinkId(pfpLink),
    gems:String(localGems),
    bestScore:String(Math.floor(bestScore||0)),
    selectedSkin:String(selectedChar||'default'),
    selectedAura:String(selectedAura||'none'),
    selectedTheme:String(selectedTheme||'classic'),
    cloudRoot:String(cloudProfileRoot||CLOUD_INFO_ROOT),
    updatedAt:String(now),
    admin:String(!!(auth&&auth.admin)),
    ...extra,
  };
  return payload;
}

async function syncSlopeMirror(extra={}){
  if (!fbReady || !fbDb || !fbUser) return;
  const payload=buildSlopeUserPayload(extra);
  await fbDb.ref(`${CLOUD_SLOPE_ROOT}/${fbUser.uid}`).update(payload);
}


async function syncLeaderboardRTDB(){
  if (!fbReady || !fbDb || !fbUser || !isSignedIn) return;
  const uid=fbUser.uid;
  const payload={name:String((auth&&auth.name)||'Runner'),updatedAt:String(Date.now())};
  const maps=[['global',Math.max(0,Math.floor(bestScore||0))],['endless',Math.max(0,Math.floor(modeScores.endless||0))],['adventure',Math.max(0,Math.floor(modeScores.adventure||0))],['impossible',Math.max(0,Math.floor(modeScores.impossible||0))],['ltm',Math.max(0,Math.floor(modeScores.ltm||0))]];
  try {
    for (const [cat,val] of maps) await fbDb.ref(`${CLOUD_LEADERBOARD_ROOT}/${cat}/${uid}`).update({...payload,score:String(val)});
  } catch(e) {}
}

async function ensureSupportedVersions(){
  if (!fbReady || !fbDb) return;
  try {
    await fbDb.ref('SLOPE/config/currentVersion').get();
    const sv=await fbDb.ref('SLOPE/config/supportedVersions').get();
    const list=(sv&&sv.val)?(sv.val()||[]):[];
    if (Array.isArray(list) && !list.includes(VERSION)) {
      await fbDb.ref('SLOPE/config/supportedVersions').set([...list,VERSION].slice(-40));
    }
    await loadGlobalLtmConfig(true);
  } catch (e) {}
}

async function resolveCloudRoot(uid, preferExisting=false){
  if (!fbReady || !fbDb || !uid) return CLOUD_INFO_ROOT;
  if (!preferExisting) return CLOUD_INFO_ROOT;
  try {
    for (const root of CLOUD_INFO_ROOT_FALLBACKS) {
      const snap=await fbDb.ref(`${root}/${uid}`).get();
      if (snap && snap.exists && snap.exists()) return root;
      if (snap && snap.val && snap.val()) return root;
    }
  } catch (e) {}
  return CLOUD_INFO_ROOT;
}

function loadAuth(){
  try { return JSON.parse(localStorage.getItem(AUTH_KEY)||JSON.stringify(AUTH_GUEST)); }
  catch { return {...AUTH_GUEST}; }
}
function saveAuth(v){ localStorage.setItem(AUTH_KEY,JSON.stringify(v)); }
let auth=loadAuth();
let isSignedIn=!!auth.signedIn;
let authFlowState='idle'; // idle/loading/success/error
let authFlowTimer=0;
let authFlowError='';
let authFlowMsg='';
let signinForm={email:'',password:''};
let signupForm={username:'',email:'',password:'',confirm:''};

var USERNAME_CHANGE_KEY=window.USERNAME_CHANGE_KEY||'slope_username_change'; window.USERNAME_CHANGE_KEY=USERNAME_CHANGE_KEY;
const USERNAME_TRY_WINDOW_MS=7*24*60*60*1000;
let usernameChangeFlow={active:false,phase:'idle',progress:0,msg:'',candidate:'',elapsed:0};
function loadUsernameChangeState(){
  const now=Date.now();
  try {
    const raw=JSON.parse(localStorage.getItem(USERNAME_CHANGE_KEY)||'{}');
    let triesLeft=Number.isFinite(raw.triesLeft)?Math.floor(raw.triesLeft):2;
    let refreshAt=Number(raw.refreshAt||0)||0;
    if (refreshAt>0 && now>=refreshAt) { triesLeft=2; refreshAt=0; }
    triesLeft=clamp(triesLeft,0,2);
    return {triesLeft,refreshAt};
  } catch(e){ return {triesLeft:2,refreshAt:0}; }
}
function saveUsernameChangeState(v){
  localStorage.setItem(USERNAME_CHANGE_KEY,JSON.stringify({triesLeft:clamp(Math.floor(v.triesLeft||0),0,2),refreshAt:Number(v.refreshAt||0)||0}));
}
let usernameChangeState=loadUsernameChangeState();
function refreshUsernameChangeState(){
  const now=Date.now();
  if (usernameChangeState.refreshAt>0 && now>=usernameChangeState.refreshAt) {
    usernameChangeState={triesLeft:2,refreshAt:0};
    saveUsernameChangeState(usernameChangeState);
  }
}
function usernameCountdownStr(){
  refreshUsernameChangeState();
  if (usernameChangeState.triesLeft>0) return 'READY';
  const left=Math.max(0,usernameChangeState.refreshAt-Date.now());
  const d=Math.floor(left/86400000); const h=Math.floor((left%86400000)/3600000); const m=Math.floor((left%3600000)/60000);
  return `${d}d ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m`;
}
function consumeUsernameTry(){
  refreshUsernameChangeState();
  if (usernameChangeState.triesLeft<=0) return false;
  usernameChangeState.triesLeft=Math.max(0,usernameChangeState.triesLeft-1);
  if (usernameChangeState.triesLeft<=0) usernameChangeState.refreshAt=Date.now()+USERNAME_TRY_WINDOW_MS;
  saveUsernameChangeState(usernameChangeState);
  return true;
}
function usernameUnavailableMsg(name){ return `Username ${name} is taken.`; }
function openUsernameFlowPhase(phase,msg=''){ usernameChangeFlow.active=true; usernameChangeFlow.phase=phase; usernameChangeFlow.msg=String(msg||''); if (phase!=='loading') usernameChangeFlow.progress=1; }
async function isUsernameTaken(desired){
  if (!fbReady || !fbDb) return false;
  const uid=String((fbUser&&fbUser.uid)||(auth&&auth.uid)||'');
  const needle=String(desired||'').trim().toLowerCase();
  if (!needle) return true;
  const roots=[];
  [cloudProfileRoot||CLOUD_INFO_ROOT, ...CLOUD_INFO_ROOT_FALLBACKS, CLOUD_SLOPE_ROOT].forEach(r=>{ if (r && !roots.includes(r)) roots.push(r); });
  for (const root of roots){
    try {
      const snap=await fbDb.ref(root).get();
      const all=snap&&snap.val?snap.val():{};
      for (const [k,v] of Object.entries(all||{})) {
        const row=v||{};
        const rowUid=String(row.uid||k||'');
        const rowName=String((row.name||row.displayName||'')).trim().toLowerCase();
        if (!rowName) continue;
        if (rowUid===uid) continue;
        if (rowName===needle) return true;
      }
    } catch(e){}
  }
  return false;
}
async function requestUsernameChange(newNameRaw){
  const desired=String(newNameRaw||'').trim();
  usernameChangeFlow.candidate=desired;
  refreshUsernameChangeState();
  if (!isSignedIn || !fbUser) { openUsernameFlowPhase('error','Sign in required.'); return; }
  if (!navigator.onLine) { openUsernameFlowPhase('error','You are offline.'); return; }
  if (usernameChangeState.triesLeft<=0) { openUsernameFlowPhase('error',`No tries left. Refresh in ${usernameCountdownStr()}.`); return; }
  if (desired.length<3 || desired.length>32) { openUsernameFlowPhase('error','Username must be 3-32 chars.'); return; }
  if (!/^[a-zA-Z0-9_\- ]+$/.test(desired)) { openUsernameFlowPhase('error','Use letters, numbers, spaces, _ or -.'); return; }
  if (String(auth.name||'').trim().toLowerCase()===desired.toLowerCase()) { openUsernameFlowPhase('error','That is already your username.'); return; }

  openUsernameFlowPhase('loading','Checking username availability...');
  usernameChangeFlow.elapsed=0;
  try {
    await new Promise(r=>setTimeout(r,520));
    const taken=await isUsernameTaken(desired);
    if (taken) { openUsernameFlowPhase('error',usernameUnavailableMsg(desired)); return; }

    if (!consumeUsernameTry()) { openUsernameFlowPhase('error',`No tries left. Refresh in ${usernameCountdownStr()}.`); return; }

    if (fbUser.updateProfile) await fbUser.updateProfile({displayName:desired});
    auth={...auth,name:desired};
    saveAuth(auth);
    try { await writeCloudUserInfo({name:desired,displayName:desired}); } catch(e){}
    try { await syncSlopeMirror({displayName:String(desired)}); } catch(e){}

    openUsernameFlowPhase('success',`Congratulations ${desired}! Username updated.`);
    addNotif('USERNAME UPDATED',CFG.GR);
  } catch(e){
    openUsernameFlowPhase('error','Could not update username. Try again.');
  }
}
function drawUsernameChangeOverlay(t){
  if (!usernameChangeFlow.active) return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.74)'; ctx.fillRect(0,0,LW,LH);
  const w=320,h=188,x=(LW-w)/2,y=(LH-h)/2;
  const col=usernameChangeFlow.phase==='success'?CFG.GR:(usernameChangeFlow.phase==='error'?CFG.PK:CFG.CY);
  ctx.fillStyle='#000'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle=col; ctx.lineWidth=2; glow(col,14); ctx.strokeRect(x,y,w,h);
  const title=usernameChangeFlow.phase==='loading'?'CHECKING USERNAME':(usernameChangeFlow.phase==='success'?'CONGRATULATIONS':'USERNAME ERROR');
  setFont(14,'900'); glow(col,10); txt(title,LW/2,y+28,col);
  setFont(9,'700',"'Share Tech Mono',monospace"); noGlow();
  const m=String(usernameChangeFlow.msg||'').slice(0,90);
  txt(m,LW/2,y+58,'rgba(220,240,255,0.9)');

  if (usernameChangeFlow.phase==='loading') {
    usernameChangeFlow.elapsed+=1/60;
    const prog=clamp((Math.sin(t*2.2)+1)/2*0.55 + clamp(usernameChangeFlow.elapsed/1.8,0,0.45),0,0.97);
    const bx=x+22,by=y+88,bw=w-44,bh=10;
    ctx.fillStyle='rgba(0,245,255,0.12)'; ctx.fillRect(bx,by,bw,bh);
    const g=ctx.createLinearGradient(bx,0,bx+bw,0); g.addColorStop(0,'#00f5ff'); g.addColorStop(1,'#66bbff');
    ctx.fillStyle=g; glow(CFG.CY,8); ctx.fillRect(bx,by,bw*prog,bh);
    setFont(8,'400',"'Share Tech Mono',monospace"); noGlow(); txt('Loading...',LW/2,by+24,'rgba(180,230,255,0.75)');
  } else if (usernameChangeFlow.phase==='error') {
    BTNS.usernameTryAgain={x:x+88,y:y+92,w:144,h:30};
    BTNS.usernameExit={x:x+88,y:y+128,w:144,h:30};
    drawNeonBtn(BTNS.usernameTryAgain.x,BTNS.usernameTryAgain.y,BTNS.usernameTryAgain.w,BTNS.usernameTryAgain.h,CFG.CY,'TRY AGAIN',11,1,Math.sin(t*2));
    drawNeonBtn(BTNS.usernameExit.x,BTNS.usernameExit.y,BTNS.usernameExit.w,BTNS.usernameExit.h,CFG.PK,'EXIT',11,1,Math.sin(t*2));
  } else {
    BTNS.usernameContinue={x:x+88,y:y+124,w:144,h:30};
    drawNeonBtn(BTNS.usernameContinue.x,BTNS.usernameContinue.y,BTNS.usernameContinue.w,BTNS.usernameContinue.h,CFG.GR,'CONTINUE',11,1,Math.sin(t*2));
  }
  ctx.restore();
}

const ADMIN_SECRET_ENABLED=true;
let isAdminUser=false;
let adminSessionUnlocked=false;
let adminAuthInput='';
let adminAuthState='idle';
let adminAuthMsg='';
let adminScroll=0;
let adminViewH=0;
let adminContentH=0;
let adminFlags={syncCloud:true, grantSkin:true, grantAura:true, grantTheme:true, confirmLocks:false};
let adminVerifyUid='';
let adminVerifyValue=false;
refreshAdminFlag();

function refreshAdminFlag(){
  isAdminUser=!!(ADMIN_SECRET_ENABLED && isSignedIn && auth && auth.admin===true);
  if (!isAdminUser) adminSessionUnlocked=false;
}


function minAdminScroll(){ return Math.min(0, adminViewH-adminContentH); }

function saveAdminUnlocks(){
  saveUnlocked(unlockedChars||['default']);
  saveAuraUnlocks(unlockedAuras||['none']);
  saveThemeUnlocks(unlockedThemes||['classic']);
  if (adminFlags.syncCloud) queueCloudSync(50);
}

function adminUnlockSelected(){
  if (adminFlags.grantSkin && selectedChar && !unlockedChars.includes(selectedChar)) unlockedChars.push(selectedChar);
  if (adminFlags.grantAura && selectedAura && !unlockedAuras.includes(selectedAura)) unlockedAuras.push(selectedAura);
  if (adminFlags.grantTheme && selectedTheme && !unlockedThemes.includes(selectedTheme)) unlockedThemes.push(selectedTheme);
  saveAdminUnlocks();
  addNotif('Admin: selected unlock flags applied.',CFG.YL);
}

function adminLockSelected(){
  if (!adminFlags.confirmLocks) { addNotif('Enable CONFIRM LOCKS first.',CFG.PK); return; }
  if (selectedChar!=='default') unlockedChars=unlockedChars.filter(id=>id!==selectedChar);
  if (selectedAura!=='none') unlockedAuras=unlockedAuras.filter(id=>id!==selectedAura);
  if (selectedTheme!=='classic') unlockedThemes=unlockedThemes.filter(id=>id!==selectedTheme);
  if (!unlockedChars.includes('default')) unlockedChars.unshift('default');
  if (!unlockedAuras.includes('none')) unlockedAuras.unshift('none');
  if (!unlockedThemes.includes('classic')) unlockedThemes.unshift('classic');
  if (!unlockedChars.includes(selectedChar)) setSelectedChar('default');
  if (!unlockedAuras.includes(selectedAura)) setSelectedAura('none');
  if (!unlockedThemes.includes(selectedTheme)) setSelectedTheme('classic');
  saveAdminUnlocks();
  addNotif('Admin: selected items locked.',CFG.PK);
}

function adminUnlockAll(){
  unlockedChars=CHAR_CATALOG.map(c=>c.id);
  unlockedAuras=AURA_CATALOG.map(a=>a.id);
  unlockedThemes=THEME_CATALOG.map(t=>t.id);
  saveAdminUnlocks();
  addNotif('Admin: unlocked all cosmetics.',CFG.GR);
}

function adminLockAll(){
  if (!adminFlags.confirmLocks) { addNotif('Enable CONFIRM LOCKS first.',CFG.PK); return; }
  unlockedChars=['default'];
  unlockedAuras=['none'];
  unlockedThemes=['classic'];
  setSelectedChar('default'); setSelectedAura('none'); setSelectedTheme('classic');
  saveAdminUnlocks();
  addNotif('Admin: locked all cosmetics.',CFG.PK);
}

let inputDialog={active:false,title:'',label:'',value:'',maxLen:64,secret:false,multiline:false,onSubmit:null,selectAll:false,saveLabel:'SAVE',cancelLabel:'CANCEL'};
function openInputDialog(cfg={}){
  inputDialog={
    active:true,
    title:cfg.title||'INPUT',
    label:cfg.label||'Value',
    value:String(cfg.value||''),
    maxLen:cfg.maxLen||64,
    secret:!!cfg.secret,
    multiline:!!cfg.multiline,
    onSubmit:typeof cfg.onSubmit==='function'?cfg.onSubmit:null,
    selectAll:false,
    saveLabel:String(cfg.saveLabel||'SAVE').slice(0,12),
    cancelLabel:String(cfg.cancelLabel||'CANCEL').slice(0,12),
  };
}
function closeInputDialog(save=false){
  if (save && inputDialog.onSubmit) inputDialog.onSubmit(inputDialog.value);
  inputDialog.active=false;
}
function drawInputDialog(t){
  if (!inputDialog.active) return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.72)'; ctx.fillRect(0,0,LW,LH);
  const w=320,h=210,x=(LW-w)/2,y=(LH-h)/2;
  ctx.fillStyle='#000'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle=CFG.CY; ctx.lineWidth=2; glow(CFG.CY,12); ctx.strokeRect(x,y,w,h);
  setFont(14,'900'); glow(CFG.CY,10); txt(inputDialog.title,LW/2,y+28,CFG.CY);
  setFont(9,'700',"'Share Tech Mono',monospace"); noGlow(); txt(inputDialog.label,x+16,y+52,'rgba(0,245,255,0.85)','left');
  const ibx=x+16, iby=y+62, ibw=w-32, ibh=84;
  ctx.strokeStyle='rgba(0,245,255,0.55)'; ctx.lineWidth=1.5; ctx.strokeRect(ibx,iby,ibw,ibh);
  ctx.fillStyle='rgba(0,245,255,0.08)'; ctx.fillRect(ibx,iby,ibw,ibh);
  if (inputDialog.selectAll) {
    ctx.fillStyle='rgba(57,255,20,0.14)';
    ctx.fillRect(ibx+4,iby+4,ibw-8,ibh-8);
  }
  const shown=inputDialog.secret?'•'.repeat(inputDialog.value.length):inputDialog.value;
  const cursor=((Math.floor(t*2)%2)===0)?'|':'';
  setFont(10,'700',"'Share Tech Mono',monospace"); noGlow();
  const text=(shown+cursor).slice(-(inputDialog.multiline?140:48));
  if (inputDialog.multiline) {
    const lines=[]; let r=text;
    while (r.length>34) { lines.push(r.slice(0,34)); r=r.slice(34); }
    lines.push(r);
    lines.slice(0,4).forEach((ln,i)=>txt(ln,ibx+8,iby+20+i*16,'#d8f6ff','left'));
  } else {
    txt(text,ibx+8,iby+48,'#d8f6ff','left');
  }
  setFont(8,'400',"'Share Tech Mono',monospace"); noGlow();
  txt(`${inputDialog.value.length}/${inputDialog.maxLen}`,ibx+ibw-8,iby+ibh-8,'rgba(0,245,255,0.55)','right');

  BTNS.inputSave={x:x+22,y:y+h-44,w:120,h:28};
  BTNS.inputCancel={x:x+w-142,y:y+h-44,w:120,h:28};
  drawNeonBtn(BTNS.inputSave.x,BTNS.inputSave.y,120,28,CFG.GR,inputDialog.saveLabel||'SAVE',10,1,Math.sin(t*2));
  drawNeonBtn(BTNS.inputCancel.x,BTNS.inputCancel.y,120,28,CFG.PK,inputDialog.cancelLabel||'CANCEL',10,1,Math.sin(t*2.2));
  ctx.restore();
}

function initFirebase(){
  try {
    if (!window.firebase || !firebase.apps) throw new Error('SDK_MISSING');
    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    fbAuth=firebase.auth();
    fbDb=firebase.database();
    fbReady=true;
    ensureSupportedVersions();
    fbAuth.onAuthStateChanged(async u=>{
      fbUser=u||null;
      if (u) {
        isSignedIn=true;
        const keepVerified=(auth&&typeof auth.verified==='boolean')?auth.verified:!!u.emailVerified;
        auth={signedIn:true,name:u.displayName||auth.name||'Runner',email:u.email||'',uid:u.uid||'',verified:!!keepVerified,bio:profileBio||'',avatar:profileAvatar||'',admin:!!(auth&&auth.admin),status:String((auth&&auth.status)||'online'),statusPref:STATUS_COLORS[String((auth&&auth.statusPref)||'').toLowerCase()]?String(auth.statusPref).toLowerCase():'online'};
        saveAuth(auth);
        refreshAdminFlag();
        socialData={friends:[],followers:[],following:[],received:[],sent:[]};
        socialCounters={friends:0,followers:0,following:0,received:0,sent:0};
        rebuildSocialRelationCache();
        await loadCloudProfileAndProgress();
        totalGems=loadBank();
        await applyConnectivityStatus(false);
        fetchSocialData();
      } else {
        isSignedIn=false;
        auth={...AUTH_GUEST};
        profileBio=''; profileAvatar='';
        cloudProfileRoot=CLOUD_INFO_ROOT;
        cloudGemCount=loadBank();
        totalGems=loadBank();
        cloudUpdatedAt=0;
        cloudJoinedAt=0;
        saveAuth(auth);
        refreshAdminFlag();
      }
    });
  } catch (e) {
    fbReady=false;
  }
}

function drawLoadingDots(x,y,t,col='#888') {
  for (let i=0;i<3;i++) {
    ctx.globalAlpha=0.25+0.75*Math.max(0,Math.sin(t*5+i));
    circle(x+i*14,y,4,col);
  }
  ctx.globalAlpha=1;
}
function drawLoadingSquares(x,y,t,col='#888') {
  const size=7, gap=6;
  for (let i=0;i<3;i++) {
    ctx.globalAlpha=0.2+0.8*Math.max(0,Math.sin(t*4.5+i*0.85));
    ctx.fillStyle=col;
    ctx.fillRect(x-((size*3+gap*2)/2)+i*(size+gap),y,size,size);
  }
  ctx.globalAlpha=1;
}

function drawAuthField(x,y,w,label,val) {
  setFont(8,'700','Arial'); noGlow(); txt(label,x,y-4,'#7a7a7a','left');
  ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.lineWidth=1; ctx.strokeRect(x,y,w,24);
  setFont(10,'700','Arial'); txt(val||'Not set',x+8,y+16,'#222','left');
}

function drawAuthOverlay(t) {
  if (authFlowState==='idle') return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.68)'; ctx.fillRect(0,0,LW,LH);
  const w=310,h=180,x=(LW-w)/2,y=(LH-h)/2;
  const stateCol=authFlowState==='success'?CFG.GR:authFlowState==='error'?CFG.PK:CFG.CY;
  ctx.fillStyle='#000'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle=stateCol; ctx.lineWidth=2; glow(stateCol,14); ctx.strokeRect(x,y,w,h);

  const title=authFlowState==='loading'?'AUTH IN PROGRESS':(authFlowState==='error'?'SIGN-IN FAILED':'AUTH SUCCESS');
  setFont(14,'900'); glow(stateCol,10); txt(title,LW/2,y+28,stateCol);

  if (authFlowState==='loading') {
    setFont(10,'700',"'Share Tech Mono',monospace"); noGlow();
    txt('Please wait while we contact cloud auth...',LW/2,y+54,'rgba(220,245,255,0.85)');
    drawLoadingDots(LW/2-14,y+88,t,'#fff');
  } else if (authFlowState==='error') {
    setFont(9,'700',"'Share Tech Mono',monospace"); noGlow();
    const msg=(authFlowError||'Unknown error').slice(0,72);
    txt(msg,LW/2,y+62,'#ffb5c6');
    txt('Check credentials and try again.',LW/2,y+82,'rgba(220,245,255,0.75)');
    BTNS.authContinue={x:(LW-180)/2,y:y+h-46,w:180,h:30};
    drawNeonBtn(BTNS.authContinue.x,BTNS.authContinue.y,180,30,CFG.CY,'CONTINUE',11,1,Math.sin(t*2));
  } else {
    setFont(9,'700',"'Share Tech Mono',monospace"); noGlow();
    txt((authFlowMsg||'Done.').slice(0,72),LW/2,y+62,'rgba(190,255,190,0.95)');
    txt('Auth complete. Return to main menu.',LW/2,y+82,'rgba(220,245,255,0.75)');
    BTNS.authRestart={x:(LW-180)/2,y:y+h-46,w:180,h:30};
    drawNeonBtn(BTNS.authRestart.x,BTNS.authRestart.y,180,30,CFG.GR,'MAIN MENU',11,1,Math.sin(t*2));
  }
  ctx.restore();
}

function drawSignInScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(20,'900','Arial'); noGlow(); txt('Sign In',LW/2,86,'#202226');
  setFont(9,'400','Arial'); txt('Enter your email and password',LW/2,106,'#7b7b7b');

  const x=40,y=132,w=LW-80;
  ctx.fillStyle='#f8f8f8'; ctx.fillRect(x,y,w,372);
  ctx.strokeStyle='rgba(0,0,0,0.15)'; ctx.strokeRect(x,y,w,372);

  BTNS.signinEmail={x:x+24,y:y+54,w:w-48,h:24};
  BTNS.signinPass={x:x+24,y:y+100,w:w-48,h:24};
  drawAuthField(BTNS.signinEmail.x,BTNS.signinEmail.y,BTNS.signinEmail.w,'Email',signinForm.email);
  drawAuthField(BTNS.signinPass.x,BTNS.signinPass.y,BTNS.signinPass.w,'Password',signinForm.password?'•'.repeat(Math.max(6,Math.min(12,signinForm.password.length))):'');

  BTNS.authSubmit={x:x+24,y:y+148,w:w-48,h:34};
  drawNeonBtn(BTNS.authSubmit.x,BTNS.authSubmit.y,BTNS.authSubmit.w,BTNS.authSubmit.h,CFG.CY,'LOGIN',12,1,Math.sin(t*2));
  BTNS.signinGoogle={x:x+24,y:y+196,w:w-48,h:34};
  drawNeonBtn(BTNS.signinGoogle.x,BTNS.signinGoogle.y,BTNS.signinGoogle.w,BTNS.signinGoogle.h,'#db4437','▣ G SIGN IN WITH GOOGLE',10,1,Math.sin(t*2.6));

  BTNS.signinSwitch={x:x+24,y:y+244,w:w-48,h:30};
  drawNeonBtn(BTNS.signinSwitch.x,BTNS.signinSwitch.y,BTNS.signinSwitch.w,BTNS.signinSwitch.h,'#a8a8a8','GO TO SIGN UP',10,1,0);

  BTNS.authBack={x:(LW-130)/2,y:LH-44,w:130,h:30};
  drawNeonBtn(BTNS.authBack.x,BTNS.authBack.y,130,30,CFG.PK,'← BACK',11,0.9,Math.sin(t*2));
}

function drawSignUpScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  setFont(20,'900','Arial'); noGlow(); txt('Sign Up',LW/2,86,'#202226');
  setFont(9,'400','Arial'); txt('Create your account (password 6-20)',LW/2,106,'#7b7b7b');
  const x=40,y=124,w=LW-80;
  ctx.fillStyle='#f8f8f8'; ctx.fillRect(x,y,w,446);
  ctx.strokeStyle='rgba(0,0,0,0.15)'; ctx.strokeRect(x,y,w,446);

  BTNS.signupName={x:x+24,y:y+40,w:w-48,h:24};
  BTNS.signupEmail={x:x+24,y:y+84,w:w-48,h:24};
  BTNS.signupPass={x:x+24,y:y+128,w:w-48,h:24};
  BTNS.signupConfirm={x:x+24,y:y+172,w:w-48,h:24};
  drawAuthField(BTNS.signupName.x,BTNS.signupName.y,BTNS.signupName.w,'Username',signupForm.username);
  drawAuthField(BTNS.signupEmail.x,BTNS.signupEmail.y,BTNS.signupEmail.w,'Email',signupForm.email);
  drawAuthField(BTNS.signupPass.x,BTNS.signupPass.y,BTNS.signupPass.w,'Password',signupForm.password?'•'.repeat(Math.max(6,Math.min(12,signupForm.password.length))):'');
  drawAuthField(BTNS.signupConfirm.x,BTNS.signupConfirm.y,BTNS.signupConfirm.w,'Confirm Password',signupForm.confirm?'•'.repeat(Math.max(6,Math.min(12,signupForm.confirm.length))):'');

  BTNS.authSubmit={x:x+24,y:y+224,w:w-48,h:34};
  drawNeonBtn(BTNS.authSubmit.x,BTNS.authSubmit.y,BTNS.authSubmit.w,BTNS.authSubmit.h,CFG.GR,'SIGN UP',12,1,Math.sin(t*2.2));

  BTNS.signupGoogle={x:x+24,y:y+272,w:w-48,h:34};
  drawNeonBtn(BTNS.signupGoogle.x,BTNS.signupGoogle.y,BTNS.signupGoogle.w,BTNS.signupGoogle.h,'#db4437','▣ G SIGN UP WITH GOOGLE',10,1,Math.sin(t*2.5));
  BTNS.signupSwitch={x:x+24,y:y+316,w:w-48,h:30};
  drawNeonBtn(BTNS.signupSwitch.x,BTNS.signupSwitch.y,BTNS.signupSwitch.w,BTNS.signupSwitch.h,'#a8a8a8','ALREADY HAVE ACCOUNT? SIGN IN',9,1,0);

  BTNS.authBack={x:(LW-130)/2,y:LH-44,w:130,h:30};
  drawNeonBtn(BTNS.authBack.x,BTNS.authBack.y,130,30,CFG.PK,'← BACK',11,0.9,Math.sin(t*2));
}

async function writeCloudUserInfo(extra={}) {
  if (!fbReady || !fbDb || !fbUser) return;
  cloudProfileRoot=await resolveCloudRoot(fbUser.uid,true);
  const payload={
    uid:fbUser.uid,
    email:fbUser.email||'',
    name:fbUser.displayName||auth.name||'Runner',
    displayName:fbUser.displayName||auth.name||'Runner',
    verified:((extra&&typeof extra.verified==='boolean')?!!extra.verified:!!(auth&&auth.verified===true)),
    bio:profileBio||'',
    avatar:profileAvatar||'',
    pfpLink:profileAvatar||'',
    pfpLinkId:getAvatarLinkId(profileAvatar)||'none',
    status:String((auth&&auth.status)||'offline'),
    statusPref:String((auth&&auth.statusPref)||'online'),
    lastSeen:Number((auth&&auth.lastSeen)||Date.now()),
    gems:loadBank(),
    bestScore:Math.floor(bestScore||0),
    selectedSkin:selectedChar||'default',
    selectedAura:selectedAura||'none',
    selectedTheme:selectedTheme||'classic',
    cloudRoot:cloudProfileRoot||CLOUD_INFO_ROOT,
    updatedAt:Date.now(),
    admin:!!(auth&&auth.admin),
    ...extra,
  };
  await fbDb.ref(`${cloudProfileRoot}/${fbUser.uid}`).update(payload);
  await syncSlopeMirror({updatedAt:String(payload.updatedAt)});
}

function buildLocalProgressPayload(){
  return {
    gems:loadBank(),
    upgrades:loadUpgrades(),
    unlocked:loadUnlocked(),
    unlockedAuras:unlockedAuras||['none'],
    unlockedThemes:unlockedThemes||['classic'],
    selectedChar:selectedChar||'default',
    selectedAura:selectedAura||'none',
    selectedTheme:selectedTheme||'classic',
    doneObjs:loadDoneObjs(),
    options:OPTION_PREFS,
    bestScore:bestScore||0,
    modeScores:modeScores||{endless:0,adventure:0,impossible:0,ltm:0},
    runs:parseInt(localStorage.getItem('slope_runs')||'0',10),
    totalTime:parseFloat(localStorage.getItem('slope_totalTime')||'0'),
    updatedAt:Date.now(),
    admin:!!(auth&&auth.admin),
  };
}

async function syncProgressToCloud(reason='auto') {
  if (!isSignedIn || !fbReady || !fbDb || !fbUser) return;
  try {
    cloudProfileRoot=await resolveCloudRoot(fbUser.uid,true);
    await fbDb.ref(`${cloudProfileRoot}/${fbUser.uid}/progress`).set(buildLocalProgressPayload());
    cloudGemCount=loadBank();
    cloudUpdatedAt=Date.now();
    await syncSlopeMirror({gems:String(cloudGemCount),bestScore:String(Math.floor(bestScore||0)),endlessScore:String(Math.floor(modeScores.endless||0)),adventureScore:String(Math.floor(modeScores.adventure||0)),impossibleScore:String(Math.floor(modeScores.impossible||0)),ltmScore:String(Math.floor(modeScores.ltm||0)),updatedAt:String(cloudUpdatedAt)});
  } catch (e) {}
}
function queueCloudSync(delay=700){
  if (!isSignedIn) return;
  if (cloudSyncTimer) clearTimeout(cloudSyncTimer);
  cloudSyncTimer=setTimeout(()=>{ cloudSyncTimer=0; syncProgressToCloud('queued'); },delay);
}

async function loadCloudProfileAndProgress() {
  if (!fbReady || !fbDb || !fbUser) return;
  try {
    cloudProfileRoot=await resolveCloudRoot(fbUser.uid,true);
    const snap=await fbDb.ref(`${cloudProfileRoot}/${fbUser.uid}`).get();
    const val=snap&&snap.val?snap.val():null;
    if (!val) {
      await writeCloudUserInfo({createdAt:Date.now(),admin:false});
      await syncProgressToCloud('init');
      cloudGemCount=loadBank();
      cloudUpdatedAt=Date.now();
      cloudJoinedAt=cloudUpdatedAt;
      await syncSlopeMirror({createdAt:String(cloudUpdatedAt),updatedAt:String(cloudUpdatedAt)});
      return;
    }
    let slopeMirror=null;
    try {
      const slopeSnap=await fbDb.ref(`${CLOUD_SLOPE_ROOT}/${fbUser.uid}`).get();
      slopeMirror=slopeSnap&&slopeSnap.val?slopeSnap.val():null;
    } catch (e) {}

    profileBio=val.bio||((slopeMirror&&slopeMirror.bio)||'');
    profileAvatar=val.avatar||((slopeMirror&&slopeMirror.pfpLink)||'');
    const dbStatus=String(val.status??(slopeMirror&&slopeMirror.status)??'online').toLowerCase();
    const dbLastSeen=Number(val.lastSeen??(slopeMirror&&slopeMirror.lastSeen)??Date.now())||Date.now();
    if (val.progress) {
      const p=val.progress;
      if (typeof p.gems==='number') saveBank(p.gems);
      if (p.upgrades) { upgrades={...upgrades,...p.upgrades}; saveUpgrades(upgrades); }
      if (Array.isArray(p.unlocked)) { unlockedChars=p.unlocked.slice(); saveUnlocked(unlockedChars); }
      if (Array.isArray(p.doneObjs)) { doneObjs=p.doneObjs.slice(); saveDoneObjs(doneObjs); }
      if (Array.isArray(p.unlockedAuras)) { unlockedAuras=p.unlockedAuras.slice(); saveAuraUnlocks(unlockedAuras); }
      if (Array.isArray(p.unlockedThemes)) { unlockedThemes=p.unlockedThemes.slice(); saveThemeUnlocks(unlockedThemes); }
      if (p.selectedChar) { setSelectedChar(p.selectedChar); }
      if (p.selectedAura) { setSelectedAura(p.selectedAura); }
      if (p.selectedTheme) { setSelectedTheme(p.selectedTheme); }
      if (typeof p.bestScore==='number') bestScore=Math.max(bestScore,p.bestScore);
      if (p.modeScores && typeof p.modeScores==='object') modeScores={...modeScores,...p.modeScores};
      if (p.options && typeof p.options==='object') { OPTION_PREFS={...OPTION_PREFS,...p.options}; saveOptionPrefs(); }
    }
    cloudGemCount=Number((val.progress&&val.progress.gems)|| (slopeMirror&&slopeMirror.gems));
    if (!Number.isFinite(cloudGemCount)) cloudGemCount=loadBank();
    cloudUpdatedAt=Number((val.progress&&val.progress.updatedAt)||val.updatedAt||(slopeMirror&&slopeMirror.updatedAt)||0)||0;
    cloudJoinedAt=parseCloudTs(val.createdAt||(slopeMirror&&slopeMirror.createdAt)||(fbUser&&fbUser.metadata&&fbUser.metadata.creationTime)||0);
    const isAdminDb=(String(val.admin??(slopeMirror&&slopeMirror.admin)??'false')==='true') || val.admin===true || (slopeMirror&&slopeMirror.admin===true);
    const dbVerifiedRaw=(val.verified??(slopeMirror&&slopeMirror.verified));
    const dbVerified=(dbVerifiedRaw===true||String(dbVerifiedRaw)==='true');
    auth={...auth,signedIn:true,name:val.name||auth.name,email:val.email||auth.email,uid:fbUser.uid,verified:dbVerified,bio:profileBio,avatar:profileAvatar,admin:isAdminDb,status:STATUS_COLORS[dbStatus]?dbStatus:'online',statusPref:STATUS_COLORS[String(val.statusPref||'').toLowerCase()]?String(val.statusPref).toLowerCase():(STATUS_COLORS[dbStatus]?dbStatus:'online'),lastSeen:dbLastSeen};
    saveAuth(auth);
    refreshAdminFlag();
  } catch (e) {}
}

async function handleAuthSignIn(){
  if (!fbReady || !fbAuth) { authFlowState='error'; authFlowError='Cloud service unavailable'; return; }
  try {
    authFlowState='loading'; authFlowError='';
    const cred=await fbAuth.signInWithEmailAndPassword((signinForm.email||'').trim(),signinForm.password||'');
    fbUser=cred.user;
    await loadCloudProfileAndProgress();
    authFlowState='success';
    authFlowMsg='Signed in and cloud sync ready. Tap REFRESH GAME.';
  } catch (e) {
    const code=String((e&&e.code)||'');
    authFlowState='error';
    if (code.includes('wrong-password')||code.includes('invalid-credential')) authFlowError='Invalid email or password.';
    else if (code.includes('user-not-found')) authFlowError='No account found for this email.';
    else if (code.includes('too-many-requests')) authFlowError='Too many attempts. Wait and retry.';
    else authFlowError='Sign in failed. Please try again.';
  }
}

async function handleAuthGoogleSignIn(){
  if (!fbReady || !fbAuth || !window.firebase || !firebase.auth) { authFlowState='error'; authFlowError='Cloud service unavailable'; return; }
  try {
    authFlowState='loading'; authFlowError=''; authFlowMsg='Open in Google popup...';
    const provider=new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({prompt:'select_account'});
    const cred=await fbAuth.signInWithPopup(provider);
    fbUser=cred&&cred.user?cred.user:null;
    await loadCloudProfileAndProgress();
    totalGems=loadBank();
    authFlowState='success';
    authFlowMsg='Google sign-in complete. Cloud data refreshed.';
  } catch (e) {
    const code=String((e&&e.code)||'');
    authFlowState='error';
    if (code.includes('popup-blocked')) authFlowError='Popup blocked. Allow popups and try again.';
    else if (code.includes('popup-closed-by-user')) authFlowError='Google popup closed before completion.';
    else authFlowError='Google sign in failed. Please try again.';
  }
}

function resetLocalForNewAccount(){
  bestScore=0;
  modeScores={endless:0,adventure:0,impossible:0,ltm:0};
  saveBank(0);
  totalGems=0;
  localStorage.setItem('slope_runs','0');
  localStorage.setItem('slope_totalTime','0');
}

async function generateUniqueNeonRunnerName(){
  if (!fbDb) return `NeonRunner${Math.floor(10000000+Math.random()*90000000)}`;
  for (let i=0;i<9;i++) {
    const candidate=`NeonRunner${Math.floor(10000000+Math.random()*90000000)}`;
    const taken=await isUsernameTaken(candidate);
    if (!taken) return candidate;
  }
  return `NeonRunner${Date.now().toString().slice(-8)}`;
}

async function handleAuthSignUp(){
  const pwd=signupForm.password||'';
  if (pwd.length<6 || pwd.length>20) { authFlowState='error'; authFlowError='Password must be 6 to 20 chars.'; return; }
  if (signupForm.password!==signupForm.confirm) { authFlowState='error'; authFlowError='Password mismatch.'; return; }
  if (!fbReady || !fbAuth) { authFlowState='error'; authFlowError='Cloud service unavailable'; return; }
  try {
    authFlowState='loading'; authFlowError='';
    const desired=(signupForm.username||'').trim();
    let finalName='';
    if (desired) {
      if (desired.length<3 || desired.length>32) { authFlowState='error'; authFlowError='Username must be 3 to 32 chars.'; return; }
      if (!/^[a-zA-Z0-9_\- ]+$/.test(desired)) { authFlowState='error'; authFlowError='Use letters, numbers, spaces, _ or -.'; return; }
      const clash=await isUsernameTaken(desired);
      if (clash) { authFlowState='error'; authFlowError='Username taken. Try another one.'; return; }
      finalName=desired;
    } else {
      finalName=await generateUniqueNeonRunnerName();
    }
    const cred=await fbAuth.createUserWithEmailAndPassword((signupForm.email||'').trim(),pwd);
    if (cred.user) {
      await cred.user.updateProfile({displayName:finalName});
      await cred.user.sendEmailVerification();
      fbUser=cred.user;
      auth={signedIn:true,name:finalName,email:cred.user.email||signupForm.email,uid:cred.user.uid,verified:false,bio:'',avatar:'',status:'online',statusPref:'online',lastSeen:Date.now()};
      isSignedIn=true; saveAuth(auth);
      resetLocalForNewAccount();
      await writeCloudUserInfo({name:auth.name,email:auth.email,verified:false,createdAt:Date.now(),admin:false,status:'online',statusPref:'online',lastSeen:Date.now(),progress:{bestScore:0,gems:0,modeScores:{endless:0,adventure:0,impossible:0,ltm:0}}});
      try { await syncSlopeMirror({bestScore:'0',endlessScore:'0',adventureScore:'0',impossibleScore:'0',ltmScore:'0',gems:'0',status:'online',updatedAt:String(Date.now())}); } catch(e) {}
      authFlowState='success';
      authFlowMsg='Verification email sent. Verify, then tap REFRESH GAME.';
    }
  } catch (e) {
    authFlowState='error'; authFlowError='Sign up failed. Please try again.';
  }
}

function handleSignInTap(p){
  if (hitBtn(p,BTNS.authBack)) { SFX.click(); doTransition('MENU'); return; }
  if (hitBtn(p,BTNS.signinSwitch)) { SFX.click(); doTransition('SIGNUP'); return; }
  if (hitBtn(p,BTNS.signinEmail)) { SFX.click(); openInputDialog({title:'SIGN IN',label:'Email',value:signinForm.email||'',maxLen:64,onSubmit:v=>{signinForm.email=(v||'').trim();}}); return; }
  if (hitBtn(p,BTNS.signinPass)) { SFX.click(); openInputDialog({title:'SIGN IN',label:'Password',value:'',maxLen:20,secret:true,onSubmit:v=>{signinForm.password=v||'';}}); return; }
  if (hitBtn(p,BTNS.authSubmit)) { SFX.click(); handleAuthSignIn(); return; }
  if (hitBtn(p,BTNS.signinGoogle)) { SFX.click(); handleAuthGoogleSignIn(); return; }
  if (hitBtn(p,BTNS.authContinue)) { SFX.click(); authFlowState='idle'; authFlowError=''; authFlowMsg=''; return; }
  if (hitBtn(p,BTNS.authRestart)) { SFX.click(); goMenu(); doTransition('MENU'); authFlowState='idle'; return; }
}

function handleSignUpTap(p){
  if (hitBtn(p,BTNS.authBack)) { SFX.click(); doTransition('MENU'); return; }
  if (hitBtn(p,BTNS.signupSwitch)) { SFX.click(); doTransition('SIGNIN'); return; }
  if (hitBtn(p,BTNS.signupName)) { SFX.click(); openInputDialog({title:'SIGN UP',label:'Username',value:signupForm.username||'',maxLen:32,onSubmit:v=>{signupForm.username=(v||'').trim();}}); return; }
  if (hitBtn(p,BTNS.signupEmail)) { SFX.click(); openInputDialog({title:'SIGN UP',label:'Email',value:signupForm.email||'',maxLen:64,onSubmit:v=>{signupForm.email=(v||'').trim();}}); return; }
  if (hitBtn(p,BTNS.signupPass)) { SFX.click(); openInputDialog({title:'SIGN UP',label:'Password (6-20)',value:'',maxLen:20,secret:true,onSubmit:v=>{signupForm.password=v||'';}}); return; }
  if (hitBtn(p,BTNS.signupConfirm)) { SFX.click(); openInputDialog({title:'SIGN UP',label:'Confirm Password',value:'',maxLen:20,secret:true,onSubmit:v=>{signupForm.confirm=v||'';}}); return; }
  if (hitBtn(p,BTNS.authSubmit)) { SFX.click(); handleAuthSignUp(); return; }
  if (hitBtn(p,BTNS.signupGoogle)) { SFX.click(); handleAuthGoogleSignIn(); return; }
  if (hitBtn(p,BTNS.authContinue)) { SFX.click(); authFlowState='idle'; authFlowError=''; authFlowMsg=''; return; }
  if (hitBtn(p,BTNS.authRestart)) { SFX.click(); goMenu(); doTransition('MENU'); authFlowState='idle'; return; }
}


function drawAdminAuthScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.08,0.03); drawBgSquares();
  const x=32,y=118,w=LW-64,h=340;
  ctx.save();
  ctx.fillStyle='rgba(6,10,14,0.95)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(255,230,0,0.45)'; ctx.lineWidth=2; glow(CFG.YL,12); ctx.strokeRect(x,y,w,h);
  setFont(24,'900'); glow(CFG.YL,16); txt('ADMIN AUTH',LW/2,y+38,CFG.YL);
  setFont(9,'700',"'Share Tech Mono',monospace"); noGlow();
  txt('ENTER ADMIN + YOUR ACCOUNT PASSWORD',LW/2,y+62,'rgba(255,245,160,0.9)');
  BTNS.adminAuthInput={x:x+26,y:y+96,w:w-52,h:42};
  drawNeonBtn(BTNS.adminAuthInput.x,BTNS.adminAuthInput.y,BTNS.adminAuthInput.w,BTNS.adminAuthInput.h,CFG.CY,adminAuthInput?'••••••••••':'TYPE ADMIN+PASSWORD',10,1,0);
  BTNS.adminAuthSubmit={x:x+26,y:y+152,w:w-52,h:36};
  drawNeonBtn(BTNS.adminAuthSubmit.x,BTNS.adminAuthSubmit.y,BTNS.adminAuthSubmit.w,BTNS.adminAuthSubmit.h,CFG.GR,'VERIFY',12,1,Math.sin(t*2));
  const msgCol=adminAuthState==='error'?CFG.PK:adminAuthState==='ok'?CFG.GR:'rgba(200,235,255,0.8)';
  const msg=adminAuthMsg || 'Tip: Press M from menu/profile/options.';
  txt(msg,LW/2,y+214,msgCol);
  BTNS.adminBack={x:(LW-140)/2,y:y+h-50,w:140,h:34};
  drawNeonBtn(BTNS.adminBack.x,BTNS.adminBack.y,140,34,CFG.PK,'← BACK',11,1,Math.sin(t*2.2));
  ctx.restore();
}

async function verifyAdminPassword(){
  if (!isAdminUser) { adminAuthState='error'; adminAuthMsg='Admin account required.'; return; }
  const raw=String(adminAuthInput||'').trim();
  if (!raw.startsWith('ADMIN')) { adminAuthState='error'; adminAuthMsg='Prefix with ADMIN + your password.'; return; }
  const pwd=raw.slice(5);
  if (!pwd) { adminAuthState='error'; adminAuthMsg='Missing password after ADMIN prefix.'; return; }
  if (!fbUser || !window.firebase || !firebase.auth || !firebase.auth.EmailAuthProvider) {
    adminAuthState='error'; adminAuthMsg='Email/password auth required.'; return;
  }
  try {
    const email=String((fbUser&&fbUser.email)||(auth&&auth.email)||'').trim();
    if (!email) { adminAuthState='error'; adminAuthMsg='Current account has no email.'; return; }
    const cred=firebase.auth.EmailAuthProvider.credential(email,pwd);
    await fbUser.reauthenticateWithCredential(cred);
    adminSessionUnlocked=true;
    adminAuthState='ok';
    adminAuthMsg='Access granted.';
    addNotif('Admin menu unlocked.',CFG.YL);
    doTransition('ADMIN_MENU');
  } catch (e) {
    adminAuthState='error';
    adminAuthMsg='Invalid ADMIN+password.';
    addNotif('Admin auth failed.',CFG.PK);
  }
}

async function adminApplyVerifyStatus(){
  const uid=String(adminVerifyUid||'').trim();
  if (!uid) { addNotif('Admin: set target UID first.',CFG.PK); return; }
  if (!fbReady || !fbDb) { addNotif('Admin: cloud service unavailable.',CFG.PK); return; }
  const ts=Date.now();
  try {
    const roots=[CLOUD_INFO_ROOT,...CLOUD_INFO_ROOT_FALLBACKS,cloudProfileRoot].filter(Boolean).filter((v,i,a)=>a.indexOf(v)===i);
    const tasks=[];
    roots.forEach(root=>tasks.push(fbDb.ref(`${root}/${uid}`).update({verified:!!adminVerifyValue,updatedAt:ts})));
    tasks.push(fbDb.ref(`${CLOUD_SLOPE_ROOT}/${uid}`).update({verified:String(!!adminVerifyValue),updatedAt:String(ts)}));
    const settled=await Promise.allSettled(tasks);
    const ok=settled.some(r=>r.status==='fulfilled');
    if (!ok) throw new Error('no updates applied');
    if (auth && auth.uid===uid) { auth={...auth,verified:!!adminVerifyValue}; saveAuth(auth); }
    addNotif(`Admin: verified for ${uid.slice(0,8)}... = ${adminVerifyValue?'TRUE':'FALSE'}`,CFG.YL);
  } catch (e) {
    addNotif('Admin: verify update failed.',CFG.PK);
  }
}

function handleAdminAuthTap(p){
  if (hitBtn(p,BTNS.adminBack)) { SFX.click(); doTransition('MENU'); return; }
  if (hitBtn(p,BTNS.adminAuthInput)) {
    SFX.click();
    openInputDialog({title:'ADMIN AUTH',label:'Password',value:'',maxLen:64,secret:true,onSubmit:v=>{adminAuthInput=String(v||'');}});
    return;
  }
  if (hitBtn(p,BTNS.adminAuthSubmit)) { SFX.click(); verifyAdminPassword(); return; }
}

function drawAdminToggle(x,y,label,on,key){
  const col=on?CFG.GR:'#45505a';
  BTNS[key]={x,y,w:300,h:28};
  drawNeonBtn(x,y,300,28,col,`${on?'☑':'☐'} ${label}`,9,1,0);
}

function drawAdminMenuScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.08,0.03); drawBgSquares();
  const x=20,y=70,w=LW-40,h=620;
  const viewX=x+10, viewY=y+58, viewW=w-20, viewH=h-106;
  adminViewH=viewH;
  ctx.save();
  ctx.fillStyle='rgba(6,10,14,0.95)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(255,230,0,0.45)'; ctx.lineWidth=2; glow(CFG.YL,12); ctx.strokeRect(x,y,w,h);
  setFont(22,'900'); glow(CFG.YL,14); txt('ADMIN MENU',LW/2,y+34,CFG.YL);
  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt('WARNING: CLIENT-SIDE ADMIN TOOLS ARE FOR DEV USE ONLY.',LW/2,y+49,'rgba(255,200,140,0.9)');

  ctx.beginPath(); ctx.rect(viewX,viewY,viewW,viewH); ctx.clip();
  ctx.translate(0,adminScroll);
  let cy=viewY+8;
  const lh=34;
  setFont(9,'700',"'Share Tech Mono',monospace"); noGlow();
  txt(`Admin: ${auth.name||'Runner'} (${auth.email||'no-email'})`,viewX+8,cy,'rgba(240,255,190,0.95)','left');
  cy+=18;
  txt(`Selected Skin/Aura/Theme: ${selectedChar} / ${selectedAura} / ${selectedTheme}`,viewX+8,cy,'rgba(200,245,255,0.85)','left');
  cy+=14;

  BTNS.adminSetGems={x:viewX+8,y:cy,w:170,h:30};
  drawNeonBtn(BTNS.adminSetGems.x,BTNS.adminSetGems.y,BTNS.adminSetGems.w,BTNS.adminSetGems.h,CFG.YL,'SET GEMS',10,1,Math.sin(t*2));
  setFont(10,'700'); glow(CFG.CY,6); txt(`${Math.floor(loadBank())} ◆`,viewX+200,cy+20,CFG.CY,'left');
  cy+=lh+6;

  drawAdminToggle(viewX+8,cy,'SYNC TO CLOUD',adminFlags.syncCloud,'adminT0'); cy+=32;
  drawAdminToggle(viewX+8,cy,'GRANT SELECTED SKIN',adminFlags.grantSkin,'adminT1'); cy+=32;
  drawAdminToggle(viewX+8,cy,'GRANT SELECTED AURA',adminFlags.grantAura,'adminT2'); cy+=32;
  drawAdminToggle(viewX+8,cy,'GRANT SELECTED THEME',adminFlags.grantTheme,'adminT3'); cy+=32;
  drawAdminToggle(viewX+8,cy,'CONFIRM LOCK ACTIONS',adminFlags.confirmLocks,'adminT4'); cy+=38;

  BTNS.adminGrantSelected={x:viewX+8,y:cy,w:viewW-16,h:30};
  drawNeonBtn(BTNS.adminGrantSelected.x,BTNS.adminGrantSelected.y,BTNS.adminGrantSelected.w,BTNS.adminGrantSelected.h,CFG.GR,'APPLY GRANT FLAGS TO SELECTED',10,1,Math.sin(t*2));
  cy+=36;

  BTNS.adminLockSelectedSkin={x:viewX+8,y:cy,w:viewW-16,h:28};
  drawNeonBtn(BTNS.adminLockSelectedSkin.x,BTNS.adminLockSelectedSkin.y,BTNS.adminLockSelectedSkin.w,BTNS.adminLockSelectedSkin.h,CFG.PK,'LOCK SELECTED SKIN',9,1,0); cy+=32;
  BTNS.adminLockSelectedAura={x:viewX+8,y:cy,w:viewW-16,h:28};
  drawNeonBtn(BTNS.adminLockSelectedAura.x,BTNS.adminLockSelectedAura.y,BTNS.adminLockSelectedAura.w,BTNS.adminLockSelectedAura.h,CFG.PK,'LOCK SELECTED AURA',9,1,0); cy+=32;
  BTNS.adminLockSelectedTheme={x:viewX+8,y:cy,w:viewW-16,h:28};
  drawNeonBtn(BTNS.adminLockSelectedTheme.x,BTNS.adminLockSelectedTheme.y,BTNS.adminLockSelectedTheme.w,BTNS.adminLockSelectedTheme.h,CFG.PK,'LOCK SELECTED THEME',9,1,0); cy+=38;

  BTNS.adminVerifyUid={x:viewX+8,y:cy,w:viewW-16,h:28};
  drawNeonBtn(BTNS.adminVerifyUid.x,BTNS.adminVerifyUid.y,BTNS.adminVerifyUid.w,BTNS.adminVerifyUid.h,CFG.CY,`TARGET UID: ${(adminVerifyUid||'NOT SET').slice(0,22)}`,9,1,0); cy+=32;
  BTNS.adminVerifyToggle={x:viewX+8,y:cy,w:viewW-16,h:28};
  drawNeonBtn(BTNS.adminVerifyToggle.x,BTNS.adminVerifyToggle.y,BTNS.adminVerifyToggle.w,BTNS.adminVerifyToggle.h,adminVerifyValue?CFG.GR:CFG.PK,`VERIFIED: ${adminVerifyValue?'TRUE':'FALSE'} (TOGGLE)`,9,1,0); cy+=32;
  BTNS.adminVerifyApply={x:viewX+8,y:cy,w:viewW-16,h:30};
  drawNeonBtn(BTNS.adminVerifyApply.x,BTNS.adminVerifyApply.y,BTNS.adminVerifyApply.w,BTNS.adminVerifyApply.h,CFG.YL,'APPLY VERIFY STATUS TO TARGET UID',9,1,Math.sin(t*2)); cy+=40;

  BTNS.adminUnlockAll={x:viewX+8,y:cy,w:viewW-16,h:30};
  drawNeonBtn(BTNS.adminUnlockAll.x,BTNS.adminUnlockAll.y,BTNS.adminUnlockAll.w,BTNS.adminUnlockAll.h,CFG.CY,'UNLOCK ALL SKINS / AURAS / THEMES',10,1,0); cy+=36;
  BTNS.adminLockAll={x:viewX+8,y:cy,w:viewW-16,h:30};
  drawNeonBtn(BTNS.adminLockAll.x,BTNS.adminLockAll.y,BTNS.adminLockAll.w,BTNS.adminLockAll.h,CFG.PK,'LOCK ALL TO DEFAULT',10,1,0); cy+=42;

  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt('Scroll for more. Press M to reopen admin auth.',LW/2,cy,'rgba(180,230,255,0.65)');
  adminContentH=(cy-viewY)+20;
  adminScroll=clamp(adminScroll,minAdminScroll(),0);

  ctx.restore();
  const sbX=viewX+viewW-6, sbY=viewY, sbH=viewH;
  ctx.fillStyle='rgba(255,230,0,0.14)'; ctx.fillRect(sbX,sbY,5,sbH);
  if (minAdminScroll()<0) {
    const thumbH=Math.max(24,(viewH/(viewH+Math.abs(minAdminScroll())))*sbH);
    const track=sbH-thumbH;
    const thumbY=sbY + ((-adminScroll)/Math.abs(minAdminScroll()))*track;
    ctx.fillStyle='rgba(255,230,0,0.8)'; ctx.fillRect(sbX,thumbY,5,thumbH);
  }

  BTNS.adminBack={x:(LW-140)/2,y:y+h-40,w:140,h:30};
  drawNeonBtn(BTNS.adminBack.x,BTNS.adminBack.y,140,30,CFG.PK,'← BACK',11,1,Math.sin(t*2));
  ctx.restore();
}

function hitAdminBtn(p,b){
  if (!b) return false;
  const py=p.y-adminScroll;
  return p.x>=b.x && p.x<=b.x+b.w && py>=b.y && py<=b.y+b.h;
}

function handleAdminMenuTap(p){
  if (hitBtn(p,BTNS.adminBack)) { SFX.click(); doTransition('MENU'); return; }
  if (!adminSessionUnlocked) { doTransition('ADMIN_AUTH'); return; }
  if (hitAdminBtn(p,BTNS.adminSetGems)) {
    SFX.click();
    openInputDialog({title:'ADMIN',label:'Gems: 100=set, +100=add, -100=remove',value:String(Math.floor(loadBank())),maxLen:12,onSubmit:v=>{ const raw=String(v||'').trim(); if (!/^[+-]?\d+$/.test(raw)) { addNotif('Admin: enter a whole number.',CFG.PK); return; } const parsed=Number.parseInt(raw,10); if (!Number.isFinite(parsed)) { addNotif('Admin: invalid gems value.',CFG.PK); return; } const cur=Math.floor(loadBank()); const n=raw.startsWith('+')?clamp(cur+Math.abs(parsed),0,999999999):(raw.startsWith('-')?clamp(cur-Math.abs(parsed),0,999999999):clamp(parsed,0,999999999)); saveBank(n); totalGems=n; if (adminFlags.syncCloud) queueCloudSync(50); addNotif('Admin: gems now '+n+'.',CFG.YL); }});
    return;
  }
  if (hitAdminBtn(p,BTNS.adminT0)) { SFX.click(); adminFlags.syncCloud=!adminFlags.syncCloud; return; }
  if (hitAdminBtn(p,BTNS.adminT1)) { SFX.click(); adminFlags.grantSkin=!adminFlags.grantSkin; return; }
  if (hitAdminBtn(p,BTNS.adminT2)) { SFX.click(); adminFlags.grantAura=!adminFlags.grantAura; return; }
  if (hitAdminBtn(p,BTNS.adminT3)) { SFX.click(); adminFlags.grantTheme=!adminFlags.grantTheme; return; }
  if (hitAdminBtn(p,BTNS.adminT4)) { SFX.click(); adminFlags.confirmLocks=!adminFlags.confirmLocks; return; }
  if (hitAdminBtn(p,BTNS.adminGrantSelected)) { SFX.click(); adminUnlockSelected(); return; }
  if (hitAdminBtn(p,BTNS.adminVerifyUid)) {
    SFX.click();
    openInputDialog({title:'ADMIN VERIFY',label:'Target UID',value:adminVerifyUid||'',maxLen:80,onSubmit:v=>{adminVerifyUid=String(v||'').trim();}});
    return;
  }
  if (hitAdminBtn(p,BTNS.adminVerifyToggle)) { SFX.click(); adminVerifyValue=!adminVerifyValue; return; }
  if (hitAdminBtn(p,BTNS.adminVerifyApply)) { SFX.click(); adminApplyVerifyStatus(); return; }
  if (hitAdminBtn(p,BTNS.adminLockSelectedSkin)) { SFX.click(); if (!adminFlags.confirmLocks) { addNotif('Enable CONFIRM LOCK ACTIONS.',CFG.PK); return; } if (selectedChar!=='default') unlockedChars=unlockedChars.filter(id=>id!==selectedChar); if (!unlockedChars.includes('default')) unlockedChars.unshift('default'); if (!unlockedChars.includes(selectedChar)) setSelectedChar('default'); saveAdminUnlocks(); return; }
  if (hitAdminBtn(p,BTNS.adminLockSelectedAura)) { SFX.click(); if (!adminFlags.confirmLocks) { addNotif('Enable CONFIRM LOCK ACTIONS.',CFG.PK); return; } if (selectedAura!=='none') unlockedAuras=unlockedAuras.filter(id=>id!==selectedAura); if (!unlockedAuras.includes('none')) unlockedAuras.unshift('none'); if (!unlockedAuras.includes(selectedAura)) setSelectedAura('none'); saveAdminUnlocks(); return; }
  if (hitAdminBtn(p,BTNS.adminLockSelectedTheme)) { SFX.click(); if (!adminFlags.confirmLocks) { addNotif('Enable CONFIRM LOCK ACTIONS.',CFG.PK); return; } if (selectedTheme!=='classic') unlockedThemes=unlockedThemes.filter(id=>id!==selectedTheme); if (!unlockedThemes.includes('classic')) unlockedThemes.unshift('classic'); if (!unlockedThemes.includes(selectedTheme)) setSelectedTheme('classic'); saveAdminUnlocks(); return; }
  if (hitAdminBtn(p,BTNS.adminUnlockAll)) { SFX.click(); adminUnlockAll(); return; }
  if (hitAdminBtn(p,BTNS.adminLockAll)) { SFX.click(); adminLockAll(); return; }
}

function drawProfileScreen(t){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);
  drawPerspGrid(terrain.scrollY*0.1,0.04); drawBgSquares();

  const x=18,y=78,w=LW-36,h=590;
  ctx.save();
  ctx.fillStyle='rgba(6,10,14,0.95)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='rgba(0,245,255,0.35)'; ctx.lineWidth=1.5; glow(CFG.CY,8); ctx.strokeRect(x,y,w,h);

  setFont(32,'900'); glow(CFG.CY,18); txt('PROFILE',LW/2,y+40,CFG.CY);
  setFont(9,'700',"'Share Tech Mono',monospace"); noGlow();
  txt(isSignedIn?'CLOUD SAVE ENABLED':'GUEST LOCAL SAVE',LW/2,y+58,isSignedIn?CFG.GR:CFG.YL);

  const avatarX=x+64, avatarY=y+104, avatarR=34;
  BTNS.profileAvatar={x:avatarX-avatarR-6,y:avatarY-avatarR-6,w:(avatarR+6)*2,h:(avatarR+6)*2,cx:avatarX,cy:avatarY,r:avatarR+6};
  ctx.save();
  const cardAvatar=String(profileAvatar||'');
  if (cardAvatar) {
    const img=new Image(); img.src=cardAvatar;
    ctx.beginPath(); ctx.arc(avatarX,avatarY,avatarR,0,Math.PI*2); ctx.clip();
    ctx.drawImage(img,avatarX-avatarR,avatarY-avatarR,avatarR*2,avatarR*2);
  } else {
    glow('#9fb8cc',10); circle(avatarX,avatarY,avatarR,'#1f2c36');
    drawDefaultProfileIcon(avatarX,avatarY,avatarR,'rgba(216,246,255,0.95)');
  }
  ctx.restore();
  glow(CFG.CY,12); ctx.strokeStyle='rgba(0,245,255,0.55)'; ctx.lineWidth=2; circle(avatarX,avatarY,avatarR+3,CFG.CY,false);
  const isHold=profileAvatarHoldFX || (profileAvatarPressing && (Date.now()-profileAvatarPressStart>320));
  if (isHold) {
    ctx.save();
    ctx.beginPath(); ctx.arc(avatarX,avatarY,avatarR+1,0,Math.PI*2); ctx.clip();
    ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(avatarX-avatarR-2,avatarY-avatarR-2,(avatarR+2)*2,(avatarR+2)*2);
    setFont(9,'900',"'Share Tech Mono',monospace"); noGlow(); txt('UPLOAD',avatarX,avatarY+4,'#fff');
    ctx.restore();
  }

  const left=x+118;
  const btnH=30, btnGap=8;
  const signOutY=y+h-74;
  const deleteY=signOutY-(btnH+btnGap);
  const passY=deleteY-(btnH+btnGap);
  const bioBtnY=passY-(btnH+btnGap);
  const uploadY=bioBtnY-(btnH+btnGap);
  const usernameBtnY=uploadY-(btnH+btnGap);
  const usernameInfoY=usernameBtnY-8;
  const infoX=x+110, infoY=y+74, infoW=w-148, infoH=Math.max(120, usernameInfoY-infoY-12);
  const totalTimeSec=Math.max(0, Number(localStorage.getItem('slope_totalTime')||0));
  const lines=isSignedIn ? [
    ['Display Name',auth.name||'Player'],
    ['When Joined',fmtCloudTs(cloudJoinedAt)],
    ['Email',auth.email||''],
    ['Verified',auth.verified?'YES':'NO'],
    ['Best Score',String(Math.floor(bestScore))],
    ['Gems (Local)',`${Math.floor(loadBank())}`],
    ['Gems (Cloud)',`${Math.floor(cloudGemCount||0)}`],
    ['Cloud Path',cloudProfileRoot.replace('SLOPE/','')],
    ['PFP Link ID',getAvatarLinkId(profileAvatar)||'none'],
    ['Last Cloud Sync',fmtCloudTs(cloudUpdatedAt)],
    ['Avg Run Time',`${runAvgTime().toFixed(1)}s`],
    ['Total Time Played',`${totalTimeSec.toFixed(1)}s`],
    ['Active Skin',String((CHAR_CATALOG.find(c=>c.id===selectedChar)||CHAR_CATALOG[0]).name)],
    ['Active Aura',String((AURA_CATALOG.find(a=>a.id===selectedAura)||AURA_CATALOG[0]).name)],
    ['Active Theme',String((THEME_CATALOG.find(t2=>t2.id===selectedTheme)||THEME_CATALOG[0]).name)],
    ['Unlocked Skins',String((unlockedChars||[]).length)],
    ['Unlocked Auras',String((unlockedAuras||[]).length)],
    ['Unlocked Themes',String((unlockedThemes||[]).length)],
    ['Upgrade Levels',Object.values(loadUpgrades()).join(' / ')],
  ] : [
    ['Time Played',`${totalTimeSec.toFixed(1)}s`],
    ['Gems',`${Math.floor(loadBank())}`],
  ];
  profileViewH=infoH;
  profileContentH=10+lines.length*34 + (isSignedIn?84:0);
  profileScroll=clamp(profileScroll,minProfileScroll(),0);

  BTNS.profileInfoBox={x:infoX,y:infoY,w:infoW,h:infoH};
  ctx.save();
  ctx.beginPath(); ctx.rect(infoX,infoY,infoW,infoH); ctx.clip();
  ctx.translate(0,profileScroll);
  lines.forEach((entry,i)=>{
    const yy=infoY+10+i*34;
    setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt(entry[0],left,yy,'rgba(0,245,255,0.7)','left');
    const isNameLine=entry[0]==='Display Name';
    const hasAdmin=isNameLine && !!(auth&&auth.admin===true);
    const hasVerified=isNameLine && !!(auth&&auth.verified===true);
    const nameBase=String(entry[1]||'Player');
    const roleTxt=isNameLine?(hasAdmin&&hasVerified?`${nameBase} | ADMIN | VERIFIED`:(hasAdmin?`${nameBase} | ADMIN`:(hasVerified?`${nameBase} | VERIFIED`:nameBase))):String(entry[1]||'');
    const vcol=hasAdmin?((Math.sin(t*7)>0)?CFG.YL:'#fff47a'):'#d8f6ff';
    setFont(10,'700'); glow(vcol,6); txt(roleTxt,left,yy+14,vcol,'left');
    if (isNameLine) {
      const tw=ctx.measureText(roleTxt).width;
      let bx=left+tw+12;
      if (hasAdmin) { drawRoleBadgeSquare(bx,yy+10,10,CFG.YL,t,false); bx+=16; }
      if (hasVerified) drawRoleBadgeSquare(bx,yy+10,10,'#33aaff',t,true);
    }
  });
  if (isSignedIn) {
    const bioY=infoY+10+lines.length*34+6;
    ctx.fillStyle='rgba(0,245,255,0.06)'; ctx.fillRect(x+14,bioY,w-28,74);
    ctx.strokeStyle='rgba(0,245,255,0.25)'; ctx.lineWidth=1; ctx.strokeRect(x+14,bioY,w-28,74);
    setFont(9,'700',"'Share Tech Mono',monospace"); noGlow(); txt('BIO',x+24,bioY+12,CFG.CY,'left');
    const bioTxt=(profileBio||'Tap UPDATE BIO to set one.').slice(0,96);
    const b1=bioTxt.slice(0,48), b2=bioTxt.length>48?bioTxt.slice(48,96):'';
    setFont(8,'400',"'Share Tech Mono',monospace"); txt(b1,x+24,bioY+28,'rgba(220,245,255,0.9)','left'); if (b2) txt(b2,x+24,bioY+42,'rgba(220,245,255,0.8)','left');
  } else {
    setFont(8,'700',"'Share Tech Mono',monospace"); noGlow();
    txt('Sign in to view full cloud profile details.',left,infoY+10+lines.length*34+8,'rgba(0,245,255,0.55)','left');
  }
  ctx.restore();

  const canEditProfile=isSignedIn;
  const hasCustomAvatar=!!profileAvatar;
  const uploadH=btnH;
  const trashW=42;
  const uploadW=(canEditProfile && hasCustomAvatar) ? (w-28-trashW-8) : (w-28);
  BTNS.profileUpload={x:x+14,y:uploadY,w:uploadW,h:uploadH};
  drawNeonBtn(BTNS.profileUpload.x,BTNS.profileUpload.y,BTNS.profileUpload.w,BTNS.profileUpload.h,canEditProfile?CFG.CY:'#255f66',canEditProfile?'UPLOAD ICON (<256KB)':'UPLOAD LOCKED (SIGN IN)',10,1,0);
  BTNS.profileTrash=null;
  if (canEditProfile && hasCustomAvatar) {
    BTNS.profileTrash={x:BTNS.profileUpload.x+BTNS.profileUpload.w+8,y:uploadY,w:trashW,h:uploadH};
    drawNeonBtn(BTNS.profileTrash.x,BTNS.profileTrash.y,BTNS.profileTrash.w,BTNS.profileTrash.h,CFG.PK,'🗑',12,1,0);
  }
  refreshUsernameChangeState();
  setFont(8,'400',"'Share Tech Mono',monospace"); noGlow();
  const triesTxt=`Username tries: ${usernameChangeState.triesLeft}/2  •  Refresh: ${usernameCountdownStr()}`;
  txt(triesTxt.slice(0,56),x+14,usernameInfoY,'rgba(190,230,255,0.75)','left');
  BTNS.profileChangeUsername={x:x+14,y:usernameBtnY,w:w-28,h:btnH};
  drawNeonBtn(BTNS.profileChangeUsername.x,BTNS.profileChangeUsername.y,BTNS.profileChangeUsername.w,BTNS.profileChangeUsername.h,canEditProfile&&usernameChangeState.triesLeft>0?CFG.CY:'#3a5661',canEditProfile?(usernameChangeState.triesLeft>0?'CHANGE USERNAME':'USERNAME LOCKED (WAIT)'):'USERNAME LOCKED',10,1,0);
  const uidLabelY=usernameInfoY-14;
  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt('Player UID',x+14,uidLabelY,'rgba(120,220,255,0.72)','left');
  const rawUid=String((auth&&auth.uid)||'');
  const uidShow=uidVisible?rawUid:('*'.repeat(Math.min(14,Math.max(6,rawUid.length||6))));
  setFont(9,'700',"'Share Tech Mono',monospace"); txt(uidShow||'******',x+78,uidLabelY,'#d8f6ff','left');
  BTNS.profileUidToggle={x:x+w-112,y:uidLabelY-10,w:48,h:22};
  BTNS.profileUidCopy={x:x+w-58,y:uidLabelY-10,w:44,h:22};
  drawNeonBtn(BTNS.profileUidToggle.x,BTNS.profileUidToggle.y,BTNS.profileUidToggle.w,BTNS.profileUidToggle.h,CFG.CY,uidVisible?'HIDE':'SHOW',8,1,0);
  drawNeonBtn(BTNS.profileUidCopy.x,BTNS.profileUidCopy.y,BTNS.profileUidCopy.w,BTNS.profileUidCopy.h,CFG.YL,'COPY',8,1,0);
  const statusY=signOutY+btnH+6;
  const stW=Math.floor((w-28-12)/4);
  BTNS.profileStatusDefault={x:x+14,y:statusY,w:stW,h:22};
  BTNS.profileStatusIdle={x:x+14+(stW+4),y:statusY,w:stW,h:22};
  BTNS.profileStatusDnd={x:x+14+(stW+4)*2,y:statusY,w:stW,h:22};
  BTNS.profileStatusOffline={x:x+14+(stW+4)*3,y:statusY,w:stW,h:22};
  const statusLocked=!isSignedIn || !navigator.onLine;
  drawNeonBtn(BTNS.profileStatusDefault.x,BTNS.profileStatusDefault.y,BTNS.profileStatusDefault.w,BTNS.profileStatusDefault.h,statusLocked?'#3a3f47':(getStatusValue()==='online'?CFG.GR:'#2d4f2f'),statusLocked?'LOCK':'DEFAULT',7,1,0);
  drawNeonBtn(BTNS.profileStatusIdle.x,BTNS.profileStatusIdle.y,BTNS.profileStatusIdle.w,BTNS.profileStatusIdle.h,statusLocked?'#3a3f47':(getStatusValue()==='idle'?CFG.YL:'#5a5522'),statusLocked?'LOCK':'IDLE',7,1,0);
  drawNeonBtn(BTNS.profileStatusDnd.x,BTNS.profileStatusDnd.y,BTNS.profileStatusDnd.w,BTNS.profileStatusDnd.h,statusLocked?'#3a3f47':(getStatusValue()==='dnd'?CFG.PK:'#5a2230'),statusLocked?'LOCK':'DND',7,1,0);
  drawNeonBtn(BTNS.profileStatusOffline.x,BTNS.profileStatusOffline.y,BTNS.profileStatusOffline.w,BTNS.profileStatusOffline.h,getStatusValue()==='offline'?'#8a95a5':'#3f4650','OFFLINE',7,1,0);
  BTNS.profileBio={x:x+14,y:bioBtnY,w:w-28,h:btnH};
  drawNeonBtn(BTNS.profileBio.x,BTNS.profileBio.y,BTNS.profileBio.w,BTNS.profileBio.h,canEditProfile?CFG.GR:'#2f5f2f',canEditProfile?'EDIT PUBLIC PROFILE':'PUBLIC PROFILE LOCKED',10,1,0);
  BTNS.profileChangePassword={x:x+14,y:passY,w:w-28,h:btnH};
  drawNeonBtn(BTNS.profileChangePassword.x,BTNS.profileChangePassword.y,BTNS.profileChangePassword.w,BTNS.profileChangePassword.h,canEditProfile?CFG.YL:'#6a6222',canEditProfile?'CHANGE PASSWORD':'PASSWORD LOCKED',10,1,0);
  BTNS.profileDelete={x:x+14,y:deleteY,w:w-28,h:btnH};
  drawNeonBtn(BTNS.profileDelete.x,BTNS.profileDelete.y,BTNS.profileDelete.w,BTNS.profileDelete.h,isSignedIn?'#ff3355':'#5a3238',isSignedIn?'DELETE ACCOUNT':'DELETE LOCKED',9,1,0);
  BTNS.profileSignOut={x:x+14,y:signOutY,w:w-28,h:btnH};
  drawNeonBtn(BTNS.profileSignOut.x,BTNS.profileSignOut.y,BTNS.profileSignOut.w,BTNS.profileSignOut.h,isSignedIn?CFG.PK:CFG.CY,isSignedIn?'SIGN OUT':'GO TO SIGN IN',10,1,0);
  BTNS.profileDelete={x:x+14,y:signOutY-36,w:w-28,h:28};
  drawNeonBtn(BTNS.profileDelete.x,BTNS.profileDelete.y,BTNS.profileDelete.w,BTNS.profileDelete.h,isSignedIn?'#ff3355':'#5a3238',isSignedIn?'DELETE ACCOUNT':'DELETE LOCKED',9,1,0);

  const minP=minProfileScroll();
  const sbX=infoX+infoW+4, sbY=infoY-2, sbH=Math.max(24,uidLabelY-infoY-6);
  if (sbH>20) {
    ctx.save();
    ctx.fillStyle='rgba(0,245,255,0.10)'; ctx.fillRect(sbX,sbY,4,sbH);
    ctx.strokeStyle='rgba(0,245,255,0.25)'; ctx.strokeRect(sbX,sbY,4,sbH);
    if (minP<0) {
      const thumbH=Math.max(24,(infoH/(infoH+Math.abs(minP)))*sbH);
      const track=sbH-thumbH;
      const thumbY=sbY + ((-profileScroll)/Math.abs(minP))*track;
      ctx.fillStyle='rgba(0,245,255,0.75)'; ctx.fillRect(sbX+1,thumbY,2,thumbH);
    } else {
      ctx.fillStyle='rgba(0,245,255,0.45)'; ctx.fillRect(sbX+1,sbY+1,2,sbH-2);
    }
    ctx.restore();
  }

  if (profileUploadState.active) drawProfileUploadOverlay(t);

  BTNS.authBack={x:(LW-140)/2,y:LH-44,w:140,h:30};
  drawNeonBtn(BTNS.authBack.x,BTNS.authBack.y,140,30,CFG.PK,'← BACK',11,1,Math.sin(t*2));
  ctx.restore();
}


function drawProfileUploadOverlay(t){
  const st=profileUploadState;
  if (!st.active) return;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.82)'; ctx.fillRect(0,0,LW,LH);
  const w=354,h=410,x=(LW-w)/2,y=(LH-h)/2;
  ctx.fillStyle='#000'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle=st.mode==='error'?CFG.PK:CFG.CY; ctx.lineWidth=2; glow(st.mode==='error'?CFG.PK:CFG.CY,12); ctx.strokeRect(x,y,w,h);
  if (st.mode==='error') {
    setFont(16,'900'); glow(CFG.PK,10); txt('UPLOAD FAILED',LW/2,y+30,CFG.PK);
    setFont(9,'700',"'Share Tech Mono',monospace"); noGlow(); txt((st.error||'Unknown upload failure').slice(0,90),LW/2,y+72,'#ffc0d0');
    BTNS.profileUploadErrOk={x:(LW-120)/2,y:y+h-46,w:120,h:30};
    drawNeonBtn(BTNS.profileUploadErrOk.x,BTNS.profileUploadErrOk.y,120,30,CFG.PK,'OK',11,1,Math.sin(t*2));
    ctx.restore();
    return;
  }
  setFont(14,'900'); glow(CFG.CY,10); txt('CROP PROFILE ICON',LW/2,y+26,CFG.CY);
  const frame=220, fx=(LW-frame)/2, fy=y+44;
  ctx.fillStyle='rgba(0,245,255,0.06)'; ctx.fillRect(fx,fy,frame,frame);
  ctx.save(); ctx.beginPath(); ctx.rect(fx,fy,frame,frame); ctx.clip();
  if (st.img) {
    const base=Math.max(frame/Math.max(st.img.width,1), frame/Math.max(st.img.height,1));
    const sc=base*st.zoom;
    const dw=st.img.width*sc, dh=st.img.height*sc;
    const dx=fx+(frame-dw)/2+st.offX;
    const dy=fy+(frame-dh)/2+st.offY;
    ctx.drawImage(st.img,dx,dy,dw,dh);
  }
  ctx.restore();
  ctx.strokeStyle='rgba(0,245,255,0.7)'; ctx.lineWidth=2; ctx.strokeRect(fx,fy,frame,frame);
  ctx.save();
  ctx.strokeStyle='rgba(0,245,255,0.26)';
  ctx.lineWidth=1;
  for (let i=1;i<3;i++) {
    const s=(frame/3)*i;
    ctx.beginPath(); ctx.moveTo(fx+s,fy); ctx.lineTo(fx+s,fy+frame); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(fx,fy+s); ctx.lineTo(fx+frame,fy+s); ctx.stroke();
  }
  ctx.restore();
  setFont(8,'700',"'Share Tech Mono',monospace"); noGlow(); txt('Drag/touch to reposition. +/- or wheel to zoom.',LW/2,fy+frame+16,'rgba(220,245,255,0.8)');
  const ctrlY=fy+frame+26;
  BTNS.profileUploadZoomOut={x:fx+6,y:ctrlY,w:58,h:30};
  BTNS.profileUploadZoomIn={x:fx+72,y:ctrlY,w:58,h:30};
  BTNS.profileUploadReset={x:fx+138,y:ctrlY,w:76,h:30};
  drawNeonBtn(BTNS.profileUploadZoomOut.x,BTNS.profileUploadZoomOut.y,BTNS.profileUploadZoomOut.w,BTNS.profileUploadZoomOut.h,CFG.PU,'-',14,1,0);
  drawNeonBtn(BTNS.profileUploadZoomIn.x,BTNS.profileUploadZoomIn.y,BTNS.profileUploadZoomIn.w,BTNS.profileUploadZoomIn.h,CFG.PU,'+',14,1,0);
  drawNeonBtn(BTNS.profileUploadReset.x,BTNS.profileUploadReset.y,BTNS.profileUploadReset.w,BTNS.profileUploadReset.h,CFG.CY,'RESET',9,1,0);
  BTNS.profileUploadOk={x:fx+36,y:ctrlY+40,w:148,h:34};
  BTNS.profileUploadCancel={x:fx+36,y:ctrlY+80,w:148,h:34};
  drawNeonBtn(BTNS.profileUploadOk.x,BTNS.profileUploadOk.y,BTNS.profileUploadOk.w,BTNS.profileUploadOk.h,CFG.GR,'UPLOAD',11,1,Math.sin(t*2));
  drawNeonBtn(BTNS.profileUploadCancel.x,BTNS.profileUploadCancel.y,BTNS.profileUploadCancel.w,BTNS.profileUploadCancel.h,CFG.PK,'CANCEL',11,1,Math.sin(t*2));
  setFont(7,'700',"'Share Tech Mono',monospace"); noGlow(); txt('Controller: L/R stick move · LB/RB zoom · A upload · B cancel · X/Y reset',LW/2,ctrlY+124,'rgba(180,245,255,0.6)');
  ctx.restore();
}

async function handleChangePassword(){
  if (!isSignedIn || !fbUser || !fbUser.updatePassword) { addNotif('Sign in first to change password.',CFG.YL); return; }
  openInputDialog({title:'CHANGE PASSWORD',label:'New Password (6-20)',value:'',maxLen:20,secret:true,onSubmit:async val=>{
    const pwd=String(val||'');
    if (pwd.length<6 || pwd.length>20) { addNotif('Password must be 6-20 chars.',CFG.PK); return; }
    try {
      const providers=Array.isArray(fbUser.providerData)?fbUser.providerData.map(p=>String(p&&p.providerId||'')):[];
      const hasGoogle=providers.includes('google.com');
      const hasPassword=providers.includes('password');
      if (hasGoogle && !hasPassword && window.firebase && firebase.auth && firebase.auth.EmailAuthProvider && fbUser.linkWithCredential) {
        const email=String((fbUser&&fbUser.email)||(auth&&auth.email)||'').trim();
        if (email) {
          const cred=firebase.auth.EmailAuthProvider.credential(email,pwd);
          await fbUser.linkWithCredential(cred);
        }
      }
      await fbUser.updatePassword(pwd);
      addNotif('Password changed.',CFG.GR);
      openActionPopup('PASSWORD UPDATED','Your password has been updated successfully.',true);
    } catch (e) {
      const code=String((e&&e.code)||'');
      if (code.includes('requires-recent-login')) {
        addNotif('Re-auth required. Sign out/in and retry.',CFG.PK);
        openActionPopup('PASSWORD UPDATE FAILED','Re-auth required. Sign out and sign back in, then retry.',false);
      } else {
        addNotif('Password change failed. Re-sign in and retry.',CFG.PK);
        openActionPopup('PASSWORD UPDATE FAILED','Could not update password. Please retry.',false);
      }
    }
  }});
}

function handleProfileTap(p){
  if (profileUploadState.active) {
    if (profileUploadState.mode==='error') {
      if (hitBtn(p,BTNS.profileUploadErrOk)) { SFX.click(); resetProfileUploadState(); return; }
      return;
    }
    const st=profileUploadState;
    const frame=220, fx=(LW-frame)/2, fy=((LH-410)/2)+44;
    if (p.x>=fx && p.x<=fx+frame && p.y>=fy && p.y<=fy+frame) { st.drag=true; st.lastX=p.x; st.lastY=p.y; return; }
    if (hitBtn(p,BTNS.profileUploadZoomIn)) { SFX.click(); st.zoom=clamp(st.zoom+0.1,1,3); clampProfileUploadOffsets(st,220); return; }
    if (hitBtn(p,BTNS.profileUploadZoomOut)) { SFX.click(); st.zoom=clamp(st.zoom-0.1,1,3); clampProfileUploadOffsets(st,220); return; }
    if (hitBtn(p,BTNS.profileUploadReset)) { SFX.click(); st.zoom=1; st.offX=0; st.offY=0; clampProfileUploadOffsets(st,220); return; }
    if (hitBtn(p,BTNS.profileUploadOk)) { SFX.click(); applyProfileCropAndSave(); return; }
    if (hitBtn(p,BTNS.profileUploadCancel)) { SFX.click(); resetProfileUploadState(); return; }
    return;
  }
  if (hitBtn(p,BTNS.authBack)) { SFX.click(); doTransition('MENU'); return; }
  if (hitBtn(p,BTNS.profileInfoBox)) { SFX.click(); playerCardPopup.active=true; playerCardPopup.isSelf=isSignedIn; return; }
  if (hitBtn(p,BTNS.profileUidToggle)) { SFX.click(); uidVisible=!uidVisible; return; }
  if (hitBtn(p,BTNS.profileUidCopy)) { SFX.click(); const uid=String((auth&&auth.uid)||''); try { if (navigator.clipboard&&uid) navigator.clipboard.writeText(uid); addNotif(uid?'UID copied.':'No UID to copy.',uid?CFG.GR:CFG.PK); } catch(e) { addNotif('Copy failed.',CFG.PK); } return; }
  if (hitBtn(p,BTNS.profileStatusDefault)) { SFX.click(); setPlayerStatus('online'); return; }
  if (hitBtn(p,BTNS.profileStatusIdle)) { SFX.click(); setPlayerStatus('idle'); return; }
  if (hitBtn(p,BTNS.profileStatusDnd)) { SFX.click(); setPlayerStatus('dnd'); return; }
  if (hitBtn(p,BTNS.profileStatusOffline)) { SFX.click(); setPlayerStatus('offline'); return; }
  if (hitBtn(p,BTNS.profileAvatar) || hitBtn(p,BTNS.profileUpload)) {
    SFX.click();
    if (!navigator.onLine) { addNotif('PLAYER OFFLINE',CFG.PK); return; }
    if (!isSignedIn) { addNotif('Upload is locked for guests. Sign in first.',CFG.YL); return; }
    const inp=document.getElementById('profileUploadInput');
    if (inp) inp.click();
    return;
  }
  if (hitBtn(p,BTNS.profileTrash)) {
    SFX.click();
    if (!navigator.onLine) { addNotif('PLAYER OFFLINE',CFG.PK); return; }
    if (!isSignedIn) { addNotif('Trash is locked for guests.',CFG.YL); return; }
    openConfirm('REMOVE_PFP','REMOVE PROFILE ICON?','This resets avatar to default icon.');
    return;
  }
  if (hitBtn(p,BTNS.profileChangeUsername)) {
    SFX.click();
    if (!navigator.onLine) { addNotif('PLAYER OFFLINE',CFG.PK); return; }
    if (!isSignedIn) { addNotif('Username change is locked for guests.',CFG.YL); return; }
    refreshUsernameChangeState();
    if (usernameChangeState.triesLeft<=0) { usernameChangeFlow.candidate=''; openUsernameFlowPhase('error',`No tries left. Refresh in ${usernameCountdownStr()}.`); return; }
    openInputDialog({title:'CHANGE USERNAME',label:'New Username',value:auth.name||'',maxLen:32,onSubmit:async v=>{ await requestUsernameChange(v||''); }});
    return;
  }
  if (hitBtn(p,BTNS.profileBio)) {
    SFX.click();
    if (!isSignedIn) { addNotif('Sign in to edit public profile.',CFG.YL); return; }
    doTransition('PUBLIC_PROFILE');
    return;
  }
  if (hitBtn(p,BTNS.profileChangePassword)) {
    SFX.click();
    handleChangePassword();
    return;
  }
  if (hitBtn(p,BTNS.profileDelete)) { SFX.click(); if (!isSignedIn) return; openConfirm('DELETE_ACCOUNT','DELETE ACCOUNT?','This is permanent and removes your cloud account.'); return; }
  if (hitBtn(p,BTNS.profileSignOut)) {
    SFX.click();
    if (!navigator.onLine) { addNotif('PLAYER OFFLINE',CFG.PK); return; }
    if (!isSignedIn) { doTransition('SIGNIN'); return; }
    openConfirm('SIGNOUT','SIGN OUT?','Cloud session will end and guest local save will be used.');
    return;
  }
}

async function beginDeleteAccountFlow(){
  if (!isSignedIn || !fbUser || !fbReady || !firebase.auth) return;
  openInputDialog({title:'DELETE ACCOUNT',label:'Type your username to confirm',value:'',maxLen:32,onSubmit:v=>{
    const name=String(v||'').trim();
    if (name.toLowerCase()!==String(auth.name||'').trim().toLowerCase()) { addNotif('Username mismatch.',CFG.PK); return; }
    openInputDialog({title:'DELETE ACCOUNT',label:'Type your password (or type GOOGLE for Google sign-in)',value:'',maxLen:64,secret:true,onSubmit:async p=>{
      const pwd=String(p||'').trim();
      openActionPopup('DELETE ACCOUNT','Removing account... Please wait.',true,true);
      try {
        const providerData=Array.isArray(fbUser.providerData)?fbUser.providerData:[];
        const hasGoogle=providerData.some(x=>String(x&&x.providerId||'')==='google.com');
        if (pwd.toUpperCase()==='GOOGLE' && hasGoogle) {
          const gp=new firebase.auth.GoogleAuthProvider();
          await fbUser.reauthenticateWithPopup(gp);
        } else {
          if (!pwd) throw new Error('Password required');
          const email=String((fbUser&&fbUser.email)||(auth&&auth.email)||'').trim();
          if (!email) throw new Error('No email');
          const cred=firebase.auth.EmailAuthProvider.credential(email,pwd);
          await fbUser.reauthenticateWithCredential(cred);
        }
        const uid=fbUser.uid;
        const socialSnap=await fbDb.ref(CLOUD_SOCIAL_ROOT).get();
        const socialAll=(socialSnap&&socialSnap.val)?(socialSnap.val()||{}):{};
        const cleanupTasks=[];
        ['friends','followers','following'].forEach(group=>{
          const grp=socialAll[group]||{};
          Object.keys(grp).forEach(owner=>{
            if ((grp[owner]||{})[uid]!=null) cleanupTasks.push(fbDb.ref(`${CLOUD_SOCIAL_ROOT}/${group}/${owner}/${uid}`).remove());
          });
        });
        const reqRoot=socialAll.requests||{};
        Object.keys(reqRoot).forEach(owner=>{
          const node=reqRoot[owner]||{};
          if ((node.received||{})[uid]!=null) cleanupTasks.push(fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${owner}/received/${uid}`).remove());
          if ((node.sent||{})[uid]!=null) cleanupTasks.push(fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${owner}/sent/${uid}`).remove());
        });
        await Promise.allSettled([
          fbDb.ref(`${CLOUD_SLOPE_ROOT}/${uid}`).remove(),
          fbDb.ref(`${CLOUD_INFO_ROOT}/${uid}`).remove(),
          fbDb.ref(`${CLOUD_LEADERBOARD_ROOT}/global/${uid}`).remove(),
          fbDb.ref(`${CLOUD_LEADERBOARD_ROOT}/endless/${uid}`).remove(),
          fbDb.ref(`${CLOUD_LEADERBOARD_ROOT}/adventure/${uid}`).remove(),
          fbDb.ref(`${CLOUD_LEADERBOARD_ROOT}/impossible/${uid}`).remove(),
          fbDb.ref(`${CLOUD_LEADERBOARD_ROOT}/ltm/${uid}`).remove(),
          fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${uid}`).remove(),
          fbDb.ref(`${CLOUD_SOCIAL_ROOT}/followers/${uid}`).remove(),
          fbDb.ref(`${CLOUD_SOCIAL_ROOT}/following/${uid}`).remove(),
          fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${uid}`).remove(),
          ...cleanupTasks,
        ]);
        await fbUser.delete();
        openActionPopup('DELETE ACCOUNT','Success. Your account has been officially removed.',true,false);
        isSignedIn=false; auth={...AUTH_GUEST}; saveAuth(auth);
        socialData={friends:[],followers:[],following:[],received:[],sent:[]};
        socialCounters={friends:0,followers:0,following:0,received:0,sent:0};
        rebuildSocialRelationCache();
        setTimeout(()=>{ actionPopup.active=false; goMenu(); doTransition('MENU'); },1200);
      } catch(e) {
        openActionPopup('DELETE ACCOUNT','Failed. Re-auth failed or cloud delete failed.',false,false);
      }
    }});
  }});
}

function doSignOut(){
  if (fbReady && fbAuth) fbAuth.signOut();
  isSignedIn=false; auth={...AUTH_GUEST}; saveAuth(auth);
  cloudProfileRoot=CLOUD_INFO_ROOT;
  cloudGemCount=loadBank();
  cloudUpdatedAt=0;
  socialData={friends:[],followers:[],following:[],received:[],sent:[]};
  socialCounters={friends:0,followers:0,following:0,received:0,sent:0};
  rebuildSocialRelationCache();
  lastSocialSnapshot={statusByUid:{},received:new Set()};
  addNotif('Signed out. Guest local save active.',CFG.CY);
  goMenu();
  doTransition('MENU');
}

initFirebase();
if (!socialPollTimer) {
  socialPollTimer=setInterval(()=>{
    if (!isSignedIn || !navigator.onLine) return;
    refreshSelfPresence(false);
    fetchSocialData();
  },4000);
}
if (!profileLiveRefreshTimer) {
  profileLiveRefreshTimer=setInterval(()=>{
    if (playerCardPopup.active && !playerCardPopup.isSelf) {
      const uid=String((playerCardPopup.viewed&&playerCardPopup.viewed.uid)||'');
      if (uid) {
        const live=socialUserIndexCache[uid]||null;
        if (live) playerCardPopup.viewed={...playerCardPopup.viewed,...live};
      }
    }
    const syncList=(arr)=>{
      for (let i=0;i<arr.length;i++) {
        const it=arr[i]||{}; const uid=String(it.uid||''); if (!uid) continue;
        const live=socialUserIndexCache[uid]||null; if (live) arr[i]={...it,...live};
      }
    };
    syncList(socialData.friends); syncList(socialData.followers); syncList(socialData.following); syncList(socialData.received); syncList(socialData.sent);
    if (playerCardPopup.active && !playerCardPopup.isSelf) {
      const uid=String((playerCardPopup.viewed&&playerCardPopup.viewed.uid)||'');
      const c=socialCountsCache[uid];
      if (c && uid) playerCardPopup.viewed={...playerCardPopup.viewed,...c};
    }
  },50);
}
setInterval(()=>{ if (isSignedIn) refreshSelfPresence(false); },5000);
const _profileUploadInput=document.getElementById('profileUploadInput');
if (_profileUploadInput) {
  _profileUploadInput.addEventListener('change',async e=>{
    const f=e.target&&e.target.files&&e.target.files[0]?e.target.files[0]:null;
    if (!f) return;
    if (f.size>256*1024) { openProfileUploadError('Image must be under 256KB.'); e.target.value=''; return; }
    const r=new FileReader();
    r.onerror=()=>{ openProfileUploadError('Profile icon upload failed while reading file.'); e.target.value=''; };
    r.onload=()=>{
      const data=String(r.result||'');
      if (!data) { openProfileUploadError('Empty file content.'); e.target.value=''; return; }
      beginProfileUploadPreview(data);
      e.target.value='';
    };
    r.readAsDataURL(f);
  });
}
function loadUnlocked() {
  try { return JSON.parse(localStorage.getItem('slope_chars')||'["default"]'); }
  catch(e) { return ['default']; }
}
function saveUnlocked(arr) { localStorage.setItem('slope_chars',JSON.stringify(arr)); if (typeof queueCloudSync==='function') queueCloudSync(); }
function unlockChar(id) { const arr=loadUnlocked(); if (!arr.includes(id)){arr.push(id);saveUnlocked(arr);} }
let unlockedChars=loadUnlocked();
let selectedChar=localStorage.getItem('slope_selectedChar')||'default';
function setSelectedChar(id) { selectedChar=id; localStorage.setItem('slope_selectedChar',id); if (typeof queueCloudSync==='function') queueCloudSync(); }

function loadDoneObjs() { try { return JSON.parse(localStorage.getItem('slope_objs')||'[]'); } catch(e){return[];} }
function saveDoneObjs(arr) { localStorage.setItem('slope_objs',JSON.stringify(arr)); if (typeof queueCloudSync==='function') queueCloudSync(); }
let doneObjs=loadDoneObjs();

// State
gs='LOADING';
let gameMode='ENDLESS';
let impossibleStage=0, impossibleIntroT=0, impossibleIntroDone=false;
let score=0, bestScore=0, lives=0, maxLives=CFG.LIVES, multi=1, gemStreak=0, maxCombo=1;
let modeScores={endless:0,adventure:0,impossible:0,ltm:0};
let gemsCollected=0;
let worldSpeedMult=1;
let activePwr=null, pwrTimer=0;
let gemDoubleActive=false, gemDoubleTimer=0;
let gemBoostMult=1;
let gemDropActive=false, gemDropTimer=0, gemDropSpawnTimer=0;
transAlpha=1; transDir=1; pendingGS='MENU';

// Health boost state
let healthBoostActive=false, healthBoostTimer=0, healthBoostMax=60;

// Adventure state
let adventureStage=0, adventureStageTimer=0;
let miniJetpackActive=false, miniJetpackTimer=0;
let stageBoostActive=false; // compatibility alias to avoid stale references
let newStageActive=false, newStageTimer=0;
let stagePowerupNext=rnd(20,30), stagePowerupElapsed=0;
let badLuckActive=false,badLuckTimer=0,badLuckSpawnT=0;

let gemTimer=0, gemNext=0, pwrTimer2=0, pwrNext=0, obsTimer=0, obsNext=0;
fps=0; fpsFrames=0; fpsTimer=0;
let menuT=0, gameTime=0, scorePopT=0;
let lastMilestone=0, clusterTimer=0, clusterNext=8;

const gems=[], powerups=[], obstacles=[];

// Stage transition animation
let stageTransT=0, stageTransLabel='';
let camZoom=1;
let immunityActive=false, immunityTimer=0;
let obstacleClearTimer=0;
let pauseToggleLock=0;
let pauseStartedAt=0;

let leaderboardState='idle';
let leaderboardTimer=0;
let leaderboardData=[];
let leaderboardNextRefresh=0;
let leaderboardReturnState='MENU';
let leaderboardScroll=0;
let leaderboardViewH=0;
let leaderboardContentH=0;

let leaderboardCategory='GLOBAL';
const LEADERBOARD_TABS=['GLOBAL','ENDLESS','ADVENTURE','IMPOSSIBLE','LTM'];
let ltmRotationIndex=0;
let ltmStage=0, ltmStageTimer=0;
let adminLtmScroll=0, adminLtmViewH=0, adminLtmContentH=0;
let noAdsPopup=false;
let adminLtmTestButtons=[];
let ltmForcedIndex=-1;
let ltmSelectedIndex=-1;
let socialData={friends:[],followers:[],following:[],received:[],sent:[]};
let socialCounters={friends:0,followers:0,following:0,received:0,sent:0};
let socialView={mode:'friends',scroll:0,viewH:0,contentH:0,renderCount:0,loading:false};
const CLOUD_SOCIAL_ROOT='SLOPE/social';
function minSocialScroll(){ return Math.min(0,socialView.viewH-socialView.contentH); }
function mapSocialSnapToList(snap,idxMap){
  const v=(snap&&snap.val)?(snap.val()||{}):{};
  if (!v||typeof v!=='object') return [];
  const arr=[];
  Object.keys(v).forEach(uid=>{
    const meta=v[uid]||{};
    const u=idxMap[uid]||{uid,name:'Runner',status:'offline',lastSeen:0,avatar:'',bestScore:0,bio:''};
    arr.push({...u,uid,ts:Number(meta.ts||0)});
  });
  arr.sort((a,b)=>(b.ts||0)-(a.ts||0));
  return arr;
}
async function fetchUserIndexMap(){
  if (!fbReady || !fbDb) return {};
  try {
    const snap=await fbDb.ref(CLOUD_SLOPE_ROOT).get();
    const all=snap&&snap.val?snap.val():{};
    const out={};
    Object.keys(all||{}).forEach(uid=>{ const u=all[uid]||{}; out[uid]={uid,name:u.displayName||u.name||u.email||'Runner',avatar:u.pfpLink||u.avatar||'',status:String(u.status||'offline').toLowerCase(),statusPref:String(u.statusPref||u.status||'online').toLowerCase(),lastSeen:Number(u.lastSeen||0),bestScore:Number(u.bestScore||0),bio:String(u.bio||''),selectedSkin:String(u.selectedSkin||u.skin||''),selectedAura:String(u.selectedAura||u.aura||''),selectedTheme:String(u.selectedTheme||u.theme||'')}; });
    return out;
  } catch(e){ return {}; }
}
function rebuildSocialRelationCache(){
  socialRelationCache={
    friends:new Set((socialData.friends||[]).map(o=>String(o.uid||''))),
    followers:new Set((socialData.followers||[]).map(o=>String(o.uid||''))),
    following:new Set((socialData.following||[]).map(o=>String(o.uid||''))),
    received:new Set((socialData.received||[]).map(o=>String(o.uid||''))),
    sent:new Set((socialData.sent||[]).map(o=>String(o.uid||''))),
  };
}
function emitSocialPresenceToasts(idx){
  const watched=new Set();
  ['friends','followers','following','received','sent'].forEach(k=>(socialData[k]||[]).forEach(it=>watched.add(String(it.uid||''))));
  const next={...lastSocialSnapshot.statusByUid};
  watched.forEach(uid=>{
    const u=idx[uid]||{};
    const st=resolveDisplayStatus(u);
    const prev=lastSocialSnapshot.statusByUid[uid]||'offline';
    next[uid]=st;
    if (prev!==st && st==='online') addSocialToast(`${(u.name||'Runner').slice(0,18)} is online`,CFG.GR);
  });
  lastSocialSnapshot.statusByUid=next;
}
function emitFriendRequestToasts(){
  const next=new Set((socialData.received||[]).map(o=>String(o.uid||'')));
  next.forEach(uid=>{
    if (!lastSocialSnapshot.received.has(uid)) {
      const u=(socialData.received||[]).find(v=>String(v.uid||'')===uid)||{};
      addSocialToast(`${String(u.name||'Runner').slice(0,18)} sent a friend request`,CFG.YL);
    }
  });
  lastSocialSnapshot.received=next;
}
async function fetchSocialData(){
  if (!isSignedIn || !fbUser || !fbReady || !fbDb) {
    socialData={friends:[],followers:[],following:[],received:[],sent:[]};
    socialCounters={friends:0,followers:0,following:0,received:0,sent:0};
    rebuildSocialRelationCache();
    return;
  }
  socialView.loading=true; socialView.renderCount=0;
  try {
    const uid=fbUser.uid;
    const [idx,fr,fo,fg,rc,st]=await Promise.all([
      fetchUserIndexMap(),
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${uid}`).get(),
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/followers/${uid}`).get(),
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/following/${uid}`).get(),
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${uid}/received`).get(),
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${uid}/sent`).get(),
    ]);
    socialUserIndexCache=idx||{};
    socialData={
      friends:mapSocialSnapToList(fr,idx),
      followers:mapSocialSnapToList(fo,idx),
      following:mapSocialSnapToList(fg,idx),
      received:mapSocialSnapToList(rc,idx),
      sent:mapSocialSnapToList(st,idx),
    };
    socialCounters={friends:socialData.friends.length,followers:socialData.followers.length,following:socialData.following.length,received:socialData.received.length,sent:socialData.sent.length};
    rebuildSocialRelationCache();
    emitFriendRequestToasts();
    emitSocialPresenceToasts(idx);
  } catch(e) {
    socialData={friends:[],followers:[],following:[],received:[],sent:[]};
    socialCounters={friends:0,followers:0,following:0,received:0,sent:0};
    rebuildSocialRelationCache();
  }
  socialView.loading=false;
}
async function openMiniProfileByUsername(raw){
  const q=String(raw||'').trim().toLowerCase();
  if (!q) { openActionPopup('FIND USER','Cannot find user.',false); return false; }
  if (!fbReady || !fbDb) { openActionPopup('FIND USER','Cloud unavailable.',false); return false; }
  socialView.loading=true;
  pendingFoundProfile=null;
  openActionPopup('FIND USER','Searching user...',true,true);
  try {
    const snap=await fbDb.ref(CLOUD_SLOPE_ROOT).get();
    const all=snap&&snap.val?snap.val():{};
    let foundUid='';
    Object.keys(all||{}).some(uid=>{ const u=all[uid]||{}; const nm=String(u.displayName||u.name||u.email||'').toLowerCase(); if (nm===q) { foundUid=uid; return true; } return false; });
    if (!foundUid) { openActionPopup('FIND USER','Cannot find user.',false,false); return false; }
    const u=all[foundUid]||{};
    pendingFoundProfile={uid:foundUid,name:String(u.displayName||u.name||'Runner'),avatar:String(u.pfpLink||u.avatar||''),status:String(u.status||'offline'),statusPref:String(u.statusPref||u.status||'online'),lastSeen:Number(u.lastSeen||0),bio:String(u.bio||''),bestScore:Number(u.bestScore||0),selectedSkin:String(u.selectedSkin||u.skin||''),selectedAura:String(u.selectedAura||u.aura||''),selectedTheme:String(u.selectedTheme||u.theme||'')};
    openActionPopup('FIND USER',`Found: ${pendingFoundProfile.name} • Best ${Math.floor(pendingFoundProfile.bestScore||0)}`,true,false,()=>{
      if (!pendingFoundProfile) return;
      playerCardPopup.active=true;
      playerCardPopup.isSelf=!!(isSignedIn&&auth&&auth.uid===pendingFoundProfile.uid);
      playerCardPopup.fromMenu=false;
      playerCardPopup.viewed={...pendingFoundProfile};
      playerCardFriendMenu.open=false;
      hydrateViewedSocialCounts();
      pendingFoundProfile=null;
    });
    return true;
  } catch(e) { openActionPopup('FIND USER','Search failed.',false,false); return false; }
  finally { socialView.loading=false; }
}

async function fetchSocialCountsForUid(uid){
  const id=String(uid||'');
  if (!id || !fbDb || !fbReady) return {friendCount:0,followerCount:0,followingCount:0};
  try {
    const [fr,fo,fg]=await Promise.all([
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${id}`).get(),
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/followers/${id}`).get(),
      fbDb.ref(`${CLOUD_SOCIAL_ROOT}/following/${id}`).get(),
    ]);
    const count=(snap)=>{ const v=(snap&&snap.val)?(snap.val()||{}):{}; return Object.keys(v||{}).length; };
    return {friendCount:count(fr),followerCount:count(fo),followingCount:count(fg)};
  } catch(e){ return {friendCount:0,followerCount:0,followingCount:0}; }
}
async function hydrateViewedSocialCounts(){
  if (!playerCardPopup.active || playerCardPopup.isSelf) return;
  const uid=String((playerCardPopup.viewed&&playerCardPopup.viewed.uid)||'');
  if (!uid) return;
  const now=Date.now();
  const cached=socialCountsCache[uid];
  if (cached && (now-cached.ts)<8000) {
    playerCardPopup.viewed={...playerCardPopup.viewed,...cached};
    return;
  }
  const counts=await fetchSocialCountsForUid(uid);
  socialCountsCache[uid]={...counts,ts:now};
  if (playerCardPopup.active && String((playerCardPopup.viewed&&playerCardPopup.viewed.uid)||'')===uid) playerCardPopup.viewed={...playerCardPopup.viewed,...counts};
}
async function sendFriendRequestToViewed(){
  const v=playerCardPopup.viewed||{};
  if (!isSignedIn || !fbUser) { addNotif('Sign in required.',CFG.PK); return; }
  if (!navigator.onLine) { addNotif('Offline.',CFG.PK); return; }
  const toUid=String(v.uid||'');
  if (!toUid || toUid===fbUser.uid) return;
  if (socialRelationCache.sent.has(toUid)) { addNotif('Request already sent.',CFG.YL); return; }
  const ts=Date.now();
  try {
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${toUid}/received/${fbUser.uid}`).update({ts:String(ts)});
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${fbUser.uid}/sent/${toUid}`).update({ts:String(ts)});
    addNotif('Friend request sent.',CFG.GR);
    addSocialToast(`Request sent to ${(v.name||'Runner').slice(0,18)}`,CFG.CY);
    await fetchSocialData();
  } catch(e) { addNotif('Request failed.',CFG.PK); }
}
async function cancelFriendRequestToViewed(){
  const v=playerCardPopup.viewed||{};
  const toUid=String(v.uid||'');
  if (!toUid || !fbUser || !fbDb) return;
  try {
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${fbUser.uid}/sent/${toUid}`).remove();
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${toUid}/received/${fbUser.uid}`).remove();
    addNotif('Friend request canceled.',CFG.PK);
    await fetchSocialData();
  } catch(e){ addNotif('Cancel failed.',CFG.PK); }
}
async function acceptIncomingRequestForViewed(){
  const v=playerCardPopup.viewed||{};
  const ou=String(v.uid||'');
  if (!ou || !fbUser || !fbDb) return;
  const uid=fbUser.uid, ts=Date.now();
  try {
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${uid}/${ou}`).update({ts:String(ts)});
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${ou}/${uid}`).update({ts:String(ts)});
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${uid}/received/${ou}`).remove();
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${ou}/sent/${uid}`).remove();
    addNotif('Friend request accepted.',CFG.GR);
    await fetchSocialData();
  } catch(e){ addNotif('Accept failed.',CFG.PK); }
}
async function removeFriendWithViewed(){
  const v=playerCardPopup.viewed||{};
  const ou=String(v.uid||'');
  if (!ou || !fbUser || !fbDb) return;
  const uid=fbUser.uid;
  try {
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${uid}/${ou}`).remove();
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${ou}/${uid}`).remove();
    addNotif('Friend removed.',CFG.PK);
    await fetchSocialData();
  } catch(e){ addNotif('Remove friend failed.',CFG.PK); }
}
async function toggleFollowViewed(){
  const v=playerCardPopup.viewed||{};
  const toUid=String(v.uid||'');
  if (!toUid || !fbUser || !fbDb) return;
  const me=fbUser.uid;
  const isFollowing=socialRelationCache.following.has(toUid);
  try {
    if (isFollowing) {
      await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/following/${me}/${toUid}`).remove();
      await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/followers/${toUid}/${me}`).remove();
      addNotif('Unfollowed user.',CFG.PK);
    } else {
      const ts=Date.now();
      await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/following/${me}/${toUid}`).update({ts:String(ts)});
      await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/followers/${toUid}/${me}`).update({ts:String(ts)});
      addNotif('Now following user.',CFG.GR);
    }
    await fetchSocialData();
  } catch(e){ addNotif('Follow update failed.',CFG.PK); }
}
function toggleFavoriteViewed(){
  const uid=String((playerCardPopup.viewed&&playerCardPopup.viewed.uid)||'');
  if (!uid) return;
  if (cardFavUids.has(uid)) {
    cardFavUids.delete(uid);
    addNotif('Removed favorite.',CFG.PK);
  } else {
    cardFavUids.add(uid);
    addNotif('Added favorite.',CFG.YL);
  }
  saveCardFavs();
}
async function handlePlayerCardPrimaryAction(){
  const v=playerCardPopup.viewed||{};
  const uid=String(v.uid||'');
  if (!uid) return;
  const rel=getCardRelation(uid);
  if (rel.incoming) {
    playerCardPopup.active=false;
    socialView.mode='received';
    socialView.scroll=0;
    doTransition('FRIEND_REQUESTS');
    fetchSocialData();
    return;
  }
  if (rel.outgoing) { await cancelFriendRequestToViewed(); return; }
  if (rel.friend) { playerCardFriendMenu.open=!playerCardFriendMenu.open; return; }
  await sendFriendRequestToViewed();
}
async function handleSocialPrimaryAction(idxOverride=-1){
  const idx=(socialView.mode==='sent'?socialData.sent:socialData.received);
  const btnIdx=idxOverride>=0?idxOverride:((BTNS.socialActionA&&BTNS.socialActionA.idx)||-1);
  const item=idx[btnIdx]||null;
  if (!item||!fbUser||!fbDb) return;
  if (socialView.mode==='received') {
    const uid=fbUser.uid, ou=item.uid, ts=Date.now();
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${uid}/${ou}`).update({ts:String(ts)});
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/friends/${ou}/${uid}`).update({ts:String(ts)});
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${uid}/received/${ou}`).remove();
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${ou}/sent/${uid}`).remove();
    addNotif('Friend request accepted.',CFG.GR);
    fetchSocialData();
  } else {
    playerCardPopup.active=true; playerCardPopup.isSelf=false; playerCardPopup.viewed=item; playerCardFriendMenu.open=false; hydrateViewedSocialCounts();
  }
}
async function handleSocialSecondaryAction(idxOverride=-1){
  const idx=(socialView.mode==='sent'?socialData.sent:socialData.received);
  const btnIdx=idxOverride>=0?idxOverride:((BTNS.socialActionB&&BTNS.socialActionB.idx)||-1);
  const item=idx[btnIdx]||null;
  if (!item||!fbUser||!fbDb) return;
  const uid=fbUser.uid, ou=item.uid;
  if (socialView.mode==='received') {
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${uid}/received/${ou}`).remove();
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${ou}/sent/${uid}`).remove();
  } else {
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${uid}/sent/${ou}`).remove();
    await fbDb.ref(`${CLOUD_SOCIAL_ROOT}/requests/${ou}/received/${uid}`).remove();
  }
  addNotif('Request removed.',CFG.PK); fetchSocialData();
}
let ltmGlobalUpdatedAt=0;
let ltmConfigFetchAt=0;
const CLOUD_LTM_CONFIG='SLOPE/config/ltm';
function minAdminLtmScroll(){ return Math.min(0, adminLtmViewH-adminLtmContentH); }
function getDailyLtmIndex(){
  const now=new Date();
  const key=`${now.getUTCFullYear()}-${now.getUTCMonth()+1}-${now.getUTCDate()}`;
  let h=0; for (let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))>>>0;
  return h%Math.max(1,LTM_MODES.length);
}
function getDailyCountdown(){
  const now=new Date();
  const end=Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()+1,0,0,0);
  let ms=Math.max(0,end-now.getTime());
  const h=Math.floor(ms/3600000); ms-=h*3600000;
  const m=Math.floor(ms/60000); ms-=m*60000;
  const s=Math.floor(ms/1000);
  return `${String(h).padStart(2,'0')}h:${String(m).padStart(2,'0')}m:${String(s).padStart(2,'0')}s`;
}
ltmSelectedIndex=getDailyLtmIndex();
function getActiveLtm(){ return LTM_MODES[clamp(ltmRotationIndex,0,LTM_MODES.length-1)]||LTM_MODES[0]; }

async function loadGlobalLtmConfig(force=false){
  if (!fbReady || !fbDb) return;
  const now=Date.now();
  if (!force && now-ltmConfigFetchAt<15000) return;
  ltmConfigFetchAt=now;
  try {
    const snap=await fbDb.ref(CLOUD_LTM_CONFIG).get();
    const val=(snap&&snap.val)?(snap.val()||{}):{};
    const idxRaw=Number(val.index);
    if (Number.isFinite(idxRaw)) {
      const idx=clamp(Math.floor(idxRaw),0,Math.max(0,LTM_MODES.length-1));
      ltmSelectedIndex=idx;
      ltmGlobalUpdatedAt=Number(val.updatedAt)||0;
      if (gameMode!=='LTM') ltmRotationIndex=idx;
    }
  } catch (e) {}
}

async function setGlobalLtmConfig(idx){
  if (!fbReady || !fbDb) return;
  const safe=clamp(Math.floor(Number(idx)||0),0,Math.max(0,LTM_MODES.length-1));
  const ts=Date.now();
  const mode=LTM_MODES[safe]||LTM_MODES[0];
  const payload={index:String(safe),name:String(mode.name||`LTM ${safe+1}`),updatedAt:String(ts),updatedBy:String((auth&&auth.uid)||'system')};
  try {
    await fbDb.ref(CLOUD_LTM_CONFIG).update(payload);
    ltmSelectedIndex=safe;
    ltmGlobalUpdatedAt=ts;
  } catch (e) {}
}

function minLeaderboardScroll(){ return Math.min(0,leaderboardViewH-leaderboardContentH); }

// Score multiplier (includes mini jetpack bonus).
const scoreMultiplier = () => { const comboBonus=Math.max(0,multi-1); const base=1 + comboBonus + (player.jetpackActive ? 10 : 0) + (miniJetpackActive ? 5 : 0); return Math.max(1,Math.floor(base*(gemDoubleActive?2:1))); }; 

async function triggerLeaderboardFetch(force=false) {
  if (!force && leaderboardState==='loading') return;
  if (!force && Date.now()<leaderboardNextRefresh && leaderboardState==='loaded' && leaderboardData.length) return;
  if (!navigator.onLine) { leaderboardState='error'; leaderboardData=[]; leaderboardScroll=0; return; }
  if (!isSignedIn) { leaderboardState='error'; leaderboardData=[]; leaderboardScroll=0; return; }
  leaderboardState='loading';
  leaderboardTimer=0;
  leaderboardData=[];
  leaderboardScroll=0;
  leaderboardNextRefresh=Date.now()+3600*1000;
  try {
    if (!fbReady || !fbDb) throw new Error('Sign in required');
    const cat=String(leaderboardCategory||'GLOBAL').toLowerCase();
    const merged=new Map();
    const lbSnap=await fbDb.ref(`${CLOUD_LEADERBOARD_ROOT}/${cat}`).get();
    const lbVal=lbSnap&&lbSnap.val?lbSnap.val():null;
    if (lbVal && typeof lbVal==='object' && Object.keys(lbVal).length) {
      Object.keys(lbVal).forEach(uid=>{
        const v=lbVal[uid]||{};
        merged.set(uid,{uid,name:String(v.name||'Runner').slice(0,20),score:Number(v.score||0)});
      });
    }

    const slopeSnap=await fbDb.ref(CLOUD_SLOPE_ROOT).get();
    const slopeAll=slopeSnap&&slopeSnap.val?slopeSnap.val():{};
    Object.keys(slopeAll||{}).forEach(uid=>{
      const u=slopeAll[uid]||{};
      const modeScores={endless:Number(u.endlessScore||0),adventure:Number(u.adventureScore||0),impossible:Number(u.impossibleScore||0),ltm:Number(u.ltmScore||0)};
      const globalSum=Number(modeScores.endless||0)+Number(modeScores.adventure||0)+Number(modeScores.impossible||0)+Number(modeScores.ltm||0);
      const score=leaderboardCategory==='ENDLESS'?Number(modeScores.endless||0):leaderboardCategory==='ADVENTURE'?Number(modeScores.adventure||0):leaderboardCategory==='IMPOSSIBLE'?Number(modeScores.impossible||0):leaderboardCategory==='LTM'?Number(modeScores.ltm||0):(globalSum>0?globalSum:Number(u.bestScore||0));
      const cur=merged.get(uid);
      const name=String((u.displayName||u.name||u.email||'Runner')).slice(0,20);
      if (!cur || score>cur.score) merged.set(uid,{uid,name,score:Number.isFinite(score)?score:0});
    });

    const root=await resolveCloudRoot(fbUser&&fbUser.uid,true);
    const snap=await fbDb.ref(root).get();
    const all=snap&&snap.val?snap.val():{};
    Object.keys(all||{}).forEach(uid=>{
      const u=all[uid]||{};
      const p=(u.progress||{});
      const modeScores=(p.modeScores||{});
      const globalSum=Number(modeScores.endless||0)+Number(modeScores.adventure||0)+Number(modeScores.impossible||0)+Number(modeScores.ltm||0);
      const score=leaderboardCategory==='ENDLESS'?Number(modeScores.endless||0):leaderboardCategory==='ADVENTURE'?Number(modeScores.adventure||0):leaderboardCategory==='IMPOSSIBLE'?Number(modeScores.impossible||0):leaderboardCategory==='LTM'?Number(modeScores.ltm||0):(globalSum>0?globalSum:Number(p.bestScore||0));
      const cur=merged.get(uid);
      const name=(u.name||u.email||'Runner').toString().slice(0,20);
      if (!cur || score>cur.score) merged.set(uid,{uid,name,score:Number.isFinite(score)?score:0});
    });
    const rows=[...merged.values()];
    rows.sort((a,b)=>b.score-a.score);
    const top=rows.slice(0,100);
    while (top.length<100) top.push({uid:`empty-${top.length}`,name:'—',score:0,empty:true});
    leaderboardData=top;
    leaderboardState='loaded';
  } catch (e) {
    leaderboardState='error';
    leaderboardData=[];
    leaderboardScroll=0;
  }
}


function currentStageConfig(){
  if (gameMode==='IMPOSSIBLE') return IMP_STAGES[impossibleStage]||IMP_STAGES[0];
  if (gameMode==='LTM') { const m=getActiveLtm(); return (m.stages&&m.stages[ltmStage])||m.stages[0]||ADV_STAGES[0]; }
  if (gameMode==='ADVENTURE') return ADV_STAGES[adventureStage]||ADV_STAGES[0];
  return ADV_STAGES[0];
}
function isStageMode(){ return gameMode==='ADVENTURE'||gameMode==='IMPOSSIBLE'||gameMode==='LTM'; }
function hasStageProgression(){
  if (!isStageMode()) return false;
  if (gameMode==='ADVENTURE') return ADV_STAGES.length>1;
  if (gameMode==='IMPOSSIBLE') return IMP_STAGES.length>1;
  if (gameMode==='LTM') {
    const m=getActiveLtm();
    return !!(m&&Array.isArray(m.stages)&&m.stages.length>1);
  }
  return false;
}
function canAdvanceStage(){
  if (!hasStageProgression()) return false;
  if (gameMode==='ADVENTURE') return adventureStage<ADV_STAGES.length-1;
  if (gameMode==='IMPOSSIBLE') return impossibleStage<IMP_STAGES.length-1;
  if (gameMode==='LTM') {
    const m=getActiveLtm();
    const len=(m&&Array.isArray(m.stages))?m.stages.length:0;
    return len>1 && ltmStage<len-1;
  }
  return false;
}

function activateImmunity(sec=immunityDuration()) {
  if (gameMode==='IMPOSSIBLE') sec=Math.min(sec,1.5);
  immunityActive=true;
  immunityTimer=Math.max(immunityTimer,sec);
  player.inv=true;
  player.blink=true;
  player.blinkT=0;
  addNotif('IMMUNITY ONLINE!',CFG.GR);
}

function centerPlayerToTrack() {
  const w=terrain.getWalls(player.y);
  player.x=(w.left+w.right)/2;
}

function clearObstaclesTemporarily() {
  obstacles.length=0;
  obstacleClearTimer=1.0;
}


function startImpossibleIntro() {
  gameMode='IMPOSSIBLE';
  gs='IMPOSSIBLE_INTRO';
  impossibleIntroT=0; impossibleIntroDone=false;
  clearAllFX();
  terrain.reset(); player.reset();
  gems.length=0; powerups.length=0; obstacles.length=0;
  transDir=1; transAlpha=1;
}


function goMenu() {
  gs='MENU'; menuSlideY=0;
  gameMode='ENDLESS'; impossibleStage=0;
  clearAllFX(); terrain.reset(); player.reset();
  gems.length=0; powerups.length=0; obstacles.length=0;
  transDir=1; transAlpha=1;
  activePwr=null; pwrTimer=0; worldSpeedMult=1;
  immunityActive=false; immunityTimer=0; obstacleClearTimer=0; badLuckActive=false; badLuckTimer=0; badLuckSpawnT=0; gemDoubleActive=false; gemDoubleTimer=0; gemBoostMult=1; gemDropActive=false; gemDropTimer=0; gemDropSpawnTimer=0;
  pauseToggleLock=0;
  continueOfferTimer=0;
  shuffleShop();
}

function startGame(starterPwr=null, forceNoStarter=false) {
  score=0; maxLives=(gameMode==='IMPOSSIBLE'?1:CFG.LIVES); lives=maxLives;
  continueAttempts=0; continueOfferTimer=0;
  multi=1; gemStreak=0; maxCombo=1; gemsCollected=0;
  worldSpeedMult=1; activePwr=null; pwrTimer=0;
  flashAlpha=0; scorePopT=0; gameTime=0; overShakePow=0;
  healthBoostActive=false; healthBoostTimer=0;
  gems.length=0; powerups.length=0; obstacles.length=0;
  clearAllFX();
  gemTimer=0; gemNext=rnd(...CFG.GEM_INT);
  pwrTimer2=0; pwrNext=rnd(...CFG.PWR_INT);
  obsTimer=0; obsNext=rnd(...CFG.OBS_INT);
  lastMilestone=0; clusterTimer=0; clusterNext=8;
  jetpackCount=0; regenUsed=0;
  pwrCounts={JETPACK:0,MAGNET:0,BOOST:0,SHIELD:0,SLOW:0,HEALTH_BOOST:0,MINI_JETPACK:0,NEW_STAGE:0,REGEN:0,X2_GEMS:0,X4_GEMS:0,GEM_DROP:0,BAD_LUCK:0,SICK:0,LTM_SPECIAL:0};
  // Adventure setup
  adventureStage=0; adventureStageTimer=0; impossibleStage=0; ltmStage=0; ltmStageTimer=0;
  if (gameMode==='LTM') {
    if (!navigator.onLine) { addNotif('LTM REQUIRES INTERNET',CFG.PK); gameMode='ENDLESS'; }
    const picked=(ltmSelectedIndex>=0?ltmSelectedIndex:getDailyLtmIndex());
    ltmRotationIndex=clamp(picked,0,Math.max(0,LTM_MODES.length-1));
    ltmSelectedIndex=ltmRotationIndex;
  } else {
    ltmRotationIndex=getDailyLtmIndex();
  }
  miniJetpackActive=false; miniJetpackTimer=0;
  newStageActive=false; newStageTimer=0;
  stagePowerupNext=rnd(20,30); stagePowerupElapsed=0;
  stageTransT=0;
  immunityActive=false; immunityTimer=0; obstacleClearTimer=0; badLuckActive=false; badLuckTimer=0; badLuckSpawnT=0; gemDoubleActive=false; gemDoubleTimer=0; gemBoostMult=1; gemDropActive=false; gemDropTimer=0; gemDropSpawnTimer=0;
  terrain.reset(); player.reset();
  // Set starting speed by mode
  if (gameMode==='ENDLESS') {
    terrain.speed=CFG.SPD0;
  }
  if (gameMode==='ADVENTURE') {
    const st=ADV_STAGES[0];
    terrain.speed=st.spd;
  }
  if (gameMode==='LTM') {
    const st=currentStageConfig();
    terrain.speed=st.spd||terrain.speed;
  }
  if (gameMode==='IMPOSSIBLE') {
    const st=IMP_STAGES[0];
    terrain.speed=st.spd;
  }
  transDir=1; transAlpha=1;


  if (gameMode==='LTM') {
    const lm=getActiveLtm();
    activePwr='BOOST'; pwrTimer=10;
    activatePwr('SHIELD',shieldDuration(90)); player.shield=true;
    addNotif(`${lm.name} ACTIVE`,lm.cardCol||CFG.YL);
  }

  if (starterPwr && !forceNoStarter && gameMode!=='IMPOSSIBLE') {
    if (starterPwr==='SHIELD') {
      activatePwr('SHIELD',shieldDuration(150)); player.shield=true;
    } else if (starterPwr==='JETPACK') {
      setTimeout(()=>{ if(gs==='PLAY'){ player.activateJetpack(10.0); worldSpeedMult=1.3; }},200);
    } else if (starterPwr==='HEALTH_BOOST') {
      activateHealthBoost(healthBoostDuration(60));
    } else {
      activePwr=starterPwr; pwrTimer=PWR_TYPES[starterPwr]?.dur||5;
      if (starterPwr==='SLOW') worldSpeedMult=0.42;
    }
    addNotif(`STARTED WITH ${PWR_TYPES[starterPwr]?.label||starterPwr}!`,PWR_TYPES[starterPwr]?.col||CFG.CY);
  }
  if (gameMode==='LTM') ltmForcedIndex=-1;
  gs='PLAY'; SFX.start();
}

function activateHealthBoost(dur=healthBoostDuration(30)) {
  if (gameMode==='IMPOSSIBLE') return;
  healthBoostActive=true; healthBoostTimer=dur; healthBoostMax=dur;
  const prevMax=maxLives; maxLives=CFG.MAX_LIVES;
  // Top up to new max if possible
  if (lives<maxLives) {
    const added=Math.min(maxLives-lives, maxLives-prevMax);
    lives=Math.min(maxLives, lives+added);
  }
  addNotif(`❤ HEALTH BOOST! ${maxLives} LIVES!`,'#ff44aa');
  burst(player.x,player.y,'#ff44aa',20,200);
  addRing(player.x,player.y,'#ff44aa',90,200,2.5);
}

function deactivateHealthBoost() {
  healthBoostActive=false;
  const prevMax=maxLives; maxLives=CFG.LIVES;
  if (lives>maxLives) lives=maxLives;
  addNotif('HEALTH BOOST ENDED','rgba(255,68,170,0.7)');
}

function advanceAdventureStage() {
  if (adventureStage>=ADV_STAGES.length-1) {
    addNotif('MAX STAGE REACHED!',CFG.YL);
    stageTransLabel='MAX STAGE!';
    stageTransT=3.0;
    return;
  }
  adventureStage++;
  const st=ADV_STAGES[adventureStage];
  terrain.speed=Math.max(terrain.speed,st.spd);
  const prevLives=lives;
  lives=Math.min(maxLives,lives+1);
  if (lives>prevLives) {
    addNotif(`+1 LIFE ON ${st.name}!`,CFG.GR);
    addRing(player.x,player.y,CFG.GR,90,220,2.5);
  }
  stageTransLabel=`${st.name}  ·  ${st.label}`;
  stageTransT=3.0;
  centerPlayerToTrack();
  addNotif(`⬆ ${st.name} — ${st.label}!`,'#88ffcc');
  addShake(12,0.5);
  burst(LW/2,LH/2,'#88ffcc',40,350);
  addRing(LW/2,LH/2,'#88ffcc',200,300,3);
  SFX.stage();
  flashAlpha=0.5; flashCol='#88ffcc';
}



function advanceLtmStage() {
  const m=getActiveLtm();
  if (!m || !m.stages || ltmStage>=m.stages.length-1) {
    stageTransLabel='LTM MAX STAGE!'; stageTransT=2.8; addNotif('LTM MAX STAGE!',CFG.YL); return;
  }
  ltmStage++;
  const st=currentStageConfig();
  terrain.speed=Math.max(terrain.speed,st.spd||terrain.speed);
  lives=Math.min(maxLives,lives+1);
  stageTransLabel=`${m.name} · ${st.name} · ${st.label}`;
  stageTransT=3.0;
  addNotif(`⬆ ${m.name} ${st.name}!`,m.cardCol||CFG.YL);
  addRing(LW/2,LH/2,m.cardCol||CFG.YL,180,280,3);
}

function advanceImpossibleStage() {
  if (impossibleStage>=IMP_STAGES.length-1) {
    stageTransLabel='STAGE 4 · THE IMPOSSIBLE CHALLENGE!';
    stageTransT=3.2;
    addNotif('MAX IMPOSSIBLE STAGE!', '#ff3333');
    return;
  }
  impossibleStage++;
  const st=IMP_STAGES[impossibleStage];
  terrain.speed=Math.max(terrain.speed,st.spd);
  const names=['STAGE 1: Defeat the Evil!','STAGE 2: Avoid the Demons!','STAGE 3: Thin Storm!','STAGE 4: The Impossible Challenge!'];
  stageTransLabel=names[impossibleStage]||`${st.name} · ${st.label}`;
  stageTransT=3.2;
  addNotif(`⬆ ${st.name} — ${st.label}!`,'#ff4455');
}

function togglePause() {
  const now=performance.now();
  if (now<pauseToggleLock) return;
  pauseToggleLock=now+110;
  if (gs==='PLAY') { gs='PAUSE'; pauseStartedAt=performance.now(); SFX.pause(); }
  else if (gs==='PAUSE') {
    const nowPerf=performance.now();
    lastTime=nowPerf;
    touchSwipe=0; touchSwipeTarget=0;
    gs='PLAY';
    setTimeout(()=>{ try { SFX.resume(); } catch(e){} },0);
    touchSwipe=0; touchActive=false; K.left=false; K.right=false;
  }
}

function loseLife() {
  if (immunityActive||player.jetpackActive) return;
  if (player.shield||activePwr==='SHIELD') {
    player.shield=false;
    if (activePwr==='SHIELD') { activePwr=null; pwrTimer=0; }
    addNotif('SHIELD BROKE!',CFG.CY); SFX.shieldBlock();
    addRing(player.x,player.y,CFG.BL,80,280,3);
    addRing(player.x,player.y,CFG.CY,110,220,2);
    burst(player.x,player.y,CFG.BL,16);
    addShake(5,0.2);
    return;
  }
  lives--;
  multi=1; gemStreak=0;
  addShake(10,0.35);
  burst(player.x,player.y,CFG.PK,28);
  flashAlpha=0.45; flashCol=CFG.PK;
  if (lives<=0) {
    if (continueAttempts<3) {
      gs='CONTINUE';
      continueOfferTimer=10;
      BTNS.continueBuy=null; BTNS.continueGiveUp=null;
    } else {
      finalizeGameOver();
    }
  } else {
    SFX.loseLife();
    const w=terrain.getWalls(player.y);
    player.x=(w.left+w.right)/2;
    addNotif(`-1 LIFE! (${lives}/${maxLives})`,CFG.PK);
    activateImmunity(IMMUNITY_COLLISION_COOLDOWN);
  }
}


function finalizeGameOver() {
  continueOfferTimer=0;
  gs='OVER';
  SFX.gameOver();
  if (score>bestScore) bestScore=score;
  if (gameMode==='ENDLESS') modeScores.endless=Math.max(modeScores.endless||0,score);
  if (gameMode==='ADVENTURE') modeScores.adventure=Math.max(modeScores.adventure||0,score);
  if (gameMode==='IMPOSSIBLE') modeScores.impossible=Math.max(modeScores.impossible||0,score);
  if (gameMode==='LTM') modeScores.ltm=Math.max(modeScores.ltm||0,score);
  const runs=parseInt(localStorage.getItem('slope_runs')||'0',10)+1;
  const total=parseFloat(localStorage.getItem('slope_totalTime')||'0')+Math.max(0,gameTime);
  localStorage.setItem('slope_runs',String(runs));
  localStorage.setItem('slope_totalTime',String(total));
  burst(player.x,player.y,CFG.PK,60,420);
  addShake(20,0.8); overShakePow=12;
  triggerGameOverFlash();
  transDir=1; transAlpha=1;
  syncLeaderboardRTDB();
}


function tryContinueRun() {
  if (continueOfferTimer<=0||continueAttempts>=3) return;
  const cost=CONTINUE_COSTS[continueAttempts];
  if (totalGems<cost) { SFX.hit(); return; }
  totalGems-=cost; saveBank(totalGems);
  continueAttempts++;
  continueOfferTimer=0;
  gs='PLAY';
  activePwr=null; pwrTimer=0;
  lives=Math.max(1,lives);
  player.startInv();
  centerPlayerToTrack();
  obstacles.length=0;
  if (continueAttempts===1) {
    player.activateJetpack(15.0); worldSpeedMult=1.3;
  } else if (continueAttempts===2) {
    player.activateJetpack(10.0); worldSpeedMult=1.3;
    activatePwr('SHIELD',shieldDuration(120)); player.shield=true;
  } else {
    player.activateJetpack(10.0); worldSpeedMult=1.3;
    activatePwr('SHIELD',shieldDuration(90)); player.shield=true;
    activateHealthBoost(healthBoostDuration(30));
  }
}

function collectNearbyDrops(cx,cy,radius=120) {
  const r2=radius*radius;
  for (let i=gems.length-1;i>=0;i--) {
    const g=gems[i];
    if (!g||g.collected||!g.active) continue;
    const dx=g.x-cx,dy=g.y-cy;
    if (dx*dx+dy*dy<=r2) collectGem(g);
  }
  for (let i=powerups.length-1;i>=0;i--) {
    const p=powerups[i];
    if (!p||p.collected||!p.active) continue;
    const dx=p.x-cx,dy=p.y-cy;
    if (dx*dx+dy*dy<=r2) collectPwr(p);
  }
  addNotif('CONTINUE PURCHASED!',CFG.CY);
}

function collectGem(gem) {
  gem.collected=true; gem.active=false;
  gemsCollected++; gemStreak++;
  if (gemStreak>=20) multi=5;
  else if (gemStreak>=15) multi=4;
  else if (gemStreak>=10) multi=3;
  else if (gemStreak>=5)  multi=2;
  else                     multi=1;
  if (multi>maxCombo) maxCombo=multi;
  const pts=gem.type.pts*scoreMultiplier()*(activePwr==='BOOST'?scoreBoostMult():1);
  score+=pts; scorePopT=0.3;
  const gm=(gemDoubleActive?Math.max(2,gemBoostMult):1);
  const earned=gem.type.gemVal*gm;
  totalGems=addToBank(earned);
  const tier=GEM_TYPES.indexOf(gem.type);
  SFX.gem(tier);
  burst(gem.x,gem.y,gem.type.col,12,180);
  flashAlpha=0.12; flashCol=gem.type.col;
  addFloat(gem.x,gem.y-10,`+${pts}${scoreMultiplier()>1?` ×${scoreMultiplier()}`:''}`,gem.type.col);
  addFloat(gem.x,gem.y-28,`+${earned}◆${gemDoubleActive?`  X${Math.max(2,gemBoostMult)}`:''}`,gem.type.col);
}

function collectPwr(pwr) {
  pwr.collected=true; pwr.active=false;
  const col=pwr.info.col;
  if      (pwr.key==='JETPACK')      { SFX.jetpack(); player.activateJetpack(10.0); worldSpeedMult=1.3; jetpackCount++; pwrCounts.JETPACK++; }
  else if (pwr.key==='SHIELD')       { SFX.pwr(); activatePwr('SHIELD',shieldDuration(150)); pwrCounts.SHIELD++; addRing(pwr.x,pwr.y,CFG.BL,70,240,2.5); }
  else if (pwr.key==='SLOW')         { SFX.slow(); activatePwr('SLOW',4.5); worldSpeedMult=0.42; pwrCounts.SLOW++; }
  else if (pwr.key==='BOOST')        { SFX.boost(); activatePwr('BOOST',10.0); pwrCounts.BOOST++; }
  else if (pwr.key==='MAGNET')       { SFX.magnet(); activatePwr('MAGNET',10.0); pwrCounts.MAGNET++; }
  else if (pwr.key==='HEALTH_BOOST') { SFX.regen(); activateHealthBoost(healthBoostDuration(30)); pwrCounts.HEALTH_BOOST++; }
  else if (pwr.key==='REGEN')        { SFX.regen(); collectRegen(pwr.x,pwr.y); pwrCounts.REGEN++; }
  else if (pwr.key==='MINI_JETPACK') { SFX.jetpack(); activateMiniJetpack(); pwrCounts.MINI_JETPACK++; }
  else if (pwr.key==='NEW_STAGE')    { if (newStageActive) return; SFX.stage(); activateNewStagePowerup(); pwrCounts.NEW_STAGE++; }
  else if (pwr.key==='X2_GEMS')      { SFX.pwr(); activateGemDouble(2,10); pwrCounts.X2_GEMS++; }
  else if (pwr.key==='X4_GEMS')      { SFX.pwr(); activateGemDouble(4,8); pwrCounts.X2_GEMS++; }
  else if (pwr.key==='SICK')         { SFX.stage(); applyRandomSickPower(); }
  else if (pwr.key==='LTM_SPECIAL')  { SFX.stage(); activateLtmSpecialPower(); }
  else if (pwr.key==='GEM_DROP')     { SFX.stage(); activateGemDrop(); pwrCounts.GEM_DROP++; }
  else if (pwr.key==='BAD_LUCK')     { SFX.hit(); activateBadLuck(); pwrCounts.BAD_LUCK++; }
  else SFX.pwr();
  burst(pwr.x,pwr.y,col,24,220); ringBurst(pwr.x,pwr.y,col);
  addShake(6,0.2); flashAlpha=0.35; flashCol=col;
  if (pwr.key!=='HEALTH_BOOST'&&pwr.key!=='REGEN'&&pwr.key!=='MINI_JETPACK'&&pwr.key!=='NEW_STAGE'&&pwr.key!=='X2_GEMS'&&pwr.key!=='X4_GEMS'&&pwr.key!=='SICK'&&pwr.key!=='LTM_SPECIAL'&&pwr.key!=='GEM_DROP'&&pwr.key!=='BAD_LUCK') {
    addNotif(`${pwr.info.label} ACTIVATED!`,col);
    addFloat(pwr.x,pwr.y-16,pwr.info.icon+' '+pwr.info.label,col);
  }
}

function activatePwr(key,dur) {
  if (activePwr==='SLOW') worldSpeedMult=1;
  if (activePwr==='SHIELD'&&key!=='SHIELD') player.shield=false;
  activePwr=key; pwrTimer=dur;
  if (key==='SHIELD') player.shield=true;
}

function collectRegen(x,y) {
  if (gameMode==='IMPOSSIBLE') { addNotif('REGEN BLOCKED IN IMPOSSIBLE','#ff4455'); return; }
  if (lives>=maxLives) { addNotif('LIVES FULL!','#ff6699'); return; }
  lives=Math.min(maxLives,lives+1); regenUsed++;
  addNotif(`✚ REGEN! LIFE RESTORED (${lives}/${maxLives})`,'#ff6699');
  addFloat(x,y-16,'✚ +1 LIFE','#ff6699');
  burst(x,y,'#ff6699',18,160);
  addRing(x,y,'#ff6699',80,200,2.5);
}

function activateMiniJetpack() {

  miniJetpackActive=true; miniJetpackTimer=10.0;
  newStageActive=false; newStageTimer=0;
  worldSpeedMult=Math.max(worldSpeedMult,1.08);
  addNotif('🛸 MINI JETPACK! +5 MULTI','#88ccff');
  addFloat(player.x,player.y-20,'🛸 MINI JETPACK!','#88ccff');
  burst(player.x,player.y,'#88ccff',30,240);
  addRing(player.x,player.y,'#88ccff',140,320,3);
  collectNearbyDrops(player.x,player.y,130);
}

function activateNewStagePowerup() {
  if (!canAdvanceStage()) { addNotif('MAX STAGE REACHED!',CFG.YL); return; }
  newStageActive=true; newStageTimer=6.0;
  miniJetpackActive=false; miniJetpackTimer=0;
  player.activateJetpack(6.0);
  worldSpeedMult=1.18;
  addNotif('🌀 NEW STAGE POWERUP!','#66bbff');
  addFloat(player.x,player.y-20,'🌀 NEW STAGE','#66bbff');
  burst(player.x,player.y,'#66bbff',28,220);
  addRing(player.x,player.y,'#66bbff',120,280,2.8);
  collectNearbyDrops(player.x,player.y,140);
}



function activateGemDouble(mult=2,dur=10.0) {
  gemDoubleActive=true; gemBoostMult=Math.max(2,mult|0); gemDoubleTimer=dur;
  activateImmunity(3.0);
  addNotif(`💎 X${gemBoostMult} GEMS ACTIVE!`,'#ffd700');
  addFloat(player.x,player.y-24,`💎 X${gemBoostMult} GEMS`,'#ffd700');
}

function activateGemDrop() {
  gemDropActive=true; gemDropTimer=8.0; gemDropSpawnTimer=0;
  activateImmunity(3.0);
  addNotif('💠 GEM DROP ACTIVE!','#99ddff');
  addFloat(player.x,player.y-24,'💠 GEM RAIN','#99ddff');
}


function applyRandomSickPower(){
  const effects=[
    ()=>{ activatePwr('BOOST',8); addNotif('SICK: SCORE BOOST',CFG.YL); },
    ()=>{ activatePwr('MAGNET',10); addNotif('SICK: MAGNET',CFG.PU); },
    ()=>{ activatePwr('SHIELD',shieldDuration(120)); addNotif('SICK: SHIELD',CFG.BL); },
    ()=>{ activateGemDouble(2,10); addNotif('SICK: X2 GEMS','#ffd700'); },
    ()=>{ activateGemDouble(4,8); addNotif('SICK: X4 GEMS','#ffd700'); },
    ()=>{ activateGemDrop(); gemDropTimer=Math.max(gemDropTimer,10); addNotif('SICK: GEM DROP','#99ddff'); },
    ()=>{ activateMiniJetpack(); miniJetpackTimer=Math.max(miniJetpackTimer,12); addNotif('SICK: MINI JETPACK','#88ccff'); },
  ];
  effects[rndI(0,effects.length-1)]();
}

function activateLtmSpecialPower(){
  if (gameMode!=='LTM') return;
  const lm=getActiveLtm();
  const id=(lm&&lm.id)||'';
  if (id==='gold_rush') { activateGemDouble(4,8); activateGemDrop(); gemDropTimer=Math.max(gemDropTimer,10); totalGems=addToBank(40); addNotif('GOLD FEVER!',lm.specialCol||CFG.YL); return; }
  if (id==='volcano') { activatePwr('SHIELD',shieldDuration(140)); activateImmunity(5); clearObstaclesTemporarily(); addShake(10,0.35); addNotif('LAVA ARMOR!',lm.specialCol||CFG.OR); return; }
  if (id==='frostbite') { activatePwr('SLOW',10); activatePwr('SHIELD',shieldDuration(100)); addNotif('ICE FIELD!',lm.specialCol||CFG.CY); return; }
  if (id==='space') { activateMiniJetpack(); miniJetpackTimer=Math.max(miniJetpackTimer,12); addNotif('COSMIC BURST!',lm.specialCol||CFG.CY); return; }
  if (id==='storm') { activateImmunity(6); activatePwr('BOOST',10); addNotif('THUNDER CORE!',lm.specialCol||CFG.PU); return; }
  if (id==='hacker') { activatePwr('MAGNET',12); activateGemDouble(2,12); addNotif('GLITCH BREAK!',lm.specialCol||CFG.CY); return; }
  if (id==='void') { activateImmunity(8); activatePwr('SLOW',8); addNotif('VOID SHELL!',lm.specialCol||CFG.PU); return; }
  if (id==='jungle') { activateGemDrop(); gemDropTimer=Math.max(gemDropTimer,12); collectRegen(player.x,player.y); addNotif('WILD GROWTH!',lm.specialCol||CFG.GR); return; }
  if (id==='chrono') { activatePwr('BOOST',12); activatePwr('SLOW',8); addNotif('TIME FRACTURE!',lm.specialCol||CFG.YL); return; }
  if (id==='metro') { activatePwr('MAGNET',10); activatePwr('BOOST',10); addNotif('RAIL RUSH!',lm.specialCol||CFG.PK); return; }
  applyRandomSickPower();
}

function drawLtmModeFx(lm,t){
  if (!lm) return;
  const id=lm.id||'';
  if (id==='space') {
    ctx.save(); ctx.globalAlpha=0.16;
    for (let i=0;i<26;i++) {
      const sx=(i*31+t*15)%LW, sy=(i*67+t*8)%LH;
      circle(sx,sy,1.2+((i%3)*0.7),'rgba(170,220,255,0.8)');
    }
    ctx.restore();
    return;
  }
  if (id==='volcano') {
    ctx.save();
    const a=0.08+0.08*Math.sin(t*8);
    ctx.fillStyle=`rgba(255,60,30,${a})`; ctx.fillRect(0,0,LW,LH);
    ctx.restore();
    if (Math.random()<0.03) addShake(4.5,0.08);
    return;
  }
  if (id==='gold_rush') {
    ctx.save();
    ctx.globalAlpha=0.08+0.05*Math.sin(t*4);
    ctx.fillStyle='rgba(255,220,80,0.55)';
    for (let i=0;i<12;i++) ctx.fillRect((i*53+t*30)%LW,((i*71+t*24)%LH),2,2);
    ctx.restore();
    return;
  }
  if (id==='frostbite') {
    ctx.save();
    ctx.globalAlpha=0.11+0.04*Math.sin(t*2.5);
    ctx.fillStyle='rgba(120,230,255,0.5)';
    ctx.fillRect(0,0,LW,LH*0.35);
    ctx.restore();
    return;
  }
  if (id==='metro') {
    ctx.save();
    ctx.globalAlpha=0.12;
    for (let y=40;y<LH;y+=80) {
      ctx.fillStyle='rgba(255,77,210,0.35)';
      ctx.fillRect((t*140+y*0.6)%LW,y,LW*0.2,2);
    }
    ctx.restore();
    return;
  }
  if (id==='storm') {
    if (Math.random()<0.03) {
      ctx.save();
      ctx.globalAlpha=0.2+Math.random()*0.25;
      ctx.fillStyle='#d3c4ff';
      ctx.fillRect(0,0,LW,LH*0.18);
      ctx.restore();
    }
    return;
  }
  if (id==='hacker') {
    ctx.save();
    ctx.globalAlpha=0.08;
    ctx.fillStyle='rgba(69,255,204,0.45)';
    for (let i=0;i<8;i++) ctx.fillRect((i*70+t*55)%LW,80+i*60,20,2);
    ctx.restore();
    return;
  }
  if (id==='void') {
    ctx.save();
    const g=ctx.createRadialGradient(LW/2,LH*0.45,40,LW/2,LH*0.45,LH*0.7);
    g.addColorStop(0,'rgba(169,139,255,0.0)');
    g.addColorStop(1,'rgba(80,40,120,0.22)');
    ctx.fillStyle=g; ctx.fillRect(0,0,LW,LH);
    ctx.restore();
    return;
  }
  if (id==='jungle') {
    ctx.save();
    ctx.globalAlpha=0.08;
    ctx.fillStyle='rgba(125,255,96,0.45)';
    for (let i=0;i<10;i++) ctx.fillRect((i*47+t*18)%LW,LH-(i*44%220),2,26);
    ctx.restore();
    return;
  }
  if (id==='chrono') {
    ctx.save();
    ctx.globalAlpha=0.10;
    ctx.fillStyle='rgba(255,243,123,0.4)';
    ctx.fillRect(0,0,2+Math.abs(Math.sin(t*4))*3,LH);
    ctx.fillRect(LW-4,0,2+Math.abs(Math.cos(t*3.7))*3,LH);
    ctx.restore();
  }
}

function activateBadLuck() {
  if (gameMode!=='IMPOSSIBLE') return;
  badLuckActive=true; badLuckTimer=5.0; badLuckSpawnT=0;
  addNotif('☠ BAD LUCK! FALLING ROCKS','#ff3333');
  addFloat(player.x,player.y-24,'☠ BAD LUCK','#ff3333');
}

function spawnNewStageLine(count=8) {
  const w=terrain.getWalls(CFG.SEG_H*2);
  const pad=24;
  const start=w.left+pad;
  const end=w.right-pad;
  if (end<=start) return;
  for (let i=0;i<count;i++) {
    const p=new PowerUp(terrain);
    p.key='NEW_STAGE';
    p.info=PWR_TYPES.NEW_STAGE;
    p.x=lerp(start,end,(i+0.5)/count);
    p.y=-18;
    p.t=i*0.06;
    powerups.push(p);
  }
}

function spawnObjects(dt) {
  gemTimer+=dt;
  if (gemTimer>=gemNext) { gemTimer=0; gemNext=rnd(...CFG.GEM_INT); gems.push(new Gem(terrain)); }

  // Gem clusters
  clusterTimer+=dt;
  if (clusterTimer>=clusterNext) {
    clusterTimer=0; clusterNext=rnd(7,14);
    const count=rndI(4,7);
    for (let i=0;i<count;i++) {
      const g=new Gem(terrain); g.y=-12-i*28; gems.push(g);
    }
  }

  pwrTimer2+=dt;
  if (pwrTimer2>=pwrNext) { pwrTimer2=0; pwrNext=rnd(...CFG.PWR_INT); powerups.push(new PowerUp(terrain)); }

  // Adventure / Impossible stage powerup timing
  if (isStageMode() && canAdvanceStage() && !newStageActive) {
    stagePowerupElapsed+=dt;
    if (stagePowerupElapsed>=stagePowerupNext) {
      stagePowerupElapsed=0; stagePowerupNext=rnd(18,26);
      if (gameMode==='ADVENTURE' && adventureStage>=5) {
        const p=new PowerUp(terrain); p.key='MINI_JETPACK'; p.info=PWR_TYPES.MINI_JETPACK;
        powerups.push(p);
      } else if (gameMode==='IMPOSSIBLE' && impossibleStage>=3) {
        const p=new PowerUp(terrain); p.key='MINI_JETPACK'; p.info=PWR_TYPES.MINI_JETPACK;
        powerups.push(p);
      } else {
        spawnNewStageLine(rndI(7,10));
      }
    }
  }

  // Obstacles (mode-aware)
  const stage=currentStageConfig();
  const obsOff=((gameMode==='ADVENTURE'||gameMode==='LTM')&&stage.obsOff);
  if (!obsOff&&obstacleClearTimer<=0) {
    const obsThresh=Math.max(60,CFG.OBS_THRESH-gameTime*8);
    if (score>=obsThresh) {
      obsTimer+=dt;
      if (obsTimer>=obsNext) {
        obsTimer=0;
        const oi=(gameMode==='ADVENTURE'||gameMode==='LTM')?(stage.obsInt||[3.0,5.0]):CFG.OBS_INT;
        const minI=Math.max(1.4,oi[0]-gameTime*0.02);
        const maxI=Math.max(2.5,oi[1]-gameTime*0.04);
        obsNext=rnd(minI,maxI);
        obstacles.push(new Obstacle(terrain));
      }
    }
  }

  // Score milestones
  const ms=Math.floor(score/500);
  if (ms>lastMilestone) {
    lastMilestone=ms;
    const msgs=['GREAT RUN!','KEEP GOING!','ON FIRE!','UNSTOPPABLE!','LEGENDARY!'];
    addNotif(`${score>=2500?'LEGENDARY':'MILESTONE'}: ${Math.floor(score)}`,CFG.YL);
    addFloat(LW/2,LH*0.3,msgs[Math.min(ms-1,msgs.length-1)],CFG.YL);
    flashAlpha=0.10; flashCol=CFG.YL;
    addShake(4,0.15); SFX.boost();
  }
}
</script>

<!-- ============================================================ -->
<!--  SCRIPT 11 · MAIN LOOP                                      -->
<!-- ============================================================ -->
<script id="s-loop">
let lastTime=0, lastFPSTime=0;

// Fake loading progress
let _loadT=0;
const LOAD_DURATION=2.5;

function loop(ts) {
  // FPS limiting
  const fpsLimitMs=FPS_VALUES[SETTINGS.fpsLimit]>0?(1000/FPS_VALUES[SETTINGS.fpsLimit]):0;
  if (fpsLimitMs>0&&ts-lastTime<fpsLimitMs-1) {
    requestAnimationFrame(loop); return;
  }
  const dt=Math.min((ts-lastTime)/1000,0.05);
  lastTime=ts;

  // FPS counter
  fpsFrames++; fpsTimer+=dt;
  if (fpsTimer>=0.5) { fps=Math.round(fpsFrames/fpsTimer); fpsFrames=0; fpsTimer=0; }

  menuT+=dt;
  if (gs==='PLAY' || gs==='PAUSE') touchSwipe=lerp(touchSwipe,touchSwipeTarget,clamp(dt*14,0,1));
  else touchSwipe=lerp(touchSwipe,0,clamp(dt*10,0,1));
  updateProfileUploadController(dt);
  seasonScrollX=Math.sin(menuT*1.15)*82;
  if (leaderboardState==='loading') leaderboardTimer+=dt;
  if (charShopMsgT>0) charShopMsgT=Math.max(0,charShopMsgT-dt);
  if (stageTransT>0) stageTransT=Math.max(0,stageTransT-dt);
  if (gameOverFlash>0) gameOverFlash=Math.max(0,gameOverFlash-dt);

  // Transition fade in/out
  if (transDir===1&&transAlpha>0) transAlpha=Math.max(0,transAlpha-dt*4);
  if (transDir===0&&transAlpha<1) {
    transAlpha=Math.min(1,transAlpha+dt*3);
    if (transAlpha>=1&&pendingGS) {
      // Switch state when fully black
      if (pendingGS==='MENU') goMenu();
      else gs=pendingGS;
      if (pendingGS==='SHOP') shuffleShop();
      pendingGS=null;
      transDir=1; // start fading back in
    }
  }

  // Wipeout shake
  if (overShakePow>0) overShakePow=Math.max(0,overShakePow-dt*18);
  if (gs==='CONTINUE'&&continueOfferTimer>0) {
    continueOfferTimer=Math.max(0,continueOfferTimer-dt);
    if (continueOfferTimer<=0) finalizeGameOver();
  }

  // Clear
  ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH);

  // Background squares always update
  updateBgSquares(dt);


  // ── LOADING ──────────────────────────────────────────────────
  if (gs==='LOADING') {
    _loadT+=dt;
    loadProgress=Math.min(1,_loadT/LOAD_DURATION);
    // Simulate loading: initialize things
    if (_loadT>0.2&&!bgSquares.length) initBgSquares();
    if (loadProgress>=1&&!loadDone) {
      loadDone=true;
      loadParticles.forEach(p=>{
        p.vx*=3; p.vy=-200-Math.random()*200;
      });
      // Slide up transition to menu
      setTimeout(()=>{ doTransition('MENU'); },600);
    }
    drawLoadingScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── MENU ────────────────────────────────────────────────────
  if (gs==='MENU') {
    terrain.update(dt*0.4);
    // Menu slide-in animation
    if (menuSlideY<0) menuSlideY=Math.min(0,menuSlideY+800*dt);
    drawStartScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── ABOUT ───────────────────────────────────────────────────
  if (gs==='ABOUT') {
    terrain.update(dt*0.28);
    drawAboutScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='CONTROLS') {
    terrain.update(dt*0.2);
    drawControlsScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── MODE SELECT ─────────────────────────────────────────────
  if (gs==='MODESELECT') {
    terrain.update(dt*0.35);
    drawModeSelect(menuT);
    drawConfirmDialog();
    drawTransition();
    requestAnimationFrame(loop); return;
  }

  if (gs==='IMPOSSIBLE_INTRO') {
    impossibleIntroT+=dt;
    drawImpossibleIntro(menuT);
    if (impossibleIntroT>7.2 && !impossibleIntroDone) { impossibleIntroDone=true; startGame(null,true); }
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='IMPOSSIBLE_INTRO') {
    impossibleIntroT+=dt;
    drawImpossibleIntro(menuT);
    if (impossibleIntroT>7.2 && !impossibleIntroDone) { impossibleIntroDone=true; startGame(null,true); }
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='IMPOSSIBLE_INTRO') {
    impossibleIntroT+=dt;
    drawImpossibleIntro(menuT);
    if (impossibleIntroT>7.2 && !impossibleIntroDone) { impossibleIntroDone=true; startGame(null,true); }
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── CHARSHOP ────────────────────────────────────────────────
  if (gs==='CHARSHOP') {
    drawCharShop(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── SHOP ────────────────────────────────────────────────────
  if (gs==='SHOP') {
    terrain.update(dt*0.25);
    drawShopScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── SETTINGS ────────────────────────────────────────────────
  if (gs==='SETTINGS') {
    drawSettingsScreen(menuT);
    drawConfirmDialog();
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── QUESTS ──────────────────────────────────────────────────
  if (gs==='QUESTS') {
    drawQuestsScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='UPGRADES') {
    drawUpgradesScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='SIGNIN') {
    drawSignInScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='SIGNUP') {
    drawSignUpScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='PROFILE') {
    drawProfileScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='PUBLIC_PROFILE') {
    drawPublicProfileScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='FRIEND_REQUESTS') {
    drawFriendRequestsScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='FRIENDS_LIST') {
    drawFriendsListScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='ADMIN_AUTH') {
    drawAdminAuthScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='ADMIN_MENU') {
    drawAdminMenuScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='ADMIN_LTM') {
    drawAdminLtmScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='OPTIONS') {
    drawOptionsScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  if (gs==='LEADERBOARD') {
    drawLeaderboardScreen(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── CONTINUE OFFER (frozen gameplay) ─────────────────────────
  if (gs==='CONTINUE') {
    ctx.save(); applyShake();
    drawPerspGrid(terrain.scrollY,terrain.speedFrac());
    drawTerrain();
    gems.forEach(g=>g&&g.draw&&g.draw()); powerups.forEach(p=>p&&p.draw&&p.draw()); obstacles.forEach(o=>o&&o.draw&&o.draw());
    const th=getSelectedThemeData();
  if (th&&th.id!=='classic') { ctx.save(); ctx.globalAlpha=0.06+0.03*Math.sin(menuT*2); ctx.fillStyle=th.col; ctx.fillRect(0,0,LW,LH); ctx.restore(); }
  drawPlayer();
  drawAuraVisual(); drawParticles(); drawRings();
    ctx.restore();
    drawHUD(); drawScanlines();
    ctx.save(); ctx.fillStyle='#000'; ctx.fillRect(0,0,LW,LH); ctx.restore();
    drawContinueOffer(menuT);
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── GAME OVER ───────────────────────────────────────────────
  if (gs==='OVER') {
    ctx.save(); applyShake();
    drawPerspGrid(terrain.scrollY,0.1);
    ctx.restore();
    updateParticles(dt); updateRings(dt);
    ctx.save(); applyShake();
    drawParticles(); drawRings();
    ctx.restore();
    drawFlash();
    drawGameOver(menuT);
    drawConfirmDialog();
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── PAUSE ───────────────────────────────────────────────────
  if (gs==='PAUSE') {
    ctx.save(); applyShake();
    drawPerspGrid(terrain.scrollY,terrain.speedFrac());
    drawTerrain();
    gems.forEach(g=>g&&g.draw&&g.draw()); powerups.forEach(p=>p&&p.draw&&p.draw()); obstacles.forEach(o=>o&&o.draw&&o.draw());
    const th=getSelectedThemeData();
  if (th&&th.id!=='classic') { ctx.save(); ctx.globalAlpha=0.06+0.03*Math.sin(menuT*2); ctx.fillStyle=th.col; ctx.fillRect(0,0,LW,LH); ctx.restore(); }
  drawPlayer();
  drawAuraVisual(); drawParticles(); drawRings();
    ctx.restore();
    drawHUD(); drawNotifs(); drawFloats(); drawObjAnims(); drawScanlines(); drawPause();
    drawConfirmDialog();
    drawTransition();
    drawTopOverlays(menuT);
    requestAnimationFrame(loop); return;
  }

  // ── PLAY ────────────────────────────────────────────────────
  const wdt=dt*worldSpeedMult;
  gameTime+=dt;
  if (gameMode==='IMPOSSIBLE' && impossibleStage>=2) { gemDoubleActive=true; gemBoostMult=2; gemDoubleTimer=999; }

  // Active powerup countdown
  if (activePwr&&PWR_TYPES[activePwr]?.dur>0) {
    pwrTimer-=dt;
    if (pwrTimer<=0) {
      if (activePwr==='SLOW') worldSpeedMult=1;
      if (activePwr==='SHIELD') player.shield=false;
      addNotif(`${PWR_TYPES[activePwr].label} ENDED`,'rgba(0,245,255,0.7)');
      activePwr=null; pwrTimer=0;
    }
  }

  // Health boost countdown
  if (healthBoostActive) {
    healthBoostTimer-=dt;
    if (healthBoostTimer<=0) deactivateHealthBoost();
  }

  if (gemDoubleActive && !(gameMode==='IMPOSSIBLE' && impossibleStage>=2)) {
    gemDoubleTimer-=dt;
    if (gemDoubleTimer<=0) { gemDoubleActive=false; gemDoubleTimer=0; addNotif('X2 GEMS ENDED',CFG.YL); }
  }

  if (gemDropActive) {
    gemDropTimer-=dt;
    gemDropSpawnTimer-=dt;
    if (gemDropSpawnTimer<=0) {
      gemDropSpawnTimer=0.12;
      const count=rndI(3,7);
      for (let i=0;i<count;i++) {
        const r=Math.random();
        const base=r<0.01?GEM_TYPES[2]:r<0.05?GEM_TYPES[2]:r<0.2?GEM_TYPES[1]:GEM_TYPES[0];
        const mult=r<0.01?5:r<0.05?3:r<0.2?2:1;
        const g=new Gem(terrain);
        g.type={...base, gemVal:Math.max(1,base.gemVal*mult), pts:Math.max(1,base.pts*mult)};
        g.x=rnd(26,LW-26); g.y=-rnd(10,120); gems.push(g);
      }
    }
    if (gemDropTimer<=0) { gemDropActive=false; gemDropTimer=0; addNotif('GEM DROP ENDED',CFG.CY); }
  }

  if (immunityActive) {
    immunityTimer-=dt;
    if (immunityTimer<=0) {
      immunityActive=false; immunityTimer=0;
      if (!player.jetpackActive) { player.inv=false; player.blink=true; }
    }
  }

  if (obstacleClearTimer>0) obstacleClearTimer=Math.max(0,obstacleClearTimer-dt);

  if (badLuckActive && gameMode!=='IMPOSSIBLE') { badLuckActive=false; badLuckTimer=0; }
  if (badLuckActive) {
    badLuckTimer-=dt; badLuckSpawnT-=dt;
    if (badLuckSpawnT<=0) {
      badLuckSpawnT=rnd(0.42,0.68);
      const count=Math.random()<0.22?2:1;
      for (let i=0;i<count;i++) {
        const o=new FallingRock(terrain);
        if (count>1) o.x=clamp(o.x+(i===0?-42:42),24,LW-24);
        obstacles.push(o);
      }
    }
    if (badLuckTimer<=0) { badLuckActive=false; badLuckTimer=0; addNotif('BAD LUCK ENDED','#ff3333'); }
  }

  if (miniJetpackActive) {
    miniJetpackTimer-=dt;
    if (miniJetpackTimer<=0) {
      miniJetpackActive=false; miniJetpackTimer=0;
      if (!newStageActive) worldSpeedMult=1;
      addRing(player.x,player.y,'#88ccff',160,320,3);
      collectNearbyDrops(player.x,player.y,130);
      activateImmunity(3.0);
    }
  }

  stageBoostActive = miniJetpackActive || newStageActive;

  if (newStageActive) {
    newStageTimer-=dt;
    if (newStageTimer<=0) {
      newStageActive=false; newStageTimer=0;
      worldSpeedMult=1;
      camZoom=1;
      addRing(player.x,player.y,'#66bbff',180,360,3.5);
      burst(player.x,player.y,'#66bbff',40,300);
      addShake(14,0.5);
      collectNearbyDrops(player.x,player.y,150);
      activateImmunity(3.0);
      if (gameMode==='IMPOSSIBLE') advanceImpossibleStage();
      else if (gameMode==='LTM') advanceLtmStage();
      else advanceAdventureStage();
    }
  }

  // BUG FIX 3: Removed duplicate score increment. Score was being added twice per frame.
  // stageMult kept as 1; special multipliers are in scoreMultiplier().
  const stageMult=1;
  score+=(CFG.SPS*terrain.speedFrac()*3*dt*scoreMultiplier()+CFG.SPS*dt)*stageMult;

  if (scorePopT>0) scorePopT=Math.max(0,scorePopT-dt*3);
  if (flashAlpha>0) flashAlpha=Math.max(0,flashAlpha-dt*3.5);

  updateShake(dt);
  if (gameMode==='IMPOSSIBLE' && impossibleStage>=2 && !(transDir===0 && transAlpha<1)) addShake(impossibleStage>=3?1.2:0.6,0.05);
  terrain.update(wdt);
  const hitResult=player.update(dt,terrain);
  if (hitResult==='SIDE_TOUCH' || hitResult==='WALL') {
    centerPlayerToTrack();
    if (!immunityActive && !player.jetpackActive) loseLife();
  }
  updateParticles(dt); updateRings(dt);
  updateFloats(dt); updateNotifs(dt); updateObjAnims(dt);
  spawnObjects(dt);
  tickObjectives();

  // Magnet: very intense pull
  for (let i=gems.length-1;i>=0;i--) {
    const gem=gems[i];
    if (!gem||!gem.update||!gem.checkHit){gems.splice(i,1);continue;}
    if (gem.collected||!gem.active){gems.splice(i,1);continue;}
    if (activePwr==='MAGNET') {
      const dx=player.x-gem.x,dy=player.y-gem.y,dist=Math.hypot(dx,dy);
      if (dist<300&&dist>1) {
        const f=clamp(900/dist,120,1200);
        gem.x+=dx/dist*f*dt; gem.y+=dy/dist*f*dt;
      }
    }
    gem.update(dt,terrain.speed*worldSpeedMult);
    if (!gem.active){gems.splice(i,1);continue;}
    if (gem.checkHit(player.x,player.y)) collectGem(gem);
  }

  for (let i=powerups.length-1;i>=0;i--) {
    const pwr=powerups[i];
    if (!pwr||!pwr.update||!pwr.checkHit){powerups.splice(i,1);continue;}
    if (pwr.collected||!pwr.active){powerups.splice(i,1);continue;}
    if (activePwr==='MAGNET') {
      const dx=player.x-pwr.x,dy=player.y-pwr.y,dist=Math.hypot(dx,dy);
      if (dist<280&&dist>1) {
        const f=clamp(800/dist,100,1000);
        pwr.x+=dx/dist*f*dt; pwr.y+=dy/dist*f*dt;
      }
    }
    pwr.update(dt,terrain.speed*worldSpeedMult);
    if (!pwr.active){powerups.splice(i,1);continue;}
    if (pwr.checkHit(player.x,player.y)) collectPwr(pwr);
  }

  if (gs==='PLAY') {
    for (let i=obstacles.length-1;i>=0;i--) {
      const obs=obstacles[i];
      if (!obs||!obs.update||!obs.checkHit){obstacles.splice(i,1);continue;}
      obs.update(dt,terrain.speed*worldSpeedMult,terrain);
      if (!obs.active){obstacles.splice(i,1);continue;}
      if (!immunityActive&&!player.inv&&!player.jetpackActive&&Math.abs(player.y-obs.y)<40) {
        if (obs.checkHit(player.x,player.y)) {
          obs.hit=true; obs.active=false; obstacles.splice(i,1);
          centerPlayerToTrack();
          clearObstaclesTemporarily();
          if (!immunityActive && !player.jetpackActive) loseLife();
        }
      }
    }
  }

  // ── DRAW ────────────────────────────────────────────────────
  if (player.jetpackActive) addShake(2.4,0.05);
  const targetZoom=(miniJetpackActive||newStageActive)?1.08:(player.jetpackActive?1.04:1);
  camZoom=lerp(camZoom,targetZoom,dt*3);
  ctx.save(); applyShake();
  if (camZoom!==1) {
    ctx.translate(player.x,player.y);
    ctx.scale(camZoom,camZoom);
    ctx.translate(-player.x,-player.y);
  }
  drawPerspGrid(terrain.scrollY,terrain.speedFrac());
  drawTerrain();
  drawExhaust();
  drawMagnetEffect(gems,powerups);
  gems.forEach(g=>g&&g.draw&&g.draw());
  powerups.forEach(p=>p&&p.draw&&p.draw());
  obstacles.forEach(o=>o&&o.draw&&o.draw());
  const th=getSelectedThemeData();
  if (th&&th.id!=='classic') { ctx.save(); ctx.globalAlpha=0.06+0.03*Math.sin(menuT*2); ctx.fillStyle=th.col; ctx.fillRect(0,0,LW,LH); ctx.restore(); }
  drawPlayer();
  drawAuraVisual();
  drawParticles(); drawRings();
  ctx.restore();

  if (gameMode==='LTM') drawLtmModeFx(getActiveLtm(),menuT);

  const hideImpossibleVfx = (transDir===0 && transAlpha<1);
  if (gameMode==='IMPOSSIBLE' && (gs==='PLAY'||gs==='PAUSE'||gs==='CONTINUE') && !hideImpossibleVfx) {
    const tint=IMP_STAGES[impossibleStage]?.theme||'rgba(255,20,20,0.1)';
    ctx.save(); ctx.fillStyle=tint; ctx.fillRect(0,0,LW,LH); ctx.restore();
    if (impossibleStage>=2 && Math.random()<0.06) {
      ctx.save(); ctx.globalAlpha=0.2+Math.random()*0.3; ctx.fillStyle='#fff'; ctx.fillRect(0,rnd(0,LH*0.5),LW,2+rnd(0,2)); ctx.restore();
    }
  }

  // Stage boost visual
  if (miniJetpackActive||newStageActive) {
    const a=0.08+0.05*Math.sin(menuT*9);
    ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#77bbff'; ctx.fillRect(0,0,LW,LH); ctx.restore();
  }

  // Stage transition banner
  if (stageTransT>0) {
    const alpha=Math.min(1,stageTransT>2.5?1:(stageTransT/0.5));
    ctx.save(); ctx.globalAlpha=alpha*0.95;
    const bW=300,bH=50,bX=(LW-bW)/2,bY=LH*0.45;
    glow('#88ffcc',20); ctx.fillStyle='rgba(2,20,15,0.92)'; ctx.fillRect(bX,bY,bW,bH);
    ctx.strokeStyle='#88ffcc'; ctx.lineWidth=2; ctx.strokeRect(bX,bY,bW,bH);
    setFont(16,'900'); glow('#88ffcc',16); txt(stageTransLabel,LW/2,bY+bH/2+6,'#88ffcc');
    ctx.restore();
  }

  if (gameMode==='IMPOSSIBLE' && (gs==='PLAY'||gs==='PAUSE'||gs==='CONTINUE') && !hideImpossibleVfx) {
    ctx.save();
    const fogA=impossibleStage>=3?0.22:(impossibleStage>=2?0.16:0.1);
    const g=ctx.createLinearGradient(0,LH,0,LH*0.35);
    g.addColorStop(0,`rgba(120,0,0,${fogA})`); g.addColorStop(1,'transparent');
    ctx.fillStyle=g; ctx.fillRect(0,LH*0.35,LW,LH*0.65);
    ctx.restore();
  }
  drawJetpackFog();
  drawFlash();
  drawHUD();
  drawObjectivesPanel();
  drawTutorialHint();
  drawObjAnims();
  drawNotifs();
  drawFloats();
  drawScanlines();
  drawTransition();
  drawTopOverlays(menuT);

  requestAnimationFrame(loop);
}

// Boot: init loading screen, start
initBgSquares();
initLoadParticles();
shuffleShop();
requestAnimationFrame(ts=>{ lastTime=ts; requestAnimationFrame(loop); });
</script>

</body>
</html>
